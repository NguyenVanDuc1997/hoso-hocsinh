<?php

namespace App\Http\Controllers\Admin;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;
use Illuminate\Support\Facades\Auth;
use Exception;
use Excel,datetime;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Input;
use Illuminate\Support\Facades\Validator;
use App\Models\qlhs_message;
use App\Models\BaoCaoNhuCau_PGD;
use App\Models\LichSuHSHocSinh;
use App\Models\HoSoBaoCao;
use App\Models\TongHopCheDo_Truong;
use App\Jobs\compilationProfile;
use App\Jobs\sendDocumentary_Truong;
use App\Jobs\sendDocumentary_PhongSo;
use App\Jobs\CapNhatCheDo;
use App\Helpers\tongHopChedo;
use App\Helpers\lapcongvanCapPhong;
use App\Helpers\bussinessClass;
use App\Models\qlhs_nguoinauan;
use App\Models\qlhs_hosobaocao_ngna_PGD;
use App\Models\qlhs_hosobaocao_ngna_PTC;
use App\Models\qlhs_hosobaocao_ngna_STC;
use App\Models\qlhs_hosobaocao_ngna_duyet;


class LapHoSo9Controller extends Controller
{

    public function getPermission(){
        $json = [];
        $val = [];
        $data = DB::select('SELECT pu.module_id,pu.permission_id FROM permission_users pu WHERE pu.role_user_id = '.Auth::user()->id.' and pu.module_id = 9');
        foreach ($data as $key => $value) {
            $val[]= $value->permission_id.'';
        }
        $json['permission'] = $val;
        return $json;
    }



//-----------------------------------------------------------Cập nhật tiền----------------------------------------------------------------------------
    public function updateMoneyNew(Request $request){
        try {
            $schools_id = $request->SCHOOLID;
            $year = $request->YEAR;

            $oldYear = ($year - 1);
            $newYear = ($year + 1);

            $getKinhphiNamHoc = DB::table('qlhs_profile')
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))
                ->join('qlhs_class', 'class_id', 'history_class_id')
                ->join('history_profile_site', 'p_id', '=', DB::raw('profile_id AND history_profile_site.start_date <= "'.$year.'-09-05" AND (history_profile_site.end_date >= "'.$year.'-09-05" OR history_profile_site.end_date is null)'))
                ->join('qlhs_kinhphinamhoc', 'idKhoi', '=', DB::raw('qlhs_class.class_unit_id AND idXa = site_phuongxa AND qlhs_kinhphinamhoc.status = 1 AND qlhs_kinhphinamhoc.start_date <= "'.$year.'-09-05" AND (qlhs_kinhphinamhoc.end_date >= "'.$year.'-09-05" OR qlhs_kinhphinamhoc.end_date is null)'))
                ->where('profile_school_id', $schools_id)
                ->select('qlhs_kinhphinamhoc.id as kpnhID')->get();

            // return $getKinhphiNamHoc;

            $getSchoolType = DB::table('qlhs_schools_history')
                ->where('type_his_school_id', '=', DB::raw($schools_id.' AND type_his_startdate <= "'.$year.'-09-05" AND (type_his_enddate >= "'.$year.'-09-05" OR type_his_enddate is null)'))->select('type_his_type_id')->first();

            $getKinhphiDoiTuong = DB::table('qlhs_kinhphidoituong')
                ->where('idLoaiTruong', $getSchoolType->type_his_type_id)
                ->where('status', 1)
                ->select('id')
                ->get();

            if ((!is_null($getKinhphiDoiTuong) && !empty($getKinhphiDoiTuong) && count($getKinhphiDoiTuong) > 0) 
                || (!is_null($getKinhphiNamHoc) && !empty($getKinhphiNamHoc) && count($getKinhphiNamHoc) > 0)) {

                $subOryear = 11;

                //Get and Update profile old
                $getProfileOld = DB::table('qlhs_tonghopchedo')
                    ->where('qlhs_thcd_school_id',  $schools_id)
                    ->where('qlhs_thcd_nam',  $oldYear)
                    ->select('qlhs_thcd_id', 'qlhs_thcd_profile_id')->get();

                if (!is_null($getProfileOld) && !empty($getProfileOld) && count($getProfileOld) > 0) {
                    foreach ($getProfileOld as $value) {
                        $this->updateMoneyByProfile($oldYear, $value->qlhs_thcd_profile_id, $schools_id, $value->qlhs_thcd_id, $subOryear);
                    }
                }

                //Get and Update profile current
                $getProfileCur = DB::table('qlhs_tonghopchedo')
                    ->where('qlhs_thcd_school_id', $schools_id)
                    ->where('qlhs_thcd_nam',  $year)
                    ->select('qlhs_thcd_id', 'qlhs_thcd_profile_id')->get();

                if (!is_null($getProfileCur) && !empty($getProfileCur) && count($getProfileCur) > 0) {
                    foreach ($getProfileCur as $value) {
                        $this->updateMoneyByProfile($year, $value->qlhs_thcd_profile_id, $schools_id, $value->qlhs_thcd_id, $subOryear);
                    }
                }
                //Get and Update profile new
                $getProfileNew = DB::table('qlhs_tonghopchedo')
                    ->where('qlhs_thcd_school_id', $schools_id)
                    ->where('qlhs_thcd_nam',  $newYear)
                    ->select('qlhs_thcd_id', 'qlhs_thcd_profile_id')->get();

                if (!is_null($getProfileNew) && !empty($getProfileNew) && count($getProfileNew) > 0) {
                    foreach ($getProfileNew as $value) {
                        $this->updateMoneyByProfile($newYear, $value->qlhs_thcd_profile_id, $schools_id, $value->qlhs_thcd_id, $subOryear);
                    }
                }

                //Update lại trạng thái cho 2 bảng kinh phí
                if (!is_null($getKinhphiDoiTuong) && !empty($getKinhphiDoiTuong) && count($getKinhphiDoiTuong) > 0) {
                    foreach ($getKinhphiDoiTuong as $value) {
                        $updateKinhPhi = DB::table('qlhs_kinhphidoituong')
                            ->where('idLoaiTruong', '=', $getSchoolType->type_his_type_id)
                            ->update(['status' => 0]);
                    }
                }
                
                if (!is_null($getKinhphiNamHoc) && !empty($getKinhphiNamHoc) && count($getKinhphiNamHoc) > 0) {
                    foreach ($getKinhphiNamHoc as $value) {
                        $updateKinhPhi = DB::table('qlhs_kinhphinamhoc')
                            ->where('id', $value->kpnhID)
                            ->update(['status' => 0]);
                    }
                }
            }
        } catch (Exception $e) {
            return $e;
        }
    }

    
    
//-----------------------------------------------------------Chế độ học sinh-------------------------------------------------------------------------- use
    public function loadData(Request $request)
    {
        try {
            $json = [];
            $start = $request->start;
            $limit = $request->limit;

            $schools_id = $request->SCHOOLID;
            $type = $request->TYPE;
            $order = $request->ORDER;
            $year = $request->YEAR;
            $keySearch = $request->KEY;

            $status = $request->STATUS;

            $class_type = $request->CLASS_TYPE;

            $arrYear = [];
            $arrYear = explode("-", $year);

            $datas = null;
            $truong_id = Auth::user()->truong_id;
            $hocky = $arrYear[0];
            $namhoc = $arrYear[1];
            if ($hocky != "CA") {
                $datas = TongHopCheDo_Truong::leftJoin('qlhs_profile','profile_id','thcd_nhucau_profile_id')
                ->leftJoin('qlhs_profile_history',function($q) use($namhoc){
                    $q->on('history_profile_id','profile_id')
                    ->where('history_year',$namhoc.'-'.($namhoc + 1));
                })
                ->leftJoin('qlhs_schools','schools_id','profile_school_id')
                ->leftJoin('qlhs_class','class_id','history_class_id')
                ->leftJoin('qlhs_unit','unit_id','class_unit_id')
                ->where('thcd_nhucau_school_id',$truong_id)
                ->where('thcd_nhucau_nam',$namhoc)
                ->select('thcd_nhucau_id', 
                    'thcd_nhucau_MGHP_'.$hocky.' as MGHP', 
                    'thcd_nhucau_CPHT_'.$hocky.' as CPHT', 
                    'thcd_nhucau_HTAT_'.$hocky.' as HTAT', 
                    'thcd_nhucau_HTBT_TA_'.$hocky.' as HTBT_TA', 
                    'thcd_nhucau_HTBT_TO_'.$hocky.' as HTBT_TO', 
                    'thcd_nhucau_HTBT_VHTT_'.$hocky.' as HTBT_VHTT', 
                    'thcd_nhucau_HSDTTS_'.$hocky.' as HSDTTS', 
                    'thcd_nhucau_HSKT_HB_'.$hocky.' as HSKT_HB', 
                    'thcd_nhucau_HSKT_DDHT_'.$hocky.' as HSKT_DDHT', 
                    'thcd_nhucau_HTATHS_'.$hocky.' as HTATHS', 
                    'thcd_nhucau_HBHSDTNT_'.$hocky.' as HBHSDTNT', 
                    'thcd_nhucau_tongtien_'.$hocky.' as TONGTIEN', 
                    'thcd_nhucau_trangthai_'.$hocky.' as TRANGTHAI', 
                    'thcd_nhucau_trangthai_'.$hocky.' as TRANGTHAIPHEDUYET', 
                    'profile_id', 
                    'profile_name', 
                    'profile_birthday', 
                    'schools_name', 
                    'class_name', 
                    'unit_name', 
                    'qlhs_thcd_ghichu_'.$hocky.' as GHICHU');
            }else {
                $datas = TongHopCheDo_Truong::leftJoin('qlhs_profile','profile_id','thcd_nhucau_profile_id')
                ->leftJoin('qlhs_profile_history',function($q) use($namhoc){
                    $q->on('history_profile_id','profile_id')
                    ->where('history_year',$namhoc.'-'.($namhoc + 1));
                })
                ->leftJoin('qlhs_schools','schools_id','profile_school_id')
                ->leftJoin('qlhs_class','class_id','history_class_id')
                ->leftJoin('qlhs_unit','unit_id','class_unit_id')
                ->where('thcd_nhucau_school_id',$truong_id)
                ->where('thcd_nhucau_nam',$namhoc)
                ->select('thcd_nhucau_id', 
                    DB::raw('(thcd_nhucau_MGHP_HK1 + thcd_nhucau_MGHP_HK2) as MGHP'), 
                    DB::raw('(thcd_nhucau_CPHT_HK1 + thcd_nhucau_CPHT_HK2) as CPHT'), 
                    DB::raw('(thcd_nhucau_HTAT_HK1 + thcd_nhucau_HTAT_HK2) as HTAT'), 
                    DB::raw('(thcd_nhucau_HTBT_TA_HK1 + thcd_nhucau_HTBT_TA_HK2) as HTBT_TA'), 
                    DB::raw('(thcd_nhucau_HTBT_TO_HK1 + thcd_nhucau_HTBT_TO_HK2) as HTBT_TO'), 
                    DB::raw('(thcd_nhucau_HTBT_VHTT_HK1 + thcd_nhucau_HTBT_VHTT_HK2) as HTBT_VHTT'), 
                    DB::raw('(thcd_nhucau_HSDTTS_HK1 + thcd_nhucau_HSDTTS_HK2) as HSDTTS'), 
                    DB::raw('(thcd_nhucau_HSKT_HB_HK1 + thcd_nhucau_HSKT_HB_HK2) as HSKT_HB'), 
                    DB::raw('(thcd_nhucau_HSKT_DDHT_HK1 + thcd_nhucau_HSKT_DDHT_HK2) as HSKT_DDHT'),  
                    DB::raw('(thcd_nhucau_HTATHS_HK1 + thcd_nhucau_HTATHS_HK2) as HTATHS'),  
                    DB::raw('(thcd_nhucau_HBHSDTNT_HK1 + thcd_nhucau_HBHSDTNT_HK2) as HBHSDTNT'),  
                    DB::raw('(thcd_nhucau_tongtien_HK1 + thcd_nhucau_tongtien_HK2) as TONGTIEN'),  
                    DB::raw('CASE 
                        when (thcd_nhucau_trangthai_HK1 = 1) and (thcd_nhucau_trangthai_HK2 = 1)
                        then 1 else 0 end TRANGTHAI'),
                    DB::raw('CASE 
                        when (thcd_nhucau_trangthai_HK1 = 1) and (thcd_nhucau_trangthai_HK2 = 1)
                        then 1 else 0 end TRANGTHAIPHEDUYET'), 
                    'profile_id', 
                    'profile_name', 
                    'profile_birthday', 
                    'schools_name', 
                    'class_name', 
                    'unit_name', 
                    'qlhs_thcd_ghichu_CANAM as GHICHU');

            }
            if(!is_null($class_type) && $class_type != ""){
                $datas = $datas->where('class_unit_id',$class_type);
            }
            if (!is_null($keySearch) && !empty($keySearch)) {
                    $kw = bussinessClass::to_slug($keySearch);
                    $datas->where(function($q) use($keySearch,$kw){
                        $q->orWhere('profile_name', 'LIKE', '%'.$keySearch.'%')
                        ->orWhere("profile_rewrite", "LIKE", "%".$kw."%")
                        ->orWhere('class_name', 'LIKE', '%'.$keySearch.'%');
                    });
                        
                        
            }
            //return $datas->toSql();
            $json['totalRows'] = 0;

            if (!is_null($datas)) {
                
                if($status >= 0 && $status != null && $status != '' ){
                    if($status == 0 || $status == 1){
                        $datas->where('update_profile', $status);    
                    }else if($status == 2){
                        if ($arrYear[0] == "HK1" ) {
                            $datas->where('thcd_nhucau_trangthai_HK1',0);  
                        }else if ($arrYear[0] == "HK2") {
                            $datas->where('thcd_nhucau_trangthai_HK2', 0);  
                        }else if ($arrYear[0] == "CA") {
                            $datas->where('thcd_nhucau_trangthai_HK1',0)
                            ->where('thcd_nhucau_trangthai_HK2',0);  
                        }
                    }else if($status == 3){
                        if ($arrYear[0] == "HK1" ) {
                            $datas->where('thcd_nhucau_trangthai_HK1',1);  
                        }else if ($arrYear[0] == "HK2") {
                            $datas->where('thcd_nhucau_trangthai_HK2',1);  
                        }else if ($arrYear[0] == "CA") {
                            $datas->where('thcd_nhucau_trangthai_HK1',1)
                            ->where('thcd_nhucau_trangthai_HK2',1);  
                        }
                    }
                    
                }
                $json['totalRows'] = $datas->count();
                
                $json['startRecord'] = ($start);
                $json['numRows'] = $limit;
            $or = 'asc';
            if($order == 1){
                $or = 'desc';
            }
            if ($hocky != "CA") {
                if($type == 1){
                    $datas = $datas->orderBy('thcd_nhucau_MGHP_'.$hocky,$or);
                }else if($type == 2){
                    $datas = $datas->orderBy('thcd_nhucau_CPHT_'.$hocky,$or);
                }else if($type == 3){
                    $datas = $datas->orderBy('thcd_nhucau_HTAT_'.$hocky,$or);
                }else if($type == 4){
                    $datas = $datas->orderBy('thcd_nhucau_HTBT_TA_'.$hocky,$or);
                }else if($type == 5){
                    $datas = $datas->orderBy('thcd_nhucau_HTBT_TO_'.$hocky,$or);
                }else if($type == 6){
                    $datas = $datas->orderBy('thcd_nhucau_HTBT_VHTT_'.$hocky,$or);
                }else if($type == 7){
                    $datas = $datas->orderBy('thcd_nhucau_HTATHS_'.$hocky,$or);
                }else if($type == 8){
                    $datas = $datas->orderBy('thcd_nhucau_HSKT_HB_'.$hocky,$or);
                }else if($type == 9){
                    $datas = $datas->orderBy('thcd_nhucau_HSKT_DDHT_'.$hocky,$or);
                }else if($type == 10){
                    $datas = $datas->orderBy('thcd_nhucau_HBHSDTNT_'.$hocky,$or);
                }else if($type == 11){
                    $datas = $datas->orderBy('thcd_nhucau_HSDTTS_'.$hocky,$or);
                }else if($type == 12){
                    $datas = $datas->orderBy('thcd_nhucau_tongtien_'.$hocky,$or);
                }else if($type == 13){
                    $datas = $datas->orderBy('class_name',$or);
                }else if($type == 14){
                    $datas = $datas->orderBy('profile_name',$or);
                }
            }else{
                if($type == 1){
                    $datas = $datas->orderBy('thcd_nhucau_MGHP_HK1',$or)
                    ->orderBy('thcd_nhucau_MGHP_HK2',$or);
                }else if($type == 2){
                    $datas = $datas->orderBy('thcd_nhucau_CPHT_HK1',$or)
                    ->orderBy('thcd_nhucau_CPHT_HK2',$or);
                }else if($type == 3){
                    $datas = $datas->orderBy('thcd_nhucau_HTAT_HK1',$or)
                    ->orderBy('thcd_nhucau_HTAT_HK2',$or);
                }else if($type == 4){
                    $datas = $datas->orderBy('thcd_nhucau_HTBT_TA_HK1',$or)
                    ->orderBy('thcd_nhucau_HTBT_TA_HK2',$or);
                }else if($type == 5){
                    $datas = $datas->orderBy('thcd_nhucau_HTBT_TO_HK1',$or)
                    ->orderBy('thcd_nhucau_HTBT_TO_HK2',$or);
                }else if($type == 6){
                    $datas = $datas->orderBy('thcd_nhucau_HTBT_VHTT_HK1',$or)
                    ->orderBy('thcd_nhucau_HTBT_VHTT_HK2',$or);
                }else if($type == 7){
                    $datas = $datas->orderBy('thcd_nhucau_HTATHS_HK1',$or)
                    ->orderBy('thcd_nhucau_HTATHS_HK2',$or);
                }else if($type == 8){
                    $datas = $datas->orderBy('thcd_nhucau_HSKT_HB_HK1',$or)
                    ->orderBy('thcd_nhucau_HSKT_HB_HK2',$or);
                }else if($type == 9){
                    $datas = $datas->orderBy('thcd_nhucau_HSKT_DDHT_HK1',$or)
                    ->orderBy('thcd_nhucau_HSKT_DDHT_HK2',$or);
                }else if($type == 10){
                    $datas = $datas->orderBy('thcd_nhucau_HBHSDTNT_HK1',$or)
                    ->orderBy('thcd_nhucau_HBHSDTNT_HK2',$or);
                }else if($type == 11){
                    $datas = $datas->orderBy('thcd_nhucau_HSDTTS_HK1',$or)
                    ->orderBy('thcd_nhucau_HSDTTS_HK2',$or);
                }else if($type == 12){
                    $datas = $datas->orderBy('thcd_nhucau_tongtien_HK1',$or)
                    ->orderBy('thcd_nhucau_tongtien_HK2',$or);
                }else if($type == 13){
                    $datas = $datas->orderBy('class_name',$or);
                }else if($type == 14){
                    $datas = $datas->orderBy('profile_name',$or);
                }
            }
            
                $json['data'] = $datas->orderBy('qlhs_profile.profile_name')
                ->skip($start*$limit)->take($limit)->get();
            }
            
            return $json;
        } catch (Exception $e) {
            return $e;
        }
    }


    public function checkHistory($years,$profile_id){
        return DB::table('qlhs_profile_history')
            ->where('history_profile_id',$profile_id)
            ->where('history_year',$years.'-'.((int)$years + 1))
            ->count();
    }


    public function loadHocky(){
        $result = [];
        try {
            $result['NAMHOC'] = DB::table('qlhs_years')->orderBy('code','asc')->get();
            $result['HOCKY'] = DB::table('qlhs_hocky')->orderBy('qlhs_hocky_order','asc')->get();

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function approvedAll(Request $request){
        try {
            $result = [];

            $level = $request->LEVEL;
            $schools_id = $request->SCHOOLID;
            $year = $request->YEAR;
            $hocky = $request->HOCKY; 
            $class_type = $request->CLASS_TYPE; 
            $status = 0;
            $currentuser = Auth::user()->id;
            $currentdate = Carbon::now();
            $updateCheDo = TongHopCheDo_Truong::where('thcd_nhucau_school_id',Auth::user()->truong_id)
                ->where('thcd_nhucau_nam',$year);
            if($hocky != "CA"){                
                if($updateCheDo != null && $hocky == "HK1"){
                    $updateCheDo->update([
                        'thcd_nhucau_trangthai_MGHP_HK1' => DB::raw('CASE WHEN thcd_nhucau_MGHP_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_CPHT_HK1' => DB::raw('CASE WHEN thcd_nhucau_CPHT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTAT_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTAT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_TA_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTBT_TA_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_TO_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTBT_TO_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_VHTT_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTBT_VHTT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSKT_HB_HK1' => DB::raw('CASE WHEN thcd_nhucau_HSKT_HB_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSKT_DDHT_HK1' => DB::raw('CASE WHEN thcd_nhucau_HSKT_DDHT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSDTTS_HK1' => DB::raw('CASE WHEN thcd_nhucau_HSDTTS_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTATHS_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTATHS_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HBHSDTNT_HK1' => DB::raw('CASE WHEN thcd_nhucau_HBHSDTNT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HK1' => DB::raw('CASE WHEN thcd_nhucau_tongtien_HK1 > 0 THEN 1 ELSE 0 END')
                    ]);
                     $result['success'] = 'Xử lý học kỳ 1 toàn bộ học sinh thành công';
                }else if($updateCheDo != null && $hocky == "HK2"){
                    $updateCheDo->update([
                        'thcd_nhucau_trangthai_MGHP_HK2' => DB::raw('CASE WHEN thcd_nhucau_MGHP_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_CPHT_HK2' => DB::raw('CASE WHEN thcd_nhucau_CPHT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTAT_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTAT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_TA_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTBT_TA_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_TO_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTBT_TO_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_VHTT_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTBT_VHTT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSKT_HB_HK2' => DB::raw('CASE WHEN thcd_nhucau_HSKT_HB_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSKT_DDHT_HK2' => DB::raw('CASE WHEN thcd_nhucau_HSKT_DDHT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSDTTS_HK2' => DB::raw('CASE WHEN thcd_nhucau_HSDTTS_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTATHS_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTATHS_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HBHSDTNT_HK2' => DB::raw('CASE WHEN thcd_nhucau_HBHSDTNT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HK2' => DB::raw('CASE WHEN thcd_nhucau_tongtien_HK2 > 0 THEN 1 ELSE 0 END')
                    ]);
                    $result['success'] = 'Xử lý học kỳ 2 toàn bộ học sinh thành công';
                }
            }else{
                $updateCheDo->update([
                        'thcd_nhucau_trangthai_MGHP_HK1' => DB::raw('CASE WHEN thcd_nhucau_MGHP_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_CPHT_HK1' => DB::raw('CASE WHEN thcd_nhucau_CPHT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTAT_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTAT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_TA_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTBT_TA_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_TO_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTBT_TO_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_VHTT_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTBT_VHTT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSKT_HB_HK1' => DB::raw('CASE WHEN thcd_nhucau_HSKT_HB_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSKT_DDHT_HK1' => DB::raw('CASE WHEN thcd_nhucau_HSKT_DDHT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSDTTS_HK1' => DB::raw('CASE WHEN thcd_nhucau_HSDTTS_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTATHS_HK1' => DB::raw('CASE WHEN thcd_nhucau_HTATHS_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HBHSDTNT_HK1' => DB::raw('CASE WHEN thcd_nhucau_HBHSDTNT_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HK1' => DB::raw('CASE WHEN thcd_nhucau_tongtien_HK1 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_MGHP_HK2' => DB::raw('CASE WHEN thcd_nhucau_MGHP_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_CPHT_HK2' => DB::raw('CASE WHEN thcd_nhucau_CPHT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTAT_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTAT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_TA_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTBT_TA_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_TO_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTBT_TO_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTBT_VHTT_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTBT_VHTT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSKT_HB_HK2' => DB::raw('CASE WHEN thcd_nhucau_HSKT_HB_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSKT_DDHT_HK2' => DB::raw('CASE WHEN thcd_nhucau_HSKT_DDHT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HSDTTS_HK2' => DB::raw('CASE WHEN thcd_nhucau_HSDTTS_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HTATHS_HK2' => DB::raw('CASE WHEN thcd_nhucau_HTATHS_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HBHSDTNT_HK2' => DB::raw('CASE WHEN thcd_nhucau_HBHSDTNT_HK2 > 0 THEN 1 ELSE 0 END'),
                        'thcd_nhucau_trangthai_HK2' => DB::raw('CASE WHEN thcd_nhucau_tongtien_HK2 > 0 THEN 1 ELSE 0 END')
                ]);
                $result['success'] = 'Xử lý toàn bộ học sinh thành công';
            }
           
            return $result;
        } catch (Exception $e) {
            return $result['error'] = $e;
        }
    }

    public function unApprovedAll(Request $request){
        try {
            $result = [];

            $level = $request->LEVEL;
            $schools_id = $request->SCHOOLID;
            $year = $request->YEAR;
            $hocky = $request->HOCKY;
            $status = 0;
            $currentuser = Auth::user()->id;
            $currentdate = Carbon::now();
            $updateCheDo = TongHopCheDo_Truong::where('thcd_nhucau_school_id',Auth::user()->truong_id)
                ->where('thcd_nhucau_nam',$year);
            if($hocky != "CA"){
                    $updateCheDo->update([
                        'thcd_nhucau_trangthai_MGHP_'.$hocky => 0,
                        'thcd_nhucau_trangthai_CPHT_'.$hocky => 0,
                        'thcd_nhucau_trangthai_HTAT_'.$hocky => 0,
                        'thcd_nhucau_trangthai_HTBT_TA_'.$hocky => 0,
                        'thcd_nhucau_trangthai_HTBT_TO_'.$hocky => 0,
                        'thcd_nhucau_trangthai_HTBT_VHTT_'.$hocky => 0,
                        'thcd_nhucau_trangthai_HSKT_HB_'.$hocky => 0,
                        'thcd_nhucau_trangthai_HSKT_DDHT_'.$hocky => 0,
                        'thcd_nhucau_trangthai_HSDTTS_'.$hocky => 0,
                        'thcd_nhucau_trangthai_HTATHS_'.$hocky => 0,
                        'thcd_nhucau_trangthai_HBHSDTNT_'.$hocky => 0,
                        'thcd_nhucau_trangthai_'.$hocky => 0
                    ]);
                if($updateCheDo != null && $hocky == "HK1"){
                     $result['success'] = 'Xử lý học kỳ 1 toàn bộ học sinh thành công';
                }else if($updateCheDo != null && $hocky == "HK2"){
                    $result['success'] = 'Xử lý học kỳ 2 toàn bộ học sinh thành công';
                }
            }else{
                $updateCheDo->update([
                        'thcd_nhucau_trangthai_MGHP_HK1' => 0,
                        'thcd_nhucau_trangthai_CPHT_HK1' => 0,
                        'thcd_nhucau_trangthai_HTAT_HK1' => 0,
                        'thcd_nhucau_trangthai_HTBT_TA_HK1' => 0,
                        'thcd_nhucau_trangthai_HTBT_TO_HK1' => 0,
                        'thcd_nhucau_trangthai_HTBT_VHTT_HK1' => 0,
                        'thcd_nhucau_trangthai_HSKT_HB_HK1' => 0,
                        'thcd_nhucau_trangthai_HSKT_DDHT_HK1' => 0,
                        'thcd_nhucau_trangthai_HSDTTS_HK1' => 0,
                        'thcd_nhucau_trangthai_HTATHS_HK1' => 0,
                        'thcd_nhucau_trangthai_HBHSDTNT_HK1' => 0,
                        'thcd_nhucau_trangthai_HK1' => 0,
                        'thcd_nhucau_trangthai_MGHP_HK2' => 0,
                        'thcd_nhucau_trangthai_CPHT_HK2' => 0,
                        'thcd_nhucau_trangthai_HTAT_HK2' => 0,
                        'thcd_nhucau_trangthai_HTBT_TA_HK2' => 0,
                        'thcd_nhucau_trangthai_HTBT_TO_HK2' => 0,
                        'thcd_nhucau_trangthai_HTBT_VHTT_HK2' => 0,
                        'thcd_nhucau_trangthai_HSKT_HB_HK2' => 0,
                        'thcd_nhucau_trangthai_HSKT_DDHT_HK2' => 0,
                        'thcd_nhucau_trangthai_HSDTTS_HK2' => 0,
                        'thcd_nhucau_trangthai_HTATHS_HK2' => 0,
                        'thcd_nhucau_trangthai_HBHSDTNT_HK2' => 0,
                        'thcd_nhucau_trangthai_HK2' => 0
                    ]);
                $result['success'] = 'Xử lý toàn bộ học sinh thành công';
            }

            return $result;
        } catch (Exception $e) {
            return $result['error'] = $e;
        }
    }

    public function approvedTHCD(Request $rq){
        $result = [];
        try {
            $profile_id = $rq->IDPROFILE;
            $ghichu = $rq->note;
            $strData = $rq->objData;
            $year = explode("-", $rq->year);
            if($rq->schoolid != Auth::user()->truong_id){
                $result['error'] = 'Học sinh không thuộc quyền quản lý';
                return $result;
            }

            $statusMGHP = 0;
            $statusCPHT = 0;
            $statusHTAT = 0;
            $statusHTBT_TA = 0;
            $statusHTBT_TO = 0;
            $statusHTBT_VHTT = 0;
            $statusHSKT_HB = 0;
            $statusHSKT_DDHT = 0;
            $statusHSDTTS = 0;
            $statusHTATHS = 0;
            $statusHBHSDTNT = 0;
            $trangthai_1 = 0;
            $trangthai_2 = 0;
            $arrData = explode("|", $strData);
            foreach ($arrData as $value) {
                    //MGHP
                    if ($value == 89 || $value == 90 || $value == 91) {
                        $statusMGHP = 1;
                    }

                    //CPHT
                    if ($value == 92) {
                        $statusCPHT = 1;
                    }
                    //HTAT
                    if ($value == 93) {
                        $statusHTAT = 1;
                    }

                    //HTBT
                    if ($value == 94) {
                        $statusHTBT_TA = 1;
                    }

                    if ($value == 98) {
                        $statusHTBT_TO = 1;
                    }

                    if ($value == 115) {
                        $statusHTBT_VHTT = 1;
                    }

                    //HSKT
                    if ($value == 95) {
                        $statusHSKT_HB = 1;
                    }
                    if ($value == 100) {
                        $statusHSKT_DDHT = 1;
                    }

                    //HSDTTS
                    if ($value == 99) {
                        $statusHSDTTS = 1;
                    }

                    //HTATHS
                    if ($value == 118) {
                        $statusHTATHS = 1;
                    }

                    //HBHSDTNT
                    if ($value == 119) {
                        $statusHBHSDTNT = 1;
                    }
                }
              //  return $year[0];
            if ($year[0] == "HK1") {

                if ($statusMGHP == 0 && $statusCPHT == 0 && $statusHTAT == 0 && $statusHTBT_TA == 0 &&  $statusHTBT_TO == 0 && $statusHTBT_VHTT == 0 && $statusHSKT_HB == 0 && $statusHSKT_DDHT == 0 && $statusHSDTTS == 0 && $statusHTATHS == 0 && $statusHBHSDTNT == 0) {
                    
                    $result['success'] = 'Hủy chọn học kỳ 1 thành công';
                }
                else {
                    $trangthai_1 = 1;
                    $result['success'] = 'Chọn học kỳ 1 thành công';
                }

                $updateCheDo = TongHopCheDo_Truong::where('thcd_nhucau_profile_id',$profile_id)
                ->where('thcd_nhucau_school_id',Auth::user()->truong_id)
                ->where('thcd_nhucau_nam',$year[1])->first();
                if($updateCheDo != null){
                    $updateCheDo->thcd_nhucau_trangthai_MGHP_HK1 = $statusMGHP;
                    $updateCheDo->thcd_nhucau_trangthai_CPHT_HK1 = $statusCPHT;
                    $updateCheDo->thcd_nhucau_trangthai_HTAT_HK1 = $statusHTAT;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_TA_HK1 = $statusHTBT_TA;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_TO_HK1 = $statusHTBT_TO;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_VHTT_HK1 = $statusHTBT_VHTT;
                    $updateCheDo->thcd_nhucau_trangthai_HSKT_HB_HK1 = $statusHSKT_HB;
                    $updateCheDo->thcd_nhucau_trangthai_HSKT_DDHT_HK1 = $statusHSKT_DDHT;
                    $updateCheDo->thcd_nhucau_trangthai_HSDTTS_HK1 = $statusHSDTTS;
                    $updateCheDo->thcd_nhucau_trangthai_HTATHS_HK1 = $statusHTATHS;
                    $updateCheDo->thcd_nhucau_trangthai_HBHSDTNT_HK1 = $statusHBHSDTNT;
                    $updateCheDo->thcd_nhucau_trangthai_HK1 = $trangthai_1;
                    $updateCheDo->qlhs_thcd_ghichu_HK1 = $ghichu;
                    $updateCheDo->chedo_HK1 = $strData;
                    $updateCheDo->save();
                }
            }else if ($year[0] == "HK2") {

                if ($statusMGHP == 0 && $statusCPHT == 0 && $statusHTAT == 0 && $statusHTBT_TA == 0 &&  $statusHTBT_TO == 0 &&  $statusHTBT_VHTT == 0 && $statusHSKT_HB == 0 && $statusHSKT_DDHT == 0 && $statusHSDTTS == 0 && $statusHTATHS == 0 && $statusHBHSDTNT == 0) {
                    
                    $result['success'] = 'Hủy chọn học kỳ 2 thành công';
                }
                else {
                    $trangthai_2 = 1;
                    $result['success'] = 'Chọn học kỳ 2 thành công';
                }

                $updateCheDo = TongHopCheDo_Truong::where('thcd_nhucau_profile_id',$profile_id)
                ->where('thcd_nhucau_school_id',Auth::user()->truong_id)
                ->where('thcd_nhucau_nam',$year[1])->first();
                if($updateCheDo != null){
                    $updateCheDo->thcd_nhucau_trangthai_MGHP_HK2 = $statusMGHP;
                    $updateCheDo->thcd_nhucau_trangthai_CPHT_HK2 = $statusCPHT;
                    $updateCheDo->thcd_nhucau_trangthai_HTAT_HK2 = $statusHTAT;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_TA_HK2 = $statusHTBT_TA;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_TO_HK2 = $statusHTBT_TO;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_VHTT_HK2 = $statusHTBT_VHTT;
                    $updateCheDo->thcd_nhucau_trangthai_HSKT_HB_HK2 = $statusHSKT_HB;
                    $updateCheDo->thcd_nhucau_trangthai_HSKT_DDHT_HK2 = $statusHSKT_DDHT;
                    $updateCheDo->thcd_nhucau_trangthai_HSDTTS_HK2 = $statusHSDTTS;
                    $updateCheDo->thcd_nhucau_trangthai_HTATHS_HK2 = $statusHTATHS;
                    $updateCheDo->thcd_nhucau_trangthai_HBHSDTNT_HK2 = $statusHBHSDTNT;
                    $updateCheDo->thcd_nhucau_trangthai_HK2 = $trangthai_2;
                    $updateCheDo->qlhs_thcd_ghichu_HK2 = $ghichu;
                    $updateCheDo->chedo_HK2 = $strData;
                    $updateCheDo->save();
                }
            }

            else if ($year[0] == "CA") {
                
                if ($statusMGHP == 0 && $statusCPHT == 0 && $statusHTAT == 0 && $statusHTBT_TA == 0 &&  $statusHTBT_TO == 0 &&  $statusHTBT_VHTT == 0 && $statusHSKT_HB == 0 && $statusHSKT_DDHT == 0 && $statusHSDTTS == 0 && $statusHTATHS == 0 && $statusHBHSDTNT == 0) {
                    
                    $result['success'] = 'Hủy chọn cả năm thành công';
                }
                else {
                    $trangthai_1 = 1;
                    $trangthai_2 = 1;
                    $result['success'] = 'Chọn cả năm thành công';
                }

                $updateCheDo = TongHopCheDo_Truong::where('thcd_nhucau_profile_id',$profile_id)
                ->where('thcd_nhucau_school_id',Auth::user()->truong_id)
                ->where('thcd_nhucau_nam',$year[1])->first();
                if($updateCheDo != null){
                    $updateCheDo->thcd_nhucau_trangthai_MGHP_HK1 = $statusMGHP;
                    $updateCheDo->thcd_nhucau_trangthai_CPHT_HK1 = $statusCPHT;
                    $updateCheDo->thcd_nhucau_trangthai_HTAT_HK1 = $statusHTAT;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_TA_HK1 = $statusHTBT_TA;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_TO_HK1 = $statusHTBT_TO;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_VHTT_HK1 = $statusHTBT_VHTT;
                    $updateCheDo->thcd_nhucau_trangthai_HSKT_HB_HK1 = $statusHSKT_HB;
                    $updateCheDo->thcd_nhucau_trangthai_HSKT_DDHT_HK1 = $statusHSKT_DDHT;
                    $updateCheDo->thcd_nhucau_trangthai_HSDTTS_HK1 = $statusHSDTTS;
                    $updateCheDo->thcd_nhucau_trangthai_HTATHS_HK1 = $statusHTATHS;
                    $updateCheDo->thcd_nhucau_trangthai_HBHSDTNT_HK1 = $statusHBHSDTNT;
                    $updateCheDo->thcd_nhucau_trangthai_HK1 = $trangthai_2;
                    $updateCheDo->qlhs_thcd_ghichu_HK1 = $ghichu;
                    $updateCheDo->thcd_nhucau_trangthai_MGHP_HK2 = $statusMGHP;
                    $updateCheDo->thcd_nhucau_trangthai_CPHT_HK2 = $statusCPHT;
                    $updateCheDo->thcd_nhucau_trangthai_HTAT_HK2 = $statusHTAT;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_TA_HK2 = $statusHTBT_TA;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_TO_HK2 = $statusHTBT_TO;
                    $updateCheDo->thcd_nhucau_trangthai_HTBT_VHTT_HK2 = $statusHTBT_VHTT;
                    $updateCheDo->thcd_nhucau_trangthai_HSKT_HB_HK2 = $statusHSKT_HB;
                    $updateCheDo->thcd_nhucau_trangthai_HSKT_DDHT_HK2 = $statusHSKT_DDHT;
                    $updateCheDo->thcd_nhucau_trangthai_HSDTTS_HK2 = $statusHSDTTS;
                    $updateCheDo->thcd_nhucau_trangthai_HTATHS_HK2 = $statusHTATHS;
                    $updateCheDo->thcd_nhucau_trangthai_HBHSDTNT_HK2 = $statusHBHSDTNT;
                    $updateCheDo->thcd_nhucau_trangthai_HK2 = $trangthai_2;
                    $updateCheDo->qlhs_thcd_ghichu_HK2 = $ghichu;
                    $updateCheDo->chedo_HK1 = $strData;
                    $updateCheDo->chedo_HK2 = $strData;
                    $updateCheDo->save();
                }
            }

            return $result;
        } catch (Exception $e) {
            return $result['error'] = $e;
        }
    }

    public function approvedTHCDNew(Request $request){
        $result = [];
        try {
            $chedoId = $request->input('CHEDOID');
            $profile_id = $request->input('PROFILEID');
            $hocky = $request->input('YEAR');
            $type = $request->input('TYPE');
            
            $update = 0;

            $statusMGHP = 0;
            $statusCPHT = 0;
            $statusHTAT = 0;
            $statusHTBT_TA = 0;
            $statusHTBT_TO = 0;
            $statusHTBT_VHTT = 0;
            $statusHSKT_HB = 0;
            $statusHSKT_DDHT = 0;
            $statusHSDTTS = 0;
            $statusHTATHS = 0;
            $statusHBHSDTNT = 0;

            $trangthai_1 = 0;
            $trangthai_2 = 0;

            if ($hocky == "HK1") {
                
                if ($type == 0) {
                    $statusMGHP = 1;
                    $statusCPHT = 1;
                    $statusHTAT = 1;
                    $statusHTBT_TA = 1;
                    $statusHTBT_TO = 1;
                    $statusHTBT_VHTT = 1;
                    $statusHSKT_HB = 1;
                    $statusHSKT_DDHT = 1;
                    $statusHSDTTS = 1;
                    $statusHTATHS = 1;
                    $statusHBHSDTNT = 1;

                    $trangthai_1 = 1;
                }

                if ($statusMGHP == 0 && $statusCPHT == 0 && $statusHTAT == 0 && $statusHTBT_TA == 0 &&  $statusHTBT_TO == 0 && $statusHTBT_VHTT == 0 && $statusHSKT_HB == 0 && $statusHSKT_DDHT == 0 && $statusHSDTTS == 0 && $statusHTATHS == 0 && $statusHBHSDTNT == 0) {
                    
                    $result['success'] = 'Hủy chọn học kỳ 1 thành công';
                }
                else {
                    $result['success'] = 'Chọn học kỳ 1 thành công';
                }

                // $update = DB::update("update qlhs_tonghopchedo set
                    // qlhs_thcd_trangthai = $trangthai_1, 
                    // qlhs_thcd_trangthai_MGHP = $statusMGHP, 
                    // qlhs_thcd_trangthai_CPHT = $statusCPHT,
                    // qlhs_thcd_trangthai_HTAT = $statusHTAT,
                    // qlhs_thcd_trangthai_HTBT_TA = $statusHTBT_TA,
                    // qlhs_thcd_trangthai_HTBT_TO = $statusHTBT_TO,
                    // qlhs_thcd_trangthai_HTBT_VHTT = $statusHTBT_VHTT,
                    // qlhs_thcd_trangthai_HSKT_HB = $statusHSKT_HB,
                    // qlhs_thcd_trangthai_HSKT_DDHT = $statusHSKT_DDHT,
                    // qlhs_thcd_trangthai_HSDTTS = $statusHSDTTS,
                    // qlhs_thcd_trangthai_HTATHS = $statusHTATHS,
                    // qlhs_thcd_trangthai_HBHSDTNT = $statusHBHSDTNT,
                    // qlhs_thcd_ghichu = '$note'
                    // where qlhs_thcd_id = $id");

                $update = DB::table('qlhs_tonghopchedo')->where('qlhs_thcd_id', '=', $chedoId)
                    ->update([
                        'qlhs_thcd_trangthai' => $trangthai_1, 
                        'qlhs_thcd_trangthai_MGHP' => $statusMGHP, 
                        'qlhs_thcd_trangthai_CPHT' => $statusCPHT,
                        'qlhs_thcd_trangthai_HTAT' => $statusHTAT,
                        'qlhs_thcd_trangthai_HTBT_TA' => $statusHTBT_TA,
                        'qlhs_thcd_trangthai_HTBT_TO' => $statusHTBT_TO,
                        'qlhs_thcd_trangthai_HTBT_VHTT' => $statusHTBT_VHTT,
                        'qlhs_thcd_trangthai_HSKT_HB' => $statusHSKT_HB,
                        'qlhs_thcd_trangthai_HSKT_DDHT' => $statusHSKT_DDHT,
                        'qlhs_thcd_trangthai_HSDTTS' => $statusHSDTTS,
                        'qlhs_thcd_trangthai_HTATHS' => $statusHTATHS,
                        'qlhs_thcd_trangthai_HBHSDTNT' => $statusHBHSDTNT
                        ]);
            }

            if ($hocky == "HK2") {
                if ($type == 0) {
                    $statusMGHP = 1;
                    $statusCPHT = 1;
                    $statusHTAT = 1;
                    $statusHTBT_TA = 1;
                    $statusHTBT_TO = 1;
                    $statusHTBT_VHTT = 1;
                    $statusHSKT_HB = 1;
                    $statusHSKT_DDHT = 1;
                    $statusHSDTTS = 1;
                    $statusHTATHS = 1;
                    $statusHBHSDTNT = 1;

                    $trangthai_2 = 1;
                }

                if ($statusMGHP == 0 && $statusCPHT == 0 && $statusHTAT == 0 && $statusHTBT_TA == 0 &&  $statusHTBT_TO == 0 &&  $statusHTBT_VHTT == 0 && $statusHSKT_HB == 0 && $statusHSKT_DDHT == 0 && $statusHSDTTS == 0 && $statusHTATHS == 0 && $statusHBHSDTNT == 0) {
                    
                    $result['success'] = 'Hủy chọn học kỳ 2 thành công';
                }
                else {
                    $result['success'] = 'Chọn học kỳ 2 thành công';
                }

                // return $statusHTATHS;

                // $update = DB::update("update qlhs_tonghopchedo set
                //     qlhs_thcd_trangthai_HK2 = $trangthai_2, 
                //     qlhs_thcd_trangthai_MGHP_HK2 = $statusMGHP, 
                //     qlhs_thcd_trangthai_CPHT_HK2 = $statusCPHT,
                //     qlhs_thcd_trangthai_HTAT_HK2 = $statusHTAT,
                //     qlhs_thcd_trangthai_HTBT_TA_HK2 = $statusHTBT_TA,
                //     qlhs_thcd_trangthai_HTBT_TO_HK2 = $statusHTBT_TO,
                //     qlhs_thcd_trangthai_HTBT_VHTT_HK2 = $statusHTBT_VHTT,
                //     qlhs_thcd_trangthai_HSKT_HB_HK2 = $statusHSKT_HB,
                //     qlhs_thcd_trangthai_HSKT_DDHT_HK2 = $statusHSKT_DDHT,
                //     qlhs_thcd_trangthai_HSDTTS_HK2 = $statusHSDTTS,
                //     qlhs_thcd_trangthai_HTATHS_HK2 = $statusHTATHS,
                //     qlhs_thcd_trangthai_HBHSDTNT_HK2 = $statusHBHSDTNT,
                //     qlhs_thcd_ghichu_HK2 = '$note'
                //     where qlhs_thcd_id = $id");

                $update = DB::table('qlhs_tonghopchedo')->where('qlhs_thcd_id', '=', $chedoId)
                    ->update([
                        'qlhs_thcd_trangthai_HK2' => $trangthai_2, 
                        'qlhs_thcd_trangthai_MGHP_HK2' => $statusMGHP, 
                        'qlhs_thcd_trangthai_CPHT_HK2' => $statusCPHT,
                        'qlhs_thcd_trangthai_HTAT_HK2' => $statusHTAT,
                        'qlhs_thcd_trangthai_HTBT_TA_HK2' => $statusHTBT_TA,
                        'qlhs_thcd_trangthai_HTBT_TO_HK2' => $statusHTBT_TO,
                        'qlhs_thcd_trangthai_HTBT_VHTT_HK2' => $statusHTBT_VHTT,
                        'qlhs_thcd_trangthai_HSKT_HB_HK2' => $statusHSKT_HB,
                        'qlhs_thcd_trangthai_HSKT_DDHT_HK2' => $statusHSKT_DDHT,
                        'qlhs_thcd_trangthai_HSDTTS_HK2' => $statusHSDTTS,
                        'qlhs_thcd_trangthai_HTATHS_HK2' => $statusHTATHS,
                        'qlhs_thcd_trangthai_HBHSDTNT_HK2' => $statusHBHSDTNT
                        ]);
            }

            if ($hocky == "CA") {
                if ($type == 0) {
                    $statusMGHP = 1;
                    $statusCPHT = 1;
                    $statusHTAT = 1;
                    $statusHTBT_TA = 1;
                    $statusHTBT_TO = 1;
                    $statusHTBT_VHTT = 1;
                    $statusHSKT_HB = 1;
                    $statusHSKT_DDHT = 1;
                    $statusHSDTTS = 1;
                    $statusHTATHS = 1;
                    $statusHBHSDTNT = 1;

                    $trangthai_1 = 1;
                    $trangthai_2 = 1;
                }

                if ($statusMGHP == 0 && $statusCPHT == 0 && $statusHTAT == 0 && $statusHTBT_TA == 0 &&  $statusHTBT_TO == 0 &&  $statusHTBT_VHTT == 0 && $statusHSKT_HB == 0 && $statusHSKT_DDHT == 0 && $statusHSDTTS == 0 && $statusHTATHS == 0 && $statusHBHSDTNT == 0) {
                    
                    $result['success'] = 'Hủy chọn cả năm thành công';
                }
                else {
                    $result['success'] = 'Chọn cả năm thành công';
                }

                // $update = DB::update("update qlhs_tonghopchedo set
                //     qlhs_thcd_trangthai = $trangthai_1, 
                //     qlhs_thcd_trangthai_HK2 = $trangthai_2, 
                //     qlhs_thcd_trangthai_MGHP = $statusMGHP, 
                //     qlhs_thcd_trangthai_CPHT = $statusCPHT,
                //     qlhs_thcd_trangthai_HTAT = $statusHTAT,
                //     qlhs_thcd_trangthai_HTBT_TA = $statusHTBT_TA,
                //     qlhs_thcd_trangthai_HTBT_TO = $statusHTBT_TO,
                //     qlhs_thcd_trangthai_HTBT_VHTT = $statusHTBT_VHTT,
                //     qlhs_thcd_trangthai_HSKT_HB = $statusHSKT_HB,
                //     qlhs_thcd_trangthai_HSKT_DDHT = $statusHSKT_DDHT,
                //     qlhs_thcd_trangthai_HSDTTS = $statusHSDTTS, 
                //     qlhs_thcd_trangthai_HTATHS = $statusHTATHS,
                //     qlhs_thcd_trangthai_HBHSDTNT = $statusHBHSDTNT,
                    
                //     qlhs_thcd_trangthai_MGHP_HK2 = $statusMGHP, 
                //     qlhs_thcd_trangthai_CPHT_HK2 = $statusCPHT,
                //     qlhs_thcd_trangthai_HTAT_HK2 = $statusHTAT,
                //     qlhs_thcd_trangthai_HTBT_TA_HK2 = $statusHTBT_TA,
                //     qlhs_thcd_trangthai_HTBT_TO_HK2 = $statusHTBT_TO,
                //     qlhs_thcd_trangthai_HTBT_VHTT_HK2 = $statusHTBT_VHTT,
                //     qlhs_thcd_trangthai_HSKT_HB_HK2 = $statusHSKT_HB,
                //     qlhs_thcd_trangthai_HSKT_DDHT_HK2 = $statusHSKT_DDHT,
                //     qlhs_thcd_trangthai_HSDTTS_HK2 = $statusHSDTTS,
                //     qlhs_thcd_trangthai_HTATHS_HK2 = $statusHTATHS,
                //     qlhs_thcd_trangthai_HBHSDTNT_HK2 = $statusHBHSDTNT,
                //     qlhs_thcd_ghichu_CANAM = '$note'
                //     where qlhs_thcd_id = $id");

                $update = DB::table('qlhs_tonghopchedo')->where('qlhs_thcd_id', '=', $chedoId)
                    ->update([
                        'qlhs_thcd_trangthai' => $trangthai_1, 
                        'qlhs_thcd_trangthai_MGHP' => $statusMGHP, 
                        'qlhs_thcd_trangthai_CPHT' => $statusCPHT,
                        'qlhs_thcd_trangthai_HTAT' => $statusHTAT,
                        'qlhs_thcd_trangthai_HTBT_TA' => $statusHTBT_TA,
                        'qlhs_thcd_trangthai_HTBT_TO' => $statusHTBT_TO,
                        'qlhs_thcd_trangthai_HTBT_VHTT' => $statusHTBT_VHTT,
                        'qlhs_thcd_trangthai_HSKT_HB' => $statusHSKT_HB,
                        'qlhs_thcd_trangthai_HSKT_DDHT' => $statusHSKT_DDHT,
                        'qlhs_thcd_trangthai_HSDTTS' => $statusHSDTTS, 
                        'qlhs_thcd_trangthai_HTATHS' => $statusHTATHS,
                        'qlhs_thcd_trangthai_HBHSDTNT' => $statusHBHSDTNT,

                        'qlhs_thcd_trangthai_HK2' => $trangthai_2, 
                        'qlhs_thcd_trangthai_MGHP_HK2' => $statusMGHP, 
                        'qlhs_thcd_trangthai_CPHT_HK2' => $statusCPHT,
                        'qlhs_thcd_trangthai_HTAT_HK2' => $statusHTAT,
                        'qlhs_thcd_trangthai_HTBT_TA_HK2' => $statusHTBT_TA,
                        'qlhs_thcd_trangthai_HTBT_TO_HK2' => $statusHTBT_TO,
                        'qlhs_thcd_trangthai_HTBT_VHTT_HK2' => $statusHTBT_VHTT,
                        'qlhs_thcd_trangthai_HSKT_HB_HK2' => $statusHSKT_HB,
                        'qlhs_thcd_trangthai_HSKT_DDHT_HK2' => $statusHSKT_DDHT,
                        'qlhs_thcd_trangthai_HSDTTS_HK2' => $statusHSDTTS,
                        'qlhs_thcd_trangthai_HTATHS_HK2' => $statusHTATHS,
                        'qlhs_thcd_trangthai_HBHSDTNT_HK2' => $statusHBHSDTNT
                        ]);
            }

            return $result;
        } catch (Exception $e) {
            return $result['error'] = $e;
        }
    }

    public function revertApprovedTHCD($strData){
        $result = [];
        try {

            $arrData = [];
            $update = 0;

            $arrData = explode("-", $strData);

            $id = $arrData[0];

            if ($arrData[1] == "HK1") {
                $update = DB::update("update qlhs_tonghopchedo set
                    qlhs_thcd_trangthai = 0 
                    where qlhs_thcd_id = $id");
            }

            if ($arrData[1] == "HK2") {
                $update = DB::update("update qlhs_tonghopchedo set
                    qlhs_thcd_trangthai_HK2 = 0 
                    where qlhs_thcd_id = $id");
            }

            if ($arrData[1] == "CA") {
                $update = DB::update("update qlhs_tonghopchedo set
                    qlhs_thcd_trangthai = 0, qlhs_thcd_trangthai_HK2 = 0 
                    where qlhs_thcd_id = $id");
            }

            if ($update > 0) {
                $result['success'] = 'Hủy chọn thành công';
            }
            else {
                $result['error'] = 'Hủy chọn thất bại';
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function getProfileSubjectById($id){
        try {
            $dataResult = [];

            $listData = [];

            $lstData = [];

            $result = [];

            $arrData = [];

            $arrData = explode("-", $id);

            if ($arrData[3] > 0) {
                $listData = DB::table('qlhs_subject')
                    ->leftJoin('qlhs_profile_subject', 'profile_subject_subject_id','subject_id')
                    ->leftJoin('qlhs_subject_history', 'subject_history_subject_id','subject_id')
                    ->leftJoin('qlhs_group', 'group_id','subject_history_group_id')
                    ->where('profile_subject_profile_id',$arrData[0])
                    ->where('qlhs_profile_subject.start_year', '<=',$arrData[3])
                    ->where('qlhs_profile_subject.active',1)
                    ->where(function($q) use($arrData){
                        $q->orWhere('qlhs_profile_subject.end_year','>',$arrData[3])
                        ->orWhere('qlhs_profile_subject.end_year',null);
                    })
                    ->groupBy('subject_history_group_id','group_name')
                    ->select('subject_history_group_id', 
                        'group_name', 
                        DB::raw('MAX(subject_id) subject_id'),
                        DB::raw("GROUP_CONCAT(subject_name SEPARATOR ',') as subject_name")
                        )
                    ->get();

            }
            else {
                
            }
            // Kiểm tra khối lớp
            $khoilop = LichSuHSHocSinh::leftJoin('history_profile_site',function($q){
                $q->on('p_id','history_profile_id')
                ->where('history_profile_site.start_date','<=','P_His_startdate')
                ->where(function($p){
                    $p->orWhere('history_profile_site.end_date','>=','p_His_enddate')
                    ->orWhere('history_profile_site.end_date',null);
                });
            })
            ->where('history_profile_id',$arrData[0])
            ->where('history_school_id',Auth::user()->truong_id)
            ->where('history_year',$arrData[3].'-'.($arrData[3]+1))
            ->select('unit_class','site_quanhuyen','history_statute_57')
            ->first();
            $qlhs_schools = DB::table('qlhs_schools')
            ->leftJoin('qlhs_schools_history','schools_id','type_his_school_id')
            ->where('schools_active',1)
            ->where('type_his_startdate','<=',DB::raw('NOW()'))
            ->where(function($q){
                    $q->orWhere('type_his_enddate','>=',DB::raw('NOW()'))
                    ->orWhere('type_his_enddate',null);
            })
            ->where('type_his_school_id',Auth::user()->truong_id)
            ->select('qlhs_schools.schools_id','qlhs_schools.schools_name','qlhs_schools.schools_unit_id','qlhs_schools_history.type_his_type_id')
            ->first();
            //Miễn 100%
            $tantat = 0;
            $hocanngheo = 0;
            //Giảm 70%
            $vungkhokhan = 0;
            $dantocthieuso = 0;
            //HTBT
            $hsbantru = 0;
            $ongoaitruong = 0;
            $hocky = $arrData[2];
            $dataCheDo = null;
            // Hoc ky 1 va ky 2
            if (($arrData[1] != 3) && count($arrData) > 3) {
                $dataCheDo = TongHopCheDo_Truong::where('thcd_nhucau_profile_id', $arrData[0])
                ->where('thcd_nhucau_nam',$arrData[3])
                ->where('thcd_nhucau_school_id',Auth::user()->truong_id)
                ->select(
                    'thcd_nhucau_MGHP_'.$hocky.' as nhucauMGHP',
                    'thcd_nhucau_trangthai_MGHP_'.$hocky.' as MGHP',
                    'thcd_nhucau_CPHT_'.$hocky.' as nhucauCPHT',
                    'thcd_nhucau_trangthai_CPHT_'.$hocky.' as CPHT',
                    'thcd_nhucau_HTAT_'.$hocky.' as nhucauHTAT',
                    'thcd_nhucau_trangthai_HTAT_'.$hocky.' as HTAT',
                    'thcd_nhucau_HTBT_TA_'.$hocky.' as nhucauHTBTTA',
                    'thcd_nhucau_trangthai_HTBT_TA_'.$hocky.' as HTBT_TA',
                    'thcd_nhucau_HTBT_TO_'.$hocky.' as nhucauHSBTTO',
                    'thcd_nhucau_trangthai_HTBT_TO_'.$hocky.' as HTBT_T0',
                    'thcd_nhucau_HTBT_VHTT_'.$hocky.' as nhucauVHTT',
                    'thcd_nhucau_trangthai_HTBT_VHTT_'.$hocky.' as HTBT_VHTT',
                    'thcd_nhucau_HSKT_HB_'.$hocky.' as nhucauKTHB',
                    'thcd_nhucau_trangthai_HSKT_HB_'.$hocky.' as HSKT_HB',
                    'thcd_nhucau_HSKT_DDHT_'.$hocky.' as nhucauDDHT',
                    'thcd_nhucau_trangthai_HSKT_DDHT_'.$hocky.' as HSKT_DDHT',
                    'thcd_nhucau_HSDTTS_'.$hocky.' as nhucauDTTS',
                    'thcd_nhucau_trangthai_HSDTTS_'.$hocky.' as HSDTTS',
                    'thcd_nhucau_HTATHS_'.$hocky.' as nhucauATHS',
                    'thcd_nhucau_trangthai_HTATHS_'.$hocky.' as HTATHS',
                    'thcd_nhucau_HBHSDTNT_'.$hocky.' as nhucauDTNT',
                    'thcd_nhucau_trangthai_HBHSDTNT_'.$hocky.' as HBHSDTNT',
                    'thcd_nhucau_trangthai_'.$hocky.' as TRANGTHAI',
                    'qlhs_thcd_ghichu_'.$hocky.' as GHICHU')
                ->first();
            }
            //return $listData;
                foreach ($listData as $value) {
                    $data = [];
                    if (($value->subject_history_group_id == 89 || $value->subject_history_group_id == 90 || $value->subject_history_group_id == 91) && $khoilop->unit_class != 2 && $dataCheDo->nhucauMGHP > 0 ) {
                        //Cấp bù
                        $data['subject_history_group_id'] = $value->subject_history_group_id;
                        $data['group_name'] = "Cấp bù học phí";
                        $data['subject_name'] = $value->subject_name . '. ';
                        $data['status'] = $dataCheDo->MGHP;
                    }else if ($value->subject_history_group_id == 92 && $dataCheDo->nhucauCPHT > 0){
                        // Chi phí học tập
                        $data['subject_history_group_id'] = $value->subject_history_group_id;
                        $data['group_name'] = $value->group_name;
                        $data['subject_name'] = $value->subject_name;
                        $data['status'] = $dataCheDo->CPHT;
                    }else if ($value->subject_history_group_id == 93 && $khoilop->unit_class == 1 && $dataCheDo->nhucauHTAT > 0){
                        // Hỗ trợ ăn trưa mẫu giáo
                        $data['subject_history_group_id'] = $value->subject_history_group_id;
                        $data['group_name'] = $value->group_name;
                        $data['subject_name'] = $value->subject_name;
                        $data['status'] = $dataCheDo->HTAT;
                    }else if ((($value->subject_history_group_id == 94 && $dataCheDo->nhucauHTBTTA > 0) || ($value->subject_history_group_id == 98 && $dataCheDo->nhucauHSBTTO > 0)) && $khoilop->unit_class != 1 ){
                        // Học sinh bán trú tiền ăn ở
                        $data['subject_history_group_id'] = $value->subject_history_group_id;
                        $data['group_name'] = $value->group_name;
                        $data['subject_name'] = $value->subject_name;
                        if($value->subject_history_group_id == 94){
                            $data['status'] = $dataCheDo->HTBT_TA;
                        }else{
                            $data['status'] = $dataCheDo->HTBT_T0;
                        }
                        
                    }else if ($value->subject_history_group_id == 115 && $qlhs_schools->type_his_type_id == 2 && $dataCheDo->nhucauVHTT > 0){
                        // Học sinh bán trú vhtt
                        $data['subject_history_group_id'] = $value->subject_history_group_id;
                        $data['group_name'] = $value->group_name;
                        $data['subject_name'] = $value->subject_name;
                        $data['status'] = $dataCheDo->HTBT_VHTT;
                    }else if (($value->subject_history_group_id == 95 && $dataCheDo->nhucauKTHB > 0) || ($value->subject_history_group_id == 100 && $dataCheDo->nhucauDDHT > 0) ){
                        // học sinh khuyết tật
                        $data['subject_history_group_id'] = $value->subject_history_group_id;
                        $data['group_name'] = $value->group_name;
                        $data['subject_name'] = $value->subject_name;
                        if($value->subject_history_group_id == 95){
                            $data['status'] = $dataCheDo->HSKT_HB;
                        }else{
                            $data['status'] = $dataCheDo->HSKT_DDHT;
                        }
                        
                    }else if ($value->subject_history_group_id == 119 && $qlhs_schools->type_his_type_id == 4 && $dataCheDo->nhucauDTNT > 0){
                        // học sinh dân tộc nội trú
                        $data['subject_history_group_id'] = $value->subject_history_group_id;
                        $data['group_name'] = $value->group_name;
                        $data['subject_name'] = $value->subject_name;
                        $data['status'] = $dataCheDo->HBHSDTNT;
                    }
                    else if ($value->subject_history_group_id == 119 && $khoilop->unit_class == 33 && ($khoilop->site_quanhuyen == 100 || $khoilop->site_quanhuyen == 101 && $dataCheDo->nhucauDTTS > 0) ){
                        // học sinh mù căng chải trạm tấu
                        $data['subject_history_group_id'] = $value->subject_history_group_id;
                        $data['group_name'] = $value->group_name;
                        $data['subject_name'] = $value->subject_name;
                        $data['status'] = $dataCheDo->HSDTTS;
                    }else if ($value->subject_history_group_id == 118 && $qlhs_schools->type_his_type_id == 2 && $khoilop->history_statute_57 > 0 && $dataCheDo->nhucauATHS > 0){
                        // học sinh che do 57
                        $data['subject_history_group_id'] = $value->subject_history_group_id;
                        $data['group_name'] = $value->group_name;
                        $data['subject_name'] = $value->subject_name;
                        $data['status'] = $dataCheDo->HTATHS;
                    }
                    if (!is_null($data) && !empty($data) && count($data) > 0) {
                        array_push($result, $data);
                    }
                }

            $dataResult['SUBJECT'] = $result;
            $dataResult['GHICHU'] = $dataCheDo->GHICHU;
            //}
            //$hocky = $arrData[2];
            // Hoc ky 1 va ky 2
            // if ($arrData[1] != 0 && ($arrData[1] == 1 || $arrData[1] == 2) && count($arrData) > 3) {
            //     $dataResult['CHEDO'] = TongHopCheDo_Truong::where('thcd_nhucau_profile_id', $arrData[0])
            //     ->where('thcd_nhucau_nam',$arrData[3])
            //     ->where('thcd_nhucau_school_id',Auth::user()->truong_id)
            //     ->select(
            //         DB::raw('CASE WHEN thcd_nhucau_MGHP_'.$hocky.' > 0 THEN 
            //         thcd_nhucau_trangthai_MGHP_'.$hocky.' ELSE 2 END MGHP'), 
            //         DB::raw('CASE WHEN thcd_nhucau_CPHT_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_CPHT_'.$hocky.' ELSE 2 END CPHT'), 
            //         DB::raw('CASE WHEN thcd_nhucau_HTAT_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_HTAT_'.$hocky.' ELSE 2 END HTAT'),
            //         DB::raw('CASE WHEN thcd_nhucau_HTBT_TA_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_HTBT_TA_'.$hocky.' ELSE 2 END HTBT_TA'),
            //         DB::raw('CASE WHEN thcd_nhucau_HTBT_TO_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_HTBT_TO_'.$hocky.' ELSE 2 END HTBT_TO'),
            //         DB::raw('CASE WHEN thcd_nhucau_HTBT_VHTT_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_HTBT_VHTT_'.$hocky.' ELSE 2 END HTBT_VHTT'),
            //         DB::raw('CASE WHEN thcd_nhucau_HSKT_HB_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_HSKT_HB_'.$hocky.' ELSE 2 END HSKT_HB'),
            //         DB::raw('CASE WHEN thcd_nhucau_HSKT_DDHT_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_HSKT_DDHT_'.$hocky.' ELSE 2 END HSKT_DDHT'),
            //         DB::raw('CASE WHEN thcd_nhucau_HSDTTS_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_HSDTTS_'.$hocky.' ELSE 2 END HSDTTS'),
            //         DB::raw('CASE WHEN thcd_nhucau_HTATHS_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_HTATHS_'.$hocky.' ELSE 2 END HTATHS'),
            //         DB::raw('CASE WHEN thcd_nhucau_HBHSDTNT_'.$hocky.' > 0 THEN thcd_nhucau_trangthai_HBHSDTNT_'.$hocky.' ELSE 2 END HBHSDTNT'),
            //         'thcd_nhucau_trangthai_'.$hocky.' as TRANGTHAI',
            //         'qlhs_thcd_ghichu_'.$hocky.' as GHICHU')
            //     ->get();
            // }
            // else if ($arrData[1] != 0 && $arrData[1] == 3 && count($arrData) > 3) {
            //     $dataResult['CHEDO'] = TongHopCheDo_Truong::where('thcd_nhucau_profile_id', $arrData[0])
            //     ->where('thcd_nhucau_nam',$arrData[3])
            //     ->where('thcd_nhucau_school_id',Auth::user()->truong_id)
            //     ->select('thcd_nhucau_trangthai_MGHP_'.$hocky.' as MGHP', 
            //         'thcd_nhucau_trangthai_CPHT_'.$hocky.' as CPHT', 
            //         'thcd_nhucau_trangthai_HTAT_'.$hocky.' as HTAT',
            //         'thcd_nhucau_trangthai_HTBT_TA_'.$hocky.' as HTBT_TA',
            //         'thcd_nhucau_trangthai_HTBT_TO_'.$hocky.' as HTBT_TO',
            //         'thcd_nhucau_trangthai_HTBT_VHTT_'.$hocky.' as HTBT_VHTT',
            //         'thcd_nhucau_trangthai_HSKT_HB_'.$hocky.' as HSKT_HB',
            //         'thcd_nhucau_trangthai_HSKT_DDHT_'.$hocky.' as HSKT_DDHT',
            //         'thcd_nhucau_trangthai_HSDTTS_'.$hocky.' as HSDTTS',
            //         'thcd_nhucau_trangthai_HTATHS_'.$hocky.' as HTATHS',
            //         'thcd_nhucau_trangthai_HBHSDTNT_'.$hocky.' as HBHSDTNT',
            //         'thcd_nhucau_trangthai_'.$hocky.' as TRANGTHAI',
            //         'qlhs_thcd_ghichu_'.$hocky.' as GHICHU')
            //     ->get();
            
            // }

            return $dataResult;
        } catch (Exception $e) {
            return $e;
        }       
    }
// use
    public function getProfileSubjectByIdPhongSo($objJson){
        try {
            $dataResult = [];

            $listData = [];

            $lstData = [];

            $result = [];

            $obj = json_decode($objJson);

            $user = Auth::user()->id;
            $levelUser = Auth::user()->level;
            $profile_id = $obj->{'PROFILEID'};
            $socongvan = $obj->{'SOCONGVAN'};
            $capnhan = DB::table('qlhs_hosobaocao')
            ->where('report_name',$socongvan)
            ->select('report_cap_nhan','report_cap_gui','report_cap_status')->first();

            $levelUser = $capnhan != null ? $capnhan->report_cap_nhan : Auth::user()->level;
            

            $dataResult['LEVELUSER'] = $levelUser;

            $dataResult['APPROVED'] = $capnhan->report_cap_status;
            $getData = null;
            if($levelUser == 1 && $capnhan->report_cap_status == 2 && $capnhan->report_cap_gui == 2){// Phòng giáo dục trả lại trường
                $getData = DB::table('qlhs_tralaikinhphi_PGD');
            }else if(($levelUser == 1 || $levelUser == 2) 
                && $capnhan->report_cap_status == 2 && $capnhan->report_cap_gui == 3){// phòng tài chính trả lại trường hoặc phòng
                $getData = DB::table('qlhs_tralaikinhphi_PTC');
            }else if($levelUser == 3 && $capnhan->report_cap_status == 2 && $capnhan->report_cap_gui == 4){// Phòng tài chính trả lại phòng tc
                $getData = DB::table('qlhs_tralaikinhphi_SGD');
            }else if($levelUser == 2 
            && ($capnhan->report_cap_status == 0 || $capnhan->report_cap_status == 1 || $capnhan->report_cap_status == 4)
            && $capnhan->report_cap_gui == 1){// Trường gửi phòng GD hoặc xin thu hồi
                $getData = DB::table('qlhs_baocaokinhphi_PGD');
            }else if($levelUser == 3 
            && ($capnhan->report_cap_status == 0 || $capnhan->report_cap_status == 1 || $capnhan->report_cap_status == 4)
            && ($capnhan->report_cap_gui == 1 || $capnhan->report_cap_gui == 2)){// Trường hoặc PGD gửi phòng TC hoặc xin thu hồi
                $getData = DB::table('qlhs_baocaokinhphi_PTC');
            }else if($levelUser == 4 
            && ($capnhan->report_cap_status == 0 || $capnhan->report_cap_status == 1 || $capnhan->report_cap_status == 4)
            && ($capnhan->report_cap_gui == 3)){// Trường hoặc PGD gửi phòng TC hoặc xin thu hồi
                $getData = DB::table('qlhs_baocaokinhphi_SGD');
            }

            $dataResult['SUBJECT'] = $getData->where('bckp_profile_id', $profile_id)
                        ->where('bckp_name', $socongvan)
                        ->select(
                            'bckp_trangthai_mghp as STATUS_MGHP', 
                            'bckp_trangthai_cpht as STATUS_CPHT', 
                            'bckp_trangthai_htat as STATUS_HTAT', 
                            'bckp_trangthai_htbt_ta as STATUS_HTBT_TA', 
                            'bckp_trangthai_htbt_to as STATUS_HTBT_TO', 
                            'bckp_trangthai_htbt_vhtt as STATUS_HTBT_VHTT', 
                            'bckp_trangthai_htkt_hb as STATUS_HSKT_HB', 
                            'bckp_trangthai_htkt_ddht as STATUS_HSKT_DDHT', 
                            'bckp_trangthai_hsdtts as STATUS_HSDTTS', 
                            'bckp_trangthai_htaths as STATUS_HTATHS', 
                            'bckp_trangthai_hbhsdtnt as STATUS_HBHSDTNT',
                            'bckp_danhsach_chedo',
                            'bckp_ghichu','bckp_traloi',
                            'bckp_active_mghp as MGHP',
                            'bckp_active_cpht as CPHT',
                            'bckp_active_htat as HTAT',
                            'bckp_active_htbt_to as HTBT_TO',
                            'bckp_active_htbt_ta as HTBT_TA',
                            'bckp_active_htbt_vhtt as HTBT_VHTT',
                            'bckp_active_htkt_hb as HTKT_HB',
                            'bckp_active_htkt_ddht as HTKT_DDHT',
                            'bckp_active_hsdtts as HSDTTS',
                            'bckp_active_htaths as HTATHS',
                            'bckp_active_hbhsdtnt as HBHSDTNT'
                        )
                        ->get();
            return $dataResult;
        } catch (Exception $e) {
            return $e;
        }       
    }

//-----------------------------------------------------------Lập danh sách----------------------------------------------------------------------------
    public function lapdanhsachTHCD(Request $request){
        try {
            // $files =  $request->file('FILE');
            $school_id = $request->input('SCHOOLID');
            $year = $request->input('YEAR');
            $user_sign = '';//$request->input('SIGNNAME');
            $user_create = '';//$request->input('CREATENAME');
            $note = $request->input('NOTE');
            $status = 0;//$request->input('STATUS');
            $chedo = $request->input('ARRCHEDO');
            $khoi = $request->input('UNITNAME');
            $capnhan = $request->input('CAPNHAN');

            $current_user_id = Auth::user()->id;
            $current_date = Carbon::now();

            $arrYear = [];
            $arrYear = explode("-", $year);

            $strYear = $arrYear[1];

            $message = [];

            $arrChedo = explode(",", $chedo);
            // return $arrChedo;
            $number = 0;

            $auto_Reportname = $current_date->format('dmY').'.'.$school_id;
            $getReportNum = DB::table('qlhs_report')
                ->where('report_name', '=', $auto_Reportname)
                ->where('report_school_id', '=', $school_id)
                ->select(DB::raw('MAX(number) as number'))->get();

            foreach ($getReportNum as $value) {
                if (!is_null($value->number) && !empty($value->number) && $value->number > 0) {
                    $number = $value->number + 1;
                }
                else {
                    $number = 1;
                }
            }
            $report_name = $auto_Reportname.'.'.$number;

            $getSchoolType = DB::table('qlhs_schools_history')
                ->where('type_his_school_id',$school_id)
                ->where('type_his_startdate','<=',$strYear.'-09-05')
                ->where(function($q) use($strYear){
                    $q->orWhere('type_his_enddate','>=',$strYear.'-09-05')
                    ->orWhere('type_his_enddate',null);
                })
                ->select('type_his_type_id')->first();

            $chedoMGHP = 0;
            $chedoCPHT = 0;
            $chedoHTAT = 0;
            $chedoHTBT = 0;
            $chedoHSKT = 0;
            $chedoHSDTTS = 0;
            $chedoHTATHS = 0;
            $chedoHBHSDTNT = 0;
            $chedoNGNA = 0;

            foreach ($arrChedo as $value) {
                    if ($value == 1){
                        $chedoMGHP = 1;
                    }
                    if ($value == 2){
                        $chedoCPHT = 1;
                    }
                    if ($value == 3){
                        $chedoHTAT = 1;
                    }
                    if ($value == 4){
                        $chedoHTBT = 1;
                    }
                    if ($value == 5){
                        $chedoHSKT = 1;
                    }
                    if ($value == 6){
                        $chedoHTATHS = 1;
                    }
                    if ($value == 7){
                        $chedoHSDTTS = 1;
                    }
                    if ($value == 8){
                        $chedoHBHSDTNT = 1;
                    }
                    if ($value == 9){
                        $chedoNGNA = 1;
                    }
            }
            
            if ($chedoMGHP > 0 && $khoi != 2) {
                $this->miengiamhocphi($school_id, $strYear, $note, $report_name, $user_sign, $user_create, $status, $capnhan);
            }
                    
            if ($chedoHTAT > 0 && $khoi == 1) {
                $this->hoTroAnTruaTreEm($school_id, $strYear, $note, $report_name, $user_sign, $user_create, $status, $capnhan);
            }
                    
            if ($chedoHSDTTS > 0 && $khoi == 33) {
                $this->getDataHSDTTS($school_id, $strYear, $report_name, $user_sign, $user_create, $note, $status, $capnhan);
            }

            if ($chedoCPHT > 0) {
                $this->chiphihoctap($school_id, $strYear, $note, $report_name, $user_sign, $user_create, $status, $capnhan);
            }
            if ($chedoHTBT > 0 && $getSchoolType->type_his_type_id != 4) {
                $this->getDataHTBT($school_id, $strYear, $report_name, $user_sign, $user_create, $note, $status, $capnhan);
            }
            if ($chedoHSKT > 0) {
                $this->getDataHSKT($school_id, $strYear, $report_name, $user_sign, $user_create, $note, $status, $capnhan);
            }
            if ($chedoHTATHS > 0 && $getSchoolType->type_his_type_id == 2) {
                $this->getDataHTATHS($school_id, $strYear, $report_name, $user_sign, $user_create, $note, $status, $capnhan);
            }
            if ($chedoHBHSDTNT > 0 && $getSchoolType->type_his_type_id == 4) {
                $this->getDataHBHSDTNT($school_id, $strYear, $report_name, $user_sign, $user_create, $note, $status, $capnhan);
            }
            if ($chedoNGNA > 0) {
                $this->getDataNGNA($school_id, $strYear, $report_name, $user_sign, $user_create, $note, $status, $capnhan);
            }

            $datas = DB::table('qlhs_profile')
                ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$report_name.'")'))
                ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$report_name.'")'))
                ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$report_name.'")'))
                ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$report_name.'")'))
                ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$report_name.'")'))
                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$report_name.'")'))
                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$report_name.'")'))
                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$report_name.'")'))
                ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            if($school_id == 0 || $school_id == null){
               $datas = $datas->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                OR htaths.nhucau > 0 OR htaths.dutoan > 0
                OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
            }else{
                $datas = $datas->where('profile_school_id', '=', DB::raw($school_id.' 
                AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                OR htaths.nhucau > 0 OR htaths.dutoan > 0
                OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
            }
                
            $datas = $datas->select('qlhs_profile.profile_id')->get();
            
            //----------------------------------Update using Profile and Insert subject-------------------------------------------------
            if (!is_null($datas) && !empty($datas) && count($datas) > 0) {
                if ($capnhan == 3) {
                    $insertReport = DB::table('qlhs_report')
                    ->insert([
                        'report_name' => $auto_Reportname,
                        'report_school_id' => $school_id,
                        'report_waiting' => 0,
                        'report_approved' => $datas->count(),
                        'report_reverted' => 0,
                        'report_startdate' => $current_date,
                        'name' => $report_name,
                        'number' => $number,
                        'report_name_phongGD' => '',
                        'report_regain_phongGD' => 0,
                        'report_approved_phongGD' => 0,
                        'report_reverted_phongGD' => 0,
                        'report_name_phongTC' => '',
                        'report_regain_phongTC' => 0,
                        'report_approved_phongTC' => 0,
                        'report_reverted_phongTC' => 0,
                        'report_name_So' => '',
                        'report_approved_So' => 0,
                        'report_reverted_So' => 0
                        ]);
                }
                else {
                    $insertReport = DB::table('qlhs_report')->insert([
                        'report_name' => $auto_Reportname,
                        'report_school_id' => $school_id,
                        'report_waiting' => 0,
                        'report_approved' => $datas->count(),
                        'report_reverted' => 0,
                        'report_startdate' => $current_date,
                        'name' => $report_name,
                        'number' => $number,
                        'report_status' => 0,
                        'report_waiting_phongGD' => $datas->count(),
                        'report_approved_phongGD' => 0,
                        'report_reverted_phongGD' => 0,
                        'report_waiting_phongTC' => 0,
                        'report_approved_phongTC' => 0,
                        'report_reverted_phongTC' => 0,
                        'report_waiting_So' => 0,
                        'report_approved_So' => 0,
                        'report_reverted_So' => 0,
                        'report_reload_phongGD' => 0,
                        'report_reload_phongTC' => 0
                        ]);
                }

                foreach ($datas as $values) {

                    $result = [];

                    $lstData = [];

                    DB::table('qlhs_profile')->where('profile_id', '=', $values->profile_id)->update(['using' => 1]);

                    //------------------------------------------Insert His Subject---------------------------------------------------
                    $listData = DB::table('qlhs_subject')
                        ->leftJoin('qlhs_profile_subject', 'profile_subject_subject_id', '=', 'subject_id')
                        ->leftJoin('qlhs_subject_history', 'subject_history_subject_id', '=', 'subject_id')
                        ->leftJoin('qlhs_group', 'group_id', '=', 'subject_history_group_id')
                        ->where('profile_subject_profile_id', '=', $values->profile_id)
                        ->where('qlhs_profile_subject.start_year', '<=', DB::raw($strYear.' AND qlhs_profile_subject.active = 1 AND (qlhs_profile_subject.end_year > '.$strYear.' OR qlhs_profile_subject.end_year is null)'))
                        ->select('subject_history_group_id', 
                            'group_name', 
                            'subject_id', 
                            'subject_name')
                        ->get();

                    //Miễn 100%
                    $tantat = 0;
                    $hocanngheo = 0;
                    //Giảm 70%
                    $vungkhokhan = 0;
                    $dantocthieuso = 0;
                    //HTBT
                    $hsbantru = 0;
                    $ongoaitruong = 0;

                    // return $listData;

                    foreach ($listData as $value) {
                        if ($value->subject_id == 74) {
                            $tantat = 1;
                        }
                        if ($value->subject_id == 41) {
                            $hocanngheo = 1;
                        }
                        if ($value->subject_id == 34) {
                            $vungkhokhan = 1;
                        }
                        if ($value->subject_id == 49) {
                            $dantocthieuso = 1;
                        }
                        if ($value->subject_id == 46) {
                            $hsbantru = 1;
                        }
                        if ($value->subject_id == 72) {
                            $ongoaitruong = 1;
                        }
                        array_push($lstData, $value);
                    }
                    
                    if ($tantat > 0 && $hocanngheo > 0) {
                        $getSubMien100 = DB::table('qlhs_subject')
                            ->whereIn('subject_id', [41, 74])
                            ->select(
                                'subject_name')
                            ->get();

                        $getGroupMien100 = DB::table('qlhs_group')
                            ->where('group_id', '=', 89)
                            ->select(
                                'group_id', 
                                'group_name')
                            ->get();

                        $getGroupHTATMG = DB::table('qlhs_group')
                            ->where('group_id', '=', 93)
                            ->select(
                                'group_id', 
                                'group_name')
                            ->get();
                        

                        $data = [];
                        $dataHTATMG = [];
                        $subName = '';
                        $subNameHTATMG = '';

                        foreach ($lstData as $value) {
                            if ($value->subject_history_group_id == 89 || $value->subject_history_group_id == 90 || $value->subject_history_group_id == 91) {
                                $data['subject_history_group_id'] = $value->subject_history_group_id;
                                $data['group_name'] = "Cấp bù học phí";
                                $data['subject_name'] = $getSubMien100[0]->{'subject_name'} . ' + ' . $getSubMien100[1]->{'subject_name'} . '. ';
                                if ($value->subject_name != $subName) {
                                    $data['subject_name'] .= $value->subject_name . '. ';
                                }
                                $subName = $value->subject_name;
                            }
                            else if ($value->subject_history_group_id != 93) {
                                $dt['subject_history_group_id'] = $value->subject_history_group_id;
                                $dt['group_name'] = $value->group_name;
                                $dt['subject_name'] = $value->subject_name;

                                array_push($result, $dt);
                            }
                            else if ($value->subject_history_group_id == 93) {
                                $dataHTATMG['subject_history_group_id'] = $value->subject_history_group_id;
                                $dataHTATMG['group_name'] = $value->group_name;
                                $dataHTATMG['subject_name'] = $getSubMien100[0]->{'subject_name'} . ' + ' . $getSubMien100[1]->{'subject_name'} . '. ';

                                if ($value->subject_name != $subNameHTATMG) {
                                    $dataHTATMG['subject_name'] .= $value->subject_name . '. ';
                                }
                                $subNameHTATMG = $value->subject_name;
                            }
                        }

                        if (!is_null($data) && !empty($data) && count($data) > 0) {
                            
                            array_push($result, $data);
                        }
                        else {
                            $data['subject_history_group_id'] = 89;
                            $data['group_name'] = "Cấp bù học phí";
                            $data['subject_name'] = $getSubMien100[0]->{'subject_name'} . ' + ' . $getSubMien100[1]->{'subject_name'} . '. ';
                            array_push($result, $data);
                        }

                        if (!is_null($dataHTATMG) && !empty($dataHTATMG) && count($dataHTATMG) > 0) {
                            
                            array_push($result, $dataHTATMG);
                        }
                        else {
                            //Ăn trưa mẫu giáo
                            $dt['subject_history_group_id'] = $getGroupHTATMG[0]->{'group_id'};
                            $dt['group_name'] = $getGroupHTATMG[0]->{'group_name'};
                            $dt['subject_name'] = $getSubMien100[0]->{'subject_name'} . ' + ' . $getSubMien100[1]->{'subject_name'} . '. ';

                            array_push($result, $dt);
                        }
                    }

                    if ($vungkhokhan > 0 && $dantocthieuso > 0) {
                        $getSubGiam70 = DB::table('qlhs_subject')
                            ->whereIn('subject_id', [34, 49])
                            ->select(
                                'subject_name')
                            ->get();

                        $getGroupGiam70 = DB::table('qlhs_group')
                            ->where('group_id', '=', 90)
                            ->select(
                                'group_id', 
                                'group_name')
                            ->get();

                        $data = [];

                        foreach ($lstData as $value) {
                            if ($value->subject_history_group_id == 89 || $value->subject_history_group_id == 90 || $value->subject_history_group_id == 91) {
                                $data['subject_history_group_id'] = $value->subject_history_group_id;
                                $data['group_name'] = "Cấp bù học phí";
                                $data['subject_name'] = $value->subject_name . '. ' . $getSubGiam70[0]->{'subject_name'} . ' + ' . $getSubGiam70[1]->{'subject_name'} . '. ';
                            }
                            else {
                                $dt['subject_history_group_id'] = $value->subject_history_group_id;
                                $dt['group_name'] = $value->group_name;
                                $dt['subject_name'] = $value->subject_name;

                                array_push($result, $dt);
                            }
                        }
                        
                        if (!is_null($data) && !empty($data) && count($data) > 0) {
                            array_push($result, $data);
                        }
                        else {
                            $data['subject_history_group_id'] = 90;
                            $data['group_name'] = "Cấp bù học phí";
                            $data['subject_name'] = $getSubGiam70[0]->{'subject_name'} . ' + ' . $getSubGiam70[1]->{'subject_name'} . '. ';
                            array_push($result, $data);
                        }
                    }


                    if (is_null($result) || empty($result) || count($result) <= 0) {
                        $data = [];

                        foreach ($lstData as $value) {
                            if ($value->subject_history_group_id == 89 || $value->subject_history_group_id == 90 || $value->subject_history_group_id == 91) {
                                $data['subject_history_group_id'] = $value->subject_history_group_id;
                                $data['group_name'] = "Cấp bù học phí";
                                $data['subject_name'] = $value->subject_name . '. ';
                            }
                            else if ($value->subject_history_group_id == 93) {
                                $dt['subject_history_group_id'] = $value->subject_history_group_id;
                                $dt['group_name'] = $value->group_name;
                                $dt['subject_name'] = $value->subject_name;

                                array_push($result, $dt);
                            }
                            else {
                                $dt['subject_history_group_id'] = $value->subject_history_group_id;
                                $dt['group_name'] = $value->group_name;
                                $dt['subject_name'] = $value->subject_name;

                                array_push($result, $dt);
                            }
                        }
                        
                        if (!is_null($data) && !empty($data) && count($data) > 0) {
                            array_push($result, $data);
                        }
                    }
                    
                    if (!is_null($result) && !empty($result) && count($result) > 0) {
                        $group_sub_name = '';
                        $group_name = '';
                        $subject_name = '';
                        foreach ($result as $value) {
                            if ($value['subject_history_group_id'] == 89 || $value['subject_history_group_id'] == 90 || $value['subject_history_group_id'] == 91) {
                                if ($khoi != 2) {
                                    $group_sub_name .= $value['group_name'] . '-' . $value['subject_name'] . ',';
                                    $group_name .= $value['group_name'] . ',';
                                    $subject_name .= $value['subject_name'] . ',';
                                }
                            }
                            else if ($value['subject_history_group_id'] == 93) {
                                if ($khoi == 1) {
                                    $group_sub_name .= $value['group_name'] . '-' . $value['subject_name'] . ',';
                                    $group_name .= $value['group_name'] . ',';
                                    $subject_name .= $value['subject_name'] . ',';
                                }
                            }
                            else {
                                $group_sub_name .= $value['group_name'] . '-' . $value['subject_name'] . ',';
                                $group_name .= $value['group_name'] . ',';
                                $subject_name .= $value['subject_name'] . ',';
                            }
                        }

                        DB::table('qlhs_subject_danhsach')->insert([
                            'subject_ds_profile_id' => $values->profile_id,
                            'subject_ds_socongvan' => $report_name,
                            'subject_ds_group_sub_name' => $group_sub_name,
                            'subject_ds_group_name' => $group_name,
                            'subject_ds_subject_name' => $subject_name,
                            'subject_ds_create_id' => $current_user_id,
                            'subject_ds_create_date' => $current_date
                            ]);
                    }
                }
                $message['success'] = "Lập danh sách thành công";
            }
            else {
                $message['error'] = "Danh sách học sinh trống";
            }
            //-----------------------------------------------------End---------------------------------------------------------

            if ($number > 0) {
                try{
                    $mess = new qlhs_message();    
                    $mess->type = 0;
                    $mess->message_text = "Công văn mới số : ".$report_name;
                    $mess->school_id = $school_id;
                    $mess->created_user = Auth::user()->id;
                    $mess->report_name = $report_name;
                    $mess->save();
                    
                }catch(Exception $e){
                    $mess = new qlhs_message();    
                    $mess->type = 0;
                    $mess->message_text = "Công văn mới số : ".$report_name;
                    $mess->school_id = $school_id;
                    $mess->created_user = Auth::user()->id;
                    $mess->report_name = $report_name;
                    $mess->save();
                    $message['success'] = "Lập danh sách thành công";
                }
            }
            else {
                
            }

            return $message;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportExcelTruongDeNghi($jsonData){
        try {
            $obj = json_decode($jsonData);
            $reportName = $obj->{'REPORTNAME'};
            $reportType = $obj->{'REPORTTYPE'};
            
            $getReport = DB::table('qlhs_hosobaocao')
                ->where('report_name', '=', $reportName)
                ->where('report', '=', $reportType)
                ->select('report_id', 'report_type', 'report_year')->first();
              
            if ($reportType == "MGHP") {
                $this->exportforSchoolsMGHP($getReport->report_id, false);
            }
            if ($reportType == "CPHT") {
                $this->exportforSchoolsCPHT($getReport->report_id, false);
            }
            if ($reportType == "HTAT") {
                $this->exportforSchoolsHTAT($getReport->report_id, false);
            }
            if ($reportType == "HTBT") {
                $this->exportforSchoolsHTBT($getReport->report_id, false);
            }
            if ($reportType == "HSKT") {
                $this->exportforSchoolsHSKT($getReport->report_id, false);
            }
            if ($reportType == "HSDTTS") {
                $this->exportforSchoolsHSDTTS($getReport->report_id, false);
            }
            if ($reportType == "HTATHS") {
                $this->exportforSchoolsHTATHS($getReport->report_id, false);
            }
            if ($reportType == "HBHSDTNT") {
                $this->exportforSchoolsHBHSDTNT($getReport->report_id, false);
            }
            if ($reportType == "NGNA") {
                $this->exportforSchoolsNGNA($getReport->report_id, false);
            }
        } catch (Exception $e) {
            return $e;
        }
    }

//---------------------------------------------------------------------MGHP---------------------------------------------------------------------------
    public function miengiamhocphi($truong, $namhoc, $note, $report_name, $report_user_sign, $user_name, $status, $capnhan){
        try {
            $json = [];
        
            $user = Auth::user()->id;
            $now = Carbon::now('Asia/Ho_Chi_Minh');
            
            
            $data1 = DB::table('qlhs_profile')
                ->join('qlhs_profile_subject', 'profile_id', '=' , DB::raw('profile_subject_profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$namhoc.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$namhoc.')'))
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$namhoc.'-'.($namhoc + 1).'"'))

                ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($namhoc - 1)))
                ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$namhoc))
                ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($namhoc + 1)))
                ->select('profile_id','profile_name','profile_year', 'level_old', 'level_cur', 'level_new', 
                    'yearold.qlhs_thcd_trangthai_MGHP as old_MGHP', 'yearold.qlhs_thcd_trangthai_MGHP_HK2 as old_MGHP_HK2', 
                    'yearcur.qlhs_thcd_trangthai_MGHP as cur_MGHP', 'yearcur.qlhs_thcd_trangthai_MGHP_HK2 as cur_MGHP_HK2',
                    'yearnew.qlhs_thcd_trangthai_MGHP as new_MGHP', 'yearnew.qlhs_thcd_trangthai_MGHP_HK2 as new_MGHP_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_MGHP as money_old', 'yearold.qlhs_thcd_tien_nhucau_MGHP_HK2 as money_old_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_MGHP as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_MGHP_HK2 as money_cur_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_MGHP as money_new', 'yearnew.qlhs_thcd_tien_nhucau_MGHP_HK2 as money_new_HK2', 
                    DB::raw('MAX(qlhs_profile_subject.profile_subject_subject_id) as profile_subject_subject_id'), 
                    DB::raw('MAX(CASE when profile_subject_subject_id = 74 then 1 else 0 END) Mien'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 35 then 1 else 0 END) Mien1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 36 then 1 else 0 END) Mien2'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 38 then 1 else 0 END) Mien3'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 73 then 1 else 0 END) Mien4'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 39 then 1 else 0 END) Mien5'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 28 then 1 else 0 END) Mien6'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 34 then 1 else 0 END) Giam70'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 49 then 1 else 0 END) Giam70_1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 40 then 1 else 0 END) Giam501'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 41 then 1 else 0 END) Giam502'),

                    DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-06-01' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".$namhoc."-01-01')) then 1 else 0 END) 'HKII1'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".$namhoc."-12-31' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".$namhoc."-05-31')) then 1 else 0 END) 'HKI2'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".($namhoc + 1)."-06-01' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-01-01')) then 1 else 0 END) 'HKII2'"),
                    DB::raw("MAX(CASE when level_new <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-12-31' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-05-31')) then 1 else 0 END) 'HKI3'"))

                ->whereIn('profile_subject_subject_id', [28,35,36,73,38,39,34,40,41,74,49])
                ->where('profile_year','<',$namhoc.'-06-01')
                ->where('profile_school_id','=', DB::raw($truong.' AND (yearold.qlhs_thcd_trangthai_MGHP_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_MGHP > 0 OR yearcur.qlhs_thcd_trangthai_MGHP_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_MGHP > 0)'))
                
                ->groupBy('profile_id','profile_name','profile_year','level_old','level_cur','level_new', 
                    'yearold.qlhs_thcd_trangthai_MGHP', 'yearold.qlhs_thcd_trangthai_MGHP_HK2', 
                    'yearcur.qlhs_thcd_trangthai_MGHP', 'yearcur.qlhs_thcd_trangthai_MGHP_HK2',
                    'yearnew.qlhs_thcd_trangthai_MGHP', 'yearnew.qlhs_thcd_trangthai_MGHP_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_MGHP', 'yearold.qlhs_thcd_tien_nhucau_MGHP_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_MGHP', 'yearcur.qlhs_thcd_tien_nhucau_MGHP_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_MGHP', 'yearnew.qlhs_thcd_tien_nhucau_MGHP_HK2');
            $data11 = DB::table(DB::raw("({$data1->toSql()}) as m"))->mergeBindings( $data1 )
                ->select('HKII1','HKI2','HKII2','HKI3','m.Mien','m.Mien1','m.Mien2','m.Mien3','m.Mien4','m.Mien5','m.Mien6','m.Giam70','m.Giam70_1','m.Giam501','m.Giam502','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                    'm.old_MGHP', 'm.old_MGHP_HK2', 'm.cur_MGHP',  'm.cur_MGHP_HK2', 'm.new_MGHP', 'm.new_MGHP_HK2', 
                    'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2');

            $data2 = DB::table('qlhs_profile')
                ->join('qlhs_profile_subject', 'profile_id', '=' , DB::raw('profile_subject_profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$namhoc.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$namhoc.')'))
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$namhoc.'-'.($namhoc + 1).'"'))

                ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($namhoc - 1)))
                ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$namhoc))
                ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($namhoc + 1)))
                ->select('profile_id','profile_name','profile_year', 'level_old', 'level_cur', 'level_new', 
                    'yearold.qlhs_thcd_trangthai_MGHP as old_MGHP', 'yearold.qlhs_thcd_trangthai_MGHP_HK2 as old_MGHP_HK2', 
                    'yearcur.qlhs_thcd_trangthai_MGHP as cur_MGHP', 'yearcur.qlhs_thcd_trangthai_MGHP_HK2 as cur_MGHP_HK2',
                    'yearnew.qlhs_thcd_trangthai_MGHP as new_MGHP', 'yearnew.qlhs_thcd_trangthai_MGHP_HK2 as new_MGHP_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_MGHP as money_old', 'yearold.qlhs_thcd_tien_nhucau_MGHP_HK2 as money_old_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_MGHP as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_MGHP_HK2 as money_cur_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_MGHP as money_new', 'yearnew.qlhs_thcd_tien_nhucau_MGHP_HK2 as money_new_HK2', 
                    DB::raw('MAX(qlhs_profile_subject.profile_subject_subject_id) as profile_subject_subject_id'), 
                    DB::raw('MAX(CASE when profile_subject_subject_id = 74 then 1 else 0 END) Mien'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 35 then 1 else 0 END) Mien1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 36 then 1 else 0 END) Mien2'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 38 then 1 else 0 END) Mien3'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 73 then 1 else 0 END) Mien4'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 39 then 1 else 0 END) Mien5'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 28 then 1 else 0 END) Mien6'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 34 then 1 else 0 END) Giam70'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 49 then 1 else 0 END) Giam70_1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 40 then 1 else 0 END) Giam501'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 41 then 1 else 0 END) Giam502'),

                    DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-06-01' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".($namhoc)."-01-01')) then 1 else 0 END) 'HKII1'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".$namhoc."-12-31' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".($namhoc)."-05-31')) then 1 else 0 END) 'HKI2'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".($namhoc + 1)."-06-01' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-01-01')) then 1 else 0 END) 'HKII2'"),
                    DB::raw("MAX(CASE when level_new <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-12-31' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-05-31')) then 1 else 0 END) 'HKI3'"))

                ->whereIn('profile_subject_subject_id',[28,35,36,73,38,39,34,40,41,74,49])
                ->where('profile_year','>',$namhoc.'-05-31')
                ->where('profile_year','<',((int)$namhoc+1).'-06-01')
                ->where('profile_school_id','=', DB::raw($truong.' AND (yearold.qlhs_thcd_trangthai_MGHP_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_MGHP > 0 OR yearcur.qlhs_thcd_trangthai_MGHP_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_MGHP > 0)'))
                
                ->groupBy('profile_id','profile_name','profile_year','level_old','level_cur','level_new', 
                    'yearold.qlhs_thcd_trangthai_MGHP', 'yearold.qlhs_thcd_trangthai_MGHP_HK2', 
                    'yearcur.qlhs_thcd_trangthai_MGHP', 'yearcur.qlhs_thcd_trangthai_MGHP_HK2',
                    'yearnew.qlhs_thcd_trangthai_MGHP', 'yearnew.qlhs_thcd_trangthai_MGHP_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_MGHP', 'yearold.qlhs_thcd_tien_nhucau_MGHP_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_MGHP', 'yearcur.qlhs_thcd_tien_nhucau_MGHP_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_MGHP', 'yearnew.qlhs_thcd_tien_nhucau_MGHP_HK2');
            $data22 = DB::table(DB::raw("({$data2->toSql()}) as m"))->mergeBindings( $data2 )
                ->select('HKII1','HKI2','HKII2','HKI3','m.Mien','m.Mien1','m.Mien2','m.Mien3','m.Mien4','m.Mien5','m.Mien6','m.Giam70','m.Giam70_1','m.Giam501','m.Giam502','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                    'm.old_MGHP', 'm.old_MGHP_HK2', 'm.cur_MGHP',  'm.cur_MGHP_HK2', 'm.new_MGHP', 'm.new_MGHP_HK2', 
                    'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2');

            $data3 = DB::table('qlhs_profile')
                ->join('qlhs_profile_subject', 'profile_id', '=' , DB::raw('profile_subject_profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.($namhoc + 1).' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.($namhoc + 1).')'))
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.($namhoc + 1).'-'.($namhoc + 2).'"'))

                ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.$namhoc))
                ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.($namhoc + 1)))
                ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($namhoc + 2)))

                ->select('profile_id','profile_name','profile_year', 'level_old', 'level_cur', 'level_new', 
                    'yearold.qlhs_thcd_trangthai_MGHP as old_MGHP', 'yearold.qlhs_thcd_trangthai_MGHP_HK2 as old_MGHP_HK2', 
                    'yearcur.qlhs_thcd_trangthai_MGHP as cur_MGHP', 'yearcur.qlhs_thcd_trangthai_MGHP_HK2 as cur_MGHP_HK2',
                    'yearnew.qlhs_thcd_trangthai_MGHP as new_MGHP', 'yearnew.qlhs_thcd_trangthai_MGHP_HK2 as new_MGHP_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_MGHP as money_old', 'yearold.qlhs_thcd_tien_nhucau_MGHP_HK2 as money_old_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_MGHP as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_MGHP_HK2 as money_cur_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_MGHP as money_new', 'yearnew.qlhs_thcd_tien_nhucau_MGHP_HK2 as money_new_HK2', 
                    DB::raw('MAX(qlhs_profile_subject.profile_subject_subject_id) as profile_subject_subject_id'), 
                    DB::raw('MAX(CASE when profile_subject_subject_id = 74 then 1 else 0 END) Mien'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 35 then 1 else 0 END) Mien1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 36 then 1 else 0 END) Mien2'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 38 then 1 else 0 END) Mien3'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 73 then 1 else 0 END) Mien4'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 39 then 1 else 0 END) Mien5'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 28 then 1 else 0 END) Mien6'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 34 then 1 else 0 END) Giam70'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 49 then 1 else 0 END) Giam70_1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 40 then 1 else 0 END) Giam501'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 41 then 1 else 0 END) Giam502'),

                    DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-06-01' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".($namhoc)."-01-01')) then 1 else 0 END) 'HKII1'"),
                    DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-12-31' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".($namhoc)."-05-31')) then 1 else 0 END) 'HKI2'"),
                    DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".($namhoc + 1)."-06-01' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-01-01')) then 1 else 0 END) 'HKII2'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-12-31' and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-05-31')) then 1 else 0 END) 'HKI3'"))

                ->whereIn('profile_subject_subject_id',[28,35,36,73,38,39,34,40,41,74,49])
                ->where('profile_year','>',((int)$namhoc+1).'-05-31')
                ->where('profile_year','<',((int)$namhoc+2).'-01-01')
                ->where('profile_school_id','=', DB::raw($truong.' AND (yearold.qlhs_thcd_trangthai_MGHP_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_MGHP > 0 OR yearcur.qlhs_thcd_trangthai_MGHP_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_MGHP > 0)'))
                
                ->groupBy('profile_id','profile_name','profile_year','level_old','level_cur','level_new', 
                    'yearold.qlhs_thcd_trangthai_MGHP', 'yearold.qlhs_thcd_trangthai_MGHP_HK2', 
                    'yearcur.qlhs_thcd_trangthai_MGHP', 'yearcur.qlhs_thcd_trangthai_MGHP_HK2',
                    'yearnew.qlhs_thcd_trangthai_MGHP', 'yearnew.qlhs_thcd_trangthai_MGHP_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_MGHP', 'yearold.qlhs_thcd_tien_nhucau_MGHP_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_MGHP', 'yearcur.qlhs_thcd_tien_nhucau_MGHP_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_MGHP', 'yearnew.qlhs_thcd_tien_nhucau_MGHP_HK2');

            $data33 = DB::table(DB::raw("({$data3->toSql()}) as m"))->mergeBindings( $data3 )
                ->select('HKII1','HKI2','HKII2','HKI3','m.Mien','m.Mien1','m.Mien2','m.Mien3','m.Mien4','m.Mien5','m.Mien6','m.Giam70','m.Giam70_1','m.Giam501','m.Giam502','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                    'm.old_MGHP', 'm.old_MGHP_HK2', 'm.cur_MGHP',  'm.cur_MGHP_HK2', 'm.new_MGHP', 'm.new_MGHP_HK2', 
                    'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2');

            if($data11->count()==0 && $data22->count()==0 && $data33->count()==0){
                    
            }else{
                $import =  $this->insertReportMGHP($data1,$data2,$data3,$truong,$namhoc,$user,$now,$report_name,$report_user_sign,$user_name,$status,$note, $capnhan);

                // return $import;
            }  
        } catch (Exception $e) {
            return $e;
        }
    }

    public function insertReportMGHP($data11,$data22,$data33,$truong,$namhoc,$user,$now,$report_name,$report_user_sign,$user_name,$status,$note, $capnhan){
        try {
            $json = [];
            $time = time();
            $dir = storage_path().'/files/MGHP';

            $phongGD_duyet = 0;

            if ($capnhan == 3) {
                $phongGD_duyet = 1;
            }

            if($data11->count() > 0){
                foreach ($data11->get() as $value) {

                    $giam70hp = 0;
                    $nhucau = 0;
                    $dutoan = 0;

                    if ($value->Giam70 > 0 && $value->Giam70_1 > 0) {
                        $giam70hp = 1;
                    }

                    if ($value->Mien > 0 && $value->Giam502 > 0) {

                            $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                            $dutoan = ($value->money_cur_HK2 * $value->cur_MGHP_HK2) + $value->money_new;

                            $json['1'] = DB::table('qlhs_miengiamhocphi')->insert([
                                'id_profile' => $value->profile_id,
                                'mienphi_1' => $value->Mien1,
                                'mienphi_2' => 1,//$value->Mien2,
                                'mienphi_3' => $value->Mien3,
                                'mienphi_4' => $value->Mien4,
                                'mienphi_5' => $value->Mien5,
                                'mienphi_6' => $value->Mien6, 
                                'giam_70' => $giam70hp,//$value->Giam70,
                                'giam_50_1' => $value->Giam501,
                                'giam_50_2' => $value->Giam502,
                                'hocky2_old' => $value->HKII1,
                                'hocky1_cur' => $value->HKI2,
                                'hocky2_cur' => $value->HKII2,
                                'hocky1_new' => $value->HKI3,
                                // 'hocphi_old' => $value->money1,
                                // 'hocphi_new' => $value->money2,
                                'nhu_cau' => $nhucau,
                                'du_toan' => $dutoan,
                                'year_old' => (int)$namhoc,
                                'year_cur' => (int)$namhoc+1,
                                'type' => 1,
                                'type_code' => 'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                                'trangthai_pheduyet_MGHP' => 1,
                                'trangthai_phongGD_MGHP' => $phongGD_duyet,
                                'trangthai_phongTC_MGHP' => 0,
                                'trangthai_So_MGHP' => 0
                                ]);

                            $json['1'] = 1;
                    }
                    else {
                        if ($value->Mien1 > 0 || $value->Mien2 > 0 || $value->Mien3 > 0 || $value->Mien4 > 0 || $value->Mien5 > 0 || $value->Mien6 > 0) {
                            $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                            $dutoan = ($value->money_cur_HK2 * $value->cur_MGHP_HK2) + $value->money_new;
                        }
                        else {
                            if ($value->Giam70 > 0 && $value->Giam70_1 > 0) {
                                $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                                $dutoan = ($value->money_cur_HK2 * $value->cur_MGHP_HK2) + $value->money_new;
                            }
                            else if ($value->Giam501 > 0 || $value->Giam502 > 0) {
                                $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                                $dutoan = ($value->money_cur_HK2 * $value->cur_MGHP_HK2) + $value->money_new;
                            }
                        }

                        if ($nhucau > 0 || $dutoan > 0) {

                            $json['1'] = DB::table('qlhs_miengiamhocphi')->insert([
                                'id_profile' => $value->profile_id,
                                'mienphi_1' => $value->Mien1,
                                'mienphi_2' => 0,//$value->Mien2,
                                'mienphi_3' => $value->Mien3,
                                'mienphi_4' => $value->Mien4,
                                'mienphi_5' => $value->Mien5,
                                'mienphi_6' => $value->Mien6, 
                                'giam_70' => $giam70hp,//$value->Giam70,
                                'giam_50_1' => $value->Giam501,
                                'giam_50_2' => $value->Giam502,
                                'hocky2_old' => $value->HKII1,
                                'hocky1_cur' => $value->HKI2,
                                'hocky2_cur' => $value->HKII2,
                                'hocky1_new' => $value->HKI3,
                                // 'hocphi_old' => $value->money1,
                                // 'hocphi_new' => $value->money2,
                                'nhu_cau' => $nhucau,
                                'du_toan' => $dutoan,
                                'year_old' => (int)$namhoc,
                                'year_cur' => (int)$namhoc+1,
                                'type' => 1,
                                'type_code' => 'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                                'trangthai_pheduyet_MGHP' => 1,
                                'trangthai_phongGD_MGHP' => $phongGD_duyet,
                                'trangthai_phongTC_MGHP' => 0,
                                'trangthai_So_MGHP' => 0
                                ]);
                        }
                        else {
                            $json['1'] = 1;
                        }
                    }
                }
            }else{
                $json['1'] = 1;
            }

            if($data22->count() > 0){
                foreach ($data22->get() as $value) {

                    $giam70hp = 0;
                    $nhucau = 0;
                    $dutoan = 0;

                    if ($value->Giam70 > 0 && $value->Giam70_1 > 0) {
                        $giam70hp = 1;
                    }

                    if ($value->Mien > 0 && $value->Giam502 > 0) {

                            $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                            $dutoan = ($value->money_cur_HK2 * $value->cur_MGHP_HK2) + $value->money_new;

                            $json['2'] = DB::table('qlhs_miengiamhocphi')->insert([
                                'id_profile' => $value->profile_id,
                                'mienphi_1' => $value->Mien1,
                                'mienphi_2' => 1,//$value->Mien2,
                                'mienphi_3' => $value->Mien3,
                                'mienphi_4' => $value->Mien4,
                                'mienphi_5' => $value->Mien5,
                                'mienphi_6' => $value->Mien6, 
                                'giam_70' => $giam70hp,//$value->Giam70,
                                'giam_50_1' => $value->Giam501,
                                'giam_50_2' => $value->Giam502,
                                'hocky2_old' => $value->HKII1,
                                'hocky1_cur' => $value->HKI2,
                                'hocky2_cur' => $value->HKII2,
                                'hocky1_new' => $value->HKI3,
                                // 'hocphi_old' => $value->money1,
                                // 'hocphi_new' => $value->money2,
                                'nhu_cau' => $nhucau,
                                'du_toan' => $dutoan,
                                'year_old' => (int)$namhoc,
                                'year_cur' => (int)$namhoc+1,
                                'type' => 2,
                                'type_code' => 'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                                'trangthai_pheduyet_MGHP' => 1,
                                'trangthai_phongGD_MGHP' => $phongGD_duyet,
                                'trangthai_phongTC_MGHP' => 0,
                                'trangthai_So_MGHP' => 0
                                ]);

                            $json['2'] = 1;
                    }
                    else {
                        if ($value->Mien1 > 0 || $value->Mien2 > 0 || $value->Mien3 > 0 || $value->Mien4 > 0 || $value->Mien5 > 0 || $value->Mien6 > 0) {
                            $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                            $dutoan = ($value->money_cur_HK2 * $value->cur_MGHP_HK2) + $value->money_new;
                        }
                        else {
                            if ($value->Giam70 > 0 && $value->Giam70_1 > 0) {
                                $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                                $dutoan = ($value->money_cur_HK2 * $value->cur_MGHP_HK2) + $value->money_new;
                            }
                            else if ($value->Giam501 > 0 || $value->Giam502 > 0) {
                                $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                                $dutoan = ($value->money_cur_HK2 * $value->cur_MGHP_HK2) + $value->money_new;
                            }
                        }

                        if ($nhucau > 0 || $dutoan > 0) {

                            $json['2'] = DB::table('qlhs_miengiamhocphi')->insert([
                                'id_profile' => $value->profile_id,
                                'mienphi_1' => $value->Mien1,
                                'mienphi_2' => 0,//$value->Mien2,
                                'mienphi_3' => $value->Mien3,
                                'mienphi_4' => $value->Mien4,
                                'mienphi_5' => $value->Mien5,
                                'mienphi_6' => $value->Mien6, 
                                'giam_70' => $giam70hp,//$value->Giam70,
                                'giam_50_1' => $value->Giam501,
                                'giam_50_2' => $value->Giam502,
                                'hocky2_old' => $value->HKII1,
                                'hocky1_cur' => $value->HKI2,
                                'hocky2_cur' => $value->HKII2,
                                'hocky1_new' => $value->HKI3,
                                // 'hocphi_old' => $value->money1,
                                // 'hocphi_new' => $value->money2,
                                'nhu_cau' => $nhucau,
                                'du_toan' => $dutoan,
                                'year_old' => (int)$namhoc,
                                'year_cur' => (int)$namhoc+1,
                                'type' => 2,
                                'type_code' => 'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                                'trangthai_pheduyet_MGHP' => 1,
                                'trangthai_phongGD_MGHP' => $phongGD_duyet,
                                'trangthai_phongTC_MGHP' => 0,
                                'trangthai_So_MGHP' => 0
                                ]);
                        }
                        else {
                            $json['2'] = 1;
                        }
                    }
                }
            }else{
                $json['2'] = 1;
            }
            if($data33->count() > 0){
                foreach ($data33->get() as $value) {

                    $giam70hp = 0;
                    $nhucau = 0;
                    $dutoan = 0;

                    if ($value->Giam70 > 0 && $value->Giam70_1 > 0) {
                        $giam70hp = 1;
                    }

                    if ($value->Mien > 0 && $value->Giam502 > 0) {

                            // $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                            $dutoan = ($value->money_old_HK2 * $value->old_MGHP_HK2) + $value->money_cur;

                            $json['3'] = DB::table('qlhs_miengiamhocphi')->insert([
                                'id_profile' => $value->profile_id,
                                'mienphi_1' => $value->Mien1,
                                'mienphi_2' => 1,//$value->Mien2,
                                'mienphi_3' => $value->Mien3,
                                'mienphi_4' => $value->Mien4,
                                'mienphi_5' => $value->Mien5,
                                'mienphi_6' => $value->Mien6, 
                                'giam_70' => $giam70hp,//$value->Giam70,
                                'giam_50_1' => $value->Giam501,
                                'giam_50_2' => $value->Giam502,
                                'hocky2_old' => $value->HKII1,
                                'hocky1_cur' => $value->HKI2,
                                'hocky2_cur' => $value->HKII2,
                                'hocky1_new' => $value->HKI3,
                                // 'hocphi_old' => $value->money1,
                                // 'hocphi_new' => $value->money2,
                                'nhu_cau' => $nhucau,
                                'du_toan' => $dutoan,
                                'year_old' => (int)$namhoc,
                                'year_cur' => (int)$namhoc+1,
                                'type' => 3,
                                'type_code' => 'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                                'trangthai_pheduyet_MGHP' => 1,
                                'trangthai_phongGD_MGHP' => $phongGD_duyet,
                                'trangthai_phongTC_MGHP' => 0,
                                'trangthai_So_MGHP' => 0
                                ]);

                            $json['3'] = 1;
                    }
                    else {
                        if ($value->Mien1 > 0 || $value->Mien2 > 0 || $value->Mien3 > 0 || $value->Mien4 > 0 || $value->Mien5 > 0 || $value->Mien6 > 0) {
                            // $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                            $dutoan = ($value->money_old_HK2 * $value->old_MGHP_HK2) + $value->money_cur;
                        }
                        else {
                            if ($value->Giam70 > 0 && $value->Giam70_1 > 0) {
                                // $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                                $dutoan = ($value->money_old_HK2 * $value->old_MGHP_HK2) + $value->money_cur;
                            }
                            else if ($value->Giam501 > 0 || $value->Giam502 > 0) {
                                // $nhucau = ($value->money_old_HK2 * $value->old_MGHP_HK2) + ($value->money_cur * $value->cur_MGHP);
                                $dutoan = ($value->money_old_HK2 * $value->old_MGHP_HK2) + $value->money_cur;
                            }
                        }

                        if ($nhucau > 0 || $dutoan > 0) {

                            $json['3'] = DB::table('qlhs_miengiamhocphi')->insert([
                                'id_profile' => $value->profile_id,
                                'mienphi_1' => $value->Mien1,
                                'mienphi_2' => 0,//$value->Mien2,
                                'mienphi_3' => $value->Mien3,
                                'mienphi_4' => $value->Mien4,
                                'mienphi_5' => $value->Mien5,
                                'mienphi_6' => $value->Mien6, 
                                'giam_70' => $giam70hp,//$value->Giam70,
                                'giam_50_1' => $value->Giam501,
                                'giam_50_2' => $value->Giam502,
                                'hocky2_old' => $value->HKII1,
                                'hocky1_cur' => $value->HKI2,
                                'hocky2_cur' => $value->HKII2,
                                'hocky1_new' => $value->HKI3,
                                // 'hocphi_old' => $value->money1,
                                // 'hocphi_new' => $value->money2,
                                'nhu_cau' => 0,
                                'du_toan' => $dutoan,
                                'year_old' => (int)$namhoc,
                                'year_cur' => (int)$namhoc+1,
                                'type' => 3,
                                'type_code' => 'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                                'trangthai_pheduyet_MGHP' => 1,
                                'trangthai_phongGD_MGHP' => $phongGD_duyet,
                                'trangthai_phongTC_MGHP' => 0,
                                'trangthai_So_MGHP' => 0
                                ]);
                        }
                        else {
                            $json['3'] = 1;
                        }
                    }
                }

            }else{
                $json['3'] = 1;
            }
            // return $json;
            if((int)$json['1'] > 0 && (int)$json['2'] > 0 && (int)$json['3'] > 0){
                
                $insert_returnID = DB::table('qlhs_hosobaocao')->insertGetId([
                        'report_name' => $report_name,
                        'report_type' => 'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                        'report_date' => $now,
                        'created_at' => $now,
                        'updated_at' => $now,
                        'create_userid' => $user,
                        'update_userid' => $user,
                        'report_user' => $user_name,
                        'report_user_sign' => $report_user_sign,
                        'report_attach_name' => '',
                        'report_nature' => $status,
                        'report_year' => $namhoc,
                        'report_id_truong' => $truong,
                        'report_note' => $note,
                        'report' => 'MGHP'
                    ]);

                if(!is_null($insert_returnID) && $insert_returnID > 0 ){
                    $this->exportforSchoolsMGHP($insert_returnID);
                    if (file_exists(storage_path().'/exceldownload/MGHP/'.'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time.'.xlsx')) {
                            
                    }
                    else {
                        $deleteHoso = DB::table('qlhs_hosobaocao')->where('report_type', 'LIKE', '%'.'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time.'%')->delete();
                        $deleteMGHP = DB::table('qlhs_miengiamhocphi')->where('type_code', 'LIKE', '%'.'MGHP-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time.'%')->delete();
                    }
                }else{
                        
                }

                return $insert_returnID;
            }
            else {
                return 0;
            }
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportforSchoolsMGHP($id, $type = true){
        $this->exportforSchool($id, $type);
    }

    public function exportforSchool($id,$type = true){
    //$type = true;
        if (is_null($id) || empty($id) || $id == 0) {
            return "Mời bấm vào tên danh sách muốn kết xuất để kêt xuất file Excel!";
        }

        $getSchoolName = DB::table('qlhs_hosobaocao')->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hosobaocao.report_id_truong')->where('qlhs_hosobaocao.report_id', '=', $id)->select('qlhs_schools.schools_name', 'qlhs_hosobaocao.report_type', 'qlhs_hosobaocao.report_year')->first();
        $data_nghilc = [];
        $data_nghilc['aT'] = 'Học sinh có mặt tại trường tháng 5/' . $getSchoolName->report_year;
        $data_nghilc['bT'] = 'Học sinh dự kiến tuyển mới năm học ' . $getSchoolName->report_year . '-' . ((int)$getSchoolName->report_year + 1);
        $data_nghilc['cT'] = 'Học sinh dự kiến tuyển mới năm học ' . ((int)$getSchoolName->report_year + 1) . '-' . ((int)$getSchoolName->report_year + 2);
        if ($getSchoolName->report_type != null && $getSchoolName->report_type != "") {
            $data_nghilc['aCount'] = $this->countValueMGHP('1',$getSchoolName->report_type);
            $data_nghilc['bCount'] = $this->countValueMGHP('2',$getSchoolName->report_type);
            $data_nghilc['cCount'] = $this->countValueMGHP('3',$getSchoolName->report_type);
            $data_nghilc['TotalCount'] = $this->countValueMGHP(null, $getSchoolName->report_type);
            //Get by type A         
            $data_nghilc['a'] = DB::table('qlhs_miengiamhocphi')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_miengiamhocphi.id_profile')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "MGHP"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->leftJoin('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_miengiamhocphi.id_profile and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_miengiamhocphi.type_code', '=', $getSchoolName->report_type) 
            ->where('qlhs_miengiamhocphi.type', '=', 1)
            ->select('qlhs_profile_history.history_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_miengiamhocphi.*')->DISTINCT()->get();

            $data_nghilc['b'] = DB::table('qlhs_miengiamhocphi')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_miengiamhocphi.id_profile')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "MGHP"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_miengiamhocphi.id_profile and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_miengiamhocphi.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_miengiamhocphi.type', '=', 2)
            ->select('qlhs_profile_history.history_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_miengiamhocphi.*')->DISTINCT()->get();

            $data_nghilc['c'] = DB::table('qlhs_miengiamhocphi')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_miengiamhocphi.id_profile')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "MGHP"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_miengiamhocphi.id_profile and qlhs_profile_history.history_year = "'.($getSchoolName->report_year + 1).'-'.($getSchoolName->report_year + 2).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_miengiamhocphi.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_miengiamhocphi.type', '=', 3)
            ->select('qlhs_profile_history.history_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_miengiamhocphi.*')->DISTINCT()->get();
        }
        $data_nghilc['schools_name'] = $getSchoolName->schools_name;
        $data_nghilc['report_year'] = $getSchoolName->report_year;
        $this->addCellExcelMGHP($data_nghilc, $getSchoolName->report_type, $type);
    }

    private function addCellExcelMGHP($data_nghilc,$filename,$type=true){
        $excel =    Excel::load(storage_path().'/exceltemplate/laphosoMGHP.xlsx', function($reader) use($data_nghilc){
            $borderArray = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => 'thin',
                        'color' => array('argb' => 'FF000000')
                    )
                )
            );
            $FontArray = array(
                'font' => array(
                    'bold' => 'bold'
                )
            );
            $FontArrayitalic = array(
                'font' => array(
                    'italic' => 'italic'
                )
            );
            $style = array(
                'alignment' => array(
                    'horizontal' => 'center',
                )
            );
            $styleLeft = array(
                'alignment' => array(
                    'horizontal' => 'left',
                )
            );
            $styleRight = array(
                'alignment' => array(
                    'horizontal' => 'right',
                )
            );
            $FormatCurrency = array(
                'VND' => '#,###'
                //'type'  => PHPExcel_Style_NumberFormat::FORMAT_CURRENCY_VND
            );
            $row = 5;

            $col = 0;
            $colA = 0;

            $class_lv1 = 0;
            $class_lv2 = 0;
            $class_lv3 = 0;

            //-----------------------------------------Title------------------------------------------------------------------------------------------------
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 2, 'Thông tin cơ bản (tính tại thời điểm tháng 5/'.$data_nghilc['report_year'].')')->getStyle('C2')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 4, 'Học kì II năm học '.($data_nghilc['report_year'] - 1).'-'.$data_nghilc['report_year'])->getStyle('C4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, 4, 'Năm học '.$data_nghilc['report_year'].'-'.($data_nghilc['report_year'] + 1))->getStyle('D4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, 4, 'Năm học '.($data_nghilc['report_year'] + 1).'-'.($data_nghilc['report_year'] + 2))->getStyle('E4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, 4, 'Học kỳ II năm học '.($data_nghilc['report_year'] - 1).'-'.$data_nghilc['report_year'])->getStyle('X4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, 4, 'Học kỳ I năm học '.$data_nghilc['report_year'].'-'.($data_nghilc['report_year'] + 1))->getStyle('Y4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, 4, 'Học kỳ II năm học '.$data_nghilc['report_year'].'-'.($data_nghilc['report_year'] + 1))->getStyle('Z4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, 4, 'Học kỳ I năm học '.($data_nghilc['report_year'] + 1).'-'.($data_nghilc['report_year'] + 2))->getStyle('AA4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, 3, 'Năm học '.($data_nghilc['report_year'] - 1).'-'.$data_nghilc['report_year'])->getStyle('AB3')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(28, 3, 'Năm học '.$data_nghilc['report_year'].'-'.($data_nghilc['report_year'] + 1).', Năm học '.($data_nghilc['report_year'] + 1).'-'.($data_nghilc['report_year'] + 2))->getStyle('AC3')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(29, 2, 'Nhu cầu kinh phí năm '.$data_nghilc['report_year'])->getStyle('AD2')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(30, 2, 'Dự toán kinh phí năm '.($data_nghilc['report_year'] + 1))->getStyle('AE2')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            //-----------------------------------------End Title----------------------------------------------------------------------------------------------------

            //$data_nghilc['aCount'][0]
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_nghilc['schools_name'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_nghilc['TotalCount']->tongmien1)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_nghilc['TotalCount']->tongmien2)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_nghilc['TotalCount']->tongmien3)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_nghilc['TotalCount']->tongmien4)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_nghilc['TotalCount']->tongmien5)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_nghilc['TotalCount']->tongmien6)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_nghilc['TotalCount']->tonggiam70)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_nghilc['TotalCount']->tonggiam501)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_nghilc['TotalCount']->tonggiam502)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_nghilc['TotalCount']->tonghk12)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_nghilc['TotalCount']->tonghk21)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_nghilc['TotalCount']->tonghk22)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_nghilc['TotalCount']->tonghk31)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row, '')->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(28, $row, '')->getStyle('AC'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(29, $row,$data_nghilc['TotalCount']->tongnc)->getStyle('AD'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic)->applyFromArray($FormatCurrency);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(30, $row,$data_nghilc['TotalCount']->tongdt)->getStyle('AE'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'a')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_nghilc['aT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            $colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_nghilc['aCount']->tongmien1)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_nghilc['aCount']->tongmien2)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_nghilc['aCount']->tongmien3)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_nghilc['aCount']->tongmien4)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_nghilc['aCount']->tongmien5)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_nghilc['aCount']->tongmien6)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_nghilc['aCount']->tonggiam70)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_nghilc['aCount']->tonggiam501)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_nghilc['aCount']->tonggiam502)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_nghilc['aCount']->tonghk12)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_nghilc['aCount']->tonghk21)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_nghilc['aCount']->tonghk22)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_nghilc['aCount']->tonghk31)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row, '')->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(28, $row, '')->getStyle('AC'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(29, $row,$data_nghilc['aCount']->tongnc)->getStyle('AD'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(30, $row,$data_nghilc['aCount']->tongdt)->getStyle('AE'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $indexa = 0;
            if($data_nghilc['a']->count()>0){
                foreach($data_nghilc['a'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_nghilc['report_year']) {
                    //  $class_lv1 = $value->level_next_1;
                    //  $class_lv2 = $value->level_next_2;
                    //  $class_lv3 = $value->level_next_3;
                    // }

                    // if ($strYear == $data_nghilc['report_year']) {
                    //  $class_lv1 = $value->level_next_1;
                    //  $class_lv2 = $value->level_next_2;
                    //  $class_lv3 = $value->level_next_3;
                    // }

                    // if ($strYear > $data_nghilc['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('H'.$row)->applyFromArray($borderArray); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('I'.$row)->applyFromArray($borderArray); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('J'.$row)->applyFromArray($borderArray); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('K'.$row)->applyFromArray($borderArray);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_confirmation)->getStyle('L'.$row)->applyFromArray($borderArray);     
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_number)->getStyle('M'.$row)->applyFromArray($borderArray);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$decided_date)->getStyle('N'.$row)->applyFromArray($borderArray);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_1)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($style);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_2)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_3)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_4)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_5)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_6)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->giam_70)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($style);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->giam_50_1)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->giam_50_2)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('Y'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('Z'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('AA'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocphi_old)->getStyle('AB'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocphi_new)->getStyle('AC'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhu_cau)->getStyle('AD'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->du_toan)->getStyle('AE'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    }
                }
            //b

            $row++;
                $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'b')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_nghilc['bT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_nghilc['bCount']->tongmien1)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_nghilc['bCount']->tongmien2)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_nghilc['bCount']->tongmien3)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_nghilc['bCount']->tongmien4)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_nghilc['bCount']->tongmien5)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_nghilc['bCount']->tongmien6)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_nghilc['bCount']->tonggiam70)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_nghilc['bCount']->tonggiam501)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_nghilc['bCount']->tonggiam502)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_nghilc['bCount']->tonghk12)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_nghilc['bCount']->tonghk21)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_nghilc['bCount']->tonghk22)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_nghilc['bCount']->tonghk31)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row, '')->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(28, $row, '')->getStyle('AC'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(29, $row,$data_nghilc['bCount']->tongnc)->getStyle('AD'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(30, $row,$data_nghilc['bCount']->tongdt)->getStyle('AE'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $indexb = 0;

            if($data_nghilc['b']->count()>0){
                foreach($data_nghilc['b'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_nghilc['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_nghilc['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_nghilc['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexb)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('H'.$row)->applyFromArray($borderArray); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('I'.$row)->applyFromArray($borderArray); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('J'.$row)->applyFromArray($borderArray); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('K'.$row)->applyFromArray($borderArray);       
                    
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_confirmation)->getStyle('L'.$row)->applyFromArray($borderArray);     
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_number)->getStyle('M'.$row)->applyFromArray($borderArray);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$decided_date)->getStyle('N'.$row)->applyFromArray($borderArray);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_1)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($style);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_2)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_3)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_4)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_5)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($style);          
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_6)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($style);     
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->giam_70)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($style);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->giam_50_1)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->giam_50_2)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('Y'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('Z'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('AA'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocphi_old)->getStyle('AB'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocphi_new)->getStyle('AC'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhu_cau)->getStyle('AD'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->du_toan)->getStyle('AE'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    }
                }

                //c

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'c')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_nghilc['cT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_nghilc['cCount']->tongmien1)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_nghilc['cCount']->tongmien2)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_nghilc['cCount']->tongmien3)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_nghilc['cCount']->tongmien4)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_nghilc['cCount']->tongmien5)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_nghilc['cCount']->tongmien6)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_nghilc['cCount']->tonggiam70)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_nghilc['cCount']->tonggiam501)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_nghilc['cCount']->tonggiam502)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_nghilc['cCount']->tonghk12)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_nghilc['cCount']->tonghk21)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_nghilc['cCount']->tonghk22)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_nghilc['cCount']->tonghk31)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row, '')->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(28, $row, '')->getStyle('AC'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(29, $row,$data_nghilc['cCount']->tongnc)->getStyle('AD'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(30, $row,$data_nghilc['cCount']->tongdt)->getStyle('AE'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $indexc = 0;
            if($data_nghilc['c']->count()>0){
                foreach($data_nghilc['c'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_nghilc['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_nghilc['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    // if ($strYear > $data_nghilc['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexc)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('C'.$row)->applyFromArray($borderArray);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('D'.$row)->applyFromArray($borderArray);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('E'.$row)->applyFromArray($borderArray);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('H'.$row)->applyFromArray($borderArray); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('I'.$row)->applyFromArray($borderArray); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('J'.$row)->applyFromArray($borderArray); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('K'.$row)->applyFromArray($borderArray);       
                    
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_confirmation)->getStyle('L'.$row)->applyFromArray($borderArray);     
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_number)->getStyle('M'.$row)->applyFromArray($borderArray);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$decided_date)->getStyle('N'.$row)->applyFromArray($borderArray);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_1)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($style);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_2)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_3)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_4)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_5)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->mienphi_6)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->giam_70)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($style);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->giam_50_1)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->giam_50_2)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($style);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('Y'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('Z'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('AA'.$row)->applyFromArray($borderArray)->applyFromArray($style);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocphi_old)->getStyle('AB'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocphi_new)->getStyle('AC'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhu_cau)->getStyle('AD'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->du_toan)->getStyle('AE'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    }
                }
            });
        if($type){
            $excel->setFilename($filename)->store('xlsx', storage_path().'/exceldownload/MGHP');
        }else{
            $excel->setFilename($filename)->download('xlsx');
        }
    }
    
    public function countValueMGHP($type = null,$code){

        if($type!=null){
            $count = DB::table('qlhs_miengiamhocphi')->where('type_code','=',$code)->where('type','=',$type)->select(DB::raw('sum(mienphi_1) as tongmien1'),DB::raw('sum(mienphi_2) as tongmien2'),DB::raw('sum(mienphi_3) as tongmien3'),DB::raw('sum(mienphi_4) as tongmien4'),DB::raw('sum(mienphi_5) as tongmien5'),DB::raw('sum(mienphi_6) as tongmien6'),DB::raw('sum(giam_70) as tonggiam70'),DB::raw('sum(giam_50_1) as tonggiam501'),DB::raw('sum(giam_50_2) as tonggiam502'),DB::raw('sum(hocky2_old) as tonghk12'),DB::raw('sum(hocky1_cur) as tonghk21'),DB::raw('sum(hocky2_cur) as tonghk22'),DB::raw('sum(hocky1_new) as tonghk31'),DB::raw('sum(nhu_cau) as tongnc'),DB::raw('sum(du_toan) as tongdt'))->first();
            return $count;
        }else{
            $count = DB::table('qlhs_miengiamhocphi')->where('type_code','=',$code)->select(DB::raw('sum(mienphi_1) as tongmien1'),DB::raw('sum(mienphi_2) as tongmien2'),DB::raw('sum(mienphi_3) as tongmien3'),DB::raw('sum(mienphi_4) as tongmien4'),DB::raw('sum(mienphi_5) as tongmien5'),DB::raw('sum(mienphi_6) as tongmien6'),DB::raw('sum(giam_70) as tonggiam70'),DB::raw('sum(giam_50_1) as tonggiam501'),DB::raw('sum(giam_50_2) as tonggiam502'),DB::raw('sum(hocky2_old) as tonghk12'),DB::raw('sum(hocky1_cur) as tonghk21'),DB::raw('sum(hocky2_cur) as tonghk22'),DB::raw('sum(hocky1_new) as tonghk31'),DB::raw('sum(nhu_cau) as tongnc'),DB::raw('sum(du_toan) as tongdt'))->first();
            return $count;
        }
    }

//---------------------------------------------------------------------CPHT---------------------------------------------------------------------------
    public function chiphihoctap($truong, $namhoc, $note, $report_name, $report_user_sign, $user_name, $status, $capnhan){
        try {
            $json = [];
            
            $user = Auth::user()->id;
            $now = Carbon::now('Asia/Ho_Chi_Minh');
           

            $data1 = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'profile_id', '=' , DB::raw('profile_subject_profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$namhoc.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$namhoc.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$namhoc.'-'.($namhoc + 1).'"'))

            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($namhoc - 1).' and (yearold.qlhs_thcd_trangthai_CPHT = 1 or yearold.qlhs_thcd_trangthai_CPHT_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$namhoc.' and (yearcur.qlhs_thcd_trangthai_CPHT = 1 or yearcur.qlhs_thcd_trangthai_CPHT_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($namhoc + 1)))
            
            ->select('profile_id','profile_name','profile_year', 'level_old','level_cur','level_new', 
                'yearold.qlhs_thcd_trangthai_CPHT as old_CPHT', 'yearold.qlhs_thcd_trangthai_CPHT_HK2 as old_CPHT_HK2', 
                'yearcur.qlhs_thcd_trangthai_CPHT as cur_CPHT', 'yearcur.qlhs_thcd_trangthai_CPHT_HK2 as cur_CPHT_HK2',
                'yearnew.qlhs_thcd_trangthai_CPHT as new_CPHT', 'yearnew.qlhs_thcd_trangthai_CPHT_HK2 as new_CPHT_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_CPHT as money_old', 'yearold.qlhs_thcd_tien_nhucau_CPHT_HK2 as money_old_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_CPHT as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_CPHT_HK2 as money_cur_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_CPHT as money_new', 'yearnew.qlhs_thcd_tien_nhucau_CPHT_HK2 as money_new_HK2', 
                DB::raw('MAX(profile_subject_subject_id) as profile_subject_subject_id'),
                DB::raw('MAX(CASE when profile_subject_subject_id = 28 then 1 else 0 END) DT1'),
                DB::raw('MAX(CASE when profile_subject_subject_id = 73 then 1 else 0 END) DT2'),

                DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-06-01' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".$namhoc."-01-01')) then 1 else 0 END) 'HKII1'"),
                DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".$namhoc."-12-31' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".$namhoc."-05-31')) then 1 else 0 END) 'HKI2'"),
                DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".($namhoc + 1)."-06-01' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-01-01')) then 1 else 0 END) 'HKII2'"),
                DB::raw("MAX(CASE when level_new <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-12-31' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-05-31')) then 1 else 0 END) 'HKI3'"))
            
            ->whereIn('profile_subject_subject_id',[28,73])
            ->where('profile_year','<',$namhoc.'-06-01')
            ->where('profile_school_id','=', DB::raw($truong.' AND (yearold.qlhs_thcd_trangthai_CPHT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_CPHT > 0 OR yearcur.qlhs_thcd_trangthai_CPHT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_CPHT > 0)'))
            
            ->groupBy('profile_id','profile_name','profile_year','level_old','level_cur','level_new', 
                'yearold.qlhs_thcd_trangthai_CPHT', 'yearold.qlhs_thcd_trangthai_CPHT_HK2', 
                'yearcur.qlhs_thcd_trangthai_CPHT', 'yearcur.qlhs_thcd_trangthai_CPHT_HK2',
                'yearnew.qlhs_thcd_trangthai_CPHT', 'yearnew.qlhs_thcd_trangthai_CPHT_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_CPHT', 'yearold.qlhs_thcd_tien_nhucau_CPHT_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_CPHT', 'yearcur.qlhs_thcd_tien_nhucau_CPHT_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_CPHT', 'yearnew.qlhs_thcd_tien_nhucau_CPHT_HK2');

            $data11 = DB::table(DB::raw("({$data1->toSql()}) as m"))->mergeBindings( $data1 )
            ->select('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                'm.old_CPHT', 'm.old_CPHT_HK2', 'm.cur_CPHT', 'm.cur_CPHT_HK2', 'm.new_CPHT', 'm.new_CPHT_HK2', 
                'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2')
            ->groupBy('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                'm.old_CPHT', 'm.old_CPHT_HK2', 'm.cur_CPHT', 'm.cur_CPHT_HK2', 'm.new_CPHT', 'm.new_CPHT_HK2', 
                'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2');

            $data2 = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'profile_id', '=' , DB::raw('profile_subject_profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$namhoc.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$namhoc.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$namhoc.'-'.($namhoc + 1).'"'))

            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($namhoc - 1).' and (yearold.qlhs_thcd_trangthai_CPHT = 1 or yearold.qlhs_thcd_trangthai_CPHT_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$namhoc))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($namhoc + 1)))
            
            ->select('profile_id','profile_name','profile_year', 'level_old','level_cur','level_new', 
                'yearold.qlhs_thcd_trangthai_CPHT as old_CPHT', 'yearold.qlhs_thcd_trangthai_CPHT_HK2 as old_CPHT_HK2', 
                'yearcur.qlhs_thcd_trangthai_CPHT as cur_CPHT', 'yearcur.qlhs_thcd_trangthai_CPHT_HK2 as cur_CPHT_HK2',
                'yearnew.qlhs_thcd_trangthai_CPHT as new_CPHT', 'yearnew.qlhs_thcd_trangthai_CPHT_HK2 as new_CPHT_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_CPHT as money_old', 'yearold.qlhs_thcd_tien_nhucau_CPHT_HK2 as money_old_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_CPHT as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_CPHT_HK2 as money_cur_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_CPHT as money_new', 'yearnew.qlhs_thcd_tien_nhucau_CPHT_HK2 as money_new_HK2', 
                DB::raw('MAX(profile_subject_subject_id) as profile_subject_subject_id'),
                DB::raw('MAX(CASE when profile_subject_subject_id = 28 then 1 else 0 END) DT1'),
                DB::raw('MAX(CASE when profile_subject_subject_id = 73 then 1 else 0 END) DT2'),

                DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-06-01' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".$namhoc."-01-01')) then 1 else 0 END) 'HKII1'"),
                DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".$namhoc."-12-31' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".$namhoc."-05-31')) then 1 else 0 END) 'HKI2'"),
                DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".($namhoc + 1)."-06-01' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-01-01')) then 1 else 0 END) 'HKII2'"),
                DB::raw("MAX(CASE when level_new <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-12-31' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-05-31')) then 1 else 0 END) 'HKI3'"))
            
            ->where('profile_year','>',$namhoc.'-06-01')
            ->where('profile_year','<',($namhoc + 1).'-06-01')
            ->whereIn('profile_subject_subject_id',[28,73])
            ->where('profile_school_id','=', DB::raw($truong.' AND (yearold.qlhs_thcd_trangthai_CPHT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_CPHT > 0 OR yearcur.qlhs_thcd_trangthai_CPHT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_CPHT > 0)'))
            
            ->groupBy('profile_id','profile_name','profile_year','level_old','level_cur','level_new', 
                'yearold.qlhs_thcd_trangthai_CPHT', 'yearold.qlhs_thcd_trangthai_CPHT_HK2', 
                'yearcur.qlhs_thcd_trangthai_CPHT', 'yearcur.qlhs_thcd_trangthai_CPHT_HK2',
                'yearnew.qlhs_thcd_trangthai_CPHT', 'yearnew.qlhs_thcd_trangthai_CPHT_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_CPHT', 'yearold.qlhs_thcd_tien_nhucau_CPHT_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_CPHT', 'yearcur.qlhs_thcd_tien_nhucau_CPHT_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_CPHT', 'yearnew.qlhs_thcd_tien_nhucau_CPHT_HK2');

            $data22 = DB::table(DB::raw("({$data2->toSql()}) as m"))->mergeBindings( $data2 )
            ->select('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                'm.old_CPHT', 'm.old_CPHT_HK2', 'm.cur_CPHT', 'm.cur_CPHT_HK2', 'm.new_CPHT', 'm.new_CPHT_HK2', 
                'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2')
            ->groupBy('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                'm.old_CPHT', 'm.old_CPHT_HK2', 'm.cur_CPHT', 'm.cur_CPHT_HK2', 'm.new_CPHT', 'm.new_CPHT_HK2', 
                'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2');

            $data3 = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'profile_id', '=' , DB::raw('profile_subject_profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.($namhoc + 1).' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.($namhoc + 1).')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.($namhoc + 1).'-'.($namhoc + 2).'"'))

            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.$namhoc.''))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.($namhoc + 1)))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($namhoc + 2).''))
            
            ->select('profile_id','profile_name','profile_year', 'level_old','level_cur','level_new', 
                'yearold.qlhs_thcd_trangthai_CPHT as old_CPHT', 'yearold.qlhs_thcd_trangthai_CPHT_HK2 as old_CPHT_HK2', 
                'yearcur.qlhs_thcd_trangthai_CPHT as cur_CPHT', 'yearcur.qlhs_thcd_trangthai_CPHT_HK2 as cur_CPHT_HK2',
                'yearnew.qlhs_thcd_trangthai_CPHT as new_CPHT', 'yearnew.qlhs_thcd_trangthai_CPHT_HK2 as new_CPHT_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_CPHT as money_old', 'yearold.qlhs_thcd_tien_nhucau_CPHT_HK2 as money_old_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_CPHT as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_CPHT_HK2 as money_cur_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_CPHT as money_new', 'yearnew.qlhs_thcd_tien_nhucau_CPHT_HK2 as money_new_HK2', 
                DB::raw('MAX(profile_subject_subject_id) as profile_subject_subject_id'),
                DB::raw('MAX(CASE when profile_subject_subject_id = 28 then 1 else 0 END) DT1'),
                DB::raw('MAX(CASE when profile_subject_subject_id = 73 then 1 else 0 END) DT2'),

                DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-06-01' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".$namhoc."-01-01')) then 1 else 0 END) 'HKII1'"),
                DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".$namhoc."-12-31' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".$namhoc."-05-31')) then 1 else 0 END) 'HKI2'"),
                DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".($namhoc + 1)."-06-01' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-01-01')) then 1 else 0 END) 'HKII2'"),
                DB::raw("MAX(CASE when level_new <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-12-31' and profile_subject_subject_id in (28,73) and (profile_leaveschool_date is null or ( profile_leaveschool_date > '".((int)$namhoc+1)."-05-31')) then 1 else 0 END) 'HKI3'"))
            
            ->where('profile_year','>', ($namhoc + 1).'-06-01')
            ->where('profile_year','<', ($namhoc + 2).'-06-01')
            ->whereIn('profile_subject_subject_id', [28,73])
            ->where('profile_school_id','=', DB::raw($truong.' AND (yearold.qlhs_thcd_trangthai_CPHT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_CPHT > 0 OR yearcur.qlhs_thcd_trangthai_CPHT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_CPHT > 0)'))
            
            ->groupBy('profile_id','profile_name','profile_year','level_old','level_cur','level_new', 
                'yearold.qlhs_thcd_trangthai_CPHT', 'yearold.qlhs_thcd_trangthai_CPHT_HK2', 
                'yearcur.qlhs_thcd_trangthai_CPHT', 'yearcur.qlhs_thcd_trangthai_CPHT_HK2',
                'yearnew.qlhs_thcd_trangthai_CPHT', 'yearnew.qlhs_thcd_trangthai_CPHT_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_CPHT', 'yearold.qlhs_thcd_tien_nhucau_CPHT_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_CPHT', 'yearcur.qlhs_thcd_tien_nhucau_CPHT_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_CPHT', 'yearnew.qlhs_thcd_tien_nhucau_CPHT_HK2');

            $data33 = DB::table(DB::raw("({$data3->toSql()}) as m"))->mergeBindings( $data3 )
            ->select('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                'm.old_CPHT', 'm.old_CPHT_HK2', 'm.cur_CPHT', 'm.cur_CPHT_HK2', 'm.new_CPHT', 'm.new_CPHT_HK2', 
                'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2')
            ->groupBy('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                'm.old_CPHT', 'm.old_CPHT_HK2', 'm.cur_CPHT', 'm.cur_CPHT_HK2', 'm.new_CPHT', 'm.new_CPHT_HK2', 
                'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2');

            if($data11->count()==0 && $data22->count()==0 && $data33->count()==0){
                
            }else{
                $import =  $this->insertReportCPHT($data11,$data22,$data33,$truong,$namhoc,$user,$now,$report_name,$report_user_sign,$user_name,$status,$note, $capnhan);
                
            }
        } catch (Exception $e) {
            return $e;
        }
        // return $json;
    }

    public function insertReportCPHT($data11,$data22,$data33,$truong,$namhoc,$user,$now,$report_name,$report_user_sign,$user_name,$status,$note, $capnhan){
        try {
            $json = [];
            $time = time();

            $phongGD_duyet = 0;
            if ($capnhan == 3) {
                $phongGD_duyet = 1;
            }

            $dir = storage_path().'/files/CPHT';
            if($data11->count() > 0){
                foreach ($data11->get() as $key => $value) {
                    if ($value->money_old_HK2 > 0 || $value->money_cur > 0 || $value->money_cur_HK2 > 0 || $value->money_new > 0) {
                        $json['1'] = DB::table('qlhs_chiphihoctap')->insert([
                            'cpht_profile_id' => $value->profile_id,
                            'cpht_doituong1' => $value->DT1,
                            'cpht_doituong2' => $value->DT2,
                            'hocky2_old' => $value->HKII1,
                            'hocky1_cur' => $value->HKI2,
                            'hocky2_cur' => $value->HKII2,
                            'hocky1_new' => $value->HKI3,
                            // 'ho_tro' => $value->money1,
                            'nhu_cau' => (($value->money_old_HK2 * $value->old_CPHT_HK2) + ($value->money_cur * $value->cur_CPHT)),
                            'du_toan' => (($value->money_cur_HK2 * $value->cur_CPHT_HK2) + ($value->money_new)),
                            'year_old' => (int)$namhoc,
                            'year_cur' => (int)$namhoc+1,
                            'type' => 1,
                            'type_code' => 'CPHT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                            'trangthai_pheduyet_CPHT' => 1,
                            'trangthai_phongGD_CPHT' => $phongGD_duyet,
                            'trangthai_phongTC_CPHT' => 0,
                            'trangthai_So_CPHT' => 0
                            ]);
                    }
                    $json['1'] = 2;
                }
            }else{
                $json['1'] = 2;
            }
            if($data22->count() > 0){
                foreach ($data22->get() as $value) {
                    if ($value->money_old_HK2 > 0 || $value->money_cur > 0 || $value->money_cur_HK2 > 0 || $value->money_new > 0) {
                        $json['2'] = DB::table('qlhs_chiphihoctap')->insert([
                            'cpht_profile_id' => $value->profile_id,
                            'cpht_doituong1' => $value->DT1,
                            'cpht_doituong2' => $value->DT2,
                            'hocky2_old' => $value->HKII1,
                            'hocky1_cur' => $value->HKI2,
                            'hocky2_cur' => $value->HKII2,
                            'hocky1_new' => $value->HKI3,
                            // 'ho_tro' => $value->money1,
                            'nhu_cau' => (($value->money_old_HK2 * $value->old_CPHT_HK2) + ($value->money_cur * $value->cur_CPHT)),
                            'du_toan' => (($value->money_cur_HK2 * $value->cur_CPHT_HK2) + ($value->money_new)),
                            'year_old' => (int)$namhoc,
                            'year_cur' => (int)$namhoc+1,
                            'type' => 2,
                            'type_code' => 'CPHT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                            'trangthai_pheduyet_CPHT' => 1,
                            'trangthai_phongGD_CPHT' => $phongGD_duyet,
                            'trangthai_phongTC_CPHT' => 0,
                            'trangthai_So_CPHT' => 0
                            ]);
                    }
                    $json['2'] = 2;
                }
            }else{
                $json['2'] = 2;
            }
            if($data33->count() > 0){
                foreach ($data33->get() as $value) {
                    if ($value->money_cur_HK2 > 0 || $value->money_new > 0) {
                        $json['3'] = DB::table('qlhs_chiphihoctap')->insert([
                            'cpht_profile_id' => $value->profile_id,
                            'cpht_doituong1' => $value->DT1,
                            'cpht_doituong2' => $value->DT2,
                            'hocky2_old' => $value->HKII1,
                            'hocky1_cur' => $value->HKI2,
                            'hocky2_cur' => $value->HKII2,
                            'hocky1_new' => $value->HKI3,
                            // 'ho_tro' => $value->money1,
                            'nhu_cau' => 0,//$value->NhuCau,
                            'du_toan' => (($value->money_old_HK2 * $value->old_CPHT_HK2) + $value->money_cur),
                            'year_old' => (int)$namhoc,
                            'year_cur' => (int)$namhoc+1,
                            'type' => 3,
                            'type_code' => 'CPHT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                            'trangthai_pheduyet_CPHT' => 1,
                            'trangthai_phongGD_CPHT' => $phongGD_duyet,
                            'trangthai_phongTC_CPHT' => 0,
                            'trangthai_So_CPHT' => 0
                            ]);
                    }
                    $json['3'] = 2;
                }

            }else{
                $json['3'] = 2;
            }
            
            if((int)$json['1'] > 0 && (int)$json['2'] > 0 && (int)$json['3'] > 0){
                  
                    $insert_returnID = DB::table('qlhs_hosobaocao')->insertGetId([
                        'report_name' => $report_name,
                        'report_type' => 'CPHT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                        'report_date' => $now,
                        'created_at' => $now,
                        'updated_at' => $now,
                        'create_userid' => $user,
                        'update_userid' => $user,
                        'report_user' => $user_name,
                        'report_user_sign' => $report_user_sign,
                        'report_attach_name' => '',
                        'report_nature' => $status,
                        'report_year' => $namhoc,
                        'report_id_truong' => $truong,
                        'report_note' => $note,
                        'report' => 'CPHT'
                    ]);
                    
                    if(!is_null($insert_returnID) && $insert_returnID > 0 ){
                        $this->exportforSchoolsCPHT($insert_returnID);
                        if (file_exists(storage_path().'/exceldownload/CPHT/'.'CPHT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time.'.xlsx')) {
                            return TRUE;
                        }
                        else {
                            $deleteHoso = DB::table('qlhs_hosobaocao')->where('report_type', 'LIKE', '%'.'CPHT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time.'%')->delete();
                            $deleteCPHT = DB::table('qlhs_chiphihoctap')->where('type_code', 'LIKE', '%'.'CPHT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time.'%')->delete();
                            return false;
                        }
                    }else{
                        
                    }
                return $insert_returnID;
            }
            else {
                return 0;
            }
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportforSchoolsCPHT($id, $type = true){
    //$type = true;
        if (is_null($id) || empty($id) || $id == 0) {
            return "Mời bấm vào tên danh sách muốn kết xuất để kêt xuất file Excel!";
        }

        $getSchoolName = DB::table('qlhs_hosobaocao')->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hosobaocao.report_id_truong')->where('qlhs_hosobaocao.report_id', '=', $id)->select('qlhs_schools.schools_name', 'qlhs_hosobaocao.report_type', 'qlhs_hosobaocao.report_year')->first();
        $data_results = [];
        $data_results['aT'] = 'Học sinh có mặt tại trường tháng 5/' . $getSchoolName->report_year;
        $data_results['bT'] = 'Học sinh dự kiến tuyển mới năm học ' . $getSchoolName->report_year . '-' . ((int)$getSchoolName->report_year + 1);
        $data_results['cT'] = 'Học sinh dự kiến tuyển mới năm học ' . ((int)$getSchoolName->report_year + 1) . '-' . ((int)$getSchoolName->report_year + 2);
        if ($getSchoolName->report_type != null && $getSchoolName->report_type != "") {
            $data_results['aCount'] = $this->countValueCPHT('1',$getSchoolName->report_type);
            $data_results['bCount'] = $this->countValueCPHT('2',$getSchoolName->report_type);
            $data_results['cCount'] = $this->countValueCPHT('3',$getSchoolName->report_type);
            $data_results['TotalCount'] = $this->countValueCPHT(null,$getSchoolName->report_type);
            //Get by type A
            $namhoc = $getSchoolName->report_year;
            $data_results['a'] = DB::table('qlhs_chiphihoctap')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_chiphihoctap.cpht_profile_id')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "CPHT"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_chiphihoctap.cpht_profile_id and qlhs_profile_history.history_year = "'.$namhoc.'-'.($namhoc + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_chiphihoctap.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_chiphihoctap.type', '=', 1)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_chiphihoctap.*')->DISTINCT()->get();

            $data_results['b'] = DB::table('qlhs_chiphihoctap')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_chiphihoctap.cpht_profile_id')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "CPHT"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_chiphihoctap.cpht_profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_chiphihoctap.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_chiphihoctap.type', '=', 2)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_chiphihoctap.*')->DISTINCT()->get();

            $data_results['c'] = DB::table('qlhs_chiphihoctap')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_chiphihoctap.cpht_profile_id')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "CPHT"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_chiphihoctap.cpht_profile_id and qlhs_profile_history.history_year = "'.($getSchoolName->report_year + 1).'-'.($getSchoolName->report_year + 2).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_chiphihoctap.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_chiphihoctap.type', '=', 3)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_chiphihoctap.*')->DISTINCT()->get();
        }
        $data_results['schools_name'] = $getSchoolName->schools_name;
        $data_results['report_year'] = $getSchoolName->report_year;
        $this->addCellExcelCPHT($data_results, $getSchoolName->report_type, $type);
    }

    private function addCellExcelCPHT($data_results, $filename, $type = true){
        $excel =    Excel::load(storage_path().'/exceltemplate/laphosoCPHT.xlsx', function($reader) use($data_results){
            $borderArray = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => 'thin',
                        'color' => array('argb' => 'FF000000')
                    )
                )
            );
            $FontArray = array(
                'font' => array(
                    'bold' => 'bold'
                )
            );
            $FontArrayitalic = array(
                'font' => array(
                    'italic' => 'italic'
                )
            );
            $style = array(
                'alignment' => array(
                    'horizontal' => 'center',
                )
            );
            $styleLeft = array(
                'alignment' => array(
                    'horizontal' => 'left',
                )
            );
            $styleRight = array(
                'alignment' => array(
                    'horizontal' => 'right',
                )
            );
            $row = 8;

            $col = 0;
            $colA = 0;

            $class_lv1 = 0;
            $class_lv2 = 0;
            $class_lv3 = 0;

            //-----------------------------------------Title------------------------------------------------------------------------------------------------
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, 2, 'NHU CẦU KINH PHÍ NĂM '.$data_results['report_year'].', DỰ TOÁN NĂM '.($data_results['report_year'] + 1).' ĐỐI VỚI CHÍNH SÁCH HỖ TRỢ CHI PHÍ HỌC TẬP THEO NGHỊ ĐỊNH SỐ 86/2015/NĐ-CP CỦA CHÍNH PHỦ')->getStyle('A2')->applyFromArray($FontArray)->applyFromArray($style);
            // $reader->getActiveSheet()->setCellValueByColumnAndRow(8, 3, '(Kèm theo Công văn số        /STC-KHNS ngày     /8/'.$data_results['report_year'].' của Sở Tài chính Yên Bái)')->getStyle('I3')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 5, 'Thông tin cơ bản (tính tại thời điểm tháng 5/'.$data_results['report_year'].')')->getStyle('C5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 7, 'Học kì II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('C7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, 7, 'Năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('D7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, 7, 'Năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('E7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, 7, 'Học kỳ II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('M7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, 7, 'Học kỳ I năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('N7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, 7, 'Học kỳ II năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('O7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, 7, 'Học kỳ I năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('P7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, 5, 'Nhu cầu kinh phí năm '.$data_results['report_year'])->getStyle('Q5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, 5, 'Dự toán kinh phí năm '.($data_results['report_year'] + 1))->getStyle('R5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            //-----------------------------------------End Title----------------------------------------------------------------------------------------------------

            //$data_results['aCount'][0]
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['schools_name'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($FontArrayitalic)->applyFromArray($styleLeft);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['TotalCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['TotalCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['TotalCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['TotalCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['TotalCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['TotalCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'a')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            //____________________________________________________________________________________________________________________________________________________
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['aT'])->getStyle('B'.$row)->applyFromArray($FontArray)->applyFromArray($styleLeft);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['aCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['aCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['aCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['aCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['aCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['aCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            if($data_results['a']->count()>0){
                $indexa = 0;
                foreach($data_results['a'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next_1;
                    //  $class_lv2 = $value->level_next_2;
                    //  $class_lv3 = $value->level_next_3;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_2;
                    //  $class_lv3 = $value->level_next_3;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_number)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_confirmation)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$decided_date)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->cpht_doituong1)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->cpht_doituong2)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhu_cau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->du_toan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }
            //b

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'b')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['bT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['bCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['bCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['bCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['bCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['bCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['bCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexb = 0;

            if($data_results['b']->count()>0){
                $indexa = 0;
                foreach($data_results['b'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_number)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_confirmation)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$decided_date)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->cpht_doituong1)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->cpht_doituong2)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhu_cau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->du_toan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }

                //c

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'c')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['cT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['cCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['cCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['cCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['cCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['cCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['cCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexc = 0;
            if($data_results['c']->count()>0){
                $indexa = 0;
                foreach($data_results['c'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_number)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_confirmation)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$decided_date)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->cpht_doituong1)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->cpht_doituong2)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhu_cau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->du_toan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                }
            }
        });
        if($type){
            return $excel->setFilename($filename)->store('xlsx', storage_path().'/exceldownload/CPHT');
        }else{
            return $excel->setFilename($filename)->download('xlsx');
        }
    }
    
    public function countValueCPHT($type = null,$code){

        if($type!=null){
            $count = DB::table('qlhs_chiphihoctap')->where('type_code','=',$code)->where('type','=',$type)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhu_cau) as tong_nhucau'),
                DB::raw('sum(du_toan) as tong_dutoan'))->first();
            return $count;
        }else{
            $count = DB::table('qlhs_chiphihoctap')->where('type_code','=',$code)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhu_cau) as tong_nhucau'),
                DB::raw('sum(du_toan) as tong_dutoan'))->first();
            return $count;
        }
    }

//---------------------------------------------------------------------HTAT---------------------------------------------------------------------------
    public function hoTroAnTruaTreEm($truong, $namhoc, $note, $report_name, $report_user_sign, $user_name, $status, $capnhan){
        try {
            $json = [];
        
            $user = Auth::user()->id;
            $now = Carbon::now('Asia/Ho_Chi_Minh');
            

            $data1 = DB::table('qlhs_profile')
                ->join('qlhs_profile_subject', 'profile_id', '=' , DB::raw('profile_subject_profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$namhoc.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$namhoc.')'))
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$namhoc.'-'.($namhoc + 1).'"'))
                
                ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($namhoc - 1).' and (yearold.qlhs_thcd_trangthai_HTAT = 1 or yearold.qlhs_thcd_trangthai_HTAT_HK2 = 1)'))
                ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$namhoc.' and (yearcur.qlhs_thcd_trangthai_HTAT = 1 or yearcur.qlhs_thcd_trangthai_HTAT_HK2 = 1)'))
                ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($namhoc + 1)))

                ->select('profile_id','profile_name','profile_year', 'level_old','level_cur','level_new', 
                    'yearold.qlhs_thcd_trangthai_HTAT as old_HTAT', 'yearold.qlhs_thcd_trangthai_HTAT_HK2 as old_HTAT_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HTAT as cur_HTAT', 'yearcur.qlhs_thcd_trangthai_HTAT_HK2 as cur_HTAT_HK2',
                    'yearnew.qlhs_thcd_trangthai_HTAT as new_HTAT', 'yearnew.qlhs_thcd_trangthai_HTAT_HK2 as new_HTAT_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HTAT as money_old', 'yearold.qlhs_thcd_tien_nhucau_HTAT_HK2 as money_old_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HTAT as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTAT_HK2 as money_cur_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HTAT as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HTAT_HK2 as money_new_HK2', 
                    DB::raw('MAX(profile_subject_subject_id) as profile_subject_subject_id'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 26 or profile_subject_subject_id = 34 then 1 else 0 END) DT1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 41 then 1 else 0 END) DT2'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 74 then 1 else 0 END) DT2_1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 28 then 1 else 0 END) DT3'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 73 then 1 else 0 END) DT4'),

                    DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-06-01' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".$namhoc."-01-01')) then 1 else 0 END) 'HKII1'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".$namhoc."-12-31' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".$namhoc."-05-31')) then 1 else 0 END) 'HKI2'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-06-01' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".((int)$namhoc+1)."-01-01')) then 1 else 0 END) 'HKII2'"),
                    DB::raw("MAX(CASE when level_new <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-12-31' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".((int)$namhoc+1)."-05-31')) then 1 else 0 END) 'HKI3'"))

                ->where('profile_year','<',$namhoc.'-06-01')
                ->whereIn('profile_subject_subject_id',[73,26,34,28,41,74])
                ->where('profile_school_id','=', DB::raw($truong.' AND (yearold.qlhs_thcd_trangthai_HTAT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTAT > 0 OR yearcur.qlhs_thcd_trangthai_HTAT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTAT > 0)'))
                
                ->groupBy('profile_id','profile_name','profile_year','level_old','level_cur','level_new', 
                    'yearold.qlhs_thcd_trangthai_HTAT', 'yearold.qlhs_thcd_trangthai_HTAT_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HTAT', 'yearcur.qlhs_thcd_trangthai_HTAT_HK2',
                    'yearnew.qlhs_thcd_trangthai_HTAT', 'yearnew.qlhs_thcd_trangthai_HTAT_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HTAT', 'yearold.qlhs_thcd_tien_nhucau_HTAT_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HTAT', 'yearcur.qlhs_thcd_tien_nhucau_HTAT_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HTAT', 'yearnew.qlhs_thcd_tien_nhucau_HTAT_HK2');

            $data11 = DB::table(DB::raw("({$data1->toSql()}) as m"))->mergeBindings( $data1 )
                ->select('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.DT2_1','m.DT3','m.DT4','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                    'm.old_HTAT', 'm.old_HTAT_HK2', 'm.cur_HTAT', 'm.cur_HTAT_HK2', 'm.new_HTAT', 'm.new_HTAT_HK2', 
                    'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2')
                ->groupBy('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.DT2_1','m.DT3','m.DT4','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                    'm.old_HTAT', 'm.old_HTAT_HK2', 'm.cur_HTAT', 'm.cur_HTAT_HK2', 'm.new_HTAT', 'm.new_HTAT_HK2', 
                    'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2');


            $data2 = DB::table('qlhs_profile')
                ->join('qlhs_profile_subject', 'profile_id', '=' , DB::raw('profile_subject_profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$namhoc.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$namhoc.')'))
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$namhoc.'-'.($namhoc + 1).'"'))
                
                ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($namhoc - 1).' and (yearold.qlhs_thcd_trangthai_HTAT = 1 or yearold.qlhs_thcd_trangthai_HTAT_HK2 = 1)'))
                ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$namhoc))
                ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($namhoc + 1)))

                ->select('profile_id','profile_name','profile_year', 'level_old','level_cur','level_new', 
                    'yearold.qlhs_thcd_trangthai_HTAT as old_HTAT', 'yearold.qlhs_thcd_trangthai_HTAT_HK2 as old_HTAT_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HTAT as cur_HTAT', 'yearcur.qlhs_thcd_trangthai_HTAT_HK2 as cur_HTAT_HK2',
                    'yearnew.qlhs_thcd_trangthai_HTAT as new_HTAT', 'yearnew.qlhs_thcd_trangthai_HTAT_HK2 as new_HTAT_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HTAT as money_old', 'yearold.qlhs_thcd_tien_nhucau_HTAT_HK2 as money_old_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HTAT as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTAT_HK2 as money_cur_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HTAT as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HTAT_HK2 as money_new_HK2', 
                    DB::raw('MAX(profile_subject_subject_id) as profile_subject_subject_id'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 26 or profile_subject_subject_id = 34 then 1 else 0 END) DT1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 41 then 1 else 0 END) DT2'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 74 then 1 else 0 END) DT2_1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 28 then 1 else 0 END) DT3'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 73 then 1 else 0 END) DT4'),

                    DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-06-01' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".$namhoc."-01-01')) then 1 else 0 END) 'HKII1'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".$namhoc."-12-31' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".$namhoc."-05-31')) then 1 else 0 END) 'HKI2'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-06-01' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".((int)$namhoc+1)."-01-01')) then 1 else 0 END) 'HKII2'"),
                    DB::raw("MAX(CASE when level_new <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-12-31' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".((int)$namhoc+1)."-05-31')) then 1 else 0 END) 'HKI3'"))

                ->where('profile_year','>',$namhoc.'-05-31')
                ->where('profile_year','<',($namhoc + 1).'-06-01')
                ->whereIn('profile_subject_subject_id',[73,26,34,28,41,74])
                ->where('profile_school_id','=', DB::raw($truong.' AND (yearold.qlhs_thcd_trangthai_HTAT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTAT > 0 OR yearcur.qlhs_thcd_trangthai_HTAT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTAT > 0)'))
                
                ->groupBy('profile_id','profile_name','profile_year','level_old','level_cur','level_new', 
                    'yearold.qlhs_thcd_trangthai_HTAT', 'yearold.qlhs_thcd_trangthai_HTAT_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HTAT', 'yearcur.qlhs_thcd_trangthai_HTAT_HK2',
                    'yearnew.qlhs_thcd_trangthai_HTAT', 'yearnew.qlhs_thcd_trangthai_HTAT_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HTAT', 'yearold.qlhs_thcd_tien_nhucau_HTAT_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HTAT', 'yearcur.qlhs_thcd_tien_nhucau_HTAT_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HTAT', 'yearnew.qlhs_thcd_tien_nhucau_HTAT_HK2');

            $data22 = DB::table(DB::raw("({$data2->toSql()}) as m"))->mergeBindings( $data2 )
                ->select('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.DT2_1','m.DT3','m.DT4','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                    'm.old_HTAT', 'm.old_HTAT_HK2', 'm.cur_HTAT', 'm.cur_HTAT_HK2', 'm.new_HTAT', 'm.new_HTAT_HK2', 
                    'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2')
                ->groupBy('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.DT2_1','m.DT3','m.DT4','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                    'm.old_HTAT', 'm.old_HTAT_HK2', 'm.cur_HTAT', 'm.cur_HTAT_HK2', 'm.new_HTAT', 'm.new_HTAT_HK2', 
                    'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2');

            $data3 = DB::table('qlhs_profile')
                ->join('qlhs_profile_subject', 'profile_id', '=' , DB::raw('profile_subject_profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.($namhoc + 1).' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.($namhoc + 1).')'))
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.($namhoc + 1).'-'.($namhoc + 2).'"'))
                
                ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.$namhoc.''))
                ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.($namhoc + 1)))
                ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($namhoc + 2).''))
                ->select('profile_id','profile_name','profile_year', 'level_old','level_cur','level_new', 
                    'yearold.qlhs_thcd_trangthai_HTAT as old_HTAT', 'yearold.qlhs_thcd_trangthai_HTAT_HK2 as old_HTAT_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HTAT as cur_HTAT', 'yearcur.qlhs_thcd_trangthai_HTAT_HK2 as cur_HTAT_HK2',
                    'yearnew.qlhs_thcd_trangthai_HTAT as new_HTAT', 'yearnew.qlhs_thcd_trangthai_HTAT_HK2 as new_HTAT_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HTAT as money_old', 'yearold.qlhs_thcd_tien_nhucau_HTAT_HK2 as money_old_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HTAT as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTAT_HK2 as money_cur_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HTAT as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HTAT_HK2 as money_new_HK2', 
                    DB::raw('MAX(profile_subject_subject_id) as profile_subject_subject_id'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 26 or profile_subject_subject_id = 34 then 1 else 0 END) DT1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 41 then 1 else 0 END) DT2'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 74 then 1 else 0 END) DT2_1'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 28 then 1 else 0 END) DT3'),
                    DB::raw('MAX(CASE when profile_subject_subject_id = 73 then 1 else 0 END) DT4'),

                    DB::raw("MAX(CASE when level_old <> '' and qlhs_profile.profile_year < '".$namhoc."-06-01' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".$namhoc."-01-01')) then 1 else 0 END) 'HKII1'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".$namhoc."-12-31' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".$namhoc."-05-31')) then 1 else 0 END) 'HKI2'"),
                    DB::raw("MAX(CASE when level_cur <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-06-01' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".((int)$namhoc+1)."-01-01')) then 1 else 0 END) 'HKII2'"),
                    DB::raw("MAX(CASE when level_new <> '' and qlhs_profile.profile_year < '".($namhoc +1)."-12-31' and profile_subject_subject_id in (73,26,34,28,41,74) and (profile_leaveschool_date is null or (profile_leaveschool_date >= '".((int)$namhoc+1)."-05-31')) then 1 else 0 END) 'HKI3'"))

                ->where('profile_year','>',($namhoc + 1).'-05-31')
                ->where('profile_year','<',($namhoc + 2).'-06-01')
                ->whereIn('profile_subject_subject_id',[73,26,34,28,41,74])
                ->where('profile_school_id','=', DB::raw($truong.' AND (yearold.qlhs_thcd_trangthai_HTAT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTAT > 0 OR yearcur.qlhs_thcd_trangthai_HTAT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTAT > 0)'))
                
                ->groupBy('profile_id','profile_name','profile_year','level_old','level_cur','level_new', 
                    'yearold.qlhs_thcd_trangthai_HTAT', 'yearold.qlhs_thcd_trangthai_HTAT_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HTAT', 'yearcur.qlhs_thcd_trangthai_HTAT_HK2',
                    'yearnew.qlhs_thcd_trangthai_HTAT', 'yearnew.qlhs_thcd_trangthai_HTAT_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HTAT', 'yearold.qlhs_thcd_tien_nhucau_HTAT_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HTAT', 'yearcur.qlhs_thcd_tien_nhucau_HTAT_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HTAT', 'yearnew.qlhs_thcd_tien_nhucau_HTAT_HK2');

            $data33 = DB::table(DB::raw("({$data3->toSql()}) as m"))->mergeBindings( $data3 )
                ->select('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.DT2_1','m.DT3','m.DT4','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                    'm.old_HTAT', 'm.old_HTAT_HK2', 'm.cur_HTAT', 'm.cur_HTAT_HK2', 'm.new_HTAT', 'm.new_HTAT_HK2', 
                    'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2')
                ->groupBy('HKII1','HKI2','HKII2','HKI3','m.DT1','m.DT2','m.DT2_1','m.DT3','m.DT4','m.profile_id','m.profile_subject_subject_id','m.profile_name','m.profile_year','m.level_old','m.level_cur','m.level_new', 
                    'm.old_HTAT', 'm.old_HTAT_HK2', 'm.cur_HTAT', 'm.cur_HTAT_HK2', 'm.new_HTAT', 'm.new_HTAT_HK2', 
                    'm.money_old', 'm.money_old_HK2', 'm.money_cur', 'm.money_cur_HK2', 'm.money_new', 'm.money_new_HK2');

            if($data11->count()==0 && $data22->count()==0 && $data33->count()==0){
                
            }else{
                $import =  $this->insertReportHTAT($data11,$data22,$data33,$truong,$namhoc,$user,$now,$report_name,$report_user_sign,$user_name,$status,$note, $capnhan);
            }
        } catch (Exception $e) {
            return $e;
        }
    }

    public function insertReportHTAT($data11,$data22,$data33,$truong,$namhoc,$user,$now,$report_name,$report_user_sign,$user_name,$status,$note, $capnhan){
        try {
            $json = [];
            $time = time();

            $phongGD_duyet = 0;
            if ($capnhan == 3) {
                $phongGD_duyet = 1;
            }

            $dir = storage_path().'/files/HTAT';
            if($data11->count() > 0){
                foreach ($data11->get() as $value) {
                    if ($value->money_old_HK2 > 0 || $value->money_cur || $value->money_cur_HK2 || $value->money_new) {
                        
                        $htta_doituong2 = 0;

                        if ($value->DT2 > 0 && $value->DT2_1 > 0) {
                            $htta_doituong2 = 1;
                        }

                        $json['1'] =DB::table('qlhs_hotrotienan')->insert([
                            'htta_profile_id' => $value->profile_id,
                            'htta_doituong1' => $value->DT1,
                            'htta_doituong2' => $htta_doituong2,//$value->DT2,
                            'htta_doituong3' => $value->DT3,
                            'htta_doituong4' => $value->DT4,
                            'hocky2_old' => $value->HKII1,
                            'hocky1_cur' => $value->HKI2,
                            'hocky2_cur' => $value->HKII2,
                            'hocky1_new' => $value->HKI3,
                            // 'ho_tro' => $value->money1,
                            'nhu_cau' => (($value->money_old_HK2 * $value->old_HTAT_HK2) + ($value->money_cur * $value->cur_HTAT)),
                            'du_toan' => (($value->money_cur_HK2 * $value->cur_HTAT_HK2) + $value->money_new),
                            'year_old' => (int)$namhoc,
                            'year_cur' => (int)$namhoc+1,
                            'type' => 1,
                            'type_code' => 'HTAT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                            'trangthai_pheduyet_HTAT' => 1,
                            'trangthai_phongGD_HTAT' => $phongGD_duyet,
                            'trangthai_phongTC_HTAT' => 0,
                            'trangthai_So_HTAT' => 0
                            ]);
                    }
                    $json['1'] = 2;
                }
            }else{
                $json['1'] = 2;
            }
            if($data22->count() > 0){
                foreach ($data22->get() as $key => $value) {
                    if ($value->money_old_HK2 > 0 || $value->money_cur || $value->money_cur_HK2 || $value->money_new) {
                        $htta_doituong2 = 0;

                        if ($value->DT2 > 0 && $value->DT2_1 > 0) {
                            $htta_doituong2 = 1;
                        }

                        $json['1'] =DB::table('qlhs_hotrotienan')->insert([
                            'htta_profile_id' => $value->profile_id,
                            'htta_doituong1' => $value->DT1,
                            'htta_doituong2' => $htta_doituong2,//$value->DT2,
                            'htta_doituong3' => $value->DT3,
                            'htta_doituong4' => $value->DT4,
                            'hocky2_old' => $value->HKII1,
                            'hocky1_cur' => $value->HKI2,
                            'hocky2_cur' => $value->HKII2,
                            'hocky1_new' => $value->HKI3,
                            // 'ho_tro' => $value->money1,
                            'nhu_cau' => (($value->money_old_HK2 * $value->old_HTAT_HK2) + ($value->money_cur * $value->cur_HTAT)),
                            'du_toan' => (($value->money_cur_HK2 * $value->cur_HTAT_HK2) + $value->money_new),
                            'year_old' => (int)$namhoc,
                            'year_cur' => (int)$namhoc+1,
                            'type' => 2,
                            'type_code' => 'HTAT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                            'trangthai_pheduyet_HTAT' => 1,
                            'trangthai_phongGD_HTAT' => $phongGD_duyet,
                            'trangthai_phongTC_HTAT' => 0,
                            'trangthai_So_HTAT' => 0
                            ]);
                    }
                    $json['2'] = 2;
                }
            }else{
                $json['2'] = 2;
            }
            if($data33->count()>0){
                foreach ($data33->get() as $key => $value) {
                    if ($value->money_cur_HK2 || $value->money_new) {
                        $htta_doituong2 = 0;

                        if ($value->DT2 > 0 && $value->DT2_1 > 0) {
                            $htta_doituong2 = 1;
                        }

                        $json['1'] =DB::table('qlhs_hotrotienan')->insert([
                            'htta_profile_id' => $value->profile_id,
                            'htta_doituong1' => $value->DT1,
                            'htta_doituong2' => $htta_doituong2,//$value->DT2,
                            'htta_doituong3' => $value->DT3,
                            'htta_doituong4' => $value->DT4,
                            'hocky2_old' => $value->HKII1,
                            'hocky1_cur' => $value->HKI2,
                            'hocky2_cur' => $value->HKII2,
                            'hocky1_new' => $value->HKI3,
                            // 'ho_tro' => $value->money1,
                            // 'nhu_cau' => (($value->money_old_HK2 * $value->old_HTAT_HK2) + ($value->money_cur * $value->cur_HTAT)),
                            'du_toan' => (($value->money_old_HK2 * $value->old_HTAT_HK2) + $value->money_cur),
                            'year_old' => (int)$namhoc,
                            'year_cur' => (int)$namhoc+1,
                            'type' => 3,
                            'type_code' => 'HTAT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                            'trangthai_pheduyet_HTAT' => 1,
                            'trangthai_phongGD_HTAT' => $phongGD_duyet,
                            'trangthai_phongTC_HTAT' => 0,
                            'trangthai_So_HTAT' => 0
                            ]);
                    }
                    $json['3'] = 2;
                }

            }else{
                $json['3'] = 2;
            }
            
            if((int)$json['1']> 0 && (int)$json['2']>0 && (int)$json['3']>0){
                
                  
                    $insert_returnID = DB::table('qlhs_hosobaocao')->insertGetId([
                        'report_name' => $report_name,
                        'report_type' => 'HTAT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time,
                        'report_date' => $now,
                        'created_at' => $now,
                        'updated_at' => $now,
                        'create_userid' => $user,
                        'update_userid' => $user,
                        'report_user' => $user_name,
                        'report_user_sign' => $report_user_sign,
                        'report_attach_name' => '',
                        'report_nature' => $status,
                        'report_year' => $namhoc,
                        'report_id_truong' => $truong,
                        'report_note' => $note,
                        'report' => 'HTAT'
                    ]);
                    
                    if(!is_null($insert_returnID) && $insert_returnID > 0 ){
                        $this->exportforSchoolsHTAT($insert_returnID);
                        if (file_exists(storage_path().'/exceldownload/HTAT/'.'HTAT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time.'.xlsx')) {
                            // return TRUE;
                        }
                        else {
                            $deleteHoso = DB::table('qlhs_hosobaocao')->where('report_type', 'LIKE', '%'.'HTAT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time.'%')->delete();
                            $deleteHTAT = DB::table('qlhs_hotrotienan')->where('type_code', 'LIKE', '%'.'HTAT-'.$user.'-'.$truong.'-'.$namhoc.''.((int)$namhoc+1).'-'.$time.'%')->delete();
                            // return false;
                        }
                    }else{
                        // return false;
                    }
                return $insert_returnID;
            }
            else {
                return 0;
            }
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportforSchoolsHTAT($id, $type = true){
    //$type = true;
        if (is_null($id) || empty($id) || $id == 0) {
            return "Mời bấm vào tên danh sách muốn kết xuất để kêt xuất file Excel!";
        }

        $getSchoolName = DB::table('qlhs_hosobaocao')->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hosobaocao.report_id_truong')->where('qlhs_hosobaocao.report_id', '=', $id)->select('qlhs_schools.schools_name', 'qlhs_hosobaocao.report_type', 'qlhs_hosobaocao.report_year')->first();
        $data_results = [];
        $data_results['aT'] = 'Học sinh có mặt tại trường tháng 5/' . $getSchoolName->report_year;
        $data_results['bT'] = 'Học sinh dự kiến tuyển mới năm học ' . $getSchoolName->report_year . '-' . ((int)$getSchoolName->report_year + 1);
        $data_results['cT'] = 'Học sinh dự kiến tuyển mới năm học ' . ((int)$getSchoolName->report_year + 1) . '-' . ((int)$getSchoolName->report_year + 2);
        if ($getSchoolName->report_type != null && $getSchoolName->report_type != "") {
            $data_results['aCount'] = $this->countValueHTAT('1',$getSchoolName->report_type);
            $data_results['bCount'] = $this->countValueHTAT('2',$getSchoolName->report_type);
            $data_results['cCount'] = $this->countValueHTAT('3',$getSchoolName->report_type);
            $data_results['TotalCount'] = $this->countValueHTAT(null,$getSchoolName->report_type);
            //Get by type A
            $data_results['a'] = DB::table('qlhs_hotrotienan')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrotienan.htta_profile_id')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HTAT"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrotienan.htta_profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrotienan.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrotienan.type', '=', 1)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrotienan.*')->DISTINCT()->get();

            $data_results['b'] = DB::table('qlhs_hotrotienan')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrotienan.htta_profile_id')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HTAT"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrotienan.htta_profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrotienan.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrotienan.type', '=', 2)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrotienan.*')->DISTINCT()->get();

            $data_results['c'] = DB::table('qlhs_hotrotienan')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrotienan.htta_profile_id')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HTAT"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrotienan.htta_profile_id and qlhs_profile_history.history_year = "'.($getSchoolName->report_year + 1).'-'.($getSchoolName->report_year + 2).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrotienan.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrotienan.type', '=', 3)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrotienan.*')->DISTINCT()->get();
        }
        $data_results['schools_name'] = $getSchoolName->schools_name;
        $data_results['report_year'] = $getSchoolName->report_year;
        $this->addCellExcelHTAT($data_results, $getSchoolName->report_type, $type);
    }

    private function addCellExcelHTAT($data_results, $filename, $type = true){
        $excel =    Excel::load(storage_path().'/exceltemplate/laphosoHTAT.xlsx', function($reader) use($data_results){
            $borderArray = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => 'thin',
                        'color' => array('argb' => 'FF000000')
                    )
                )
            );
            $FontArray = array(
                'font' => array(
                    'bold' => 'bold'
                )
            );
            $FontArrayitalic = array(
                'font' => array(
                    'italic' => 'italic'
                )
            );
            $style = array(
                'alignment' => array(
                    'horizontal' => 'center',
                )
            );
            $styleLeft = array(
                'alignment' => array(
                    'horizontal' => 'left',
                )
            );
            $styleRight = array(
                'alignment' => array(
                    'horizontal' => 'right',
                )
            );
            $row = 8;

            $col = 0;
            $colA = 0;

            $class_lv1 = 0;
            $class_lv2 = 0;
            $class_lv3 = 0;

            //-----------------------------------------Title------------------------------------------------------------------------------------------------
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, 2, 'NHU CẦU KINH PHÍ NĂM '.$data_results['report_year'].', DỰ TOÁN NĂM '.($data_results['report_year'] + 1).' ĐỐI VỚI CHÍNH SÁCH HỖ TRỢ ĂN TRƯA CHO TRẺ EM MẪU GIÁO THEO QUYẾT ĐỊNH SỐ 60/QĐ-TTG CỦA THỦ TƯỚNG CHÍNH PHỦ')->getStyle('A2')->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 5, 'Thông tin cơ bản (tính tại thời điểm tháng 5/'.$data_results['report_year'].')')->getStyle('C5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 7, 'Học kì II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('C7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, 7, 'Năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('D7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, 7, 'Năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('E7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, 7, 'Học kỳ II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('S7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, 7, 'Học kỳ I năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('T7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, 7, 'Học kỳ II năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('U7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, 7, 'Học kỳ I năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('V7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, 5, 'Nhu cầu kinh phí năm '.$data_results['report_year'])->getStyle('W5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, 5, 'Dự toán kinh phí năm '.($data_results['report_year'] + 1))->getStyle('X5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            //-----------------------------------------End Title----------------------------------------------------------------------------------------------------

            //$data_results['aCount'][0]
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['schools_name'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($FontArrayitalic)->applyFromArray($styleLeft);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['TotalCount']->tonghtta_doituong1)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['TotalCount']->tonghtta_doituong2)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['TotalCount']->tonghtta_doituong3)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['TotalCount']->tonghtta_doituong4)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['TotalCount']->tonghocky2_old)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['TotalCount']->tonghocky1_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['TotalCount']->tonghocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['TotalCount']->tonghocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['TotalCount']->tongnhu_cau)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['TotalCount']->tongdu_toan)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'a')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            //____________________________________________________________________________________________________________________________________________________
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['aT'])->getStyle('B'.$row)->applyFromArray($FontArray)->applyFromArray($styleLeft);
            
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['aCount']->tonghtta_doituong1)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['aCount']->tonghtta_doituong2)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['aCount']->tonghtta_doituong3)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['aCount']->tonghtta_doituong4)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['aCount']->tonghocky2_old)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['aCount']->tonghocky1_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['aCount']->tonghocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['aCount']->tonghocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['aCount']->tongnhu_cau)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['aCount']->tongdu_toan)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            if($data_results['a']->count()>0){
                $indexa = 0;
                foreach($data_results['a'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next_1;
                    //  $class_lv2 = $value->level_next_2;
                    //  $class_lv3 = $value->level_next_3;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_confirmation)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_number)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$decided_date)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong1)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong2)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong3)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong4)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhu_cau)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->du_toan)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }
            //b

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'b')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['bT'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['bCount']->tonghtta_doituong1)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['bCount']->tonghtta_doituong2)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['bCount']->tonghtta_doituong3)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['bCount']->tonghtta_doituong4)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['bCount']->tonghocky2_old)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['bCount']->tonghocky1_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['bCount']->tonghocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['bCount']->tonghocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['bCount']->tongnhu_cau)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['bCount']->tongdu_toan)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexb = 0;

            if($data_results['b']->count()>0){
                $indexa = 0;
                foreach($data_results['b'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_confirmation)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_number)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$decided_date)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong1)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong2)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong3)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong4)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhu_cau)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->du_toan)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }

                //c

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'c')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['cT'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['cCount']->tonghtta_doituong1)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['cCount']->tonghtta_doituong2)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['cCount']->tonghtta_doituong3)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['cCount']->tonghtta_doituong4)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['cCount']->tonghocky2_old)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['cCount']->tonghocky1_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['cCount']->tonghocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['cCount']->tonghocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['cCount']->tongnhu_cau)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['cCount']->tongdu_toan)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexc = 0;
            if($data_results['c']->count()>0){
                $indexa = 0;
                foreach($data_results['c'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_confirmation)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->decided_number)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$decided_date)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong1)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong2)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong3)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->htta_doituong4)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhu_cau)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->du_toan)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                }
            }
        });
        if($type){
            return $excel->setFilename($filename)->store('xlsx', storage_path().'/exceldownload/HTAT');
        }else{
            return $excel->setFilename($filename)->download('xlsx');
        }
    }
    
    public function countValueHTAT($type = null,$code){

        if($type!=null){
            $count = DB::table('qlhs_hotrotienan')->where('type_code','=',$code)->where('type','=',$type)
            ->select(
                DB::raw('sum(htta_doituong1) as tonghtta_doituong1'),
                DB::raw('sum(htta_doituong2) as tonghtta_doituong2'),
                DB::raw('sum(htta_doituong3) as tonghtta_doituong3'),
                DB::raw('sum(htta_doituong4) as tonghtta_doituong4'),
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhu_cau) as tongnhu_cau'),
                DB::raw('sum(du_toan) as tongdu_toan'))->first();
            return $count;
        }else{
            $count = DB::table('qlhs_hotrotienan')->where('type_code','=',$code)
            ->select(
                DB::raw('sum(htta_doituong1) as tonghtta_doituong1'),
                DB::raw('sum(htta_doituong2) as tonghtta_doituong2'),
                DB::raw('sum(htta_doituong3) as tonghtta_doituong3'),
                DB::raw('sum(htta_doituong4) as tonghtta_doituong4'),
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhu_cau) as tongnhu_cau'),
                DB::raw('sum(du_toan) as tongdu_toan'))->first();
            return $count;
        }
    }

//---------------------------------------------------------------------HTBT---------------------------------------------------------------------------
    public function getDataHTBT($school_id, $year, $report_name, $user_sign, $user_create, $note, $status, $capnhan){
        $result = [];
        try {
            
            $current_user_id = Auth::user()->id;
            $current_date = Carbon::now('Asia/Ho_Chi_Minh');
            

            $check = TRUE;

            $getDataTypeA = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id in (34, 46, 72) AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HTBT_TA = 1 or yearold.qlhs_thcd_trangthai_HTBT_TO = 1 or yearold.qlhs_thcd_trangthai_HTBT_VHTT = 1 or yearold.qlhs_thcd_trangthai_HTBT_TA_HK2 = 1 or yearold.qlhs_thcd_trangthai_HTBT_TO_HK2 = 1 or yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year.' and (yearcur.qlhs_thcd_trangthai_HTBT_TA = 1 or yearcur.qlhs_thcd_trangthai_HTBT_TO = 1 or yearcur.qlhs_thcd_trangthai_HTBT_VHTT = 1 or yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2 = 1 or yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2 = 1 or yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
            
            ->where('qlhs_profile.profile_year', '<', $year.'-06-01')
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HTBT_TA_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TA > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTBT_TA > 0 OR yearold.qlhs_thcd_trangthai_HTBT_TO_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TO > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTBT_TO > 0 OR yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_VHTT > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTBT_VHTT > 0)'))
            
            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 'profile_bantru', 

                'yearold.qlhs_thcd_trangthai_HTBT_TA as old_HTBT_TA', 'yearold.qlhs_thcd_trangthai_HTBT_TA_HK2 as old_HTBT_TA_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_TO as old_HTBT_TO', 'yearold.qlhs_thcd_trangthai_HTBT_TO_HK2 as old_HTBT_TO_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_VHTT as old_HTBT_VHTT', 'yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2 as old_HTBT_VHTT_HK2', 

                'yearcur.qlhs_thcd_trangthai_HTBT_TA as cur_HTBT_TA', 'yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2 as cur_HTBT_TA_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_TO as cur_HTBT_TO', 'yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2 as cur_HTBT_TO_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_VHTT as cur_HTBT_VHTT', 'yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2 as cur_HTBT_VHTT_HK2',

                'yearnew.qlhs_thcd_trangthai_HTBT_TA as new_HTBT_TA', 'yearnew.qlhs_thcd_trangthai_HTBT_TA_HK2 as new_HTBT_TA_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_TO as new_HTBT_TO', 'yearnew.qlhs_thcd_trangthai_HTBT_TO_HK2 as new_HTBT_TO_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_VHTT as new_HTBT_VHTT', 'yearnew.qlhs_thcd_trangthai_HTBT_VHTT_HK2 as new_HTBT_VHTT_HK2', 
                
                'yearold.qlhs_thcd_tien_nhucau_HTBT_TA as money_TA_old', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TA_HK2 as money_TA_old_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_TO as money_TO_old', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TO_HK2 as money_TO_old_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT as money_VHTT_old', 'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2 as money_VHTT_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA as money_TA_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA_HK2 as money_TA_cur_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO as money_TO_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO_HK2 as money_TO_cur_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT as money_VHTT_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2 as money_VHTT_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA as money_TA_new', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA_HK2 as money_TA_new_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO as money_TO_new', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO_HK2 as money_TO_new_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT as money_VHTT_new', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2 as money_VHTT_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 46 then 1 else 0 END) as hotrotienan'), 
                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 46 then 1 else 0 END) as hotrotieno'), 
                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 46 then 1 else 0 END) as hotroVHTT'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotrotienan_hocky2_old'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotrotieno_hocky2_old'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotroVHTT_hocky2_old'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotrotienan_hocky1_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotrotieno_hocky1_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotroVHTT_hocky1_cur'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotrotienan_hocky2_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotrotieno_hocky2_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year +1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotroVHTT_hocky2_cur'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotrotienan_hocky1_new'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotrotieno_hocky1_new'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year +1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotroVHTT_hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 'profile_bantru', 

                'yearold.qlhs_thcd_trangthai_HTBT_TA', 'yearold.qlhs_thcd_trangthai_HTBT_TA_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_TO', 'yearold.qlhs_thcd_trangthai_HTBT_TO_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_VHTT', 'yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2', 

                'yearcur.qlhs_thcd_trangthai_HTBT_TA', 'yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_TO', 'yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_VHTT', 'yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2',

                'yearnew.qlhs_thcd_trangthai_HTBT_TA', 'yearnew.qlhs_thcd_trangthai_HTBT_TA_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_TO', 'yearnew.qlhs_thcd_trangthai_HTBT_TO_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_VHTT', 'yearnew.qlhs_thcd_trangthai_HTBT_VHTT_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HTBT_TA', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TA_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_TO', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TO_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT', 'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2');

            $getDataType1 = DB::table(DB::raw("({$getDataTypeA->toSql()}) as m"))
                ->mergeBindings( $getDataTypeA )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.profile_bantru',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrotienan', 'm.hotrotieno', 'm.hotroVHTT', //'m.ongoaitruong', 
                        'm.hotrotienan_hocky2_old', 'm.hotrotieno_hocky2_old', 'm.hotroVHTT_hocky2_old',
                        'm.hotrotienan_hocky1_cur', 'm.hotrotieno_hocky1_cur', 'm.hotroVHTT_hocky1_cur',
                        'm.hotrotienan_hocky2_cur', 'm.hotrotieno_hocky2_cur', 'm.hotroVHTT_hocky2_cur',
                        'm.hotrotienan_hocky1_new', 'm.hotrotieno_hocky1_new', 'm.hotroVHTT_hocky1_new',

                        'm.old_HTBT_TA', 'm.old_HTBT_TA_HK2', 
                        'm.old_HTBT_TO', 'm.old_HTBT_TO_HK2', 
                        'm.old_HTBT_VHTT', 'm.old_HTBT_VHTT_HK2', 

                        'm.cur_HTBT_TA', 'm.cur_HTBT_TA_HK2',
                        'm.cur_HTBT_TO', 'm.cur_HTBT_TO_HK2',
                        'm.cur_HTBT_VHTT', 'm.cur_HTBT_VHTT_HK2',

                        'm.new_HTBT_TA', 'm.new_HTBT_TA_HK2', 
                        'm.new_HTBT_TO', 'm.new_HTBT_TO_HK2', 
                        'm.new_HTBT_VHTT', 'm.new_HTBT_VHTT_HK2', 

                        'm.money_TA_old', 'm.money_TA_old_HK2', 'm.money_TO_old', 'm.money_TO_old_HK2', 'm.money_VHTT_old', 'm.money_VHTT_old_HK2', 
                        'm.money_TA_cur', 'm.money_TA_cur_HK2', 'm.money_TO_cur', 'm.money_TO_cur_HK2', 'm.money_VHTT_cur', 'm.money_VHTT_cur_HK2', 
                        'm.money_TA_new', 'm.money_TA_new_HK2', 'm.money_TO_new', 'm.money_TO_new_HK2', 'm.money_VHTT_new', 'm.money_VHTT_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.profile_bantru',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrotienan', 'm.hotrotieno', 'm.hotroVHTT', //'m.ongoaitruong', 
                        'm.hotrotienan_hocky2_old', 'm.hotrotieno_hocky2_old', 'm.hotroVHTT_hocky2_old',
                        'm.hotrotienan_hocky1_cur', 'm.hotrotieno_hocky1_cur', 'm.hotroVHTT_hocky1_cur',
                        'm.hotrotienan_hocky2_cur', 'm.hotrotieno_hocky2_cur', 'm.hotroVHTT_hocky2_cur',
                        'm.hotrotienan_hocky1_new', 'm.hotrotieno_hocky1_new', 'm.hotroVHTT_hocky1_new',

                        'm.old_HTBT_TA', 'm.old_HTBT_TA_HK2', 
                        'm.old_HTBT_TO', 'm.old_HTBT_TO_HK2', 
                        'm.old_HTBT_VHTT', 'm.old_HTBT_VHTT_HK2', 

                        'm.cur_HTBT_TA', 'm.cur_HTBT_TA_HK2',
                        'm.cur_HTBT_TO', 'm.cur_HTBT_TO_HK2',
                        'm.cur_HTBT_VHTT', 'm.cur_HTBT_VHTT_HK2',

                        'm.new_HTBT_TA', 'm.new_HTBT_TA_HK2', 
                        'm.new_HTBT_TO', 'm.new_HTBT_TO_HK2', 
                        'm.new_HTBT_VHTT', 'm.new_HTBT_VHTT_HK2', 

                        'm.money_TA_old', 'm.money_TA_old_HK2', 'm.money_TO_old', 'm.money_TO_old_HK2', 'm.money_VHTT_old', 'm.money_VHTT_old_HK2', 
                        'm.money_TA_cur', 'm.money_TA_cur_HK2', 'm.money_TO_cur', 'm.money_TO_cur_HK2', 'm.money_VHTT_cur', 'm.money_VHTT_cur_HK2', 
                        'm.money_TA_new', 'm.money_TA_new_HK2', 'm.money_TO_new', 'm.money_TO_new_HK2', 'm.money_VHTT_new', 'm.money_VHTT_new_HK2')
                ->get();

            $getDataTypeB = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id in (34, 46, 72) AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HTBT_TA = 1 or yearold.qlhs_thcd_trangthai_HTBT_TO = 1 or yearold.qlhs_thcd_trangthai_HTBT_VHTT = 1 or yearold.qlhs_thcd_trangthai_HTBT_TA_HK2 = 1 or yearold.qlhs_thcd_trangthai_HTBT_TO_HK2 = 1 or yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
            
            ->where('qlhs_profile.profile_year', '>', $year.'-05-31')
            ->where('qlhs_profile.profile_year', '<', ($year + 1).'-06-01')
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HTBT_TA_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TA > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTBT_TA > 0 OR yearold.qlhs_thcd_trangthai_HTBT_TO_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TO > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTBT_TO > 0 OR yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_VHTT > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTBT_VHTT > 0)'))
            
            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 'profile_bantru', 

                'yearold.qlhs_thcd_trangthai_HTBT_TA as old_HTBT_TA', 'yearold.qlhs_thcd_trangthai_HTBT_TA_HK2 as old_HTBT_TA_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_TO as old_HTBT_TO', 'yearold.qlhs_thcd_trangthai_HTBT_TO_HK2 as old_HTBT_TO_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_VHTT as old_HTBT_VHTT', 'yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2 as old_HTBT_VHTT_HK2', 

                'yearcur.qlhs_thcd_trangthai_HTBT_TA as cur_HTBT_TA', 'yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2 as cur_HTBT_TA_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_TO as cur_HTBT_TO', 'yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2 as cur_HTBT_TO_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_VHTT as cur_HTBT_VHTT', 'yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2 as cur_HTBT_VHTT_HK2',

                'yearnew.qlhs_thcd_trangthai_HTBT_TA as new_HTBT_TA', 'yearnew.qlhs_thcd_trangthai_HTBT_TA_HK2 as new_HTBT_TA_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_TO as new_HTBT_TO', 'yearnew.qlhs_thcd_trangthai_HTBT_TO_HK2 as new_HTBT_TO_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_VHTT as new_HTBT_VHTT', 'yearnew.qlhs_thcd_trangthai_HTBT_VHTT_HK2 as new_HTBT_VHTT_HK2', 
                
                'yearold.qlhs_thcd_tien_nhucau_HTBT_TA as money_TA_old', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TA_HK2 as money_TA_old_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_TO as money_TO_old', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TO_HK2 as money_TO_old_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT as money_VHTT_old', 'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2 as money_VHTT_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA as money_TA_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA_HK2 as money_TA_cur_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO as money_TO_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO_HK2 as money_TO_cur_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT as money_VHTT_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2 as money_VHTT_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA as money_TA_new', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA_HK2 as money_TA_new_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO as money_TO_new', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO_HK2 as money_TO_new_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT as money_VHTT_new', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2 as money_VHTT_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 46 then 1 else 0 END) as hotrotienan'), 
                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 46 then 1 else 0 END) as hotrotieno'), 
                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 46 then 1 else 0 END) as hotroVHTT'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotrotienan_hocky2_old'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotrotieno_hocky2_old'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotroVHTT_hocky2_old'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotrotienan_hocky1_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotrotieno_hocky1_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotroVHTT_hocky1_cur'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotrotienan_hocky2_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotrotieno_hocky2_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year +1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotroVHTT_hocky2_cur'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotrotienan_hocky1_new'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotrotieno_hocky1_new'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year +1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotroVHTT_hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 'profile_bantru', 

                'yearold.qlhs_thcd_trangthai_HTBT_TA', 'yearold.qlhs_thcd_trangthai_HTBT_TA_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_TO', 'yearold.qlhs_thcd_trangthai_HTBT_TO_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_VHTT', 'yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2', 

                'yearcur.qlhs_thcd_trangthai_HTBT_TA', 'yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_TO', 'yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_VHTT', 'yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2',

                'yearnew.qlhs_thcd_trangthai_HTBT_TA', 'yearnew.qlhs_thcd_trangthai_HTBT_TA_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_TO', 'yearnew.qlhs_thcd_trangthai_HTBT_TO_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_VHTT', 'yearnew.qlhs_thcd_trangthai_HTBT_VHTT_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HTBT_TA', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TA_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_TO', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TO_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT', 'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2');

            $getDataType2 = DB::table(DB::raw("({$getDataTypeB->toSql()}) as m"))
                ->mergeBindings( $getDataTypeB )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.profile_bantru',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrotienan', 'm.hotrotieno', 'm.hotroVHTT', //'m.ongoaitruong', 
                        'm.hotrotienan_hocky2_old', 'm.hotrotieno_hocky2_old', 'm.hotroVHTT_hocky2_old',
                        'm.hotrotienan_hocky1_cur', 'm.hotrotieno_hocky1_cur', 'm.hotroVHTT_hocky1_cur',
                        'm.hotrotienan_hocky2_cur', 'm.hotrotieno_hocky2_cur', 'm.hotroVHTT_hocky2_cur',
                        'm.hotrotienan_hocky1_new', 'm.hotrotieno_hocky1_new', 'm.hotroVHTT_hocky1_new',

                        'm.old_HTBT_TA', 'm.old_HTBT_TA_HK2', 
                        'm.old_HTBT_TO', 'm.old_HTBT_TO_HK2', 
                        'm.old_HTBT_VHTT', 'm.old_HTBT_VHTT_HK2', 

                        'm.cur_HTBT_TA', 'm.cur_HTBT_TA_HK2',
                        'm.cur_HTBT_TO', 'm.cur_HTBT_TO_HK2',
                        'm.cur_HTBT_VHTT', 'm.cur_HTBT_VHTT_HK2',

                        'm.new_HTBT_TA', 'm.new_HTBT_TA_HK2', 
                        'm.new_HTBT_TO', 'm.new_HTBT_TO_HK2', 
                        'm.new_HTBT_VHTT', 'm.new_HTBT_VHTT_HK2', 

                        'm.money_TA_old', 'm.money_TA_old_HK2', 'm.money_TO_old', 'm.money_TO_old_HK2', 'm.money_VHTT_old', 'm.money_VHTT_old_HK2', 
                        'm.money_TA_cur', 'm.money_TA_cur_HK2', 'm.money_TO_cur', 'm.money_TO_cur_HK2', 'm.money_VHTT_cur', 'm.money_VHTT_cur_HK2', 
                        'm.money_TA_new', 'm.money_TA_new_HK2', 'm.money_TO_new', 'm.money_TO_new_HK2', 'm.money_VHTT_new', 'm.money_VHTT_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.profile_bantru',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrotienan', 'm.hotrotieno', 'm.hotroVHTT', //'m.ongoaitruong', 
                        'm.hotrotienan_hocky2_old', 'm.hotrotieno_hocky2_old', 'm.hotroVHTT_hocky2_old',
                        'm.hotrotienan_hocky1_cur', 'm.hotrotieno_hocky1_cur', 'm.hotroVHTT_hocky1_cur',
                        'm.hotrotienan_hocky2_cur', 'm.hotrotieno_hocky2_cur', 'm.hotroVHTT_hocky2_cur',
                        'm.hotrotienan_hocky1_new', 'm.hotrotieno_hocky1_new', 'm.hotroVHTT_hocky1_new',

                        'm.old_HTBT_TA', 'm.old_HTBT_TA_HK2', 
                        'm.old_HTBT_TO', 'm.old_HTBT_TO_HK2', 
                        'm.old_HTBT_VHTT', 'm.old_HTBT_VHTT_HK2', 

                        'm.cur_HTBT_TA', 'm.cur_HTBT_TA_HK2',
                        'm.cur_HTBT_TO', 'm.cur_HTBT_TO_HK2',
                        'm.cur_HTBT_VHTT', 'm.cur_HTBT_VHTT_HK2',

                        'm.new_HTBT_TA', 'm.new_HTBT_TA_HK2', 
                        'm.new_HTBT_TO', 'm.new_HTBT_TO_HK2', 
                        'm.new_HTBT_VHTT', 'm.new_HTBT_VHTT_HK2', 

                        'm.money_TA_old', 'm.money_TA_old_HK2', 'm.money_TO_old', 'm.money_TO_old_HK2', 'm.money_VHTT_old', 'm.money_VHTT_old_HK2', 
                        'm.money_TA_cur', 'm.money_TA_cur_HK2', 'm.money_TO_cur', 'm.money_TO_cur_HK2', 'm.money_VHTT_cur', 'm.money_VHTT_cur_HK2', 
                        'm.money_TA_new', 'm.money_TA_new_HK2', 'm.money_TO_new', 'm.money_TO_new_HK2', 'm.money_VHTT_new', 'm.money_VHTT_new_HK2')
                ->get();

            $getDataTypeC = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id in (34, 46, 72) AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.($year + 1).' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.($year + 1).')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.($year + 1).'-'.($year + 2).'"'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.$year.''))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', 'profile_id')
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 2).''))
            
            ->where('qlhs_profile.profile_year', '>', ($year + 1).'-05-31')
            ->where('qlhs_profile.profile_year', '<', ($year + 2).'-06-01')
            ->where('yearcur.qlhs_thcd_nam', '=', ($year + 1))
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HTBT_TA_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TA > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTBT_TA > 0 OR yearold.qlhs_thcd_trangthai_HTBT_TO_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TO > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTBT_TO > 0 OR yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_VHTT > 0 OR yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTBT_VHTT > 0)'))

            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 'profile_bantru', 

                'yearold.qlhs_thcd_trangthai_HTBT_TA as old_HTBT_TA', 'yearold.qlhs_thcd_trangthai_HTBT_TA_HK2 as old_HTBT_TA_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_TO as old_HTBT_TO', 'yearold.qlhs_thcd_trangthai_HTBT_TO_HK2 as old_HTBT_TO_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_VHTT as old_HTBT_VHTT', 'yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2 as old_HTBT_VHTT_HK2', 

                'yearcur.qlhs_thcd_trangthai_HTBT_TA as cur_HTBT_TA', 'yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2 as cur_HTBT_TA_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_TO as cur_HTBT_TO', 'yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2 as cur_HTBT_TO_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_VHTT as cur_HTBT_VHTT', 'yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2 as cur_HTBT_VHTT_HK2',

                'yearnew.qlhs_thcd_trangthai_HTBT_TA as new_HTBT_TA', 'yearnew.qlhs_thcd_trangthai_HTBT_TA_HK2 as new_HTBT_TA_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_TO as new_HTBT_TO', 'yearnew.qlhs_thcd_trangthai_HTBT_TO_HK2 as new_HTBT_TO_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_VHTT as new_HTBT_VHTT', 'yearnew.qlhs_thcd_trangthai_HTBT_VHTT_HK2 as new_HTBT_VHTT_HK2', 
                
                'yearold.qlhs_thcd_tien_nhucau_HTBT_TA as money_TA_old', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TA_HK2 as money_TA_old_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_TO as money_TO_old', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TO_HK2 as money_TO_old_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT as money_VHTT_old', 'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2 as money_VHTT_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA as money_TA_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA_HK2 as money_TA_cur_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO as money_TO_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO_HK2 as money_TO_cur_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT as money_VHTT_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2 as money_VHTT_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA as money_TA_new', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA_HK2 as money_TA_new_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO as money_TO_new', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO_HK2 as money_TO_new_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT as money_VHTT_new', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2 as money_VHTT_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 46 then 1 else 0 END) as hotrotienan'), 
                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 46 then 1 else 0 END) as hotrotieno'), 
                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 46 then 1 else 0 END) as hotroVHTT'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotrotienan_hocky2_old'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotrotieno_hocky2_old'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotroVHTT_hocky2_old'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotrotienan_hocky1_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotrotieno_hocky1_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotroVHTT_hocky1_cur'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotrotienan_hocky2_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotrotieno_hocky2_cur'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year +1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotroVHTT_hocky2_cur'), 

                DB::raw('MAX(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotrotienan_hocky1_new'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile_subject.profile_subject_subject_id = 46 and qlhs_profile.profile_year < "'.($year +1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotrotieno_hocky1_new'), 
                DB::raw('MAX(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year +1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotroVHTT_hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 'profile_bantru', 

                'yearold.qlhs_thcd_trangthai_HTBT_TA', 'yearold.qlhs_thcd_trangthai_HTBT_TA_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_TO', 'yearold.qlhs_thcd_trangthai_HTBT_TO_HK2', 
                'yearold.qlhs_thcd_trangthai_HTBT_VHTT', 'yearold.qlhs_thcd_trangthai_HTBT_VHTT_HK2', 

                'yearcur.qlhs_thcd_trangthai_HTBT_TA', 'yearcur.qlhs_thcd_trangthai_HTBT_TA_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_TO', 'yearcur.qlhs_thcd_trangthai_HTBT_TO_HK2',
                'yearcur.qlhs_thcd_trangthai_HTBT_VHTT', 'yearcur.qlhs_thcd_trangthai_HTBT_VHTT_HK2',

                'yearnew.qlhs_thcd_trangthai_HTBT_TA', 'yearnew.qlhs_thcd_trangthai_HTBT_TA_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_TO', 'yearnew.qlhs_thcd_trangthai_HTBT_TO_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTBT_VHTT', 'yearnew.qlhs_thcd_trangthai_HTBT_VHTT_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HTBT_TA', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TA_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_TO', 'yearold.qlhs_thcd_tien_nhucau_HTBT_TO_HK2', 
                'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT', 'yearold.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TA_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_TO_HK2', 
                'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT', 'yearcur.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TA_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_TO_HK2', 
                'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT', 'yearnew.qlhs_thcd_tien_nhucau_HTBT_VHTT_HK2');

            $getDataType3 = DB::table(DB::raw("({$getDataTypeC->toSql()}) as m"))
                ->mergeBindings( $getDataTypeC )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.profile_bantru',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrotienan', 'm.hotrotieno', 'm.hotroVHTT', //'m.ongoaitruong', 
                        'm.hotrotienan_hocky2_old', 'm.hotrotieno_hocky2_old', 'm.hotroVHTT_hocky2_old',
                        'm.hotrotienan_hocky1_cur', 'm.hotrotieno_hocky1_cur', 'm.hotroVHTT_hocky1_cur',
                        'm.hotrotienan_hocky2_cur', 'm.hotrotieno_hocky2_cur', 'm.hotroVHTT_hocky2_cur',
                        'm.hotrotienan_hocky1_new', 'm.hotrotieno_hocky1_new', 'm.hotroVHTT_hocky1_new',

                        'm.old_HTBT_TA', 'm.old_HTBT_TA_HK2', 
                        'm.old_HTBT_TO', 'm.old_HTBT_TO_HK2', 
                        'm.old_HTBT_VHTT', 'm.old_HTBT_VHTT_HK2', 

                        'm.cur_HTBT_TA', 'm.cur_HTBT_TA_HK2',
                        'm.cur_HTBT_TO', 'm.cur_HTBT_TO_HK2',
                        'm.cur_HTBT_VHTT', 'm.cur_HTBT_VHTT_HK2',

                        'm.new_HTBT_TA', 'm.new_HTBT_TA_HK2', 
                        'm.new_HTBT_TO', 'm.new_HTBT_TO_HK2', 
                        'm.new_HTBT_VHTT', 'm.new_HTBT_VHTT_HK2', 

                        'm.money_TA_old', 'm.money_TA_old_HK2', 'm.money_TO_old', 'm.money_TO_old_HK2', 'm.money_VHTT_old', 'm.money_VHTT_old_HK2', 
                        'm.money_TA_cur', 'm.money_TA_cur_HK2', 'm.money_TO_cur', 'm.money_TO_cur_HK2', 'm.money_VHTT_cur', 'm.money_VHTT_cur_HK2', 
                        'm.money_TA_new', 'm.money_TA_new_HK2', 'm.money_TO_new', 'm.money_TO_new_HK2', 'm.money_VHTT_new', 'm.money_VHTT_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.profile_bantru',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrotienan', 'm.hotrotieno', 'm.hotroVHTT', //'m.ongoaitruong', 
                        'm.hotrotienan_hocky2_old', 'm.hotrotieno_hocky2_old', 'm.hotroVHTT_hocky2_old',
                        'm.hotrotienan_hocky1_cur', 'm.hotrotieno_hocky1_cur', 'm.hotroVHTT_hocky1_cur',
                        'm.hotrotienan_hocky2_cur', 'm.hotrotieno_hocky2_cur', 'm.hotroVHTT_hocky2_cur',
                        'm.hotrotienan_hocky1_new', 'm.hotrotieno_hocky1_new', 'm.hotroVHTT_hocky1_new',

                        'm.old_HTBT_TA', 'm.old_HTBT_TA_HK2', 
                        'm.old_HTBT_TO', 'm.old_HTBT_TO_HK2', 
                        'm.old_HTBT_VHTT', 'm.old_HTBT_VHTT_HK2', 

                        'm.cur_HTBT_TA', 'm.cur_HTBT_TA_HK2',
                        'm.cur_HTBT_TO', 'm.cur_HTBT_TO_HK2',
                        'm.cur_HTBT_VHTT', 'm.cur_HTBT_VHTT_HK2',

                        'm.new_HTBT_TA', 'm.new_HTBT_TA_HK2', 
                        'm.new_HTBT_TO', 'm.new_HTBT_TO_HK2', 
                        'm.new_HTBT_VHTT', 'm.new_HTBT_VHTT_HK2', 

                        'm.money_TA_old', 'm.money_TA_old_HK2', 'm.money_TO_old', 'm.money_TO_old_HK2', 'm.money_VHTT_old', 'm.money_VHTT_old_HK2', 
                        'm.money_TA_cur', 'm.money_TA_cur_HK2', 'm.money_TO_cur', 'm.money_TO_cur_HK2', 'm.money_VHTT_cur', 'm.money_VHTT_cur_HK2', 
                        'm.money_TA_new', 'm.money_TA_new_HK2', 'm.money_TO_new', 'm.money_TO_new_HK2', 'm.money_VHTT_new', 'm.money_VHTT_new_HK2')
                ->get();

            $time = time();

            if ((is_null($getDataType1) || empty($getDataType1) || count($getDataType1) == 0) && (is_null($getDataType2) || empty($getDataType2) || count($getDataType2) == 0) && (is_null($getDataType3) || empty($getDataType3) || count($getDataType3) == 0)) {
                $result['success'] = "Danh sách trống!";
                return $result;
            }

            if (!is_null($getDataType1) && !empty($getDataType1) && count($getDataType1) > 0) {
                $check = $this->insertHTBT($getDataType1, 1, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType2) && !empty($getDataType2) && count($getDataType2) > 0 && $check) {
                $check = $this->insertHTBT($getDataType2, 2, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType3) && !empty($getDataType3) && count($getDataType3) > 0 && $check) {
                $check = $this->insertHTBT($getDataType3, 3, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if ($check) {
                $type_code = 'HTBT-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;


                $insert_hosobaocao_id = DB::table('qlhs_hosobaocao')->insertGetId(['report_name' => $report_name, 'report_type' => $type_code, 'report_date' => $current_date, 'created_at' => $current_date, 'updated_at' => $current_date, 'create_userid' => $current_user_id, 'update_userid' => $current_user_id, 'report_user' => $user_create, 'report_user_sign' => $user_sign, 'report_attach_name' => '', 'report_nature' => $status, 'report_year' => $year, 'report_id_truong' => $school_id, 'report_note' => $note, 'report' => 'HTBT']);


                if (!is_null($insert_hosobaocao_id) && $insert_hosobaocao_id > 0) {
                    $this->exportforSchoolsHTBT($insert_hosobaocao_id);

                    if (file_exists(storage_path().'/exceldownload/HTBT/'.$type_code.'.xlsx')) {
                        
                    }
                    else {
                        $deleteHoso = DB::table('qlhs_hosobaocao')->where('report_type', 'LIKE', '%'.$type_code.'%')->delete();
                        $deleteHTBT = DB::table('qlhs_hotrohocsinhbantru')->where('type_code', 'LIKE', '%'.$type_code.'%')->delete();
                        
                    }
                }
                return $insert_hosobaocao_id;
            }
            else {
                return 0;
            }

            // return $result;
        } catch (Exception $e) {
            return $e;
        }       
    }

    public function insertHTBT($getDataType, $type, $current_user_id, $school_id, $year, $time, $capnhan){
        try {
            $bool = TRUE;
            $count = 1;

            $phongGD_duyet = 0;
            if ($capnhan == 3) {
                $phongGD_duyet = 1;
            }
            
            $type_code = 'HTBT-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

            foreach ($getDataType as $value) {

                $nhucautienan = 0;
                $nhucautieno = 0;
                $nhucauVHTT = 0;
                $dutoantienan = 0;
                $dutoantieno = 0;
                $dutoanVHTT = 0;
                $tongnhucau = 0;
                $tongdutoan = 0;

                if ($value->hotroVHTT == 1 || $value->hotrotienan == 1 || $value->hotrotieno == 1) {

                    if ($type != 3) {
                        $nhucautienan = ($value->money_TA_old_HK2 * $value->old_HTBT_TA_HK2) + ($value->money_TA_cur * $value->cur_HTBT_TA);

                        if ($value->profile_bantru == 0) {
                            $nhucautieno = ($value->money_TO_old_HK2 * $value->old_HTBT_TO_HK2) + ($value->money_TO_cur * $value->cur_HTBT_TO);
                        }
                        
                        $nhucauVHTT = ($value->money_VHTT_old_HK2 * $value->old_HTBT_VHTT_HK2) + ($value->money_VHTT_cur * $value->cur_HTBT_VHTT);
                        $tongnhucau = ($nhucautienan + $nhucautieno + $nhucauVHTT);

                        $dutoantienan = ($value->money_TA_cur_HK2 * $value->cur_HTBT_TA_HK2) + $value->money_TA_new;

                        if ($value->profile_bantru == 0) {
                            $dutoantieno = ($value->money_TO_cur_HK2 * $value->cur_HTBT_TO_HK2) + $value->money_TO_new;
                        }

                        $dutoanVHTT = ($value->money_VHTT_cur_HK2 * $value->cur_HTBT_VHTT_HK2) + $value->money_VHTT_new;
                        $tongdutoan = ($dutoantienan + $dutoantieno + $dutoanVHTT);
                    }
                    else if ($type == 3){
                        $dutoantienan = ($value->money_TA_old_HK2 * $value->old_HTBT_TA_HK2) + $value->money_TA_cur;

                        if ($value->profile_bantru == 0) {
                            $dutoantieno = ($value->money_TO_old_HK2 * $value->old_HTBT_TO_HK2) + $value->money_TO_cur;
                        }
                        
                        $dutoanVHTT = ($value->money_VHTT_old_HK2 * $value->old_HTBT_VHTT_HK2) + $value->money_VHTT_cur;
                        $tongdutoan = ($dutoantienan + $dutoantieno + $dutoanVHTT);
                    }

                    if ($tongnhucau > 0 || $tongdutoan > 0) {
                        $insert_type = DB::table('qlhs_hotrohocsinhbantru')
                        ->insert([
                            'profile_id' => $value->profile_id, 
                            'hotrotienan' => $value->hotrotienan, 
                            'hotrotieno' => $value->hotrotieno, 
                            'hotrotienan_hocky2_old' => $value->hotrotienan_hocky2_old, 
                            'hotrotieno_hocky2_old' => $value->hotrotieno_hocky2_old, 
                            'hotrotienan_hocky1_cur' => $value->hotrotienan_hocky1_cur, 
                            'hotrotieno_hocky1_cur' => $value->hotrotieno_hocky1_cur, 
                            'hotrotienan_hocky2_cur' => $value->hotrotienan_hocky2_cur, 
                            'hotrotieno_hocky2_cur' => $value->hotrotieno_hocky2_cur, 
                            'hotrotienan_hocky1_new' => $value->hotrotienan_hocky1_new, 
                            'hotrotieno_hocky1_new' => $value->hotrotieno_hocky1_new, 
                            'nhucau_hotrotienan' => $nhucautienan, 
                            'nhucau_hotrotieno' => $nhucautieno, 
                            'nhucau_VHTT' => $nhucauVHTT, 
                            'tong_nhucau' => $tongnhucau, 
                            'dutoan_hotrotienan' => $dutoantienan, 
                            'dutoan_hotrotieno' => $dutoantieno, 
                            'dutoan_VHTT' => $dutoanVHTT, 
                            'tong_dutoan' => $tongdutoan, 
                            'type_code' => $type_code, 
                            'type' => $type,
                            'trangthai_pheduyet_HTBT' => 1,
                            'trangthai_phongGD_HTBT' => $phongGD_duyet,
                            'trangthai_phongTC_HTBT' => 0,
                            'trangthai_So_HTBT' => 0
                            ]);

                        $count++;
                        if ($insert_type == 0) {
                            
                            $deleteHTBT = DB::table('qlhs_hotrohocsinhbantru')->where('type_code', 'LIKE', '%'.$type_code.'%')->where('type', '=', $type)->delete();
                            $count--;
                            break;
                        }
                    }
                }
            }
            
            if ($count > 1) {
                $bool = TRUE;
            }
            else {
                $bool = FALSE;
            }

            return TRUE;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportforSchoolsHTBT($id, $type = true){
    //$type = true;
        if (is_null($id) || empty($id) || $id == 0) {
            return "Mời bấm vào tên danh sách muốn kết xuất để kêt xuất file Excel!";
        }

        $getSchoolName = DB::table('qlhs_hosobaocao')->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hosobaocao.report_id_truong')->where('qlhs_hosobaocao.report_id', '=', $id)->select('qlhs_schools.schools_name', 'qlhs_hosobaocao.report_type', 'qlhs_hosobaocao.report_year')->first();
        $data_results = [];
        $data_results['aT'] = 'Học sinh có mặt tại trường tháng 5/' . $getSchoolName->report_year;
        $data_results['bT'] = 'Học sinh dự kiến tuyển mới năm học ' . $getSchoolName->report_year . '-' . ((int)$getSchoolName->report_year + 1);
        $data_results['cT'] = 'Học sinh dự kiến tuyển mới năm học ' . ((int)$getSchoolName->report_year + 1) . '-' . ((int)$getSchoolName->report_year + 2);
        if ($getSchoolName->report_type != null && $getSchoolName->report_type != "") {
            $data_results['aCount'] = $this->countValueHTBT('1',$getSchoolName->report_type);
            $data_results['bCount'] = $this->countValueHTBT('2',$getSchoolName->report_type);
            $data_results['cCount'] = $this->countValueHTBT('3',$getSchoolName->report_type);
            $data_results['TotalCount'] = $this->countValueHTBT(null,$getSchoolName->report_type);
            //Get by type A
            $data_results['a'] = DB::table('qlhs_hotrohocsinhbantru')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhbantru.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhbantru.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhbantru.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhbantru.type', '=', 1)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_km', 'qlhs_profile.profile_giaothong', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhbantru.*')->DISTINCT()->get();

            $data_results['b'] = DB::table('qlhs_hotrohocsinhbantru')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhbantru.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhbantru.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhbantru.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhbantru.type', '=', 2)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_km', 'qlhs_profile.profile_giaothong', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhbantru.*')->DISTINCT()->get();

            $data_results['c'] = DB::table('qlhs_hotrohocsinhbantru')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhbantru.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhbantru.profile_id and qlhs_profile_history.history_year = "'.($getSchoolName->report_year + 1).'-'.($getSchoolName->report_year + 2).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhbantru.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhbantru.type', '=', 3)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_km', 'qlhs_profile.profile_giaothong', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhbantru.*')->DISTINCT()->get();
        }
        $data_results['schools_name'] = $getSchoolName->schools_name;
        $data_results['report_year'] = $getSchoolName->report_year;
        $this->addCellExcelHTBT($data_results, $getSchoolName->report_type, $type);
    }

    private function addCellExcelHTBT($data_results, $filename, $type = true){
        $excel =    Excel::load(storage_path().'/exceltemplate/laphosoHTBT.xlsx', function($reader) use($data_results){
            $borderArray = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => 'thin',
                        'color' => array('argb' => 'FF000000')
                    )
                )
            );
            $FontArray = array(
                'font' => array(
                    'bold' => 'bold'
                )
            );
            $FontArrayitalic = array(
                'font' => array(
                    'italic' => 'italic'
                )
            );
            $style = array(
                'alignment' => array(
                    'horizontal' => 'center',
                )
            );
            $styleLeft = array(
                'alignment' => array(
                    'horizontal' => 'left',
                )
            );
            $styleRight = array(
                'alignment' => array(
                    'horizontal' => 'right',
                )
            );
            $row = 8;

            $col = 0;
            $colA = 0;

            $class_lv1 = 0;
            $class_lv2 = 0;
            $class_lv3 = 0;

            //-----------------------------------------Title------------------------------------------------------------------------------------------------
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, 2, 'NHU CẦU KINH PHÍ NĂM '.$data_results['report_year'].', DỰ TOÁN NĂM '.($data_results['report_year'] + 1).' ĐỐI VỚI CHÍNH SÁCH HỖ TRỢ HỌC SINH BÁN TRÚ THEO QUYẾT ĐỊNH SỐ 85/2010/QĐ-TTG CỦA THỦ TƯỚNG CHÍNH PHỦ')->getStyle('A2')->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 4, 'Thông tin cơ bản (tính tại thời điểm tháng 5/'.$data_results['report_year'].')')->getStyle('C4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, 4, 'Nhu cầu kinh phí năm '.$data_results['report_year'])->getStyle('X4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, 4, 'Dự toán kinh phí năm '.($data_results['report_year'] + 1))->getStyle('AB4')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 7, 'Học kì II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('C7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, 7, 'Năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('D7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, 7, 'Năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('E7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, 6, 'Học kỳ II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('P6')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, 6, 'Học kỳ I năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('R6')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, 6, 'Học kỳ II năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('T6')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, 6, 'Học kỳ I năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('V6')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            //-----------------------------------------End Title----------------------------------------------------------------------------------------------------

            //$data_results['aCount'][0]
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['schools_name'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($FontArrayitalic)->applyFromArray($styleLeft);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row, '')->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['TotalCount']->tongtienan_hocky2_old)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['TotalCount']->tongtieno_hocky2_old)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['TotalCount']->tongtienan_hocky1_cur)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['TotalCount']->tongtieno_hocky1_cur)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['TotalCount']->tongtienan_hocky2_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['TotalCount']->tongtieno_hocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['TotalCount']->tongtienan_hocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['TotalCount']->tongtieno_hocky1_new)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['TotalCount']->tong_tongnhucau)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_results['TotalCount']->tongnhucau_hotrotienan)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_results['TotalCount']->tongnhucau_hotrotieno)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_results['TotalCount']->tongnhucau_hotroVHTT)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row,$data_results['TotalCount']->tong_tongdutoan)->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(28, $row,$data_results['TotalCount']->tongdutoan_hotrotienan)->getStyle('AC'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(29, $row,$data_results['TotalCount']->tongdutoan_hotrotieno)->getStyle('AD'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(30, $row,$data_results['TotalCount']->tongdutoan_hotroVHTT)->getStyle('AE'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'a')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            //____________________________________________________________________________________________________________________________________________________
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['aT'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($styleLeft);
            
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row, '')->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['aCount']->tongtienan_hocky2_old)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['aCount']->tongtieno_hocky2_old)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['aCount']->tongtienan_hocky1_cur)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['aCount']->tongtieno_hocky1_cur)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['aCount']->tongtienan_hocky2_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['aCount']->tongtieno_hocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['aCount']->tongtienan_hocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['aCount']->tongtieno_hocky1_new)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['aCount']->tong_tongnhucau)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_results['aCount']->tongnhucau_hotrotienan)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_results['aCount']->tongnhucau_hotrotieno)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_results['aCount']->tongnhucau_hotroVHTT)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row,$data_results['aCount']->tong_tongdutoan)->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(28, $row,$data_results['aCount']->tongdutoan_hotrotienan)->getStyle('AC'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(29, $row,$data_results['aCount']->tongdutoan_hotrotieno)->getStyle('AD'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(30, $row,$data_results['aCount']->tongdutoan_hotroVHTT)->getStyle('AE'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);


            if($data_results['a']->count()>0){
                $indexa = 0;
                foreach($data_results['a'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next_1;
                    //  $class_lv2 = $value->level_next_2;
                    //  $class_lv3 = $value->level_next_3;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_km)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_giaothong)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky2_old)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky2_old)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky1_cur)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky1_cur)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky2_cur)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky2_cur)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky1_new)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky1_new)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tong_nhucau)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau_hotrotienan)->getStyle('Y'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau_hotrotieno)->getStyle('Z'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau_VHTT)->getStyle('AA'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tong_dutoan)->getStyle('AB'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan_hotrotienan)->getStyle('AC'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan_hotrotieno)->getStyle('AD'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);          
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan_VHTT)->getStyle('AE'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }
            //b

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'b')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['bT'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row, '')->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['bCount']->tongtienan_hocky2_old)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['bCount']->tongtieno_hocky2_old)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['bCount']->tongtienan_hocky1_cur)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['bCount']->tongtieno_hocky1_cur)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['bCount']->tongtienan_hocky2_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['bCount']->tongtieno_hocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['bCount']->tongtienan_hocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['bCount']->tongtieno_hocky1_new)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['bCount']->tong_tongnhucau)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_results['bCount']->tongnhucau_hotrotienan)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_results['bCount']->tongnhucau_hotrotieno)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_results['bCount']->tongnhucau_hotroVHTT)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row,$data_results['bCount']->tong_tongdutoan)->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(28, $row,$data_results['bCount']->tongdutoan_hotrotienan)->getStyle('AC'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(29, $row,$data_results['bCount']->tongdutoan_hotrotieno)->getStyle('AD'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(30, $row,$data_results['bCount']->tongdutoan_hotroVHTT)->getStyle('AE'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $indexb = 0;

            if($data_results['b']->count()>0){
                $indexa = 0;
                foreach($data_results['b'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_km)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_giaothong)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky2_old)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky2_old)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky1_cur)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky1_cur)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky2_cur)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky2_cur)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky1_new)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky1_new)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tong_nhucau)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau_hotrotienan)->getStyle('Y'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau_hotrotieno)->getStyle('Z'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau_VHTT)->getStyle('AA'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tong_dutoan)->getStyle('AB'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan_hotrotienan)->getStyle('AC'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan_hotrotieno)->getStyle('AD'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);          
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan_VHTT)->getStyle('AE'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }

                //c

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'c')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['cT'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row, '')->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['cCount']->tongtienan_hocky2_old)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['cCount']->tongtieno_hocky2_old)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['cCount']->tongtienan_hocky1_cur)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['cCount']->tongtieno_hocky1_cur)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['cCount']->tongtienan_hocky2_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['cCount']->tongtieno_hocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['cCount']->tongtienan_hocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['cCount']->tongtieno_hocky1_new)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['cCount']->tong_tongnhucau)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_results['cCount']->tongnhucau_hotrotienan)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_results['cCount']->tongnhucau_hotrotieno)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_results['cCount']->tongnhucau_hotroVHTT)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row,$data_results['cCount']->tong_tongdutoan)->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(28, $row,$data_results['cCount']->tongdutoan_hotrotienan)->getStyle('AC'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(29, $row,$data_results['cCount']->tongdutoan_hotrotieno)->getStyle('AD'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(30, $row,$data_results['cCount']->tongdutoan_hotroVHTT)->getStyle('AE'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $indexc = 0;
            if($data_results['c']->count()>0){
                $indexa = 0;
                foreach($data_results['c'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_km)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_giaothong)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky2_old)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky2_old)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky1_cur)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky1_cur)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky2_cur)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky2_cur)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotienan_hocky1_new)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrotieno_hocky1_new)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tong_nhucau)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau_hotrotienan)->getStyle('Y'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau_hotrotieno)->getStyle('Z'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau_VHTT)->getStyle('AA'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tong_dutoan)->getStyle('AB'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan_hotrotienan)->getStyle('AC'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan_hotrotieno)->getStyle('AD'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);          
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan_VHTT)->getStyle('AE'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                }
            }
        });

        if($type){
            return $excel->setFilename($filename)->store('xlsx', storage_path().'/exceldownload/HTBT');
        }else{
            return $excel->setFilename($filename)->download('xlsx');
        }
    }
    
    public function countValueHTBT($type = null,$code){

        if($type!=null){
            $count = DB::table('qlhs_hotrohocsinhbantru')->where('type_code','=',$code)->where('type','=',$type)
            ->select(
                DB::raw('sum(hotrotienan) as tonghotrotienan'),
                DB::raw('sum(hotrotieno) as tonghotrotieno'),
                DB::raw('sum(hotrotienan_hocky2_old) as tongtienan_hocky2_old'),
                DB::raw('sum(hotrotieno_hocky2_old) as tongtieno_hocky2_old'),
                DB::raw('sum(hotrotienan_hocky1_cur) as tongtienan_hocky1_cur'),
                DB::raw('sum(hotrotieno_hocky1_cur) as tongtieno_hocky1_cur'),
                DB::raw('sum(hotrotienan_hocky2_cur) as tongtienan_hocky2_cur'),
                DB::raw('sum(hotrotieno_hocky2_cur) as tongtieno_hocky2_cur'),
                DB::raw('sum(hotrotienan_hocky1_new) as tongtienan_hocky1_new'),
                DB::raw('sum(hotrotieno_hocky1_new) as tongtieno_hocky1_new'),
                DB::raw('sum(nhucau_hotrotienan) as tongnhucau_hotrotienan'),
                DB::raw('sum(nhucau_hotrotieno) as tongnhucau_hotrotieno'),
                DB::raw('sum(nhucau_VHTT) as tongnhucau_hotroVHTT'),
                DB::raw('sum(tong_nhucau) as tong_tongnhucau'),
                DB::raw('sum(dutoan_hotrotienan) as tongdutoan_hotrotienan'),
                DB::raw('sum(dutoan_hotrotieno) as tongdutoan_hotrotieno'),
                DB::raw('sum(dutoan_VHTT) as tongdutoan_hotroVHTT'),
                DB::raw('sum(tong_dutoan) as tong_tongdutoan'))->first();
            return $count;
        }else{
            $count = DB::table('qlhs_hotrohocsinhbantru')->where('type_code','=',$code)
            ->select(
                DB::raw('sum(hotrotienan) as tonghotrotienan'),
                DB::raw('sum(hotrotieno) as tonghotrotieno'),
                DB::raw('sum(hotrotienan_hocky2_old) as tongtienan_hocky2_old'),
                DB::raw('sum(hotrotieno_hocky2_old) as tongtieno_hocky2_old'),
                DB::raw('sum(hotrotienan_hocky1_cur) as tongtienan_hocky1_cur'),
                DB::raw('sum(hotrotieno_hocky1_cur) as tongtieno_hocky1_cur'),
                DB::raw('sum(hotrotienan_hocky2_cur) as tongtienan_hocky2_cur'),
                DB::raw('sum(hotrotieno_hocky2_cur) as tongtieno_hocky2_cur'),
                DB::raw('sum(hotrotienan_hocky1_new) as tongtienan_hocky1_new'),
                DB::raw('sum(hotrotieno_hocky1_new) as tongtieno_hocky1_new'),
                DB::raw('sum(nhucau_hotrotienan) as tongnhucau_hotrotienan'),
                DB::raw('sum(nhucau_hotrotieno) as tongnhucau_hotrotieno'),
                DB::raw('sum(nhucau_VHTT) as tongnhucau_hotroVHTT'),
                DB::raw('sum(tong_nhucau) as tong_tongnhucau'),
                DB::raw('sum(dutoan_hotrotienan) as tongdutoan_hotrotienan'),
                DB::raw('sum(dutoan_hotrotieno) as tongdutoan_hotrotieno'),
                DB::raw('sum(dutoan_VHTT) as tongdutoan_hotroVHTT'),
                DB::raw('sum(tong_dutoan) as tong_tongdutoan'))->first();
            return $count;
        }
    }

//---------------------------------------------------------------------HSKT---------------------------------------------------------------------------
    public function getDataHSKT($school_id, $year, $report_name, $user_sign, $user_create, $note, $status, $capnhan){
        $result = [];
        try {

            $current_user_id = Auth::user()->id;
            $current_date = Carbon::now('Asia/Ho_Chi_Minh');


            $check = TRUE;

            $getDataTypeA = DB::table('qlhs_profile')
                ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 74 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))
                
                ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HSKT_HB = 1 or yearold.qlhs_thcd_trangthai_HSKT_DDHT = 1 or yearold.qlhs_thcd_trangthai_HSKT_HB_HK2 = 1 or yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2 = 1)'))
                ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year.' and (yearcur.qlhs_thcd_trangthai_HSKT_HB = 1 or yearcur.qlhs_thcd_trangthai_HSKT_DDHT = 1 or yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2 = 1 or yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2 = 1)'))
                ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
                
                ->where('qlhs_profile.profile_year', '<', $year.'-06-01')
                ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HSKT_HB_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_HB > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HSKT_HB > 0 OR yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_DDHT > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HSKT_DDHT > 0)'))
                
                ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                    'yearold.qlhs_thcd_trangthai_HSKT_HB as old_HSKT_HB', 'yearold.qlhs_thcd_trangthai_HSKT_HB_HK2 as old_HSKT_HB_HK2', 
                    'yearold.qlhs_thcd_trangthai_HSKT_DDHT as old_HSKT_DDHT', 'yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2 as old_HSKT_DDHT_HK2', 

                    'yearcur.qlhs_thcd_trangthai_HSKT_HB as cur_HSKT_HB', 'yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2 as cur_HSKT_HB_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HSKT_DDHT as cur_HSKT_DDHT', 'yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2 as cur_HSKT_DDHT_HK2',

                    'yearnew.qlhs_thcd_trangthai_HSKT_HB as new_HSKT_HB', 'yearnew.qlhs_thcd_trangthai_HSKT_HB_HK2 as new_HSKT_HB_HK2',
                    'yearnew.qlhs_thcd_trangthai_HSKT_DDHT as new_HSKT_DDHT', 'yearnew.qlhs_thcd_trangthai_HSKT_DDHT_HK2 as new_HSKT_DDHT_HK2',

                    'yearold.qlhs_thcd_tien_nhucau_HSKT_HB as money_HB_old', 'yearold.qlhs_thcd_tien_nhucau_HSKT_HB_HK2 as money_HB_old_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT as money_DDHT_old', 'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2 as money_DDHT_old_HK2', 

                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB as money_HB_cur', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB_HK2 as money_HB_cur_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT as money_DDHT_cur', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2 as money_DDHT_cur_HK2', 

                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB as money_HB_new', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB_HK2 as money_HB_new_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT as money_DDHT_new', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2 as money_DDHT_new_HK2', 

                    DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 74 then 1 else 0 END) as hotrohocbong'), 
                    DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 74 then 1 else 0 END) as hotromuadodunght'),
                    
                    DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotro_hocky2_old'), 
                    DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotro_hocky1_cur'), 
                    DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotro_hocky2_cur'), 
                    DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotro_hocky1_new'))
                ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                    'yearold.qlhs_thcd_trangthai_HSKT_HB', 'yearold.qlhs_thcd_trangthai_HSKT_HB_HK2', 
                    'yearold.qlhs_thcd_trangthai_HSKT_DDHT', 'yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2', 

                    'yearcur.qlhs_thcd_trangthai_HSKT_HB', 'yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HSKT_DDHT', 'yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2',

                    'yearnew.qlhs_thcd_trangthai_HSKT_HB', 'yearnew.qlhs_thcd_trangthai_HSKT_HB_HK2',
                    'yearnew.qlhs_thcd_trangthai_HSKT_DDHT', 'yearnew.qlhs_thcd_trangthai_HSKT_DDHT_HK2',

                    'yearold.qlhs_thcd_tien_nhucau_HSKT_HB', 'yearold.qlhs_thcd_tien_nhucau_HSKT_HB_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT', 'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2', 

                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2', 

                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2');

            $getDataType1 = DB::table(DB::raw("({$getDataTypeA->toSql()}) as m"))
                ->mergeBindings( $getDataTypeA )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrohocbong', 'm.hotromuadodunght',
                        'm.hotro_hocky2_old', 
                        'm.hotro_hocky1_cur', 
                        'm.hotro_hocky2_cur', 
                        'm.hotro_hocky1_new', 

                        'm.old_HSKT_HB', 'm.old_HSKT_HB_HK2', 
                        'm.old_HSKT_DDHT', 'm.old_HSKT_DDHT_HK2', 

                        'm.cur_HSKT_HB', 'm.cur_HSKT_HB_HK2', 
                        'm.cur_HSKT_DDHT', 'm.cur_HSKT_DDHT_HK2',

                        'm.new_HSKT_HB', 'm.new_HSKT_HB_HK2',
                        'm.new_HSKT_DDHT', 'm.new_HSKT_DDHT_HK2',

                        'm.money_HB_old', 'm.money_HB_old_HK2', 'm.money_DDHT_old', 'm.money_DDHT_old_HK2', 
                        'm.money_HB_cur', 'm.money_HB_cur_HK2', 'm.money_DDHT_cur', 'm.money_DDHT_cur_HK2',
                        'm.money_HB_new', 'm.money_HB_new_HK2', 'm.money_DDHT_new', 'm.money_DDHT_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrohocbong', 'm.hotromuadodunght',
                        'm.hotro_hocky2_old', 
                        'm.hotro_hocky1_cur', 
                        'm.hotro_hocky2_cur', 
                        'm.hotro_hocky1_new',

                        'm.old_HSKT_HB', 'm.old_HSKT_HB_HK2', 
                        'm.old_HSKT_DDHT', 'm.old_HSKT_DDHT_HK2', 

                        'm.cur_HSKT_HB', 'm.cur_HSKT_HB_HK2', 
                        'm.cur_HSKT_DDHT', 'm.cur_HSKT_DDHT_HK2',

                        'm.new_HSKT_HB', 'm.new_HSKT_HB_HK2',
                        'm.new_HSKT_DDHT', 'm.new_HSKT_DDHT_HK2',

                        'm.money_HB_old', 'm.money_HB_old_HK2', 'm.money_DDHT_old', 'm.money_DDHT_old_HK2', 
                        'm.money_HB_cur', 'm.money_HB_cur_HK2', 'm.money_DDHT_cur', 'm.money_DDHT_cur_HK2',
                        'm.money_HB_new', 'm.money_HB_new_HK2', 'm.money_DDHT_new', 'm.money_DDHT_new_HK2')
                ->get();


            $getDataTypeB = DB::table('qlhs_profile')
                ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 74 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))
                
                ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HSKT_HB = 1 or yearold.qlhs_thcd_trangthai_HSKT_DDHT = 1 or yearold.qlhs_thcd_trangthai_HSKT_HB_HK2 = 1 or yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2 = 1)'))
                ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year))
                ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
                
                ->where('qlhs_profile.profile_year', '>', $year.'-05-31')
                ->where('qlhs_profile.profile_year', '<', ($year + 1).'-06-01')
                ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HSKT_HB_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_HB > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HSKT_HB > 0 OR yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_DDHT > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HSKT_DDHT > 0)'))
                
                ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                    'yearold.qlhs_thcd_trangthai_HSKT_HB as old_HSKT_HB', 'yearold.qlhs_thcd_trangthai_HSKT_HB_HK2 as old_HSKT_HB_HK2', 
                    'yearold.qlhs_thcd_trangthai_HSKT_DDHT as old_HSKT_DDHT', 'yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2 as old_HSKT_DDHT_HK2', 

                    'yearcur.qlhs_thcd_trangthai_HSKT_HB as cur_HSKT_HB', 'yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2 as cur_HSKT_HB_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HSKT_DDHT as cur_HSKT_DDHT', 'yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2 as cur_HSKT_DDHT_HK2',

                    'yearnew.qlhs_thcd_trangthai_HSKT_HB as new_HSKT_HB', 'yearnew.qlhs_thcd_trangthai_HSKT_HB_HK2 as new_HSKT_HB_HK2',
                    'yearnew.qlhs_thcd_trangthai_HSKT_DDHT as new_HSKT_DDHT', 'yearnew.qlhs_thcd_trangthai_HSKT_DDHT_HK2 as new_HSKT_DDHT_HK2',

                    'yearold.qlhs_thcd_tien_nhucau_HSKT_HB as money_HB_old', 'yearold.qlhs_thcd_tien_nhucau_HSKT_HB_HK2 as money_HB_old_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT as money_DDHT_old', 'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2 as money_DDHT_old_HK2', 

                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB as money_HB_cur', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB_HK2 as money_HB_cur_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT as money_DDHT_cur', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2 as money_DDHT_cur_HK2', 

                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB as money_HB_new', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB_HK2 as money_HB_new_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT as money_DDHT_new', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2 as money_DDHT_new_HK2', 

                    DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 74 then 1 else 0 END) as hotrohocbong'), 
                    DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 74 then 1 else 0 END) as hotromuadodunght'),
                    
                    DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotro_hocky2_old'), 
                    DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotro_hocky1_cur'), 
                    DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotro_hocky2_cur'), 
                    DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotro_hocky1_new'))
                ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                    'yearold.qlhs_thcd_trangthai_HSKT_HB', 'yearold.qlhs_thcd_trangthai_HSKT_HB_HK2', 
                    'yearold.qlhs_thcd_trangthai_HSKT_DDHT', 'yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2', 

                    'yearcur.qlhs_thcd_trangthai_HSKT_HB', 'yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HSKT_DDHT', 'yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2',

                    'yearnew.qlhs_thcd_trangthai_HSKT_HB', 'yearnew.qlhs_thcd_trangthai_HSKT_HB_HK2',
                    'yearnew.qlhs_thcd_trangthai_HSKT_DDHT', 'yearnew.qlhs_thcd_trangthai_HSKT_DDHT_HK2',

                    'yearold.qlhs_thcd_tien_nhucau_HSKT_HB', 'yearold.qlhs_thcd_tien_nhucau_HSKT_HB_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT', 'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2', 

                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2', 

                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2');

            $getDataType2 = DB::table(DB::raw("({$getDataTypeB->toSql()}) as m"))
                ->mergeBindings( $getDataTypeB )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrohocbong', 'm.hotromuadodunght',
                        'm.hotro_hocky2_old', 
                        'm.hotro_hocky1_cur', 
                        'm.hotro_hocky2_cur', 
                        'm.hotro_hocky1_new', 

                        'm.old_HSKT_HB', 'm.old_HSKT_HB_HK2', 
                        'm.old_HSKT_DDHT', 'm.old_HSKT_DDHT_HK2', 

                        'm.cur_HSKT_HB', 'm.cur_HSKT_HB_HK2', 
                        'm.cur_HSKT_DDHT', 'm.cur_HSKT_DDHT_HK2',

                        'm.new_HSKT_HB', 'm.new_HSKT_HB_HK2',
                        'm.new_HSKT_DDHT', 'm.new_HSKT_DDHT_HK2',

                        'm.money_HB_old', 'm.money_HB_old_HK2', 'm.money_DDHT_old', 'm.money_DDHT_old_HK2', 
                        'm.money_HB_cur', 'm.money_HB_cur_HK2', 'm.money_DDHT_cur', 'm.money_DDHT_cur_HK2',
                        'm.money_HB_new', 'm.money_HB_new_HK2', 'm.money_DDHT_new', 'm.money_DDHT_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrohocbong', 'm.hotromuadodunght',
                        'm.hotro_hocky2_old', 
                        'm.hotro_hocky1_cur', 
                        'm.hotro_hocky2_cur', 
                        'm.hotro_hocky1_new',

                        'm.old_HSKT_HB', 'm.old_HSKT_HB_HK2', 
                        'm.old_HSKT_DDHT', 'm.old_HSKT_DDHT_HK2', 

                        'm.cur_HSKT_HB', 'm.cur_HSKT_HB_HK2', 
                        'm.cur_HSKT_DDHT', 'm.cur_HSKT_DDHT_HK2',

                        'm.new_HSKT_HB', 'm.new_HSKT_HB_HK2',
                        'm.new_HSKT_DDHT', 'm.new_HSKT_DDHT_HK2',

                        'm.money_HB_old', 'm.money_HB_old_HK2', 'm.money_DDHT_old', 'm.money_DDHT_old_HK2', 
                        'm.money_HB_cur', 'm.money_HB_cur_HK2', 'm.money_DDHT_cur', 'm.money_DDHT_cur_HK2',
                        'm.money_HB_new', 'm.money_HB_new_HK2', 'm.money_DDHT_new', 'm.money_DDHT_new_HK2')
                ->get();

            $getDataTypeC = DB::table('qlhs_profile')
                ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 74 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.($year + 1).' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.($year + 1).')'))
                ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.($year + 1).'-'.($year + 2).'"'))
                
                ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.$year.''))
                ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.($year + 1)))
                ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 2).''))
                
                ->where('qlhs_profile.profile_year', '>', ($year + 1).'-05-31')
                ->where('qlhs_profile.profile_year', '<', ($year + 2).'-06-01')
                ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HSKT_HB_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_HB > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HSKT_HB > 0 OR yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_DDHT > 0 OR yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HSKT_DDHT > 0)'))
                
                ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                    'yearold.qlhs_thcd_trangthai_HSKT_HB as old_HSKT_HB', 'yearold.qlhs_thcd_trangthai_HSKT_HB_HK2 as old_HSKT_HB_HK2', 
                    'yearold.qlhs_thcd_trangthai_HSKT_DDHT as old_HSKT_DDHT', 'yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2 as old_HSKT_DDHT_HK2', 

                    'yearcur.qlhs_thcd_trangthai_HSKT_HB as cur_HSKT_HB', 'yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2 as cur_HSKT_HB_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HSKT_DDHT as cur_HSKT_DDHT', 'yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2 as cur_HSKT_DDHT_HK2',

                    'yearnew.qlhs_thcd_trangthai_HSKT_HB as new_HSKT_HB', 'yearnew.qlhs_thcd_trangthai_HSKT_HB_HK2 as new_HSKT_HB_HK2',
                    'yearnew.qlhs_thcd_trangthai_HSKT_DDHT as new_HSKT_DDHT', 'yearnew.qlhs_thcd_trangthai_HSKT_DDHT_HK2 as new_HSKT_DDHT_HK2',

                    'yearold.qlhs_thcd_tien_nhucau_HSKT_HB as money_HB_old', 'yearold.qlhs_thcd_tien_nhucau_HSKT_HB_HK2 as money_HB_old_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT as money_DDHT_old', 'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2 as money_DDHT_old_HK2', 

                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB as money_HB_cur', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB_HK2 as money_HB_cur_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT as money_DDHT_cur', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2 as money_DDHT_cur_HK2', 

                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB as money_HB_new', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB_HK2 as money_HB_new_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT as money_DDHT_new', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2 as money_DDHT_new_HK2', 

                    DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 74 then 1 else 0 END) as hotrohocbong'), 
                    DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 74 then 1 else 0 END) as hotromuadodunght'),
                    
                    DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hotro_hocky2_old'), 
                    DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hotro_hocky1_cur'), 
                    DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hotro_hocky2_cur'), 
                    DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hotro_hocky1_new'))
                ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                    'yearold.qlhs_thcd_trangthai_HSKT_HB', 'yearold.qlhs_thcd_trangthai_HSKT_HB_HK2', 
                    'yearold.qlhs_thcd_trangthai_HSKT_DDHT', 'yearold.qlhs_thcd_trangthai_HSKT_DDHT_HK2', 

                    'yearcur.qlhs_thcd_trangthai_HSKT_HB', 'yearcur.qlhs_thcd_trangthai_HSKT_HB_HK2', 
                    'yearcur.qlhs_thcd_trangthai_HSKT_DDHT', 'yearcur.qlhs_thcd_trangthai_HSKT_DDHT_HK2',

                    'yearnew.qlhs_thcd_trangthai_HSKT_HB', 'yearnew.qlhs_thcd_trangthai_HSKT_HB_HK2',
                    'yearnew.qlhs_thcd_trangthai_HSKT_DDHT', 'yearnew.qlhs_thcd_trangthai_HSKT_DDHT_HK2',

                    'yearold.qlhs_thcd_tien_nhucau_HSKT_HB', 'yearold.qlhs_thcd_tien_nhucau_HSKT_HB_HK2', 
                    'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT', 'yearold.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2', 

                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_HB_HK2', 
                    'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT', 'yearcur.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2', 

                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_HB_HK2', 
                    'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT', 'yearnew.qlhs_thcd_tien_nhucau_HSKT_DDHT_HK2');

            $getDataType3 = DB::table(DB::raw("({$getDataTypeC->toSql()}) as m"))
                ->mergeBindings( $getDataTypeC )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrohocbong', 'm.hotromuadodunght',
                        'm.hotro_hocky2_old', 
                        'm.hotro_hocky1_cur', 
                        'm.hotro_hocky2_cur', 
                        'm.hotro_hocky1_new', 

                        'm.old_HSKT_HB', 'm.old_HSKT_HB_HK2', 
                        'm.old_HSKT_DDHT', 'm.old_HSKT_DDHT_HK2', 

                        'm.cur_HSKT_HB', 'm.cur_HSKT_HB_HK2', 
                        'm.cur_HSKT_DDHT', 'm.cur_HSKT_DDHT_HK2',

                        'm.new_HSKT_HB', 'm.new_HSKT_HB_HK2',
                        'm.new_HSKT_DDHT', 'm.new_HSKT_DDHT_HK2',

                        'm.money_HB_old', 'm.money_HB_old_HK2', 'm.money_DDHT_old', 'm.money_DDHT_old_HK2', 
                        'm.money_HB_cur', 'm.money_HB_cur_HK2', 'm.money_DDHT_cur', 'm.money_DDHT_cur_HK2',
                        'm.money_HB_new', 'm.money_HB_new_HK2', 'm.money_DDHT_new', 'm.money_DDHT_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrohocbong', 'm.hotromuadodunght',
                        'm.hotro_hocky2_old', 
                        'm.hotro_hocky1_cur', 
                        'm.hotro_hocky2_cur', 
                        'm.hotro_hocky1_new',

                        'm.old_HSKT_HB', 'm.old_HSKT_HB_HK2', 
                        'm.old_HSKT_DDHT', 'm.old_HSKT_DDHT_HK2', 

                        'm.cur_HSKT_HB', 'm.cur_HSKT_HB_HK2', 
                        'm.cur_HSKT_DDHT', 'm.cur_HSKT_DDHT_HK2',

                        'm.new_HSKT_HB', 'm.new_HSKT_HB_HK2',
                        'm.new_HSKT_DDHT', 'm.new_HSKT_DDHT_HK2',

                        'm.money_HB_old', 'm.money_HB_old_HK2', 'm.money_DDHT_old', 'm.money_DDHT_old_HK2', 
                        'm.money_HB_cur', 'm.money_HB_cur_HK2', 'm.money_DDHT_cur', 'm.money_DDHT_cur_HK2',
                        'm.money_HB_new', 'm.money_HB_new_HK2', 'm.money_DDHT_new', 'm.money_DDHT_new_HK2')
                ->get();

            $time = time();

            if ((is_null($getDataType1) || empty($getDataType1) || count($getDataType1) == 0) && (is_null($getDataType2) || empty($getDataType2) || count($getDataType2) == 0) && (is_null($getDataType3) || empty($getDataType3) || count($getDataType3) == 0)) {
                $result['success'] = "Danh sách trống!";
                return $result;
            }
            
            if (!is_null($getDataType1) && !empty($getDataType1) && count($getDataType1) > 0) {
                $check = $this->insertHSKT($getDataType1, 1, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType2) && !empty($getDataType2) && count($getDataType2) > 0 && $check) {
                $check = $this->insertHSKT($getDataType2, 2, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType3) && !empty($getDataType3) && count($getDataType3) > 0 && $check) {
                $check = $this->insertHSKT($getDataType3, 3, $current_user_id, $school_id, $year, $time, $capnhan);
            }


            if ($check) {
                $type_code = 'HSKT-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;


                $insert_hosobaocao_id = DB::table('qlhs_hosobaocao')->insertGetId(['report_name' => $report_name, 'report_type' => $type_code, 'report_date' => $current_date, 'created_at' => $current_date, 'updated_at' => $current_date, 'create_userid' => $current_user_id, 'update_userid' => $current_user_id, 'report_user' => $user_create, 'report_user_sign' => $user_sign, 'report_attach_name' => '', 'report_nature' => $status, 'report_year' => $year, 'report_id_truong' => $school_id, 'report_note' => $note, 'report' => 'HSKT']);

                if (!is_null($insert_hosobaocao_id) && $insert_hosobaocao_id > 0) {
                    $this->exportforSchoolsHSKT($insert_hosobaocao_id);

                    if (file_exists(storage_path().'/exceldownload/HSKT/'.$type_code.'.xlsx')) {
                        // $result['success'] = "Thêm mới thành công!";
                        // return TRUE;
                    }
                    else {
                        $deleteHoso = DB::table('qlhs_hosobaocao')->where('report_type', 'LIKE', '%'.$type_code.'%')->delete();
                        $deleteHSKT = DB::table('qlhs_hotrohocsinhkhuyettat')->where('type_code', 'LIKE', '%'.$type_code.'%')->delete();
                        // $result['error'] = "Thêm mới thất bại!";
                        // return false;
                    }
                }
                // else {$result['error'] = "Thêm mới thất bại!"; return false;}
                return $insert_hosobaocao_id;
            }
            else {
                return 0;
            }

            // return $result;
        } catch (Exception $e) {
            return $e;
        }       
    }

    public function insertHSKT($getDataType, $type, $current_user_id, $school_id, $year, $time, $capnhan){
        try {
            
            $bool = TRUE;
            $count = 1;

            $phongGD_duyet = 0;
            if ($capnhan == 3) {
                $phongGD_duyet = 1;
            }
            
            $type_code = 'HSKT-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

            foreach ($getDataType as $value) {

                $nhucau_hocbong = 0;
                $nhucau_muadodung = 0;
                $dutoan_hocbong = 0;
                $dutoan_muadodung = 0;
                $tong_nhucau = 0;
                $tong_dutoan = 0;

                if ($type != 3) {
                    $nhucau_hocbong = ($value->money_HB_old_HK2 * $value->old_HSKT_HB_HK2) + ($value->money_HB_cur * $value->cur_HSKT_HB);
                    $nhucau_muadodung = ($value->money_DDHT_old_HK2 * $value->old_HSKT_DDHT_HK2) + ($value->money_DDHT_cur * $value->cur_HSKT_DDHT);

                    $dutoan_hocbong = ($value->money_HB_cur_HK2 * $value->cur_HSKT_HB_HK2) + $value->money_HB_new;
                    $dutoan_muadodung = ($value->money_DDHT_cur_HK2 * $value->cur_HSKT_DDHT_HK2) + $value->money_DDHT_new;
                }
                else if ($type == 3) {
                    $dutoan_hocbong = ($value->money_HB_old_HK2 * $value->old_HSKT_HB_HK2) + $value->money_HB_cur;
                    $dutoan_muadodung = ($value->money_DDHT_old_HK2 * $value->old_HSKT_DDHT_HK2) + $value->money_DDHT_cur;
                }

                if ($type != 3) {
                    $tong_nhucau = ($nhucau_hocbong + $nhucau_muadodung);
                }
                
                $tong_dutoan = ($dutoan_hocbong + $dutoan_muadodung);

                if ($tong_nhucau > 0 || $tong_dutoan > 0) {
                    $insert_type = DB::table('qlhs_hotrohocsinhkhuyettat')->insert([
                        'profile_id' => $value->profile_id, 
                        'hotrohocbong' => $value->hotrohocbong, 
                        'hotromuadodung' => $value->hotromuadodunght, 
                        'hocky2_old' => $value->hotro_hocky2_old, 
                        'hocky1_cur' => $value->hotro_hocky1_cur, 
                        'hocky2_cur' => $value->hotro_hocky2_cur, 
                        'hocky1_new' => $value->hotro_hocky1_new, 
                        'nhucau_hocbong' => $nhucau_hocbong, 
                        'nhucau_muadodung' => $nhucau_muadodung, 
                        'tong_nhucau' => $tong_nhucau, 
                        'dutoan_hocbong' => $dutoan_hocbong, 
                        'dutoan_muadodung' => $dutoan_muadodung, 
                        'tong_dutoan' => $tong_dutoan,  
                        'type_code' => $type_code, 
                        'type' => $type,
                        'trangthai_pheduyet_HSKT' => 1,
                        'trangthai_phongGD_HSKT' => $phongGD_duyet,
                        'trangthai_phongTC_HSKT' => 0,
                        'trangthai_So_HSKT' => 0
                        ]);
                    
                    $count++;
                    if ($insert_type == 0) {
                        
                        $deleteHSKT = DB::table('qlhs_hotrohocsinhkhuyettat')->where('type_code', 'LIKE', '%'.$type_code.'%')->where('type', '=', $type)->delete();
                        $count--;
                        break;
                    }
                }
            }
            
            if ($count > 1) {
                $bool = TRUE;
            }
            else {
                $bool = FALSE;
            }

            return TRUE;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportforSchoolsHSKT($id, $type = true){
    //$type = true;
        if (is_null($id) || empty($id) || $id == 0) {
            return "Mời bấm vào tên danh sách muốn kết xuất để kêt xuất file Excel!";
        }

        $getSchoolName = DB::table('qlhs_hosobaocao')->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hosobaocao.report_id_truong')->where('qlhs_hosobaocao.report_id', '=', $id)->select('qlhs_schools.schools_name', 'qlhs_hosobaocao.report_type', 'qlhs_hosobaocao.report_year')->first();
        $data_results = [];
        $data_results['aT'] = 'Học sinh có mặt tại trường tháng 5/' . $getSchoolName->report_year;
        $data_results['bT'] = 'Học sinh dự kiến tuyển mới năm học ' . $getSchoolName->report_year . '-' . ((int)$getSchoolName->report_year + 1);
        $data_results['cT'] = 'Học sinh dự kiến tuyển mới năm học ' . ((int)$getSchoolName->report_year + 1) . '-' . ((int)$getSchoolName->report_year + 2);
        if ($getSchoolName->report_type != null && $getSchoolName->report_type != "") {
            $data_results['aCount'] = $this->countValueHSKT('1',$getSchoolName->report_type);
            $data_results['bCount'] = $this->countValueHSKT('2',$getSchoolName->report_type);
            $data_results['cCount'] = $this->countValueHSKT('3',$getSchoolName->report_type);
            $data_results['TotalCount'] = $this->countValueHSKT(null,$getSchoolName->report_type);
            //Get by type A
            $data_results['a'] = DB::table('qlhs_hotrohocsinhkhuyettat')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhkhuyettat.profile_id')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HSKT"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhkhuyettat.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhkhuyettat.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhkhuyettat.type', '=', 1)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhkhuyettat.*')->get();

            $data_results['b'] = DB::table('qlhs_hotrohocsinhkhuyettat')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhkhuyettat.profile_id')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HSKT"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhkhuyettat.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhkhuyettat.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhkhuyettat.type', '=', 2)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhkhuyettat.*')->get();

            $data_results['c'] = DB::table('qlhs_hotrohocsinhkhuyettat')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhkhuyettat.profile_id')
            ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HSKT"'))
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhkhuyettat.profile_id and qlhs_profile_history.history_year = "'.($getSchoolName->report_year + 1).'-'.($getSchoolName->report_year + 2).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhkhuyettat.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhkhuyettat.type', '=', 3)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhkhuyettat.*')->get();
        }

        $data_results['schools_name'] = $getSchoolName->schools_name;
        $data_results['report_year'] = $getSchoolName->report_year;
        $this->addCellExcelHSKT($data_results, $getSchoolName->report_type, $type);
    }

    private function addCellExcelHSKT($data_results, $filename, $type = true){
        $excel =    Excel::load(storage_path().'/exceltemplate/laphosoHSKT.xlsx', function($reader) use($data_results){
            $borderArray = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => 'thin',
                        'color' => array('argb' => 'FF000000')
                    )
                )
            );
            $FontArray = array(
                'font' => array(
                    'bold' => 'bold'
                )
            );
            $FontArrayitalic = array(
                'font' => array(
                    'italic' => 'italic'
                )
            );
            $style = array(
                'alignment' => array(
                    'horizontal' => 'center',
                )
            );
            $styleLeft = array(
                'alignment' => array(
                    'horizontal' => 'left',
                )
            );
            $styleRight = array(
                'alignment' => array(
                    'horizontal' => 'right',
                )
            );
            $row = 8;

            $col = 0;
            $colA = 0;

            $class_lv1 = 0;
            $class_lv2 = 0;
            $class_lv3 = 0;

            //-----------------------------------------Title------------------------------------------------------------------------------------------------
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, 2, 'NHU CẦU KINH PHÍ NĂM '.$data_results['report_year'].', DỰ TOÁN NĂM '.($data_results['report_year'] + 1).' ĐỐI VỚI CHÍNH SÁCH HỖ TRỢ HỌC SINH KHUYẾT TẬT THEO THÔNG TƯ LIÊN TỊCH SỐ 42/2013/TTLT-BGDĐT-BLĐTBXH-BTC (KHỐI MẦM NON VÀ TRUNG HỌC PHỔ THÔNG)')->getStyle('A2')->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 5, 'Thông tin cơ bản (tính tại thời điểm tháng 5/'.$data_results['report_year'].')')->getStyle('C5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, 5, 'Nhu cầu kinh phí năm '.$data_results['report_year'])->getStyle('W5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, 5, 'Dự toán kinh phí năm '.($data_results['report_year'] + 1))->getStyle('Z5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 7, 'Học kì II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('C7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, 7, 'Năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('D7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, 7, 'Năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('E7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, 7, 'Học kỳ II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('S7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, 7, 'Học kỳ I năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('T7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, 7, 'Học kỳ II năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('U7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, 7, 'Học kỳ I năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('V7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            //-----------------------------------------End Title----------------------------------------------------------------------------------------------------

            //$data_results['aCount'][0]
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['schools_name'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($FontArrayitalic)->applyFromArray($styleLeft);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row, '')->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row, '')->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row, '')->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row, '')->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['TotalCount']->tonghocky2_old)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['TotalCount']->tonghocky1_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['TotalCount']->tonghocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['TotalCount']->tonghocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['TotalCount']->tong_tongnhucau)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['TotalCount']->tongnhucau_hocbong)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_results['TotalCount']->tongnhucau_muadodung)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_results['TotalCount']->tong_tongdutoan)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_results['TotalCount']->tongdutoan_hocbong)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row,$data_results['TotalCount']->tongdutoan_muadodung)->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight)->applyFromArray($FontArrayitalic);


            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'a')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            //____________________________________________________________________________________________________________________________________________________
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['aT'])->getStyle('B'.$row)->applyFromArray($FontArray)->applyFromArray($styleLeft);
            
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row, '')->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row, '')->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row, '')->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row, '')->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['aCount']->tonghocky2_old)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['aCount']->tonghocky1_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['aCount']->tonghocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['aCount']->tonghocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['aCount']->tong_tongnhucau)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['aCount']->tongnhucau_hocbong)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_results['aCount']->tongnhucau_muadodung)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_results['aCount']->tong_tongdutoan)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_results['aCount']->tongdutoan_hocbong)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row,$data_results['aCount']->tongdutoan_muadodung)->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            if($data_results['a']->count()>0){
                $indexa = 0;
                foreach($data_results['a'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next_1;
                    //  $class_lv2 = $value->level_next_2;
                    //  $class_lv3 = $value->level_next_3;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row, ++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->profile_parentname)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->profile_household)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tenxa)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tenhuyen)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->decided_confirmation)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->decided_number)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $decided_date)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '-')->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '-')->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '-')->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hotrohocbong)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hotromuadodung)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky2_old)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky1_cur)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky2_cur)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky1_new)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tong_nhucau)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->nhucau_hocbong)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->nhucau_muadodung)->getStyle('Y'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tong_dutoan)->getStyle('Z'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->dutoan_hocbong)->getStyle('AA'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->dutoan_muadodung)->getStyle('AB'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }
            //b

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'b')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['bT'])->getStyle('B'.$row)->applyFromArray($FontArray)->applyFromArray($styleLeft);
            
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row, '')->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row, '')->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row, '')->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row, '')->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['bCount']->tonghocky2_old)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['bCount']->tonghocky1_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['bCount']->tonghocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['bCount']->tonghocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['bCount']->tong_tongnhucau)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['bCount']->tongnhucau_hocbong)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_results['bCount']->tongnhucau_muadodung)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_results['bCount']->tong_tongdutoan)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_results['bCount']->tongdutoan_hocbong)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row,$data_results['bCount']->tongdutoan_muadodung)->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexb = 0;

            if($data_results['b']->count()>0){
                $indexa = 0;
                foreach($data_results['b'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->profile_parentname)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->profile_household)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tenxa)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tenhuyen)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->decided_confirmation)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->decided_number)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $decided_date)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '-')->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '-')->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '-')->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hotrohocbong)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hotromuadodung)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky2_old)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky1_cur)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky2_cur)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky1_new)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tong_nhucau)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->nhucau_hocbong)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->nhucau_muadodung)->getStyle('Y'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tong_dutoan)->getStyle('Z'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->dutoan_hocbong)->getStyle('AA'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->dutoan_muadodung)->getStyle('AB'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }

                //c

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'c')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['cT'])->getStyle('B'.$row)->applyFromArray($FontArray)->applyFromArray($styleLeft);
            
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row, '')->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row, '')->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row, '')->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row, '')->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row, '')->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(18, $row,$data_results['cCount']->tonghocky2_old)->getStyle('S'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(19, $row,$data_results['cCount']->tonghocky1_cur)->getStyle('T'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(20, $row,$data_results['cCount']->tonghocky2_cur)->getStyle('U'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(21, $row,$data_results['cCount']->tonghocky1_new)->getStyle('V'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(22, $row,$data_results['cCount']->tong_tongnhucau)->getStyle('W'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(23, $row,$data_results['cCount']->tongnhucau_hocbong)->getStyle('X'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(24, $row,$data_results['cCount']->tongnhucau_muadodung)->getStyle('Y'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(25, $row,$data_results['cCount']->tong_tongdutoan)->getStyle('Z'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(26, $row,$data_results['cCount']->tongdutoan_hocbong)->getStyle('AA'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(27, $row,$data_results['cCount']->tongdutoan_muadodung)->getStyle('AB'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexc = 0;
            if($data_results['c']->count()>0){
                $indexa = 0;
                foreach($data_results['c'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //  $class_lv1 = $value->level_next;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = $value->level_next_1;
                    //  $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //  $class_lv1 = 0;
                    //  $class_lv2 = 0;
                    //  $class_lv3 = $value->level_next_1;
                    // }

                    $decided_date = "";
                    if (!is_null($value->decided_confirmdate) && !empty($value->decided_confirmdate)) {                 
                        $decided_date = Carbon::parse($value->decided_confirmdate)->format('d-m-Y');
                    }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '')->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '')->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->level_cur)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->profile_parentname)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->profile_household)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tenxa)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tenhuyen)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->decided_confirmation)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->decided_number)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $decided_date)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '-')->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '-')->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, '-')->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hotrohocbong)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hotromuadodung)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky2_old)->getStyle('S'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky1_cur)->getStyle('T'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky2_cur)->getStyle('U'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->hocky1_new)->getStyle('V'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tong_nhucau)->getStyle('W'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->nhucau_hocbong)->getStyle('X'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->nhucau_muadodung)->getStyle('Y'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);       
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->tong_dutoan)->getStyle('Z'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->dutoan_hocbong)->getStyle('AA'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row, $value->dutoan_muadodung)->getStyle('AB'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                }
            }
        });

        if($type){
            return $excel->setFilename($filename)->store('xlsx', storage_path().'/exceldownload/HSKT');
        }else{
            return $excel->setFilename($filename)->download('xlsx');
        }
    }
    
    public function countValueHSKT($type = null,$code){

        if($type!=null){
            $count = DB::table('qlhs_hotrohocsinhkhuyettat')->where('type_code','=',$code)->where('type','=',$type)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhucau_hocbong) as tongnhucau_hocbong'),
                DB::raw('sum(nhucau_muadodung) as tongnhucau_muadodung'),
                DB::raw('sum(tong_nhucau) as tong_tongnhucau'),
                DB::raw('sum(dutoan_hocbong) as tongdutoan_hocbong'),
                DB::raw('sum(dutoan_muadodung) as tongdutoan_muadodung'),
                DB::raw('sum(tong_dutoan) as tong_tongdutoan'))->first();
            return $count;
        }else{
            $count = DB::table('qlhs_hotrohocsinhkhuyettat')->where('type_code','=',$code)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhucau_hocbong) as tongnhucau_hocbong'),
                DB::raw('sum(nhucau_muadodung) as tongnhucau_muadodung'),
                DB::raw('sum(tong_nhucau) as tong_tongnhucau'),
                DB::raw('sum(dutoan_hocbong) as tongdutoan_hocbong'),
                DB::raw('sum(dutoan_muadodung) as tongdutoan_muadodung'),
                DB::raw('sum(tong_dutoan) as tong_tongdutoan'))->first();
            return $count;
        }
    }

//---------------------------------------------------------------------HSDTTS-------------------------------------------------------------------------
    public function getDataHSDTTS($school_id, $year, $report_name, $user_sign, $user_create, $note, $status, $capnhan){
        $result = [];
        try {

            $current_user_id = Auth::user()->id;
            $current_date = Carbon::now('Asia/Ho_Chi_Minh');


            $check = TRUE;

            $getDataTypeA = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 49 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))

            ->join('history_profile_site', 'history_profile_site.p_id', '=', DB::raw('qlhs_profile.profile_id and history_profile_site.start_date <= "'.$year.'-09-05" AND (history_profile_site.end_date >= "'.$year.'-09-05" OR history_profile_site.end_date is null)'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HSDTTS = 1 or yearold.qlhs_thcd_trangthai_HSDTTS_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year.' and (yearcur.qlhs_thcd_trangthai_HSDTTS = 1 or yearcur.qlhs_thcd_trangthai_HSDTTS_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
            
            ->where('qlhs_profile.profile_year', '<', $year.'-06-01')
            ->whereIn('qlhs_profile.profile_site_id2', [100, 101])
            
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HSDTTS_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HSDTTS > 0 OR yearcur.qlhs_thcd_trangthai_HSDTTS_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HSDTTS > 0)'))

            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HSDTTS as old_HSDTTS', 'yearold.qlhs_thcd_trangthai_HSDTTS_HK2 as old_HSDTTS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HSDTTS as cur_HSDTTS', 'yearcur.qlhs_thcd_trangthai_HSDTTS_HK2 as cur_HSDTTS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HSDTTS as new_HSDTTS', 'yearnew.qlhs_thcd_trangthai_HSDTTS_HK2 as new_HSDTTS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HSDTTS as money_old', 'yearold.qlhs_thcd_tien_nhucau_HSDTTS_HK2 as money_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HSDTTS as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HSDTTS_HK2 as money_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HSDTTS as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HSDTTS_HK2 as money_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 49 then 1 else 0 END) as hotrokinhphi'), 

                DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hocky2_old'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hocky1_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hocky2_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HSDTTS', 'yearold.qlhs_thcd_trangthai_HSDTTS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HSDTTS', 'yearcur.qlhs_thcd_trangthai_HSDTTS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HSDTTS', 'yearnew.qlhs_thcd_trangthai_HSDTTS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HSDTTS', 'yearold.qlhs_thcd_tien_nhucau_HSDTTS_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HSDTTS', 'yearcur.qlhs_thcd_tien_nhucau_HSDTTS_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HSDTTS', 'yearnew.qlhs_thcd_tien_nhucau_HSDTTS_HK2');
            
            $getDataType1 = DB::table(DB::raw("({$getDataTypeA->toSql()}) as m"))
                ->mergeBindings( $getDataTypeA )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HSDTTS', 'm.old_HSDTTS_HK2', 
                        'm.cur_HSDTTS', 'm.cur_HSDTTS_HK2', 
                        'm.new_HSDTTS', 'm.new_HSDTTS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HSDTTS', 'm.old_HSDTTS_HK2', 
                        'm.cur_HSDTTS', 'm.cur_HSDTTS_HK2', 
                        'm.new_HSDTTS', 'm.new_HSDTTS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')
                ->get();


            $getDataTypeB = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 49 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))

            ->join('history_profile_site', 'history_profile_site.p_id', '=', DB::raw('qlhs_profile.profile_id and history_profile_site.start_date <= "'.$year.'-09-05" AND (history_profile_site.end_date >= "'.$year.'-09-05" OR history_profile_site.end_date is null)'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HSDTTS = 1 or yearold.qlhs_thcd_trangthai_HSDTTS_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
            
            ->where('qlhs_profile.profile_year', '>', $year.'-05-31')
            ->where('qlhs_profile.profile_year', '<', ($year + 1).'-06-01')
            ->whereIn('qlhs_profile.profile_site_id2', [100, 101])
            
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HSDTTS_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HSDTTS > 0 OR yearcur.qlhs_thcd_trangthai_HSDTTS_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HSDTTS > 0)'))
            
            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HSDTTS as old_HSDTTS', 'yearold.qlhs_thcd_trangthai_HSDTTS_HK2 as old_HSDTTS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HSDTTS as cur_HSDTTS', 'yearcur.qlhs_thcd_trangthai_HSDTTS_HK2 as cur_HSDTTS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HSDTTS as new_HSDTTS', 'yearnew.qlhs_thcd_trangthai_HSDTTS_HK2 as new_HSDTTS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HSDTTS as money_old', 'yearold.qlhs_thcd_tien_nhucau_HSDTTS_HK2 as money_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HSDTTS as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HSDTTS_HK2 as money_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HSDTTS as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HSDTTS_HK2 as money_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 49 then 1 else 0 END) as hotrokinhphi'), 

                DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hocky2_old'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hocky1_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hocky2_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HSDTTS', 'yearold.qlhs_thcd_trangthai_HSDTTS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HSDTTS', 'yearcur.qlhs_thcd_trangthai_HSDTTS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HSDTTS', 'yearnew.qlhs_thcd_trangthai_HSDTTS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HSDTTS', 'yearold.qlhs_thcd_tien_nhucau_HSDTTS_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HSDTTS', 'yearcur.qlhs_thcd_tien_nhucau_HSDTTS_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HSDTTS', 'yearnew.qlhs_thcd_tien_nhucau_HSDTTS_HK2');

            $getDataType2 = DB::table(DB::raw("({$getDataTypeB->toSql()}) as m"))
                ->mergeBindings( $getDataTypeB )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HSDTTS', 'm.old_HSDTTS_HK2', 
                        'm.cur_HSDTTS', 'm.cur_HSDTTS_HK2', 
                        'm.new_HSDTTS', 'm.new_HSDTTS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HSDTTS', 'm.old_HSDTTS_HK2', 
                        'm.cur_HSDTTS', 'm.cur_HSDTTS_HK2', 
                        'm.new_HSDTTS', 'm.new_HSDTTS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')
                ->get();


            $getDataTypeC = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 49 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.($year + 1).' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.($year + 1).')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.($year + 1).'-'.($year + 2).'"'))

            ->join('history_profile_site', 'history_profile_site.p_id', '=', DB::raw('qlhs_profile.profile_id and history_profile_site.start_date <= "'.($year + 1).'-09-05" AND (history_profile_site.end_date >= "'.($year + 1).'-09-05" OR history_profile_site.end_date is null)'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.$year))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.($year + 1)))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 2)))
            
            ->where('qlhs_profile.profile_year', '>', ($year + 1).'-05-31')
            ->where('qlhs_profile.profile_year', '<', ($year + 2).'-06-01')
            ->whereIn('qlhs_profile.profile_site_id2', [100, 101])
            
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HSDTTS_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HSDTTS > 0 OR yearcur.qlhs_thcd_trangthai_HSDTTS_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HSDTTS > 0)'))
            
            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date',  

                'yearold.qlhs_thcd_trangthai_HSDTTS as old_HSDTTS', 'yearold.qlhs_thcd_trangthai_HSDTTS_HK2 as old_HSDTTS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HSDTTS as cur_HSDTTS', 'yearcur.qlhs_thcd_trangthai_HSDTTS_HK2 as cur_HSDTTS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HSDTTS as new_HSDTTS', 'yearnew.qlhs_thcd_trangthai_HSDTTS_HK2 as new_HSDTTS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HSDTTS as money_old', 'yearold.qlhs_thcd_tien_nhucau_HSDTTS_HK2 as money_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HSDTTS as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HSDTTS_HK2 as money_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HSDTTS as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HSDTTS_HK2 as money_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 49 then 1 else 0 END) as hotrokinhphi'), 

                DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hocky2_old'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hocky1_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hocky2_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HSDTTS', 'yearold.qlhs_thcd_trangthai_HSDTTS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HSDTTS', 'yearcur.qlhs_thcd_trangthai_HSDTTS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HSDTTS', 'yearnew.qlhs_thcd_trangthai_HSDTTS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HSDTTS', 'yearold.qlhs_thcd_tien_nhucau_HSDTTS_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HSDTTS', 'yearcur.qlhs_thcd_tien_nhucau_HSDTTS_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HSDTTS', 'yearnew.qlhs_thcd_tien_nhucau_HSDTTS_HK2');
            
            $getDataType3 = DB::table(DB::raw("({$getDataTypeC->toSql()}) as m"))
                ->mergeBindings( $getDataTypeC )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HSDTTS', 'm.old_HSDTTS_HK2', 
                        'm.cur_HSDTTS', 'm.cur_HSDTTS_HK2', 
                        'm.new_HSDTTS', 'm.new_HSDTTS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HSDTTS', 'm.old_HSDTTS_HK2', 
                        'm.cur_HSDTTS', 'm.cur_HSDTTS_HK2', 
                        'm.new_HSDTTS', 'm.new_HSDTTS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')
                ->get();

            $time = time();

            if ((is_null($getDataType1) || empty($getDataType1) || count($getDataType1) == 0) && (is_null($getDataType2) || empty($getDataType2) || count($getDataType2) == 0) && (is_null($getDataType3) || empty($getDataType3) || count($getDataType3) == 0)) {
                $result['success'] = "Trường không có học sinh thuộc đối tượng!";
                return $result;
            }
            
            if (!is_null($getDataType1) && !empty($getDataType1) && count($getDataType1) > 0) {
                $check = $this->insertHSDTTS($getDataType1, 1, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType2) && !empty($getDataType2) && count($getDataType2) > 0 && $check) {
                $check = $this->insertHSDTTS($getDataType2, 2, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType3) && !empty($getDataType3) && count($getDataType3) > 0 && $check) {
                $check = $this->insertHSDTTS($getDataType3, 3, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if ($check) {
                $type_code = 'HSDTTS-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

                $dir = storage_path().'/files/HSDTTS';
                

                $insert_hosobaocao_id = DB::table('qlhs_hosobaocao')->insertGetId(['report_name' => $report_name, 'report_type' => $type_code, 'report_date' => $current_date, 'created_at' => $current_date, 'updated_at' => $current_date, 'create_userid' => $current_user_id, 'update_userid' => $current_user_id, 'report_user' => $user_create, 'report_user_sign' => $user_sign, 'report_attach_name' => '', 'report_nature' => $status, 'report_year' => $year, 'report_id_truong' => $school_id, 'report_note' => $note, 'report' => 'HSDTTS']);

                if (!is_null($insert_hosobaocao_id) && $insert_hosobaocao_id > 0) {
                    $this->exportforSchoolsHSDTTS($insert_hosobaocao_id);

                    if (file_exists(storage_path().'/exceldownload/HSDTTS/'.$type_code.'.xlsx')) {
                        // $result['success'] = "Thêm mới thành công!";
                        // return TRUE;
                    }
                    else {
                        $deleteHoso = DB::table('qlhs_hosobaocao')->where('report_type', 'LIKE', '%'.$type_code.'%')->delete();
                        $deleteHSDTTS = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', 'LIKE', '%'.$type_code.'%')->delete();
                        // $result['error'] = "Thêm mới thất bại!";
                        // return false;
                    }
                }
                // else {$result['error'] = "Thêm mới thất bại!"; return false;}
                return $insert_hosobaocao_id;
            }
            else {
                return 0;
            }

            // return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function insertHSDTTS($getDataType, $type, $current_user_id, $school_id, $year, $time, $capnhan){
        try {
            $bool = TRUE;
            $count = 1;

            $phongGD_duyet = 0;
            if ($capnhan == 3) {
                $phongGD_duyet = 1;
            }
            
            $type_code = 'HSDTTS-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

            foreach ($getDataType as $value) {
                $tongnhucau = 0;
                $tongdutoan = 0;

                if ($type != 3) {
                    $tongnhucau = ($value->money_old_HK2 * $value->old_HSDTTS_HK2) + ($value->money_cur * $value->cur_HSDTTS);
                    $tongdutoan = ($value->money_cur_HK2 * $value->cur_HSDTTS_HK2) + $value->money_new;
                }
                elseif ($type == 3) {
                    $tongdutoan = ($value->money_old_HK2 * $value->old_HSDTTS_HK2) + $value->money_cur;
                }
                

                if ($tongnhucau > 0 || $tongdutoan > 0) {
                    $insert_type = DB::table('qlhs_hotrohocsinhdantocthieuso')
                    ->insert([
                        'profile_id' => $value->profile_id, 
                        'hotrokinhphi' => $value->hotrokinhphi, 
                        'hocky2_old' => $value->hocky2_old, 
                        'hocky1_cur' => $value->hocky1_cur, 
                        'hocky2_cur' => $value->hocky2_cur, 
                        'hocky1_new' => $value->hocky1_new, 
                        'nhucau' => $tongnhucau, 
                        'dutoan' => $tongdutoan, 
                        'type_code' => $type_code, 
                        'type' => $type,
                        'trangthai_pheduyet_HSDTTS' => 1,
                        'trangthai_phongGD_HSDTTS' => $phongGD_duyet,
                        'trangthai_phongTC_HSDTTS' => 0,
                        'trangthai_So_HSDTTS' => 0
                        ]);

                    $count++;
                    if ($insert_type == 0) {
                        
                        $deleteHSDTTS = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', 'LIKE', '%'.$type_code.'%')->where('type', '=', $type)->delete();
                        $count--;
                        break;
                    }
                }
                
            }
            
            if ($count > 1) {
                $bool = TRUE;
            }
            else {
                $bool = FALSE;
            }

            return TRUE;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportforSchoolsHSDTTS($id, $type = true){
    //$type = true;
        if (is_null($id) || empty($id) || $id == 0) {
            return "Mời bấm vào tên danh sách muốn kết xuất để kêt xuất file Excel!";
        }

        $getSchoolName = DB::table('qlhs_hosobaocao')->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hosobaocao.report_id_truong')->where('qlhs_hosobaocao.report_id', '=', $id)->select('qlhs_schools.schools_name', 'qlhs_hosobaocao.report_type', 'qlhs_hosobaocao.report_year')->first();
        $data_results = [];
        $data_results['aT'] = 'Học sinh có mặt tại trường tháng 5/' . $getSchoolName->report_year;
        $data_results['bT'] = 'Học sinh dự kiến tuyển mới năm học ' . $getSchoolName->report_year . '-' . ((int)$getSchoolName->report_year + 1);
        $data_results['cT'] = 'Học sinh dự kiến tuyển mới năm học ' . ((int)$getSchoolName->report_year + 1) . '-' . ((int)$getSchoolName->report_year + 2);
        if ($getSchoolName->report_type != null && $getSchoolName->report_type != "") {
            $data_results['aCount'] = $this->countValueHSDTTS('1',$getSchoolName->report_type);
            $data_results['bCount'] = $this->countValueHSDTTS('2',$getSchoolName->report_type);
            $data_results['cCount'] = $this->countValueHSDTTS('3',$getSchoolName->report_type);
            $data_results['TotalCount'] = $this->countValueHSDTTS(null,$getSchoolName->report_type);
            //Get by type A
            $year = $getSchoolName->report_year;
            $data_results['a'] = DB::table('qlhs_hotrohocsinhdantocthieuso')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 1)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhdantocthieuso.*')->get();

            $data_results['b'] = DB::table('qlhs_hotrohocsinhdantocthieuso')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 2)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhdantocthieuso.*')->get();

            $data_results['c'] = DB::table('qlhs_hotrohocsinhdantocthieuso')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.($getSchoolName->report_year + 1).'-'.($getSchoolName->report_year + 2).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 3)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhdantocthieuso.*')->get();
        }
        $data_results['schools_name'] = $getSchoolName->schools_name;
        $data_results['report_year'] = $getSchoolName->report_year;
        $this->addCellExcelHSDTTS($data_results, $getSchoolName->report_type, $type);
    }

    private function addCellExcelHSDTTS($data_results, $filename, $type = true){
        $excel =    Excel::load(storage_path().'/exceltemplate/laphosoHSDTTS.xlsx', function($reader) use($data_results){
            $borderArray = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => 'thin',
                        'color' => array('argb' => 'FF000000')
                    )
                )
            );
            $FontArray = array(
                'font' => array(
                    'bold' => 'bold'
                )
            );
            $FontArrayitalic = array(
                'font' => array(
                    'italic' => 'italic'
                )
            );
            $style = array(
                'alignment' => array(
                    'horizontal' => 'center',
                )
            );
            $styleLeft = array(
                'alignment' => array(
                    'horizontal' => 'left',
                )
            );
            $styleRight = array(
                'alignment' => array(
                    'horizontal' => 'right',
                )
            );
            $row = 8;

            $col = 0;
            $colA = 0;

            $class_lv1 = 0;
            $class_lv2 = 0;
            $class_lv3 = 0;

            //-----------------------------------------Title------------------------------------------------------------------------------------------------
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, 2, 'NHU CẦU KINH PHÍ NĂM '.$data_results['report_year'].', DỰ TOÁN NĂM '.($data_results['report_year'] + 1).' ĐỐI VỚI CHÍNH SÁCH HỖ TRỢ HỌC SINH DÂN TỘC THIỂU SỐ TẠI HUYỆN MÙ CANG CHẢI VÀ HUYỆN TRẠM TẤU THEO QUYẾT ĐỊNH 22/2016/QĐ-UBND CỦA UBND TỈNH')->getStyle('A2')->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 5, 'Thông tin cơ bản (tính tại thời điểm tháng 5/'.$data_results['report_year'].')')->getStyle('C5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 7, 'Học kì II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('C7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, 7, 'Năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('D7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, 7, 'Năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('E7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, 7, 'Học kỳ II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('M7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, 7, 'Học kỳ I năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('N7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, 7, 'Học kỳ II năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('O7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, 7, 'Học kỳ I năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('P7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, 5, 'Nhu cầu kinh phí năm '.$data_results['report_year'])->getStyle('Q5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, 5, 'Dự toán kinh phí năm '.($data_results['report_year'] + 1))->getStyle('R5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            //-----------------------------------------End Title----------------------------------------------------------------------------------------------------

            //$data_results['aCount'][0]
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['schools_name'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($FontArrayitalic)->applyFromArray($styleLeft);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['TotalCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['TotalCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['TotalCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['TotalCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['TotalCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['TotalCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'a')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            //____________________________________________________________________________________________________________________________________________________
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['aT'])->getStyle('B'.$row)->applyFromArray($FontArray)->applyFromArray($styleLeft);
            
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['aCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['aCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['aCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['aCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['aCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['aCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            if($data_results['a']->count()>0){
                $indexa = 0;
                foreach($data_results['a'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //     $class_lv1 = $value->level_next_1;
                    //     $class_lv2 = $value->level_next_2;
                    //     $class_lv3 = $value->level_next_3;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //     $class_lv1 = $value->level_next;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = 0;
                    //     $class_lv3 = $value->level_next_1;
                    // }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrokinhphi)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }
            //b

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'b')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['bT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['bCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['bCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['bCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['bCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['bCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['bCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexb = 0;

            if($data_results['b']->count()>0){
                $indexa = 0;
                foreach($data_results['b'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //     $class_lv1 = $value->level_next;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = 0;
                    //     $class_lv3 = $value->level_next_1;
                    // }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrokinhphi)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }

                //c

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'c')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['cT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['cCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['cCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['cCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['cCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['cCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['cCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexc = 0;
            if($data_results['c']->count()>0){
                $indexa = 0;
                foreach($data_results['c'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //     $class_lv1 = $value->level_next;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = 0;
                    //     $class_lv3 = $value->level_next_1;
                    // }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrokinhphi)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                }
            }
        });

        if($type){
            return $excel->setFilename($filename)->store('xlsx', storage_path().'/exceldownload/HSDTTS');
        }else{
            return $excel->setFilename($filename)->download('xlsx');
        }
    }
    
    public function countValueHSDTTS($type = null,$code){

        if($type!=null){
            $count = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code','=',$code)->where('type','=',$type)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhucau) as tong_nhucau'),
                DB::raw('sum(dutoan) as tong_dutoan'))->first();
            return $count;
        }else{
            $count = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code','=',$code)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhucau) as tong_nhucau'),
                DB::raw('sum(dutoan) as tong_dutoan'))->first();
            return $count;
        }
    }

//---------------------------------------------------------------------HTATHS-------------------------------------------------------------------------
    public function getDataHTATHS($school_id, $year, $report_name, $user_sign, $user_create, $note, $status, $capnhan){
        $result = [];
        try {

            $current_user_id = Auth::user()->id;
            $current_date = Carbon::now('Asia/Ho_Chi_Minh');


            $check = TRUE;

            $getDataTypeA = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 69 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HTATHS = 1 or yearold.qlhs_thcd_trangthai_HTATHS_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year.' and (yearcur.qlhs_thcd_trangthai_HTATHS = 1 or yearcur.qlhs_thcd_trangthai_HTATHS_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
            
            ->where('qlhs_profile.profile_year', '<', $year.'-06-01')
            ->where('qlhs_profile.profile_statusNQ57', '=', 1)
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HTATHS_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTATHS > 0 OR yearcur.qlhs_thcd_trangthai_HTATHS_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTATHS > 0)'))
            
            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HTATHS as old_HTATHS', 'yearold.qlhs_thcd_trangthai_HTATHS_HK2 as old_HTATHS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HTATHS as cur_HTATHS', 'yearcur.qlhs_thcd_trangthai_HTATHS_HK2 as cur_HTATHS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTATHS as new_HTATHS', 'yearnew.qlhs_thcd_trangthai_HTATHS_HK2 as new_HTATHS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HTATHS as money_old', 'yearold.qlhs_thcd_tien_nhucau_HTATHS_HK2 as money_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTATHS as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTATHS_HK2 as money_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTATHS as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HTATHS_HK2 as money_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 69 then 1 else 0 END) as hotrokinhphi'), 

                DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hocky2_old'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hocky1_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hocky2_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HTATHS', 'yearold.qlhs_thcd_trangthai_HTATHS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HTATHS', 'yearcur.qlhs_thcd_trangthai_HTATHS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTATHS', 'yearnew.qlhs_thcd_trangthai_HTATHS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HTATHS', 'yearold.qlhs_thcd_tien_nhucau_HTATHS_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTATHS', 'yearcur.qlhs_thcd_tien_nhucau_HTATHS_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTATHS', 'yearnew.qlhs_thcd_tien_nhucau_HTATHS_HK2');
            
            $getDataType1 = DB::table(DB::raw("({$getDataTypeA->toSql()}) as m"))
                ->mergeBindings( $getDataTypeA )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HTATHS', 'm.old_HTATHS_HK2', 
                        'm.cur_HTATHS', 'm.cur_HTATHS_HK2', 
                        'm.new_HTATHS', 'm.new_HTATHS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HTATHS', 'm.old_HTATHS_HK2', 
                        'm.cur_HTATHS', 'm.cur_HTATHS_HK2', 
                        'm.new_HTATHS', 'm.new_HTATHS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')
                ->get();


            $getDataTypeB = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 69 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HTATHS = 1 or yearold.qlhs_thcd_trangthai_HTATHS_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
            
            ->where('qlhs_profile.profile_year', '>', $year.'-05-31')
            ->where('qlhs_profile.profile_year', '<', ($year + 1).'-06-01')
            ->where('qlhs_profile.profile_statusNQ57', '=', 1)
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HTATHS_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTATHS > 0 OR yearcur.qlhs_thcd_trangthai_HTATHS_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTATHS > 0)'))
            
            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HTATHS as old_HTATHS', 'yearold.qlhs_thcd_trangthai_HTATHS_HK2 as old_HTATHS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HTATHS as cur_HTATHS', 'yearcur.qlhs_thcd_trangthai_HTATHS_HK2 as cur_HTATHS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTATHS as new_HTATHS', 'yearnew.qlhs_thcd_trangthai_HTATHS_HK2 as new_HTATHS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HTATHS as money_old', 'yearold.qlhs_thcd_tien_nhucau_HTATHS_HK2 as money_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTATHS as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTATHS_HK2 as money_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTATHS as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HTATHS_HK2 as money_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 69 then 1 else 0 END) as hotrokinhphi'), 

                DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hocky2_old'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hocky1_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hocky2_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HTATHS', 'yearold.qlhs_thcd_trangthai_HTATHS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HTATHS', 'yearcur.qlhs_thcd_trangthai_HTATHS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTATHS', 'yearnew.qlhs_thcd_trangthai_HTATHS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HTATHS', 'yearold.qlhs_thcd_tien_nhucau_HTATHS_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTATHS', 'yearcur.qlhs_thcd_tien_nhucau_HTATHS_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTATHS', 'yearnew.qlhs_thcd_tien_nhucau_HTATHS_HK2');
            
            $getDataType2 = DB::table(DB::raw("({$getDataTypeB->toSql()}) as m"))
                ->mergeBindings( $getDataTypeB )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HTATHS', 'm.old_HTATHS_HK2', 
                        'm.cur_HTATHS', 'm.cur_HTATHS_HK2', 
                        'm.new_HTATHS', 'm.new_HTATHS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HTATHS', 'm.old_HTATHS_HK2', 
                        'm.cur_HTATHS', 'm.cur_HTATHS_HK2', 
                        'm.new_HTATHS', 'm.new_HTATHS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')
                ->get();


            $getDataTypeC = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 69 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.($year + 1).' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.($year + 1).')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.($year + 1).'-'.($year + 2).'"'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.$year))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.($year + 1)))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 2)))
            
            ->where('qlhs_profile.profile_year', '>', ($year + 1).'-05-31')
            ->where('qlhs_profile.profile_year', '<', ($year + 2).'-06-01')
            ->where('qlhs_profile.profile_statusNQ57', '=', 1)
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HTATHS_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HTATHS > 0 OR yearcur.qlhs_thcd_trangthai_HTATHS_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HTATHS > 0)'))
            
            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HTATHS as old_HTATHS', 'yearold.qlhs_thcd_trangthai_HTATHS_HK2 as old_HTATHS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HTATHS as cur_HTATHS', 'yearcur.qlhs_thcd_trangthai_HTATHS_HK2 as cur_HTATHS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTATHS as new_HTATHS', 'yearnew.qlhs_thcd_trangthai_HTATHS_HK2 as new_HTATHS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HTATHS as money_old', 'yearold.qlhs_thcd_tien_nhucau_HTATHS_HK2 as money_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTATHS as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HTATHS_HK2 as money_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTATHS as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HTATHS_HK2 as money_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 69 then 1 else 0 END) as hotrokinhphi'), 

                DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hocky2_old'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hocky1_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hocky2_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HTATHS', 'yearold.qlhs_thcd_trangthai_HTATHS_HK2', 
                'yearcur.qlhs_thcd_trangthai_HTATHS', 'yearcur.qlhs_thcd_trangthai_HTATHS_HK2', 
                'yearnew.qlhs_thcd_trangthai_HTATHS', 'yearnew.qlhs_thcd_trangthai_HTATHS_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HTATHS', 'yearold.qlhs_thcd_tien_nhucau_HTATHS_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HTATHS', 'yearcur.qlhs_thcd_tien_nhucau_HTATHS_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HTATHS', 'yearnew.qlhs_thcd_tien_nhucau_HTATHS_HK2');
            
            $getDataType3 = DB::table(DB::raw("({$getDataTypeC->toSql()}) as m"))
                ->mergeBindings( $getDataTypeC )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HTATHS', 'm.old_HTATHS_HK2', 
                        'm.cur_HTATHS', 'm.cur_HTATHS_HK2', 
                        'm.new_HTATHS', 'm.new_HTATHS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HTATHS', 'm.old_HTATHS_HK2', 
                        'm.cur_HTATHS', 'm.cur_HTATHS_HK2', 
                        'm.new_HTATHS', 'm.new_HTATHS_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')
                ->get();

            $time = time();

            if ((is_null($getDataType1) || empty($getDataType1) || count($getDataType1) == 0) && (is_null($getDataType2) || empty($getDataType2) || count($getDataType2) == 0) && (is_null($getDataType3) || empty($getDataType3) || count($getDataType3) == 0)) {
                $result['success'] = "Trường không có học sinh thuộc đối tượng!";
                return $result;
            }
            
            if (!is_null($getDataType1) && !empty($getDataType1) && count($getDataType1) > 0) {
                $check = $this->insertHTATHS($getDataType1, 1, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType2) && !empty($getDataType2) && count($getDataType2) > 0 && $check) {
                $check = $this->insertHTATHS($getDataType2, 2, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType3) && !empty($getDataType3) && count($getDataType3) > 0 && $check) {
                $check = $this->insertHTATHS($getDataType3, 3, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if ($check) {
                $type_code = 'HTATHS-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

                $dir = storage_path().'/files/HTATHS';
                

                $insert_hosobaocao_id = DB::table('qlhs_hosobaocao')->insertGetId(['report_name' => $report_name, 'report_type' => $type_code, 'report_date' => $current_date, 'created_at' => $current_date, 'updated_at' => $current_date, 'create_userid' => $current_user_id, 'update_userid' => $current_user_id, 'report_user' => $user_create, 'report_user_sign' => $user_sign, 'report_attach_name' => '', 'report_nature' => $status, 'report_year' => $year, 'report_id_truong' => $school_id, 'report_note' => $note, 'report' => 'HTATHS']);

                if (!is_null($insert_hosobaocao_id) && $insert_hosobaocao_id > 0) {
                    $this->exportforSchoolsHTATHS($insert_hosobaocao_id);

                    if (file_exists(storage_path().'/exceldownload/HTATHS/'.$type_code.'.xlsx')) {
                        // $result['success'] = "Thêm mới thành công!";
                        // return TRUE;
                    }
                    else {
                        $deleteHoso = DB::table('qlhs_hosobaocao')->where('report_type', 'LIKE', '%'.$type_code.'%')->delete();
                        $deleteHTATHS = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', 'LIKE', '%'.$type_code.'%')->delete();
                        // $result['error'] = "Thêm mới thất bại!";
                        // return false;
                    }
                }
                // else {$result['error'] = "Thêm mới thất bại!"; return false;}
                return $insert_hosobaocao_id;
            }
            else {
                return 0;
            }

            // return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function insertHTATHS($getDataType, $type, $current_user_id, $school_id, $year, $time, $capnhan){
        try {
            $bool = TRUE;
            $count = 1;

            $phongGD_duyet = 0;
            if ($capnhan == 3) {
                $phongGD_duyet = 1;
            }
            
            $type_code = 'HTATHS-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

            foreach ($getDataType as $value) {
                $tongnhucau = 0;
                $tongdutoan = 0;

                if ($type != 3) {
                    $tongnhucau = ($value->money_old_HK2 * $value->old_HTATHS_HK2) + ($value->money_cur * $value->cur_HTATHS);
                    $tongdutoan = ($value->money_cur_HK2 * $value->cur_HTATHS_HK2) + $value->money_new;
                }
                elseif ($type == 3) {
                    $tongdutoan = ($value->money_old_HK2 * $value->old_HTATHS_HK2) + $value->money_cur;
                }

                if ($tongnhucau > 0 || $tongdutoan > 0) {
                    $insert_type = DB::table('qlhs_hotrohocsinhdantocthieuso')
                    ->insert([
                        'profile_id' => $value->profile_id, 
                        'hotrokinhphi' => $value->hotrokinhphi, 
                        'hocky2_old' => $value->hocky2_old, 
                        'hocky1_cur' => $value->hocky1_cur, 
                        'hocky2_cur' => $value->hocky2_cur, 
                        'hocky1_new' => $value->hocky1_new, 
                        'nhucau' => $tongnhucau, 
                        'dutoan' => $tongdutoan, 
                        'type_code' => $type_code, 
                        'type' => $type,
                        'trangthai_pheduyet_HSDTTS' => 1,
                        'trangthai_phongGD_HSDTTS' => $phongGD_duyet,
                        'trangthai_phongTC_HSDTTS' => 0,
                        'trangthai_So_HSDTTS' => 0
                        ]);

                    $count++;
                    if ($insert_type == 0) {
                        
                        $deleteHTATHS = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', 'LIKE', '%'.$type_code.'%')->where('type', '=', $type)->delete();
                        $count--;
                        break;
                    }
                }
            }
            
            if ($count > 1) {
                $bool = TRUE;
            }
            else {
                $bool = FALSE;
            }

            return TRUE;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportforSchoolsHTATHS($id, $type = true){
    //$type = true;
        if (is_null($id) || empty($id) || $id == 0) {
            return "Mời bấm vào tên danh sách muốn kết xuất để kêt xuất file Excel!";
        }

        $getSchoolName = DB::table('qlhs_hosobaocao')->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hosobaocao.report_id_truong')->where('qlhs_hosobaocao.report_id', '=', $id)->select('qlhs_schools.schools_name', 'qlhs_hosobaocao.report_type', 'qlhs_hosobaocao.report_year')->first();
        $data_results = [];
        $data_results['aT'] = 'Học sinh có mặt tại trường tháng 5/' . $getSchoolName->report_year;
        $data_results['bT'] = 'Học sinh dự kiến tuyển mới năm học ' . $getSchoolName->report_year . '-' . ((int)$getSchoolName->report_year + 1);
        $data_results['cT'] = 'Học sinh dự kiến tuyển mới năm học ' . ((int)$getSchoolName->report_year + 1) . '-' . ((int)$getSchoolName->report_year + 2);
        if ($getSchoolName->report_type != null && $getSchoolName->report_type != "") {
            $data_results['aCount'] = $this->countValueHTATHS('1',$getSchoolName->report_type);
            $data_results['bCount'] = $this->countValueHTATHS('2',$getSchoolName->report_type);
            $data_results['cCount'] = $this->countValueHTATHS('3',$getSchoolName->report_type);
            $data_results['TotalCount'] = $this->countValueHTATHS(null,$getSchoolName->report_type);
            //Get by type A
            $year = $getSchoolName->report_year;
            $data_results['a'] = DB::table('qlhs_hotrohocsinhdantocthieuso')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 1)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhdantocthieuso.*')->get();

            $data_results['b'] = DB::table('qlhs_hotrohocsinhdantocthieuso')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 2)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhdantocthieuso.*')->get();

            $data_results['c'] = DB::table('qlhs_hotrohocsinhdantocthieuso')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.($getSchoolName->report_year + 1).'-'.($getSchoolName->report_year + 2).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 3)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhdantocthieuso.*')->get();
        }
        $data_results['schools_name'] = $getSchoolName->schools_name;
        $data_results['report_year'] = $getSchoolName->report_year;
        $this->addCellExcelHTATHS($data_results, $getSchoolName->report_type, $type);
    }

    private function addCellExcelHTATHS($data_results, $filename, $type = true){
        $excel =    Excel::load(storage_path().'/exceltemplate/laphosoHTATHS.xlsx', function($reader) use($data_results){
            $borderArray = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => 'thin',
                        'color' => array('argb' => 'FF000000')
                    )
                )
            );
            $FontArray = array(
                'font' => array(
                    'bold' => 'bold'
                )
            );
            $FontArrayitalic = array(
                'font' => array(
                    'italic' => 'italic'
                )
            );
            $style = array(
                'alignment' => array(
                    'horizontal' => 'center',
                )
            );
            $styleLeft = array(
                'alignment' => array(
                    'horizontal' => 'left',
                )
            );
            $styleRight = array(
                'alignment' => array(
                    'horizontal' => 'right',
                )
            );
            $row = 8;

            $col = 0;
            $colA = 0;

            $class_lv1 = 0;
            $class_lv2 = 0;
            $class_lv3 = 0;

            //-----------------------------------------Title------------------------------------------------------------------------------------------------
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, 2, 'NHU CẦU KINH PHÍ NĂM '.$data_results['report_year'].', DỰ TOÁN NĂM '.($data_results['report_year'] + 1).' ĐỐI VỚI CHÍNH SÁCH HỖ TRỢ ĂN TRƯA DÀNH CHO HỌC SINH')->getStyle('A2')->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 5, 'Thông tin cơ bản (tính tại thời điểm tháng 5/'.$data_results['report_year'].')')->getStyle('C5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 7, 'Học kì II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('C7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, 7, 'Năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('D7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, 7, 'Năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('E7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, 7, 'Học kỳ II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('M7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, 7, 'Học kỳ I năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('N7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, 7, 'Học kỳ II năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('O7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, 7, 'Học kỳ I năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('P7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, 5, 'Nhu cầu kinh phí năm '.$data_results['report_year'])->getStyle('Q5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, 5, 'Dự toán kinh phí năm '.($data_results['report_year'] + 1))->getStyle('R5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            //-----------------------------------------End Title----------------------------------------------------------------------------------------------------

            //$data_results['aCount'][0]
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['schools_name'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($FontArrayitalic)->applyFromArray($styleLeft);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['TotalCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['TotalCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['TotalCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['TotalCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['TotalCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['TotalCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'a')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            //____________________________________________________________________________________________________________________________________________________
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['aT'])->getStyle('B'.$row)->applyFromArray($FontArray)->applyFromArray($styleLeft);
            
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['aCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['aCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['aCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['aCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['aCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['aCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            if($data_results['a']->count()>0){
                $indexa = 0;
                foreach($data_results['a'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //     $class_lv1 = $value->level_next_1;
                    //     $class_lv2 = $value->level_next_2;
                    //     $class_lv3 = $value->level_next_3;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //     $class_lv1 = $value->level_next;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = 0;
                    //     $class_lv3 = $value->level_next_1;
                    // }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrokinhphi)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }
            //b

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'b')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['bT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['bCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['bCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['bCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['bCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['bCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['bCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexb = 0;

            if($data_results['b']->count()>0){
                $indexa = 0;
                foreach($data_results['b'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //     $class_lv1 = $value->level_next;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = 0;
                    //     $class_lv3 = $value->level_next_1;
                    // }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrokinhphi)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }

                //c

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'c')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['cT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['cCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['cCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['cCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['cCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['cCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['cCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexc = 0;
            if($data_results['c']->count()>0){
                $indexa = 0;
                foreach($data_results['c'] as $key => $value){
                    $col = 0;   $row++;

                    // $strYear = substr((string)$value->history_year, 0, 4);
                    // if ($strYear < $data_results['report_year']) {
                    //     $class_lv1 = $value->level_next;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear == $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = $value->level_next_1;
                    //     $class_lv3 = $value->level_next_2;
                    // }

                    // if ($strYear > $data_results['report_year']) {
                    //     $class_lv1 = 0;
                    //     $class_lv2 = 0;
                    //     $class_lv3 = $value->level_next_1;
                    // }

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrokinhphi)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                }
            }
        });

        if($type){
            return $excel->setFilename($filename)->store('xlsx', storage_path().'/exceldownload/HTATHS');
        }else{
            return $excel->setFilename($filename)->download('xlsx');
        }
    }
    
    public function countValueHTATHS($type = null,$code){

        if($type!=null){
            $count = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code','=',$code)->where('type','=',$type)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhucau) as tong_nhucau'),
                DB::raw('sum(dutoan) as tong_dutoan'))->first();
            return $count;
        }else{
            $count = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code','=',$code)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhucau) as tong_nhucau'),
                DB::raw('sum(dutoan) as tong_dutoan'))->first();
            return $count;
        }
    }

//---------------------------------------------------------------------HBHSDTNT-----------------------------------------------------------------------
    public function getDataHBHSDTNT($school_id, $year, $report_name, $user_sign, $user_create, $note, $status, $capnhan){
        $result = [];
        try {

            $current_user_id = Auth::user()->id;
            $current_date = Carbon::now('Asia/Ho_Chi_Minh');


            $check = TRUE;

            $getDataTypeA = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 70 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HBHSDTNT = 1 or yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year.' and (yearcur.qlhs_thcd_trangthai_HBHSDTNT = 1 or yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
            
            ->where('qlhs_profile.profile_year', '<', $year.'-06-01')
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HBHSDTNT > 0 OR yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HBHSDTNT > 0)'))

            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HBHSDTNT as old_HBHSDTNT', 'yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2 as old_HBHSDTNT_HK2', 
                'yearcur.qlhs_thcd_trangthai_HBHSDTNT as cur_HBHSDTNT', 'yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2 as cur_HBHSDTNT_HK2', 
                'yearnew.qlhs_thcd_trangthai_HBHSDTNT as new_HBHSDTNT', 'yearnew.qlhs_thcd_trangthai_HBHSDTNT_HK2 as new_HBHSDTNT_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT as money_old', 'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2 as money_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2 as money_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2 as money_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 70 then 1 else 0 END) as hotrokinhphi'), 

                DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hocky2_old'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hocky1_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hocky2_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HBHSDTNT', 'yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2', 
                'yearcur.qlhs_thcd_trangthai_HBHSDTNT', 'yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2', 
                'yearnew.qlhs_thcd_trangthai_HBHSDTNT', 'yearnew.qlhs_thcd_trangthai_HBHSDTNT_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT', 'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT', 'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT', 'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2');
            
            $getDataType1 = DB::table(DB::raw("({$getDataTypeA->toSql()}) as m"))
                ->mergeBindings( $getDataTypeA )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HBHSDTNT', 'm.old_HBHSDTNT_HK2', 
                        'm.cur_HBHSDTNT', 'm.cur_HBHSDTNT_HK2', 
                        'm.new_HBHSDTNT', 'm.new_HBHSDTNT_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HBHSDTNT', 'm.old_HBHSDTNT_HK2', 
                        'm.cur_HBHSDTNT', 'm.cur_HBHSDTNT_HK2', 
                        'm.new_HBHSDTNT', 'm.new_HBHSDTNT_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')
                ->get();


            $getDataTypeB = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 70 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.$year.'-'.($year + 1).'"'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.($year - 1).' and (yearold.qlhs_thcd_trangthai_HBHSDTNT = 1 or yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2 = 1)'))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.$year))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 1)))
            
            ->where('qlhs_profile.profile_year', '>', $year.'-05-31')
            ->where('qlhs_profile.profile_year', '<', ($year + 1).'-06-01')
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HBHSDTNT > 0 OR yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HBHSDTNT > 0)'))
            
            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HBHSDTNT as old_HBHSDTNT', 'yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2 as old_HBHSDTNT_HK2', 
                'yearcur.qlhs_thcd_trangthai_HBHSDTNT as cur_HBHSDTNT', 'yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2 as cur_HBHSDTNT_HK2', 
                'yearnew.qlhs_thcd_trangthai_HBHSDTNT as new_HBHSDTNT', 'yearnew.qlhs_thcd_trangthai_HBHSDTNT_HK2 as new_HBHSDTNT_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT as money_old', 'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2 as money_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2 as money_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2 as money_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 70 then 1 else 0 END) as hotrokinhphi'), 

                DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hocky2_old'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hocky1_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hocky2_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date',  

                'yearold.qlhs_thcd_trangthai_HBHSDTNT', 'yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2', 
                'yearcur.qlhs_thcd_trangthai_HBHSDTNT', 'yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2', 
                'yearnew.qlhs_thcd_trangthai_HBHSDTNT', 'yearnew.qlhs_thcd_trangthai_HBHSDTNT_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT', 'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT', 'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT', 'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2');
            
            $getDataType2 = DB::table(DB::raw("({$getDataTypeB->toSql()}) as m"))
                ->mergeBindings( $getDataTypeB )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HBHSDTNT', 'm.old_HBHSDTNT_HK2', 
                        'm.cur_HBHSDTNT', 'm.cur_HBHSDTNT_HK2', 
                        'm.new_HBHSDTNT', 'm.new_HBHSDTNT_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HBHSDTNT', 'm.old_HBHSDTNT_HK2', 
                        'm.cur_HBHSDTNT', 'm.cur_HBHSDTNT_HK2', 
                        'm.new_HBHSDTNT', 'm.new_HBHSDTNT_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')
                ->get();


            $getDataTypeC = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_subject.profile_subject_subject_id = 70 AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.($year + 1).' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.($year + 1).')'))
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_profile_history.history_year = "'.($year + 1).'-'.($year + 2).'"'))
            
            ->leftJoin('qlhs_tonghopchedo as yearold', 'yearold.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearold.qlhs_thcd_nam = '.$year))
            ->leftJoin('qlhs_tonghopchedo as yearcur', 'yearcur.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearcur.qlhs_thcd_nam = '.($year + 1)))
            ->leftJoin('qlhs_tonghopchedo as yearnew', 'yearnew.qlhs_thcd_profile_id', '=', DB::raw('profile_id AND yearnew.qlhs_thcd_nam = '.($year + 2)))
            
            ->where('qlhs_profile.profile_year', '>', ($year + 1).'-05-31')
            ->where('qlhs_profile.profile_year', '<', ($year + 2).'-06-01')
            ->where('qlhs_profile.profile_school_id','=', DB::raw($school_id.' AND (yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2 > 0 OR yearcur.qlhs_thcd_trangthai_HBHSDTNT > 0 OR yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2 > 0 OR yearnew.qlhs_thcd_trangthai_HBHSDTNT > 0)'))
            
            ->select('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date', 

                'yearold.qlhs_thcd_trangthai_HBHSDTNT as old_HBHSDTNT', 'yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2 as old_HBHSDTNT_HK2', 
                'yearcur.qlhs_thcd_trangthai_HBHSDTNT as cur_HBHSDTNT', 'yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2 as cur_HBHSDTNT_HK2', 
                'yearnew.qlhs_thcd_trangthai_HBHSDTNT as new_HBHSDTNT', 'yearnew.qlhs_thcd_trangthai_HBHSDTNT_HK2 as new_HBHSDTNT_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT as money_old', 'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2 as money_old_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT as money_cur', 'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2 as money_cur_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT as money_new', 'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2 as money_new_HK2', 

                DB::raw('MAX(CASE when qlhs_profile_subject.profile_subject_subject_id = 70 then 1 else 0 END) as hotrokinhphi'), 

                DB::raw('(CASE when qlhs_profile_history.level_old <> "" and qlhs_profile.profile_year < "'.$year.'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-01-01")) then 1 else 0 END) as hocky2_old'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.$year.'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.$year.'-05-31")) then 1 else 0 END) as hocky1_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_cur <> "" and qlhs_profile.profile_year < "'.($year + 1).'-06-01" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-01-01")) then 1 else 0 END) as hocky2_cur'), 
                DB::raw('(CASE when qlhs_profile_history.level_new <> "" and qlhs_profile.profile_year < "'.($year + 1).'-12-31" and (qlhs_profile.profile_leaveschool_date is null or ( qlhs_profile.profile_leaveschool_date > "'.($year + 1).'-05-31")) then 1 else 0 END) as hocky1_new'))
            ->groupBy('qlhs_profile.profile_id', 'qlhs_profile.profile_school_id', 'qlhs_profile.profile_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile.profile_leaveschool_date',  

                'yearold.qlhs_thcd_trangthai_HBHSDTNT', 'yearold.qlhs_thcd_trangthai_HBHSDTNT_HK2', 
                'yearcur.qlhs_thcd_trangthai_HBHSDTNT', 'yearcur.qlhs_thcd_trangthai_HBHSDTNT_HK2', 
                'yearnew.qlhs_thcd_trangthai_HBHSDTNT', 'yearnew.qlhs_thcd_trangthai_HBHSDTNT_HK2', 

                'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT', 'yearold.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2', 

                'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT', 'yearcur.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2', 

                'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT', 'yearnew.qlhs_thcd_tien_nhucau_HBHSDTNT_HK2');
            
            $getDataType3 = DB::table(DB::raw("({$getDataTypeC->toSql()}) as m"))
                ->mergeBindings( $getDataTypeC )
                ->select('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HBHSDTNT', 'm.old_HBHSDTNT_HK2', 
                        'm.cur_HBHSDTNT', 'm.cur_HBHSDTNT_HK2', 
                        'm.new_HBHSDTNT', 'm.new_HBHSDTNT_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')

                ->groupBy('m.profile_id',
                        'm.profile_year',
                        'm.level_old',
                        'm.level_cur',
                        'm.level_new',
                        'm.profile_leaveschool_date',
                        'm.hotrokinhphi',
                        'm.hocky2_old', 
                        'm.hocky1_cur', 
                        'm.hocky2_cur', 
                        'm.hocky1_new', 

                        'm.old_HBHSDTNT', 'm.old_HBHSDTNT_HK2', 
                        'm.cur_HBHSDTNT', 'm.cur_HBHSDTNT_HK2', 
                        'm.new_HBHSDTNT', 'm.new_HBHSDTNT_HK2', 

                        'm.money_old', 'm.money_cur', 'm.money_new', 
                        'm.money_old_HK2', 'm.money_cur_HK2', 'm.money_new_HK2')
                ->get();

            $time = time();

            if ((is_null($getDataType1) || empty($getDataType1) || count($getDataType1) == 0) && (is_null($getDataType2) || empty($getDataType2) || count($getDataType2) == 0) && (is_null($getDataType3) || empty($getDataType3) || count($getDataType3) == 0)) {
                $result['success'] = "Trường không có học sinh thuộc đối tượng!";
                return $result;
            }
            
            if (!is_null($getDataType1) && !empty($getDataType1) && count($getDataType1) > 0) {
                $check = $this->insertHBHSDTNT($getDataType1, 1, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType2) && !empty($getDataType2) && count($getDataType2) > 0 && $check) {
                $check = $this->insertHBHSDTNT($getDataType2, 2, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if (!is_null($getDataType3) && !empty($getDataType3) && count($getDataType3) > 0 && $check) {
                $check = $this->insertHBHSDTNT($getDataType3, 3, $current_user_id, $school_id, $year, $time, $capnhan);
            }

            if ($check) {
                $type_code = 'HBHSDTNT-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

                $dir = storage_path().'/files/HBHSDTNT';
                

                $insert_hosobaocao_id = DB::table('qlhs_hosobaocao')->insertGetId(['report_name' => $report_name, 'report_type' => $type_code, 'report_date' => $current_date, 'created_at' => $current_date, 'updated_at' => $current_date, 'create_userid' => $current_user_id, 'update_userid' => $current_user_id, 'report_user' => $user_create, 'report_user_sign' => $user_sign, 'report_attach_name' => '', 'report_nature' => $status, 'report_year' => $year, 'report_id_truong' => $school_id, 'report_note' => $note, 'report' => 'HBHSDTNT']);

                if (!is_null($insert_hosobaocao_id) && $insert_hosobaocao_id > 0) {
                    $this->exportforSchoolsHBHSDTNT($insert_hosobaocao_id);

                    if (file_exists(storage_path().'/exceldownload/HBHSDTNT/'.$type_code.'.xlsx')) {
                        // $result['success'] = "Thêm mới thành công!";
                        // return TRUE;
                    }
                    else {
                        $deleteHoso = DB::table('qlhs_hosobaocao')->where('report_type', 'LIKE', '%'.$type_code.'%')->delete();
                        $deleteHBHSDTNT = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', 'LIKE', '%'.$type_code.'%')->delete();
                        // $result['error'] = "Thêm mới thất bại!";
                        // return false;
                    }
                }
                // else {$result['error'] = "Thêm mới thất bại!"; return false;}
                return $insert_hosobaocao_id;
            }
            else {
                return 0;
            }

            // return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function insertHBHSDTNT($getDataType, $type, $current_user_id, $school_id, $year, $time, $capnhan){
        try {
            $bool = TRUE;
            $count = 1;

            $phongGD_duyet = 0;
            if ($capnhan == 3) {
                $phongGD_duyet = 1;
            }
            
            $type_code = 'HBHSDTNT-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

            foreach ($getDataType as $value) {
                $tongnhucau = 0;
                $tongdutoan = 0;

                if ($type != 3) {
                    $tongnhucau = ($value->money_old_HK2 * $value->old_HBHSDTNT_HK2) + ($value->money_cur * $value->cur_HBHSDTNT);
                    $tongdutoan = ($value->money_cur_HK2 * $value->cur_HBHSDTNT_HK2) + $value->money_new;
                }
                elseif ($type == 3) {
                    $tongdutoan = ($value->money_old_HK2 * $value->old_HBHSDTNT_HK2) + $value->money_cur;
                }

                if ($tongnhucau > 0 || $tongdutoan > 0) {
                    $insert_type = DB::table('qlhs_hotrohocsinhdantocthieuso')
                    ->insert([
                        'profile_id' => $value->profile_id, 
                        'hotrokinhphi' => $value->hotrokinhphi, 
                        'hocky2_old' => $value->hocky2_old, 
                        'hocky1_cur' => $value->hocky1_cur, 
                        'hocky2_cur' => $value->hocky2_cur, 
                        'hocky1_new' => $value->hocky1_new, 
                        'nhucau' => $tongnhucau, 
                        'dutoan' => $tongdutoan, 
                        'type_code' => $type_code, 
                        'type' => $type,
                        'trangthai_pheduyet_HSDTTS' => 1,
                        'trangthai_phongGD_HSDTTS' => $phongGD_duyet,
                        'trangthai_phongTC_HSDTTS' => 0,
                        'trangthai_So_HSDTTS' => 0
                        ]);

                    $count++;

                    if ($insert_type == 0) {
                        
                        $deleteHBHSDTNT = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', 'LIKE', '%'.$type_code.'%')->where('type', '=', $type)->delete();

                        $count--;
                        break;
                    }
                }
            }

            if ($count > 1) {
                $bool = TRUE;
            }
            else {
                $bool = FALSE;
            }

            return TRUE;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportforSchoolsHBHSDTNT($id, $type = true){
    //$type = true;
        if (is_null($id) || empty($id) || $id == 0) {
            return "Mời bấm vào tên danh sách muốn kết xuất để kêt xuất file Excel!";
        }

        $getSchoolName = DB::table('qlhs_hosobaocao')->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hosobaocao.report_id_truong')->where('qlhs_hosobaocao.report_id', '=', $id)->select('qlhs_schools.schools_name', 'qlhs_hosobaocao.report_type', 'qlhs_hosobaocao.report_year')->first();
        $data_results = [];
        $data_results['aT'] = 'Học sinh có mặt tại trường tháng 5/' . $getSchoolName->report_year;
        $data_results['bT'] = 'Học sinh dự kiến tuyển mới năm học ' . $getSchoolName->report_year . '-' . ((int)$getSchoolName->report_year + 1);
        $data_results['cT'] = 'Học sinh dự kiến tuyển mới năm học ' . ((int)$getSchoolName->report_year + 1) . '-' . ((int)$getSchoolName->report_year + 2);
        if ($getSchoolName->report_type != null && $getSchoolName->report_type != "") {
            $data_results['aCount'] = $this->countValueHBHSDTNT('1',$getSchoolName->report_type);
            $data_results['bCount'] = $this->countValueHBHSDTNT('2',$getSchoolName->report_type);
            $data_results['cCount'] = $this->countValueHBHSDTNT('3',$getSchoolName->report_type);
            $data_results['TotalCount'] = $this->countValueHBHSDTNT(null,$getSchoolName->report_type);
            //Get by type A
            $year = $getSchoolName->report_year;
            $data_results['a'] = DB::table('qlhs_hotrohocsinhdantocthieuso')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 1)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhdantocthieuso.*')->get();

            $data_results['b'] = DB::table('qlhs_hotrohocsinhdantocthieuso')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.$getSchoolName->report_year.'-'.($getSchoolName->report_year + 1).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 2)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhdantocthieuso.*')->get();

            $data_results['c'] = DB::table('qlhs_hotrohocsinhdantocthieuso')
            ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
            ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.($getSchoolName->report_year + 1).'-'.($getSchoolName->report_year + 2).'"'))
            ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getSchoolName->report_type)
            ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 3)
            ->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'qlhs_hotrohocsinhdantocthieuso.*')->get();
        }
        $data_results['schools_name'] = $getSchoolName->schools_name;
        $data_results['report_year'] = $getSchoolName->report_year;
        $this->addCellExcelHBHSDTNT($data_results, $getSchoolName->report_type, $type);
    }

    private function addCellExcelHBHSDTNT($data_results, $filename, $type = true){
        $excel =    Excel::load(storage_path().'/exceltemplate/laphosoHBHSDTNT.xlsx', function($reader) use($data_results){
            $borderArray = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => 'thin',
                        'color' => array('argb' => 'FF000000')
                    )
                )
            );
            $FontArray = array(
                'font' => array(
                    'bold' => 'bold'
                )
            );
            $FontArrayitalic = array(
                'font' => array(
                    'italic' => 'italic'
                )
            );
            $style = array(
                'alignment' => array(
                    'horizontal' => 'center',
                )
            );
            $styleLeft = array(
                'alignment' => array(
                    'horizontal' => 'left',
                )
            );
            $styleRight = array(
                'alignment' => array(
                    'horizontal' => 'right',
                )
            );
            $row = 8;

            $col = 0;
            $colA = 0;

            $class_lv1 = 0;
            $class_lv2 = 0;
            $class_lv3 = 0;

            //-----------------------------------------Title------------------------------------------------------------------------------------------------
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, 2, 'NHU CẦU KINH PHÍ NĂM '.$data_results['report_year'].', DỰ TOÁN NĂM '.($data_results['report_year'] + 1).' ĐỐI VỚI CHÍNH SÁCH HỖ TRỢ HỌC BỔNG DÀNH CHO HỌC SINH DÂN TỘC NỘI TRÚ')->getStyle('A2')->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 5, 'Thông tin cơ bản (tính tại thời điểm tháng 5/'.$data_results['report_year'].')')->getStyle('C5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 7, 'Học kì II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('C7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, 7, 'Năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('D7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, 7, 'Năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('E7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, 7, 'Học kỳ II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('M7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, 7, 'Học kỳ I năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('N7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, 7, 'Học kỳ II năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('O7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, 7, 'Học kỳ I năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('P7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, 5, 'Nhu cầu kinh phí năm '.$data_results['report_year'])->getStyle('Q5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, 5, 'Dự toán kinh phí năm '.($data_results['report_year'] + 1))->getStyle('R5')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            //-----------------------------------------End Title----------------------------------------------------------------------------------------------------

            //$data_results['aCount'][0]
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['schools_name'])->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($FontArrayitalic)->applyFromArray($styleLeft);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['TotalCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['TotalCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['TotalCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['TotalCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['TotalCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['TotalCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style)->applyFromArray($FontArrayitalic);

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'a')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            //____________________________________________________________________________________________________________________________________________________
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['aT'])->getStyle('B'.$row)->applyFromArray($FontArray)->applyFromArray($styleLeft);
            
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['aCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['aCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['aCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['aCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['aCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['aCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            if($data_results['a']->count()>0){
                $indexa = 0;
                foreach($data_results['a'] as $key => $value){
                    $col = 0;   $row++;

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrokinhphi)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }
            //b

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'b')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['bT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['bCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['bCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['bCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['bCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['bCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['bCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexb = 0;

            if($data_results['b']->count()>0){
                $indexa = 0;
                foreach($data_results['b'] as $key => $value){
                    $col = 0;   $row++;

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_new)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrokinhphi)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    }
                }

                //c

            $row++;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row,'c')->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row,$data_results['cT'])->getStyle('B'.$row)->applyFromArray($FontArray);
            // /$colAnext = 14;
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, '')->getStyle('C'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, '')->getStyle('D'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, '')->getStyle('E'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, '')->getStyle('F'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, '')->getStyle('G'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, '')->getStyle('H'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, '')->getStyle('I'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, '')->getStyle('J'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, '')->getStyle('K'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, '')->getStyle('L'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row,$data_results['cCount']->tonghocky2_old)->getStyle('M'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(13, $row,$data_results['cCount']->tonghocky1_cur)->getStyle('N'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(14, $row,$data_results['cCount']->tonghocky2_cur)->getStyle('O'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(15, $row,$data_results['cCount']->tonghocky1_new)->getStyle('P'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(16, $row,$data_results['cCount']->tong_nhucau)->getStyle('Q'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(17, $row,$data_results['cCount']->tong_dutoan)->getStyle('R'.$row)->applyFromArray($FontArray)->applyFromArray($borderArray)->applyFromArray($styleRight);

            $indexc = 0;
            if($data_results['c']->count()>0){
                $indexa = 0;
                foreach($data_results['c'] as $key => $value){
                    $col = 0;   $row++;

                    $reader->getActiveSheet()->setCellValueByColumnAndRow($col, $row,++$indexa)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,'')->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                            
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->level_cur)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,Carbon::parse($value->profile_birthday)->format('d-m-Y'))->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nationals_name)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);  
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_parentname)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->profile_household)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenxa)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->tenhuyen)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);         
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hotrokinhphi)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);        
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_old)->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_cur)->getStyle('N'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight); 

                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky2_cur)->getStyle('O'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->hocky1_new)->getStyle('P'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->nhucau)->getStyle('Q'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);      
                    $reader->getActiveSheet()->setCellValueByColumnAndRow(++$col, $row,$value->dutoan)->getStyle('R'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
                }
            }
        });

        if($type){
            return $excel->setFilename($filename)->store('xlsx', storage_path().'/exceldownload/HBHSDTNT');
        }else{
            return $excel->setFilename($filename)->download('xlsx');
        }
    }
    
    public function countValueHBHSDTNT($type = null,$code){

        if($type!=null){
            $count = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code','=',$code)->where('type','=',$type)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhucau) as tong_nhucau'),
                DB::raw('sum(dutoan) as tong_dutoan'))->first();
            return $count;
        }else{
            $count = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code','=',$code)
            ->select(
                DB::raw('sum(hocky2_old) as tonghocky2_old'),
                DB::raw('sum(hocky1_cur) as tonghocky1_cur'),
                DB::raw('sum(hocky2_cur) as tonghocky2_cur'),
                DB::raw('sum(hocky1_new) as tonghocky1_new'),
                DB::raw('sum(nhucau) as tong_nhucau'),
                DB::raw('sum(dutoan) as tong_dutoan'))->first();
            return $count;
        }
    }

//---------------------------------------------------------------------NGNA---------------------------------------------------------------------------
    public function getDataNGNA($school_id, $year, $report_name, $user_sign, $user_create, $note, $status){
        $result = [];
        try {
            $current_user_id = Auth::user()->id;
            $current_date = Carbon::now('Asia/Ho_Chi_Minh');
            
            
            $check = TRUE;

            $getMoney = DB::table('qlhs_schools_history', 'qlhs_schools_history.type_his_school_id', '=', DB::raw($school_id.' AND qlhs_schools_history.type_his_startdate <= "'.$year.'-09-05" AND (qlhs_schools_history.type_his_enddate >= "'.$year.'-09-10" OR qlhs_schools_history.type_his_enddate is null)'))

            ->join('years_months_kp as kp', 'kp.id_schooltype', '=', DB::raw('qlhs_schools_history.type_his_type_id AND kp.id_doituong = 102 AND '.$year.' <= YEAR(kp.date_con) and YEAR(kp.date_con) <= '.($year + 1).''))
            
            ->select(
                    DB::raw('MAX(
                            CASE
                            WHEN (kp.months in (1,2,3,4,5) and kp.years = '.$year.' AND kp.id_doituong = 102) 
                            THEN
                                kp.value_m
                            ELSE
                                0
                            END
                        ) AS NHUCAU1'),
                    DB::raw('MAX(
                            CASE
                            WHEN (kp.months in (9,10,11,12) and kp.years = '.$year.' AND kp.id_doituong = 102) 
                            THEN
                                kp.value_m
                            ELSE
                                0
                            END
                        ) AS NHUCAU2'),
                    DB::raw('MAX(
                            CASE
                            WHEN (kp.months in (1,2,3,4,5) and kp.years = '.($year + 1).' AND kp.id_doituong = 102) 
                            THEN
                                kp.value_m
                            ELSE
                                0
                            END
                        ) AS DUTOAN1'),
                    DB::raw('MAX(
                            CASE
                            WHEN (kp.months in (9,10,11,12) and kp.years = '.($year + 1).' AND kp.id_doituong = 102) 
                            THEN
                                kp.value_m
                            ELSE
                                0
                            END
                        ) AS DUTOAN2'));
            
            $getData = DB::table(DB::raw("({$getMoney->toSql()}) as m"))
                ->mergeBindings( $getMoney )
                ->select(
                        DB::raw('SUM(m.NHUCAU1) as nhucau'), 
                        DB::raw('SUM(m.DUTOAN1) as duToan'),
                        DB::raw('SUM(m.NHUCAU2) as nhucau1'), 
                        DB::raw('SUM(m.DUTOAN2) as duToan1'))
                ->get();

            // return $getData;

            // $getHS_old = DB::select("select * from qlhs_profile where profile_bantru = 1 and profile_school_id = ".$school_id." and profile_year < '".$year."-06-01' and (profile_leaveschool_date IS NULL or profile_leaveschool_date > '".$year."-01-01')", array());

            $getHS_old = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->where('qlhs_profile.profile_school_id', '=', $school_id)
            ->where('qlhs_profile.profile_year', '<', DB::raw('"'.$year.'-06-01" AND (profile_leaveschool_date IS NULL OR profile_leaveschool_date > "'.$year.'-01-01")'))
            ->select('profile_id')->groupBy('profile_id')->get();
            

            $getHS_cur1 = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->where('qlhs_profile.profile_school_id', '=', $school_id)
            ->where('qlhs_profile.profile_year', '<', DB::raw('"'.$year.'-12-31" AND (profile_leaveschool_date IS NULL OR profile_leaveschool_date > "'.$year.'-06-01")'))
            ->select('profile_id')->groupBy('profile_id')->get();


            $getHS_cur2 = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.$year.' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.$year.')'))
            ->where('qlhs_profile.profile_school_id', '=', $school_id)
            ->where('qlhs_profile.profile_year', '<', DB::raw('"'.($year + 1).'-06-01" AND (profile_leaveschool_date IS NULL OR profile_leaveschool_date > "'.($year + 1).'-01-01")'))
            ->select('profile_id')->groupBy('profile_id')->get();


            $getHS_new = DB::table('qlhs_profile')
            ->join('qlhs_profile_subject', 'qlhs_profile_subject.profile_subject_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_profile_subject.active = 1 AND qlhs_profile_subject.start_year <= '.($year + 1).' AND (qlhs_profile_subject.end_year is null OR qlhs_profile_subject.end_year > '.($year + 1).')'))
            ->where('qlhs_profile.profile_school_id', '=', $school_id)
            ->where('qlhs_profile.profile_year', '<', DB::raw('"'.($year + 1).'-12-31" AND (profile_leaveschool_date IS NULL OR profile_leaveschool_date > "'.($year + 1).'-06-01")'))
            ->select('profile_id')->groupBy('profile_id')->get();

            $time = time();

            $getNGNA_old = DB::table('qlhs_nguoinauan')->where('NGNA_school_id', $school_id)->where('NGNA_startdate', '<=', DB::raw('"'.$year.'-01-01" AND (NGNA_enddate >= "'.$year.'-06-01" OR NGNA_enddate is null)'))->select('NGNA_amount')->first();

            $getNGNA_cur1 = DB::table('qlhs_nguoinauan')->where('NGNA_school_id', $school_id)->where('NGNA_startdate', '<=', DB::raw('"'.$year.'-09-01" AND (NGNA_enddate >= "'.$year.'-12-31" OR NGNA_enddate is null)'))->select('NGNA_amount')->first();


            $getNGNA_cur2 = DB::table('qlhs_nguoinauan')->where('NGNA_school_id', $school_id)->where('NGNA_startdate', '<=', DB::raw('"'.($year + 1).'-01-01" AND (NGNA_enddate >= "'.($year + 1).'-06-01" OR NGNA_enddate is null)'))->select('NGNA_amount')->first();

            $getNGNA_new = DB::table('qlhs_nguoinauan')->where('NGNA_school_id', $school_id)->where('NGNA_startdate', '<=', DB::raw('"'.($year + 1).'-09-01" AND (NGNA_enddate >= "'.($year + 1).'-12-31" OR NGNA_enddate is null)'))->select('NGNA_amount')->first();

            if ((is_null($getHS_old) || empty($getHS_old) || count($getHS_old) == 0)
                && (is_null($getHS_cur1) || empty($getHS_cur1) || count($getHS_cur1) == 0)
                && (is_null($getHS_cur2) || empty($getHS_cur2) || count($getHS_cur2) == 0)
                && (is_null($getHS_new) || empty($getHS_new) || count($getHS_new) == 0)
                && (is_null($getNGNA_old) || empty($getNGNA_old) || $getNGNA_old->NGNA_amount == 0)
                && (is_null($getNGNA_cur1) || empty($getNGNA_cur1) || $getNGNA_cur1->NGNA_amount == 0)
                && (is_null($getNGNA_cur2) || empty($getNGNA_cur2) || $getNGNA_cur2->NGNA_amount == 0)
                && (is_null($getNGNA_new) || empty($getNGNA_new) || $getNGNA_new->NGNA_amount == 0)
                && $getData[0]->{'nhucau'} == 0 && $getData[0]->{'duToan'} == 0 && $getData[0]->{'nhucau1'} == 0 && $getData[0]->{'duToan1'} == 0) {
                // $result['success'] = "Danh sách trống!";
                return 0;
            }

            $amount_old = 0;
            $amount_cur1 = 0;
            $amount_cur2 = 0;
            $amount_new = 0;

            if (!is_null($getNGNA_old->NGNA_amount) && !empty($getNGNA_old->NGNA_amount)) {
                $amount_old = $getNGNA_old->NGNA_amount;
            }
            if (!is_null($getNGNA_cur1->NGNA_amount) && !empty($getNGNA_cur1->NGNA_amount)) {
                $amount_cur1 = $getNGNA_cur1->NGNA_amount;
            }
            if (!is_null($getNGNA_cur2->NGNA_amount) && !empty($getNGNA_cur2->NGNA_amount)) {
                $amount_cur2 = $getNGNA_cur2->NGNA_amount;
            }
            if (!is_null($getNGNA_new->NGNA_amount) && !empty($getNGNA_new->NGNA_amount)) {
                $amount_new = $getNGNA_new->NGNA_amount;
            }
            
            // if (!is_null($getData) && !empty($getData) && count($getData) > 0) {
            $check = $this->insertNGNA($getData[0]->{'nhucau'}, $getData[0]->{'duToan'}, $getData[0]->{'nhucau1'}, $getData[0]->{'duToan1'}, count($getHS_old), count($getHS_cur1), count($getHS_cur2), count($getHS_new), $current_user_id, $school_id, $year, $time, $amount_old, $amount_cur1, $amount_cur2, $amount_new);
            // }

            if ($check) {
                $type_code = 'NGNA-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

                // $dir = storage_path().'/files/NGNA';
                // if(trim($files) != ""){
                //     if(file_exists($dir.'/'. $filename_attach)){
                //         $files->move($dir, $filename_attach.'-'.$time); 
                //         //File::delete($dir.'/'. $filename_attach); 
                //     }else{
                //         $files->move($dir, $filename_attach);   
                //     }
                // }

                $insert_hosobaocao_id = DB::table('qlhs_hosobaocao')->insertGetId(['report_name' => $report_name, 'report_type' => $type_code, 'report_date' => $current_date, 'created_at' => $current_date, 'updated_at' => $current_date, 'create_userid' => $current_user_id, 'update_userid' => $current_user_id, 'report_user' => $user_create, 'report_user_sign' => $user_sign, 'report_attach_name' => '', 'report_nature' => $status, 'report_year' => $year, 'report_id_truong' => $school_id, 'report_note' => $note, 'report' => 'NGNA']);

                if (!is_null($insert_hosobaocao_id) && $insert_hosobaocao_id > 0) {
                    $this->exportforSchoolsNGNA($insert_hosobaocao_id);

                    if (file_exists(storage_path().'/exceldownload/NGNA/'.$type_code.'.xlsx')) {
                        // $result['success'] = "Thêm mới thành công!";
                    }
                    else {
                        $deleteHoso = DB::table('qlhs_hosobaocao')->where('report_type', 'LIKE', '%'.$type_code.'%')->delete();
                        $deleteNGNA = DB::table('qlhs_hotronguoinauan')->where('type_code', 'LIKE', '%'.$type_code.'%')->delete();
                        // $result['error'] = "Thêm mới thất bại!";
                    }
                }

                return $insert_hosobaocao_id;
                // else {$result['error'] = "Thêm mới thất bại!";}
            }
            // else {$result['error'] = "Thêm mới thất bại!";}

            // return $result;
        } catch (Exception $e) {
            return $e;
        }       
    }

    public function insertNGNA($nhucau, $dutoan, $nhucau1, $dutoan1, $hs_old, $hs_cur1, $hs_cur2, $hs_new, $current_user_id, $school_id, $year, $time, $amount_old, $amount_cur1, $amount_cur2, $amount_new){
        try {
            $bool = TRUE;
            
            $type_code = 'NGNA-' . $current_user_id . '-' . $school_id . '-' . $year . '' . ($year + 1) . '-' . $time;

            // foreach ($getData as $value) {
                $sohocsinhhocky2_old = (int)$hs_old;//$value->{'sohocsinhhocky2_old'};
                $sohocsinhhocky1_cur = (int)$hs_cur1;//$value->{'sohocsinhhocky1_cur'};
                $sohocsinhhocky2_cur = (int)$hs_cur2;//$value->{'sohocsinhhocky2_cur'};
                $sohocsinhhocky1_new = (int)$hs_new;//$value->{'sohocsinhhocky1_new'};

                $tong_nhucau = 0;
                
                $tong_nhucau = ($nhucau * 5 * $amount_old) + ($nhucau1 * 4 * $amount_cur1);

                $tong_dutoan = 0;
                
                $tong_dutoan = ($dutoan * 5 * $amount_cur2) + ($dutoan1 * 4 * $amount_new);

                $insert_type = DB::table('qlhs_hotronguoinauan')->insert([
                    'school_id' => $school_id, 
                    'sohocsinhhocky2_old' => $sohocsinhhocky2_old, 
                    'sohocsinhhocky1_cur' => $sohocsinhhocky1_cur, 
                    'sohocsinhhocky2_cur' => $sohocsinhhocky2_cur, 
                    'sohocsinhhocky1_new' => $sohocsinhhocky1_new, 
                    'nguoinauanhocky2_old' => $amount_old, 
                    'nguoinauanhocky1_cur' => $amount_cur1, 
                    'nguoinauanhocky2_cur' => $amount_cur2, 
                    'nguoinauanhocky1_new' => $amount_new, 
                    'nhucau' => $tong_nhucau, 
                    'dutoan' => $tong_dutoan, 
                    'type_code' => $type_code
                    ]);

                if ($insert_type == 0) {
                    $bool = FALSE;
                }
            // }

            return $bool;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function exportforSchoolsNGNA($id, $type = true){
    //$type = true;
        if (is_null($id) || empty($id) || $id == 0) {
            return "Mời bấm vào tên danh sách muốn kết xuất để kêt xuất file Excel!";
        }

        $getSchoolName = DB::table('qlhs_hosobaocao')->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hosobaocao.report_id_truong')->where('qlhs_hosobaocao.report_id', '=', $id)->select('qlhs_schools.schools_name', 'qlhs_hosobaocao.report_type', 'qlhs_hosobaocao.report_year')->first();
        $data_results = [];
        
        if ($getSchoolName->report_type != null && $getSchoolName->report_type != "") {
            //Get by type A
            $data_results = DB::table('qlhs_hotronguoinauan')
            ->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hotronguoinauan.school_id')
            ->where('qlhs_hotronguoinauan.type_code', '=', $getSchoolName->report_type)
            ->select('qlhs_schools.schools_name', 'qlhs_hotronguoinauan.*')->get();
        }
        
        $data_results['report_year'] = $getSchoolName->report_year;
        $this->addCellExcelNGNA($data_results, $getSchoolName->report_type, $type);
    }
    
    private function addCellExcelNGNA($data_results, $filename, $type = true){
        $excel =    Excel::load(storage_path().'/exceltemplate/laphosoNGNA.xlsx', function($reader) use($data_results){
            $borderArray = array(
                'borders' => array(
                    'allborders' => array(
                        'style' => 'thin',
                        'color' => array('argb' => 'FF000000')
                    )
                )
            );
            $FontArray = array(
                'font' => array(
                    'bold' => 'bold'
                )
            );
            $FontArrayitalic = array(
                'font' => array(
                    'italic' => 'italic'
                )
            );
            $style = array(
                'alignment' => array(
                    'horizontal' => 'center',
                )
            );
            $styleLeft = array(
                'alignment' => array(
                    'horizontal' => 'left',
                )
            );
            $styleRight = array(
                'alignment' => array(
                    'horizontal' => 'right',
                )
            );
            $row = 8;

            $col = 0;
            $colA = 0;

            //-----------------------------------------Title------------------------------------------------------------------------------------------------
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, 3, 'NHU CẦU KINH PHÍ NĂM '.$data_results['report_year'].', DỰ TOÁN NĂM '.($data_results['report_year'] + 1).' ĐỐI VỚI CHÍNH SÁCH HỖ TRỢ NGƯỜI NẤU ĂN THEO NGHỊ QUYẾT SỐ 23/2015/NQ-HĐND CỦA HỘI ĐỒNG NHÂN DÂN')->getStyle('A3')->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, 7, 'Học kỳ II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('C7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, 7, 'Học kỳ I năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('D7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, 7, 'Học kỳ II năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('E7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, 7, 'Học kỳ I năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('F7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, 7, 'Học kỳ II năm học '.($data_results['report_year'] - 1).'-'.$data_results['report_year'])->getStyle('G7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, 7, 'Học kỳ I năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('H7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, 7, 'Học kỳ II năm học '.$data_results['report_year'].'-'.($data_results['report_year'] + 1))->getStyle('I7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, 7, 'Học kỳ I năm học '.($data_results['report_year'] + 1).'-'.($data_results['report_year'] + 2))->getStyle('J7')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);

            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, 6, 'Nhu cầu kinh phí năm '.$data_results['report_year'])->getStyle('K6')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, 6, 'Dự toán kinh phí năm '.($data_results['report_year'] + 1))->getStyle('L6')->applyFromArray($borderArray)->applyFromArray($FontArray)->applyFromArray($style);
            //-----------------------------------------End Title----------------------------------------------------------------------------------------------------

            //$data_results['aCount'][0]
            $reader->getActiveSheet()->setCellValueByColumnAndRow(0, $row, 1)->getStyle('A'.$row)->applyFromArray($borderArray)->applyFromArray($style);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(1, $row, $data_results[0]->schools_name)->getStyle('B'.$row)->applyFromArray($borderArray)->applyFromArray($styleLeft);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(2, $row, $data_results[0]->sohocsinhhocky2_old)->getStyle('C'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(3, $row, $data_results[0]->sohocsinhhocky1_cur)->getStyle('D'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(4, $row, $data_results[0]->sohocsinhhocky2_cur)->getStyle('E'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(5, $row, $data_results[0]->sohocsinhhocky1_new)->getStyle('F'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(6, $row, $data_results[0]->nguoinauanhocky2_old)->getStyle('G'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(7, $row, $data_results[0]->nguoinauanhocky1_cur)->getStyle('H'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(8, $row, $data_results[0]->nguoinauanhocky2_cur)->getStyle('I'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(9, $row, $data_results[0]->nguoinauanhocky1_new)->getStyle('J'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(10, $row, $data_results[0]->nhucau)->getStyle('K'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(11, $row, $data_results[0]->dutoan)->getStyle('L'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            $reader->getActiveSheet()->setCellValueByColumnAndRow(12, $row, '')->getStyle('M'.$row)->applyFromArray($borderArray)->applyFromArray($styleRight);
            
        });
        if($type){
            return $excel->setFilename($filename)->store('xlsx', storage_path().'/exceldownload/NGNA');
        }else{
            return $excel->setFilename($filename)->download('xlsx');
        }
    }

//------------------------------------------------------------Thêm mới học sinh new-------------------------------------------------------------------
    public function getViewChedo(){
        return view('admin.hoso.hosohocsinh.listingnew');
    }
    public function getViewLapCongVan(){
        return view('admin.hoso.lapdanhsach.listinglapcongvan');
    }


    public function getViewDanhsachdalap(){
        return view('admin.hoso.hosohocsinh.listingview');
    }

    public function loadDataBaocao(Request $request)
    {
        try {
            $school_id = $request->input('SCHOOLID');
            $arrYear = $request->input('YEAR');
            $currentdate = Carbon::now('Asia/Ho_Chi_Minh')->toDateString();
            $year = [];
            $year = explode('-', $arrYear);

            $getData = DB::table('qlhs_hosobaocao')
                ->leftJoin('users', 'id', '=', 'create_userid')
                ->where('report_id_truong', '=', $school_id)
                ->where('report_year', '=', $year[1])
                ->where('report_date', 'LIKE', '%'.$currentdate.'%')
                ->select('report_id', 'report_name', 'report_type', 'report_date', 'report', 'report_status', 'first_name', 'last_name')
                ->orderBy('report_date', 'desc')->get();

            return $getData;
        } catch (Exception $e) {
            return $e;
        }
    }



//---------------------------------------------------------Danh sách học sinh chờ phê duyệt-----------------------------------------------------------
    public function ViewApproved(){
        $school = Auth::user()->truong_id;
        $congvan = '';
        return view('admin.hoso.hosohocsinh.listingnewapproved',['school' => $school,'congvan' =>$congvan]);
    }
    public function getViewApproved($school,$congvan){
        return view('admin.hoso.hosohocsinh.listingnewapproved',['school' => $school,'congvan' =>$congvan]);
    }

    public function loadDanhSachChoPheDuyet(Request $request)
    {
        try {
            $json = [];
            $start = $request->input('start');
            $limit = $request->input('limit');

            $schools_id = $request->input('SCHOOLID');
           // $year = $request->input('YEAR');
            $socongvan = $request->input('SOCONGVAN');
            $keySearch = $request->input('KEY');
            // $status = $request->input('STATUS');

            // $arrYear = [];
            // $arrYear = explode("-", $year);
            // $schoolId = 37;//$request->input('SCHOOLID');
         //    $year = 2016;//$request->input('YEAR');
         //    $profileId = 834;

            $user = Auth::user()->id;
            $levelUser = 0;

            $getLevelUser = DB::table('users')->where('id', $user)->select('level')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
            }

            if ($levelUser == 1) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_MGHP = 0 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_CPHT = 0 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTAT = 0 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTBT = 0 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HSKT = 0 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_pheduyet_HSDTTS = 0 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_pheduyet_HSDTTS = 0 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_pheduyet_HSDTTS = 0 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }
            else if ($levelUser == 2) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 0 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 0 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 0 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 0 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 0 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 0 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 0 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 0 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }
            else if ($levelUser == 3) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 0 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 0 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 0 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 0 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 0 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 0 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 0 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 0 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }
            else if ($levelUser == 4) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_MGHP = 1 AND trangthai_So_MGHP = 0 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_CPHT = 1 AND trangthai_So_CPHT = 0 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HTAT = 1 AND trangthai_So_HTAT = 0 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HTBT = 1 AND trangthai_So_HTBT = 0 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HSKT = 1 AND trangthai_So_HSKT = 0 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_phongTC_HSDTTS = 1 AND hsdtts.trangthai_So_HSDTTS = 0 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_phongTC_HSDTTS = 1 AND htaths.trangthai_So_HSDTTS = 0 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1 AND hbhsdtnt.trangthai_So_HSDTTS = 0 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }

            // if (!is_null($status) && !empty($status)) {
            //     if ($status == "CHO") {
            //         $datas->where('trangthai_pheduyet_MGHP', '=', DB::raw('0 or trangthai_pheduyet_CPHT = 0 or trangthai_pheduyet_HTAT = 0 or trangthai_pheduyet_HTBT = 0 or trangthai_pheduyet_HSKT = 0 or hsdtts.trangthai_pheduyet_HSDTTS = 0 or htaths.trangthai_pheduyet_HSDTTS = 0 or hbhsdtnt.trangthai_pheduyet_HSDTTS = 0'));
            //     }
            //     if ($status == "DA") {
            //         $datas->where('trangthai_pheduyet_MGHP', '=', DB::raw('1 or trangthai_pheduyet_CPHT = 1 or trangthai_pheduyet_HTAT = 1 or trangthai_pheduyet_HTBT = 1 or trangthai_pheduyet_HSKT = 1 or hsdtts.trangthai_pheduyet_HSDTTS = 1 or htaths.trangthai_pheduyet_HSDTTS = 1 or hbhsdtnt.trangthai_pheduyet_HSDTTS = 1'));
            //     }
            // }
            if ($levelUser > 0) {
                if($schools_id == 0 || $schools_id == null){
                   $datas = $datas->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0 OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0 OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0 OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0 OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0 OR htaths.nhucau > 0 OR htaths.dutoan > 0 OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $datas = $datas->where('profile_school_id', '=', DB::raw($schools_id.' AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0 OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0 OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0 OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0 OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0 OR htaths.nhucau > 0 OR htaths.dutoan > 0 OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $datas = $datas->select('qlhs_profile.profile_id', 'profile_birthday', 'schools_name', 'profile_name', 'class_name', 
                    DB::raw('CASE when qlhs_miengiamhocphi.nhu_cau is not null or qlhs_miengiamhocphi.du_toan is not null then (qlhs_miengiamhocphi.nhu_cau + qlhs_miengiamhocphi.du_toan) else 0 end MGHP'),
                    DB::raw('CASE when qlhs_chiphihoctap.nhu_cau is not null or qlhs_chiphihoctap.du_toan is not null then (qlhs_chiphihoctap.nhu_cau + qlhs_chiphihoctap.du_toan) else 0 end CPHT'),
                    DB::raw('CASE when qlhs_hotrotienan.nhu_cau is not null or qlhs_hotrotienan.du_toan is not null then (qlhs_hotrotienan.nhu_cau + qlhs_hotrotienan.du_toan) else 0 end HTAT'),
                    DB::raw('CASE when qlhs_hotrohocsinhbantru.nhucau_hotrotienan is not null or qlhs_hotrohocsinhbantru.dutoan_hotrotienan is not null then (qlhs_hotrohocsinhbantru.nhucau_hotrotienan + qlhs_hotrohocsinhbantru.dutoan_hotrotienan) else 0 end HTBT_TA'),
                    DB::raw('CASE when qlhs_hotrohocsinhbantru.nhucau_hotrotieno is not null or qlhs_hotrohocsinhbantru.dutoan_hotrotieno is not null then (qlhs_hotrohocsinhbantru.nhucau_hotrotieno + qlhs_hotrohocsinhbantru.dutoan_hotrotieno) else 0 end HTBT_TO'),
                    DB::raw('CASE when qlhs_hotrohocsinhbantru.nhucau_VHTT is not null or qlhs_hotrohocsinhbantru.dutoan_VHTT is not null then (qlhs_hotrohocsinhbantru.nhucau_VHTT + qlhs_hotrohocsinhbantru.dutoan_VHTT) else 0 end HTBT_VHTT'),
                    DB::raw('CASE when qlhs_hotrohocsinhkhuyettat.nhucau_hocbong is not null or qlhs_hotrohocsinhkhuyettat.dutoan_hocbong is not null then (qlhs_hotrohocsinhkhuyettat.nhucau_hocbong + qlhs_hotrohocsinhkhuyettat.dutoan_hocbong) else 0 end HSKT_HB'),
                    DB::raw('CASE when qlhs_hotrohocsinhkhuyettat.nhucau_muadodung is not null or qlhs_hotrohocsinhkhuyettat.dutoan_muadodung is not null then (qlhs_hotrohocsinhkhuyettat.nhucau_muadodung + qlhs_hotrohocsinhkhuyettat.dutoan_muadodung) else 0 end HSKT_DDHT'),
                    DB::raw('CASE when hsdtts.nhucau is not null or hsdtts.dutoan is not null then (hsdtts.nhucau + hsdtts.dutoan) else 0 end HSDTTS'),
                    DB::raw('CASE when htaths.nhucau is not null or htaths.dutoan is not null then (htaths.nhucau + htaths.dutoan) else 0 end HTATHS'),
                    DB::raw('CASE when hbhsdtnt.nhucau is not null or hbhsdtnt.dutoan is not null then (hbhsdtnt.nhucau + hbhsdtnt.dutoan) else 0 end HBHSDTNT'));

                if (!is_null($keySearch) && !empty($keySearch)) {
                    $datas->where('profile_name', 'LIKE', '%'.$keySearch.'%')
                            ->orWhere('class_name', 'LIKE', '%'.$keySearch.'%');
                }

                $json['totalRows'] = $datas->get()->count();
                
                $json['startRecord'] = ($start);
                $json['numRows'] = $limit;
                    
                $json['data'] = $datas->orderBy('qlhs_profile.updated_at','desc')->skip($start*$limit)->take($limit)->get();
            }

            return $json;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadDanhSachDaPheDuyet(Request $request)
    {
        try {
            $json = [];
            $start = $request->input('start');
            $limit = $request->input('limit');

            $schools_id = $request->input('SCHOOLID');
           // $year = $request->input('YEAR');
            $socongvan = $request->input('SOCONGVAN');
            $keySearch = $request->input('KEY');
            // $status = $request->input('STATUS');

            // $arrYear = [];
            // $arrYear = explode("-", $year);
            // $schoolId = 37;//$request->input('SCHOOLID');
         //    $year = 2016;//$request->input('YEAR');
         //    $profileId = 834;

            $user = Auth::user()->id;
            $levelUser = 0;

            $getLevelUser = DB::table('users')->where('id', $user)->select('level')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
            }

            if ($levelUser == 1) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_MGHP = 1 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_CPHT = 1 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTAT = 1 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTBT = 1 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HSKT = 1 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))
                    ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }
            else if ($levelUser == 2) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))
                    ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }
            else if ($levelUser == 3) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 1 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 1 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 1 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 1 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 1 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 1 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 1 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))
                    ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }
            else if ($levelUser == 4) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_MGHP = 1 AND trangthai_So_MGHP = 1 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_CPHT = 1 AND trangthai_So_CPHT = 1 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HTAT = 1 AND trangthai_So_HTAT = 1 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HTBT = 1 AND trangthai_So_HTBT = 1 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HSKT = 1 AND trangthai_So_HSKT = 1 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_phongTC_HSDTTS = 1 AND hsdtts.trangthai_So_HSDTTS = 1 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_phongTC_HSDTTS = 1 AND htaths.trangthai_So_HSDTTS = 1 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1 AND hbhsdtnt.trangthai_So_HSDTTS = 1 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))
                    ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }

            if ($levelUser > 0) {
                
                if($schools_id == 0 || $schools_id == null){
                   $datas = $datas->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0 OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0 OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0 OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0 OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0 OR htaths.nhucau > 0 OR htaths.dutoan > 0 OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $datas = $datas->where('profile_school_id', '=', DB::raw($schools_id.' AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0 OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0 OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0 OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0 OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0 OR htaths.nhucau > 0 OR htaths.dutoan > 0 OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $datas = $datas->select('qlhs_profile.profile_id', 'profile_birthday', 'schools_name', 'profile_name', 'class_name', 'his_trangthai_thuhoi_phongGD', 'his_trangthai_thuhoi_phongTC', 
                    DB::raw('CASE when qlhs_miengiamhocphi.nhu_cau is not null or qlhs_miengiamhocphi.du_toan is not null then (qlhs_miengiamhocphi.nhu_cau + qlhs_miengiamhocphi.du_toan) else 0 end MGHP'),
                    DB::raw('CASE when qlhs_chiphihoctap.nhu_cau is not null or qlhs_chiphihoctap.du_toan is not null then (qlhs_chiphihoctap.nhu_cau + qlhs_chiphihoctap.du_toan) else 0 end CPHT'),
                    DB::raw('CASE when qlhs_hotrotienan.nhu_cau is not null or qlhs_hotrotienan.du_toan is not null then (qlhs_hotrotienan.nhu_cau + qlhs_hotrotienan.du_toan) else 0 end HTAT'),
                    DB::raw('CASE when qlhs_hotrohocsinhbantru.nhucau_hotrotienan is not null or qlhs_hotrohocsinhbantru.dutoan_hotrotienan is not null then (qlhs_hotrohocsinhbantru.nhucau_hotrotienan + qlhs_hotrohocsinhbantru.dutoan_hotrotienan) else 0 end HTBT_TA'),
                    DB::raw('CASE when qlhs_hotrohocsinhbantru.nhucau_hotrotieno is not null or qlhs_hotrohocsinhbantru.dutoan_hotrotieno is not null then (qlhs_hotrohocsinhbantru.nhucau_hotrotieno + qlhs_hotrohocsinhbantru.dutoan_hotrotieno) else 0 end HTBT_TO'),
                    DB::raw('CASE when qlhs_hotrohocsinhbantru.nhucau_VHTT is not null or qlhs_hotrohocsinhbantru.dutoan_VHTT is not null then (qlhs_hotrohocsinhbantru.nhucau_VHTT + qlhs_hotrohocsinhbantru.dutoan_VHTT) else 0 end HTBT_VHTT'),
                    DB::raw('CASE when qlhs_hotrohocsinhkhuyettat.nhucau_hocbong is not null or qlhs_hotrohocsinhkhuyettat.dutoan_hocbong is not null then (qlhs_hotrohocsinhkhuyettat.nhucau_hocbong + qlhs_hotrohocsinhkhuyettat.dutoan_hocbong) else 0 end HSKT_HB'),
                    DB::raw('CASE when qlhs_hotrohocsinhkhuyettat.nhucau_muadodung is not null or qlhs_hotrohocsinhkhuyettat.dutoan_muadodung is not null then (qlhs_hotrohocsinhkhuyettat.nhucau_muadodung + qlhs_hotrohocsinhkhuyettat.dutoan_muadodung) else 0 end HSKT_DDHT'),
                    DB::raw('CASE when hsdtts.nhucau is not null or hsdtts.dutoan is not null then (hsdtts.nhucau + hsdtts.dutoan) else 0 end HSDTTS'),
                    DB::raw('CASE when htaths.nhucau is not null or htaths.dutoan is not null then (htaths.nhucau + htaths.dutoan) else 0 end HTATHS'),
                    DB::raw('CASE when hbhsdtnt.nhucau is not null or hbhsdtnt.dutoan is not null then (hbhsdtnt.nhucau + hbhsdtnt.dutoan) else 0 end HBHSDTNT'));

                if (!is_null($keySearch) && !empty($keySearch)) {
                    $datas->where('profile_name', 'LIKE', '%'.$keySearch.'%')
                            ->orWhere('class_name', 'LIKE', '%'.$keySearch.'%');
                }

                $json['totalRows'] = $datas->get()->count();
                
                $json['startRecord'] = ($start);
                $json['numRows'] = $limit;
                    
                $json['data'] = $datas->orderBy('qlhs_profile.updated_at','desc')->skip($start*$limit)->take($limit)->get();
            }

            return $json;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadDanhSachTraLai(Request $request)
    {
        try {
            $json = [];
            $start = $request->input('start');
            $limit = $request->input('limit');

            $schools_id = $request->input('SCHOOLID');
           // $year = $request->input('YEAR');
            $socongvan = $request->input('SOCONGVAN');
            $keySearch = $request->input('KEY');
            // $status = $request->input('STATUS');

            // $arrYear = [];
            // $arrYear = explode("-", $year);
            // $schoolId = 37;//$request->input('SCHOOLID');
         //    $year = 2016;//$request->input('YEAR');
         //    $profileId = 834;

            $user = Auth::user()->id;
            $levelUser = 0;

            $getLevelUser = DB::table('users')->where('id', $user)->select('level')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
            }

            if ($levelUser == 1) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_MGHP = 2 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_CPHT = 2 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTAT = 2 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTBT = 2 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HSKT = 2 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_pheduyet_HSDTTS = 2 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_pheduyet_HSDTTS = 2 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_pheduyet_HSDTTS = 2 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }
            else if ($levelUser == 2) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 2 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 2 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 2 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 2 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 2 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 2 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 2 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 2 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }
            else if ($levelUser == 3) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 2 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 2 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 2 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 2 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 2 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 2 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 2 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 2 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }
            else if ($levelUser == 4) {
                $datas = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_MGHP = 1 AND trangthai_So_MGHP = 2 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_CPHT = 1 AND trangthai_So_CPHT = 2 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HTAT = 1 AND trangthai_So_HTAT = 2 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HTBT = 1 AND trangthai_So_HTBT = 2 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HSKT = 1 AND trangthai_So_HSKT = 2 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_phongTC_HSDTTS = 1 AND hsdtts.trangthai_So_HSDTTS = 2 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_phongTC_HSDTTS = 1 AND htaths.trangthai_So_HSDTTS = 2 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1 AND hbhsdtnt.trangthai_So_HSDTTS = 2 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');
            }

            if ($levelUser > 0) {
                
                if($schools_id == 0 || $schools_id == null){
                   $datas = $datas->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0 OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0 OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0 OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0 OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0 OR htaths.nhucau > 0 OR htaths.dutoan > 0 OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $datas = $datas->where('profile_school_id', '=', DB::raw($schools_id.' AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0 OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0 OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0 OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0 OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0 OR htaths.nhucau > 0 OR htaths.dutoan > 0 OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $datas = $datas->select('qlhs_profile.profile_id', 'profile_birthday', 'schools_name', 'profile_name', 'class_name', 
                    DB::raw('CASE when qlhs_miengiamhocphi.nhu_cau is not null or qlhs_miengiamhocphi.du_toan is not null then (qlhs_miengiamhocphi.nhu_cau + qlhs_miengiamhocphi.du_toan) else 0 end MGHP'),
                    DB::raw('CASE when qlhs_chiphihoctap.nhu_cau is not null or qlhs_chiphihoctap.du_toan is not null then (qlhs_chiphihoctap.nhu_cau + qlhs_chiphihoctap.du_toan) else 0 end CPHT'),
                    DB::raw('CASE when qlhs_hotrotienan.nhu_cau is not null or qlhs_hotrotienan.du_toan is not null then (qlhs_hotrotienan.nhu_cau + qlhs_hotrotienan.du_toan) else 0 end HTAT'),
                    DB::raw('CASE when qlhs_hotrohocsinhbantru.nhucau_hotrotienan is not null or qlhs_hotrohocsinhbantru.dutoan_hotrotienan is not null then (qlhs_hotrohocsinhbantru.nhucau_hotrotienan + qlhs_hotrohocsinhbantru.dutoan_hotrotienan) else 0 end HTBT_TA'),
                    DB::raw('CASE when qlhs_hotrohocsinhbantru.nhucau_hotrotieno is not null or qlhs_hotrohocsinhbantru.dutoan_hotrotieno is not null then (qlhs_hotrohocsinhbantru.nhucau_hotrotieno + qlhs_hotrohocsinhbantru.dutoan_hotrotieno) else 0 end HTBT_TO'),
                    DB::raw('CASE when qlhs_hotrohocsinhbantru.nhucau_VHTT is not null or qlhs_hotrohocsinhbantru.dutoan_VHTT is not null then (qlhs_hotrohocsinhbantru.nhucau_VHTT + qlhs_hotrohocsinhbantru.dutoan_VHTT) else 0 end HTBT_VHTT'),
                    DB::raw('CASE when qlhs_hotrohocsinhkhuyettat.nhucau_hocbong is not null or qlhs_hotrohocsinhkhuyettat.dutoan_hocbong is not null then (qlhs_hotrohocsinhkhuyettat.nhucau_hocbong + qlhs_hotrohocsinhkhuyettat.dutoan_hocbong) else 0 end HSKT_HB'),
                    DB::raw('CASE when qlhs_hotrohocsinhkhuyettat.nhucau_muadodung is not null or qlhs_hotrohocsinhkhuyettat.dutoan_muadodung is not null then (qlhs_hotrohocsinhkhuyettat.nhucau_muadodung + qlhs_hotrohocsinhkhuyettat.dutoan_muadodung) else 0 end HSKT_DDHT'),
                    DB::raw('CASE when hsdtts.nhucau is not null or hsdtts.dutoan is not null then (hsdtts.nhucau + hsdtts.dutoan) else 0 end HSDTTS'),
                    DB::raw('CASE when htaths.nhucau is not null or htaths.dutoan is not null then (htaths.nhucau + htaths.dutoan) else 0 end HTATHS'),
                    DB::raw('CASE when hbhsdtnt.nhucau is not null or hbhsdtnt.dutoan is not null then (hbhsdtnt.nhucau + hbhsdtnt.dutoan) else 0 end HBHSDTNT'));

                if (!is_null($keySearch) && !empty($keySearch)) {
                    $datas->where('profile_name', 'LIKE', '%'.$keySearch.'%')
                            ->orWhere('class_name', 'LIKE', '%'.$keySearch.'%');
                }

                $json['totalRows'] = $datas->get()->count();
                
                $json['startRecord'] = ($start);
                $json['numRows'] = $limit;
                    
                $json['data'] = $datas->orderBy('qlhs_profile.updated_at','desc')->skip($start*$limit)->take($limit)->get();
            }

            return $json;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadDanhSach(Request $request)
    {
        try {
            $json = [];
            $start = $request->input('start');
            $limit = $request->input('limit');

            $schools_id = $request->input('SCHOOLID');
            $socongvan = $request->input('SOCONGVAN');
            $keySearch = $request->input('KEY');
            $type = $request->input('TYPE');

            // $user = Auth::user()->id;
            // $levelUser = 0;

            // $getLevelUser = DB::table('users')->where('id', $user)->select('level')->get();
            // if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
            //     $levelUser = $getLevelUser[0]->level;
            // }

            if ($type == 1) { //---------------------------------------Trường gửi danh sách--------------------------------------------
                $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_Truong', 'rppst_profile_id', DB::raw('profile_id AND rppst_year = rpp_year_cur'));
            }
            else if ($type == 2) { //---------------------------------------Phòng GD chờ duyệt--------------------------------------------
                $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_PGD', 'rppspgd_profile_id', DB::raw('profile_id AND (rppspgd_Status_HK1 = 0 AND rppspgd_Status_HK2 = 0) AND rppspgd_report_name = "'.$socongvan.'"'));
            }
            else if ($type == 3) { //---------------------------------------Phòng GD đã duyệt--------------------------------------------
                $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_PGD', 'rppspgd_profile_id', DB::raw('profile_id AND (rppspgd_Status_HK1 = 1 AND rppspgd_Status_HK2 = 1) AND rppspgd_report_name = "'.$socongvan.'"'));
            }
            else if ($type == 4) { //---------------------------------------Phòng GD trả lại--------------------------------------------
                $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_PGD', 'rppspgd_profile_id', DB::raw('profile_id AND (rppspgd_Status_HK1 = 2 AND rppspgd_Status_HK2 = 2) AND rppspgd_report_name = "'.$socongvan.'"'));
            }
            else if ($type == 5) { //---------------------------------------Phòng TC chờ duyệt--------------------------------------------
                $datas = $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_PTC', 'rppsptc_profile_id', DB::raw('profile_id AND (rppsptc_Status_HK1 = 0 AND rppsptc_Status_HK2 = 0) AND rppsptc_report_name = "'.$socongvan.'"'));
            }
            else if ($type == 6) { //---------------------------------------Phòng TC đã duyệt--------------------------------------------
                $datas = $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_PTC', 'rppsptc_profile_id', DB::raw('profile_id AND (rppsptc_Status_HK1 = 1 AND rppsptc_Status_HK2 = 1) AND rppsptc_report_name = "'.$socongvan.'"'));
            }
            else if ($type == 7) { //---------------------------------------Phòng TC trả lại--------------------------------------------
                $datas = $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_PTC', 'rppsptc_profile_id', DB::raw('profile_id AND (rppsptc_Status_HK1 = 2 AND rppsptc_Status_HK2 = 2) AND rppsptc_report_name = "'.$socongvan.'"'));
            }
            else if ($type == 8) { //--------------------------------------- Sở chờ duyệt-------------------------------------------------
                $datas = $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_So', 'rppss_profile_id', DB::raw('profile_id AND (rppss_Status_HK1 = 0 AND rppss_Status_HK2 = 0) AND rppss_report_name = "'.$socongvan.'"'));
            }
            else if ($type == 9) { //--------------------------------------- Sở đã duyệt----------------------------------------------------
                $datas = $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_So', 'rppss_profile_id', DB::raw('profile_id AND (rppss_Status_HK1 = 1 AND rppss_Status_HK2 = 1) AND rppss_report_name = "'.$socongvan.'"'));
            }
            else if ($type == 10) { //--------------------------------------- Sở trả lại--------------------------------------------------
                $datas = $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', 'profile_nationals_id')
                        ->join('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->join('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_tien', 'rpp_profile_id', DB::raw('profile_id AND rpp_report_name = "'.$socongvan.'"'))
                        ->join('qlhs_hosobaocao_trangthai_So', 'rppss_profile_id', DB::raw('profile_id AND (rppss_Status_HK1 = 2 AND rppss_Status_HK2 = 2) AND rppss_report_name = "'.$socongvan.'"'));
            }
            else if ($type == 11) { //---------------------------------------Phòng GD yêu cầu thu hồi--------------------------------------
                $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                        ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_MGHP = 1 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_CPHT = 1 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HTAT = 1 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HTBT = 1 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongGD_HSKT = 1 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->where('his_trangthai_thuhoi_phongGD', '=', 1);
            }
            else if ($type == 12) { //---------------------------------------Phòng TC yêu cầu thu hồi--------------------------------------
                $datas = DB::table('qlhs_profile')
                        ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                        ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_MGHP = 1 AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_CPHT = 1 AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HTAT = 1 AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HTBT = 1 AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND trangthai_phongTC_HSKT = 1 AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.trangthai_phongTC_HSDTTS = 1 AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.trangthai_phongTC_HSDTTS = 1 AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                        ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1 AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))
                        ->leftJoin('qlhs_report_history', 'his_profile_id', '=', DB::raw('qlhs_profile.profile_id and his_socongvan = "'.$socongvan.'"'))
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                        ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id')
                        ->where('his_trangthai_thuhoi_phongTC', '=', 1);
            }

            if (!is_null($datas) && !empty($datas)) {
                
                if(!is_null($schools_id) && $schools_id > 0){
                   
                    $datas = $datas->where('profile_school_id', $schools_id);
                }

                $datas = $datas->select('qlhs_profile.profile_id', 'profile_birthday', 'schools_name', 'profile_name', 'class_name', 'his_trangthai_thuhoi_phongGD', 'his_trangthai_thuhoi_phongTC', 'his_capthuhoi', 

                    DB::raw('CASE when rpp_MGHP_NhuCau is not null or rpp_MGHP_DuToan is not null then (rpp_MGHP_NhuCau + rpp_MGHP_DuToan) else 0 end MGHP'),

                    DB::raw('CASE when rpp_CPHT_NhuCau is not null or rpp_CPHT_DuToan is not null then (rpp_CPHT_NhuCau + rpp_CPHT_DuToan) else 0 end CPHT'),

                    DB::raw('CASE when rpp_HTAT_NhuCau is not null or rpp_HTAT_DuToan is not null then (rpp_HTAT_NhuCau + rpp_HTAT_DuToan) else 0 end HTAT'),

                    DB::raw('CASE when rpp_HTBT_NhuCau_TA is not null or rpp_HTBT_DuToan_TA is not null then (rpp_HTBT_NhuCau_TA + rpp_HTBT_DuToan_TA) else 0 end HTBT_TA'),

                    DB::raw('CASE when rpp_HTBT_NhuCau_TO is not null or rpp_HTBT_DuToan_TO is not null then (rpp_HTBT_NhuCau_TO + rpp_HTBT_DuToan_TO) else 0 end HTBT_TO'),

                    DB::raw('CASE when rpp_HTBT_NhuCau_VHTT is not null or rpp_HTBT_DuToan_VHTT is not null then (rpp_HTBT_NhuCau_VHTT + rpp_HTBT_DuToan_VHTT) else 0 end HTBT_VHTT'),

                    DB::raw('CASE when rpp_HSKT_NhuCau_HB is not null or rpp_HSKT_DuToan_HB is not null then (rpp_HSKT_NhuCau_HB + rpp_HSKT_DuToan_HB) else 0 end HSKT_HB'),

                    DB::raw('CASE when rpp_HSKT_NhuCau_DDHT is not null or rpp_HSKT_DuToan_DDHT is not null then (rpp_HSKT_NhuCau_DDHT + rpp_HSKT_DuToan_DDHT) else 0 end HSKT_DDHT'),

                    DB::raw('CASE when rpp_HSDTTS_NhuCau is not null or rpp_HSDTTS_DuToan is not null then (rpp_HSDTTS_NhuCau + rpp_HSDTTS_DuToan) else 0 end HSDTTS'),

                    DB::raw('CASE when rpp_HTATHS_NhuCau is not null or rpp_HTATHS_DuToan is not null then (rpp_HTATHS_NhuCau + rpp_HTATHS_DuToan) else 0 end HTATHS'),

                    DB::raw('CASE when rpp_HBHSDTNT_NhuCau is not null or rpp_HBHSDTNT_DuToan is not null then (rpp_HBHSDTNT_NhuCau + rpp_HBHSDTNT_DuToan) else 0 end HBHSDTNT'));

                if (!is_null($keySearch) && !empty($keySearch)) {
                    $datas->where('profile_name', 'LIKE', '%'.$keySearch.'%')
                            ->orWhere('class_name', 'LIKE', '%'.$keySearch.'%');
                }

                $json['totalRows'] = $datas->get()->count();
                
                $json['startRecord'] = ($start);
                $json['numRows'] = $limit;
                    
                $json['data'] = $datas->orderBy('qlhs_profile.updated_at','desc')->skip($start*$limit)->take($limit)->get();
            }

            return $json;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function approvedchedoPD(Request $request){
        $result = [];
        try {

            $profile_id = $request->input('PROFILEID');
            $schools_id = $request->input('SCHOOLID');
            $socongvan = $request->input('SOCONGVAN');
            $status = $request->input('STATUS');
            
            $note = $request->input('NOTE');

            $currentdate = Carbon::now('Asia/Ho_Chi_Minh');

            $update = 0;

            $getProfile = DB::table('qlhs_profile')
                ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id')
                ->where('qlhs_profile.profile_id', '=', $profile_id)
                ->select(
                    DB::raw('(CASE when (trangthai_pheduyet_MGHP = 0 OR trangthai_pheduyet_MGHP is null) AND (trangthai_pheduyet_CPHT = 0 OR trangthai_pheduyet_CPHT is null) AND (trangthai_pheduyet_HTAT = 0 OR trangthai_pheduyet_HTAT is null) AND (trangthai_pheduyet_HTBT = 0 OR trangthai_pheduyet_HTBT is null) AND (trangthai_pheduyet_HSKT = 0 OR trangthai_pheduyet_HSKT is null) AND (hsdtts.trangthai_pheduyet_HSDTTS = 0 OR hsdtts.trangthai_pheduyet_HSDTTS is null) AND (htaths.trangthai_pheduyet_HSDTTS = 0 OR htaths.trangthai_pheduyet_HSDTTS is null) AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 0 OR hbhsdtnt.trangthai_pheduyet_HSDTTS is null) then 1 else 0 END) as truong_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_pheduyet_MGHP = 1 OR trangthai_pheduyet_MGHP is null) AND (trangthai_pheduyet_CPHT = 1 OR trangthai_pheduyet_CPHT is null) AND (trangthai_pheduyet_HTAT = 1 OR trangthai_pheduyet_HTAT is null) AND (trangthai_pheduyet_HTBT = 1 OR trangthai_pheduyet_HTBT is null) AND (trangthai_pheduyet_HSKT = 1 OR trangthai_pheduyet_HSKT is null) AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 OR hsdtts.trangthai_pheduyet_HSDTTS is null) AND (htaths.trangthai_pheduyet_HSDTTS = 1 OR htaths.trangthai_pheduyet_HSDTTS is null) AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 OR hbhsdtnt.trangthai_pheduyet_HSDTTS is null) then 1 else 0 END) as truong_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_pheduyet_MGHP = 2 OR trangthai_pheduyet_MGHP is null) AND (trangthai_pheduyet_CPHT = 2 OR trangthai_pheduyet_CPHT is null) AND (trangthai_pheduyet_HTAT = 2 OR trangthai_pheduyet_HTAT is null) AND (trangthai_pheduyet_HTBT = 2 OR trangthai_pheduyet_HTBT is null) AND (trangthai_pheduyet_HSKT = 2 OR trangthai_pheduyet_HSKT is null) AND (hsdtts.trangthai_pheduyet_HSDTTS = 2 OR hsdtts.trangthai_pheduyet_HSDTTS is null) AND (htaths.trangthai_pheduyet_HSDTTS = 2 OR htaths.trangthai_pheduyet_HSDTTS is null) AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 2 OR hbhsdtnt.trangthai_pheduyet_HSDTTS is null) then 1 else 0 END) as truong_tralai'), 


                    DB::raw('(CASE when (trangthai_phongGD_MGHP = 0 OR trangthai_phongGD_MGHP is null) AND (trangthai_phongGD_CPHT = 0 OR trangthai_phongGD_CPHT is null) AND (trangthai_phongGD_HTAT = 0 OR trangthai_phongGD_HTAT is null) AND (trangthai_phongGD_HTBT = 0 OR trangthai_phongGD_HTBT is null) AND (trangthai_phongGD_HSKT = 0 OR trangthai_phongGD_HSKT is null) AND (hsdtts.trangthai_phongGD_HSDTTS = 0 OR hsdtts.trangthai_phongGD_HSDTTS is null) AND (htaths.trangthai_phongGD_HSDTTS = 0 OR htaths.trangthai_phongGD_HSDTTS is null) AND (hbhsdtnt.trangthai_phongGD_HSDTTS = 0 OR hbhsdtnt.trangthai_phongGD_HSDTTS is null) then 1 else 0 END) as phongGD_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_phongGD_MGHP = 1 OR trangthai_phongGD_MGHP is null) AND (trangthai_phongGD_CPHT = 1 OR trangthai_phongGD_CPHT is null) AND (trangthai_phongGD_HTAT = 1 OR trangthai_phongGD_HTAT is null) AND (trangthai_phongGD_HTBT = 1 OR trangthai_phongGD_HTBT is null) AND (trangthai_phongGD_HSKT = 1 OR trangthai_phongGD_HSKT is null) AND (hsdtts.trangthai_phongGD_HSDTTS = 1 OR hsdtts.trangthai_phongGD_HSDTTS is null) AND (htaths.trangthai_phongGD_HSDTTS = 1 OR htaths.trangthai_phongGD_HSDTTS is null) AND (hbhsdtnt.trangthai_phongGD_HSDTTS = 1 OR hbhsdtnt.trangthai_phongGD_HSDTTS is null) then 1 else 0 END) as phongGD_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_phongGD_MGHP = 2 OR trangthai_phongGD_MGHP is null) AND (trangthai_phongGD_CPHT = 2 OR trangthai_phongGD_CPHT is null) AND (trangthai_phongGD_HTAT = 2 OR trangthai_phongGD_HTAT is null) AND (trangthai_phongGD_HTBT = 2 OR trangthai_phongGD_HTBT is null) AND (trangthai_phongGD_HSKT = 2 OR trangthai_phongGD_HSKT is null) AND (hsdtts.trangthai_phongGD_HSDTTS = 2 OR hsdtts.trangthai_phongGD_HSDTTS is null) AND (htaths.trangthai_phongGD_HSDTTS = 2 OR htaths.trangthai_phongGD_HSDTTS is null) AND (hbhsdtnt.trangthai_phongGD_HSDTTS = 2 OR hbhsdtnt.trangthai_phongGD_HSDTTS is null) then 1 else 0 END) as phongGD_tralai'), 


                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 0 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 0 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 0 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 0 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 0 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 0 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 0 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 0 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 1 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 1 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 1 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 1 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 1 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 1 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 1 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 1 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 2 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 2 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 2 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 2 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 2 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 2 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 2 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 2 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_tralai'), 


                    DB::raw('(CASE when (trangthai_So_MGHP = 0 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 0 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 0 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 0 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 0 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 0 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 0 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 0 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_So_MGHP = 1 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 1 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 1 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 1 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 1 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 1 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 1 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 1 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_So_MGHP = 2 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 2 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 2 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 2 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 2 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 2 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 2 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 2 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_tralai'))
                ->get();

            if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                $user = Auth::user()->id;
                $levelUser = 0;
                $userName = '';

                $getLevelUser = DB::table('users')->where('id', $user)->select('level', 'first_name', 'last_name')->get();
                if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                    $levelUser = $getLevelUser[0]->level;
                    if (!is_null($getLevelUser[0]->first_name) && !empty($getLevelUser[0]->first_name)) {
                        $userName =  $getLevelUser[0]->first_name.' '. $getLevelUser[0]->last_name;
                    }
                    else {
                        $userName =  $getLevelUser[0]->last_name;
                    }
                }

                $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                    //----------------------------------------------Cấp trường duyệt----------------------------------------------
                    if ($levelUser == 1 && ($getProfile[0]->truong_chopheduyet == 1 || $getProfile[0]->truong_tralai == 1)) { 

                        foreach ($getType as $valueType) {
                            if ($valueType->report == "MGHP") {
                                $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_MGHP' => 1, 
                                        'truong_user_MGHP' => $userName, 
                                        'truong_update_date_MGHP' => $currentdate, 
                                        'trangthai_phongGD_MGHP' => 0]);
                            }
                            if ($valueType->report == "CPHT") {
                                $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_CPHT' => 1, 
                                        'truong_user_CPHT' => $userName, 
                                        'truong_update_date_CPHT' => $currentdate, 
                                        'trangthai_phongGD_CPHT' => 0]);
                            }
                            if ($valueType->report == "HTAT") {
                                $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HTAT' => 1, 
                                        'truong_user_HTAT' => $userName, 
                                        'truong_update_date_HTAT' => $currentdate, 
                                        'trangthai_phongGD_HTAT' => 0]);
                            }
                            if ($valueType->report == "HTBT") {
                                $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HTBT' => 1, 
                                        'truong_user_HTBT' => $userName, 
                                        'truong_update_date_HTBT' => $currentdate, 
                                        'trangthai_phongGD_HTBT' => 0]);
                            }
                            if ($valueType->report == "HSKT") {
                                $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HSKT' => 1, 
                                        'truong_user_HSKT' => $userName, 
                                        'truong_update_date_HSKT' => $currentdate, 
                                        'trangthai_phongGD_HSKT' => 0]);
                            }
                            if ($valueType->report == "HSDTTS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HSDTTS' => 1, 
                                        'truong_user_HSDTTS' => $userName, 
                                        'truong_update_date_HSDTTS' => $currentdate, 
                                        'trangthai_phongGD_HSDTTS' => 0]);
                            }
                            if ($valueType->report == "HTATHS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HSDTTS' => 1, 
                                        'truong_user_HSDTTS' => $userName, 
                                        'truong_update_date_HSDTTS' => $currentdate, 
                                        'trangthai_phongGD_HSDTTS' => 0]);
                            }
                            if ($valueType->report == "HBHSDTNT") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HSDTTS' => 1, 
                                        'truong_user_HSDTTS' => $userName, 
                                        'truong_update_date_HSDTTS' => $currentdate, 
                                        'trangthai_phongGD_HSDTTS' => 0]);
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $reverted = 0;

                            $waiting_phongGD = 0;
                            if ($status == 0) {
                                foreach ($getReport as $value) {
                                    $waiting = $value->report_waiting - 1;
                                    $approved = $value->report_approved + 1;
                                    $waiting_phongGD = $value->report_waiting_phongGD + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_waiting' => $waiting,
                                        'report_approved' => $approved, 
                                        'report_waiting_phongGD' => $waiting_phongGD
                                        ]);
                            }
                            else {
                                foreach ($getReport as $value) {
                                    $approved = $value->report_approved + 1;
                                    $reverted = $value->report_reverted - 1;
                                    $waiting_phongGD = $value->report_waiting_phongGD + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reverted' => $reverted,
                                        'report_approved' => $approved, 
                                        'report_waiting_phongGD' => $waiting_phongGD
                                        ]);
                            }
                        }

                        $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                        if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                            DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                'his_trangthai_duyet' => 1]);
                        }
                        else {
                            DB::table('qlhs_report_history')->insert([
                                'his_profile_id' => $profile_id,
                                'his_trangthai_duyet' => 1,
                                'his_trangthai_tralai' => 0,
                                'his_trangthai_thuhoi_phongGD' => 0,
                                'his_trangthai_thuhoi_phongTC' => 0,
                                'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                        }


                        $check = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->select('report_waiting')->first();
                        if($check->report_waiting <= 0 ){
                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }
                    }
                    else if ($levelUser == 2 && ($getProfile[0]->phongGD_chopheduyet == 1 || $getProfile[0]->phongGD_tralai == 1)) { 
                    //----------------------------------------------Cấp phòng GD------------------------------------
                        foreach ($getType as $valueType) {
                            if ($valueType->report == "MGHP") {
                                $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_MGHP' => 1, 
                                        'phongGD_user_MGHP' => $userName, 
                                        'phongGD_update_date_MGHP' => $currentdate, 
                                        'trangthai_phongTC_MGHP' => 0]);
                            }
                            if ($valueType->report == "CPHT") {
                                $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_CPHT' => 1, 
                                        'phongGD_user_CPHT' => $userName, 
                                        'phongGD_update_date_CPHT' => $currentdate, 
                                        'trangthai_phongTC_CPHT' => 0]);
                            }
                            if ($valueType->report == "HTAT") {
                                $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HTAT' => 1, 
                                        'phongGD_user_HTAT' => $userName, 
                                        'phongGD_update_date_HTAT' => $currentdate, 
                                        'trangthai_phongTC_HTAT' => 0]);
                            }
                            if ($valueType->report == "HTBT") {
                                $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HTBT' => 1, 
                                        'phongGD_user_HTBT' => $userName, 
                                        'phongGD_update_date_HTBT' => $currentdate, 
                                        'trangthai_phongTC_HTBT' => 0]);
                            }
                            if ($valueType->report == "HSKT") {
                                $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HSKT' => 1, 
                                        'phongGD_user_HSKT' => $userName, 
                                        'phongGD_update_date_HSKT' => $currentdate, 
                                        'trangthai_phongTC_HSKT' => 0]);
                            }
                            if ($valueType->report == "HSDTTS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HSDTTS' => 1, 
                                        'phongGD_user_HSDTTS' => $userName, 
                                        'phongGD_update_date_HSDTTS' => $currentdate, 
                                        'trangthai_phongTC_HSDTTS' => 0]);
                            }
                            if ($valueType->report == "HTATHS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HSDTTS' => 1, 
                                        'phongGD_user_HSDTTS' => $userName, 
                                        'phongGD_update_date_HSDTTS' => $currentdate, 
                                        'trangthai_phongTC_HSDTTS' => 0]);
                            }
                            if ($valueType->report == "HBHSDTNT") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HSDTTS' => 1, 
                                        'phongGD_user_HSDTTS' => $userName, 
                                        'phongGD_update_date_HSDTTS' => $currentdate, 
                                        'trangthai_phongTC_HSDTTS' => 0]);
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $reverted = 0;

                            $waiting_phongTC = 0;
                            if ($status == 2) {
                                foreach ($getReport as $value) {
                                    $waiting = $value->report_waiting_phongGD - 1;
                                    $approved = $value->report_approved_phongGD + 1;
                                    $waiting_phongTC = $value->report_waiting_phongTC + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_waiting_phongGD' => $waiting,
                                        'report_approved_phongGD' => $approved, 
                                        'report_waiting_phongTC' => $waiting_phongTC
                                        ]);
                            }
                            else if ($status == 4) {
                                foreach ($getReport as $value) {
                                    $approved = $value->report_approved_phongGD + 1;
                                    $reverted = $value->report_reverted_phongGD - 1;
                                    $waiting_phongTC = $value->report_waiting_phongTC + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reverted_phongGD' => $reverted,
                                        'report_approved_phongGD' => $approved, 
                                        'report_waiting_phongTC' => $waiting_phongTC
                                        ]);
                            }
                        }

                        $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                        if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                            DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                'his_trangthai_duyet' => 1,
                                'his_note_duyet_phongGD' => $note,
                                'his_note_tralai_phongGD' => '']);
                        }
                        else {
                            DB::table('qlhs_report_history')->insert([
                                'his_profile_id' => $profile_id,
                                'his_trangthai_duyet' => 1,
                                'his_trangthai_tralai' => 0,
                                'his_trangthai_thuhoi_phongGD' => 0,
                                'his_trangthai_thuhoi_phongTC' => 0,
                                'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                        }

                    }
                    else if ($levelUser == 3 && ($getProfile[0]->phongTC_chopheduyet == 1 || $getProfile[0]->phongTC_tralai == 1)) { 
                    //----------------------------------------------Cấp phòng TC------------------------------------
                        foreach ($getType as $valueType) {
                            if ($valueType->report == "MGHP") {
                                $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_MGHP' => 1, 
                                        'phongTC_user_MGHP' => $userName, 
                                        'phongTC_update_date_MGHP' => $currentdate, 
                                        'trangthai_So_MGHP' => 0]);
                            }
                            if ($valueType->report == "CPHT") {
                                $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_CPHT' => 1, 
                                        'phongTC_user_CPHT' => $userName, 
                                        'phongTC_update_date_CPHT' => $currentdate, 
                                        'trangthai_So_CPHT' => 0]);
                            }
                            if ($valueType->report == "HTAT") {
                                $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HTAT' => 1, 
                                        'phongTC_user_HTAT' => $userName, 
                                        'phongTC_update_date_HTAT' => $currentdate, 
                                        'trangthai_So_HTAT' => 0]);
                            }
                            if ($valueType->report == "HTBT") {
                                $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HTBT' => 1, 
                                        'phongTC_user_HTBT' => $userName, 
                                        'phongTC_update_date_HTBT' => $currentdate, 
                                        'trangthai_So_HTBT' => 0]);
                            }
                            if ($valueType->report == "HSKT") {
                                $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HSKT' => 1, 
                                        'phongTC_user_HSKT' => $userName, 
                                        'phongTC_update_date_HSKT' => $currentdate, 
                                        'trangthai_So_HSKT' => 0]);
                            }
                            if ($valueType->report == "HSDTTS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HSDTTS' => 1, 
                                        'phongTC_user_HSDTTS' => $userName, 
                                        'phongTC_update_date_HSDTTS' => $currentdate, 
                                        'trangthai_So_HSDTTS' => 0]);
                            }
                            if ($valueType->report == "HTATHS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HSDTTS' => 1, 
                                        'phongTC_user_HSDTTS' => $userName, 
                                        'phongTC_update_date_HSDTTS' => $currentdate, 
                                        'trangthai_So_HSDTTS' => 0]);
                            }
                            if ($valueType->report == "HBHSDTNT") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HSDTTS' => 1, 
                                        'phongTC_user_HSDTTS' => $userName, 
                                        'phongTC_update_date_HSDTTS' => $currentdate, 
                                        'trangthai_So_HSDTTS' => 0]);
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $reverted = 0;

                            $waiting_So = 0;
                            if ($status == 5) {
                                foreach ($getReport as $value) {
                                    $waiting = $value->report_waiting_phongTC - 1;
                                    $approved = $value->report_approved_phongTC + 1;
                                    $waiting_So = $value->report_waiting_So + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_waiting_phongTC' => $waiting,
                                        'report_approved_phongTC' => $approved, 
                                        'report_waiting_So' => $waiting_So
                                        ]);
                            }
                            else if ($status == 7) {
                                foreach ($getReport as $value) {
                                    $approved = $value->report_approved_phongTC + 1;
                                    $reverted = $value->report_reverted_phongTC - 1;
                                    $waiting_So = $value->report_waiting_So + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reverted_phongTC' => $reverted,
                                        'report_approved_phongTC' => $approved, 
                                        'report_waiting_So' => $waiting_So
                                        ]);
                            }
                        }

                        $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                        if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                            DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                'his_trangthai_duyet' => 1,
                                'his_note_duyet_phongTC' => $note,
                                'his_note_tralai_phongTC' => '']);
                        }
                        else {
                            DB::table('qlhs_report_history')->insert([
                                'his_profile_id' => $profile_id,
                                'his_trangthai_duyet' => 1,
                                'his_trangthai_tralai' => 0,
                                'his_trangthai_thuhoi_phongGD' => 0,
                                'his_trangthai_thuhoi_phongTC' => 0,
                                'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                        }

                    }
                    else if ($levelUser == 4 && ($getProfile[0]->So_chopheduyet == 1 || $getProfile[0]->So_tralai == 1)) { 
                    //----------------------------------------------Cấp Sở------------------------------------
                        foreach ($getType as $valueType) {
                            if ($valueType->report == "MGHP") {
                                $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_MGHP' => 1, 
                                        'so_user_MGHP' => $userName, 
                                        'so_update_date_MGHP' => $currentdate]);
                            }
                            if ($valueType->report == "CPHT") {
                                $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_CPHT' => 1, 
                                        'so_user_CPHT' => $userName, 
                                        'so_update_date_CPHT' => $currentdate]);
                            }
                            if ($valueType->report == "HTAT") {
                                $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HTAT' => 1, 
                                        'so_user_HTAT' => $userName, 
                                        'so_update_date_HTAT' => $currentdate]);
                            }
                            if ($valueType->report == "HTBT") {
                                $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HTBT' => 1, 
                                        'so_user_HTBT' => $userName, 
                                        'so_update_date_HTBT' => $currentdate]);
                            }
                            if ($valueType->report == "HSKT") {
                                $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HSKT' => 1, 
                                        'so_user_HSKT' => $userName, 
                                        'so_update_date_HSKT' => $currentdate]);
                            }
                            if ($valueType->report == "HSDTTS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HSDTTS' => 1, 
                                        'so_user_HSDTTS' => $userName, 
                                        'so_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HTATHS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HSDTTS' => 1, 
                                        'so_user_HSDTTS' => $userName, 
                                        'so_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HBHSDTNT") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HSDTTS' => 1, 
                                        'so_user_HSDTTS' => $userName, 
                                        'so_update_date_HSDTTS' => $currentdate]);
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $reverted = 0;
                            if ($status == 8) {
                                foreach ($getReport as $value) {
                                    $waiting = $value->report_waiting_So - 1;
                                    $approved = $value->report_approved_So + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_waiting_So' => $waiting,
                                        'report_approved_So' => $approved
                                        ]);
                            }
                            else if ($status == 10) {
                                foreach ($getReport as $value) {
                                    $approved = $value->report_approved_So + 1;
                                    $reverted = $value->report_reverted_So - 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reverted_So' => $reverted,
                                        'report_approved_So' => $approved
                                        ]);
                            }
                        }

                        $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                        if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                            DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                'his_trangthai_duyet' => 1,
                                'his_note_duyet_So' => $note,
                                'his_note_tralai_So' => '']);
                        }
                        else {
                            DB::table('qlhs_report_history')->insert([
                                'his_profile_id' => $profile_id,
                                'his_trangthai_duyet' => 1,
                                'his_trangthai_tralai' => 0,
                                'his_trangthai_thuhoi_phongGD' => 0,
                                'his_trangthai_thuhoi_phongTC' => 0,
                                'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                        }

                    }
                    
                    $result['success'] = "Phê duyệt học sinh thành công";
                }
            }
            else {
                $result['error'] = "Phê duyệt học sinh thất bại";
            }

            return $result;
        } catch (Exception $e) {
            return $result['error'] = $e;
        }
    }

    public function revertchedoPD(Request $request){
        $result = [];
        try {

            $profile_id = $request->input('PROFILEID');
            $schools_id = $request->input('SCHOOLID');
            $socongvan = $request->input('SOCONGVAN');
            $status = $request->input('STATUS');
            
            $note = $request->input('NOTE');

            $currentdate = Carbon::now('Asia/Ho_Chi_Minh');

            $update = 0;

            $getProfile = DB::table('qlhs_profile')
                ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id')
                ->where('qlhs_profile.profile_id', '=', $profile_id)
                ->select(
                    DB::raw('(CASE when (trangthai_pheduyet_MGHP = 0 OR trangthai_pheduyet_MGHP is null) AND (trangthai_pheduyet_CPHT = 0 OR trangthai_pheduyet_CPHT is null) AND (trangthai_pheduyet_HTAT = 0 OR trangthai_pheduyet_HTAT is null) AND (trangthai_pheduyet_HTBT = 0 OR trangthai_pheduyet_HTBT is null) AND (trangthai_pheduyet_HSKT = 0 OR trangthai_pheduyet_HSKT is null) AND (hsdtts.trangthai_pheduyet_HSDTTS = 0 OR hsdtts.trangthai_pheduyet_HSDTTS is null) AND (htaths.trangthai_pheduyet_HSDTTS = 0 OR htaths.trangthai_pheduyet_HSDTTS is null) AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 0 OR hbhsdtnt.trangthai_pheduyet_HSDTTS is null) then 1 else 0 END) as truong_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_pheduyet_MGHP = 1 OR trangthai_pheduyet_MGHP is null) AND (trangthai_pheduyet_CPHT = 1 OR trangthai_pheduyet_CPHT is null) AND (trangthai_pheduyet_HTAT = 1 OR trangthai_pheduyet_HTAT is null) AND (trangthai_pheduyet_HTBT = 1 OR trangthai_pheduyet_HTBT is null) AND (trangthai_pheduyet_HSKT = 1 OR trangthai_pheduyet_HSKT is null) AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 OR hsdtts.trangthai_pheduyet_HSDTTS is null) AND (htaths.trangthai_pheduyet_HSDTTS = 1 OR htaths.trangthai_pheduyet_HSDTTS is null) AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 OR hbhsdtnt.trangthai_pheduyet_HSDTTS is null) then 1 else 0 END) as truong_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_pheduyet_MGHP = 2 OR trangthai_pheduyet_MGHP is null) AND (trangthai_pheduyet_CPHT = 2 OR trangthai_pheduyet_CPHT is null) AND (trangthai_pheduyet_HTAT = 2 OR trangthai_pheduyet_HTAT is null) AND (trangthai_pheduyet_HTBT = 2 OR trangthai_pheduyet_HTBT is null) AND (trangthai_pheduyet_HSKT = 2 OR trangthai_pheduyet_HSKT is null) AND (hsdtts.trangthai_pheduyet_HSDTTS = 2 OR hsdtts.trangthai_pheduyet_HSDTTS is null) AND (htaths.trangthai_pheduyet_HSDTTS = 2 OR htaths.trangthai_pheduyet_HSDTTS is null) AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 2 OR hbhsdtnt.trangthai_pheduyet_HSDTTS is null) then 1 else 0 END) as truong_tralai'), 


                    DB::raw('(CASE when (trangthai_phongGD_MGHP = 0 OR trangthai_phongGD_MGHP is null) AND (trangthai_phongGD_CPHT = 0 OR trangthai_phongGD_CPHT is null) AND (trangthai_phongGD_HTAT = 0 OR trangthai_phongGD_HTAT is null) AND (trangthai_phongGD_HTBT = 0 OR trangthai_phongGD_HTBT is null) AND (trangthai_phongGD_HSKT = 0 OR trangthai_phongGD_HSKT is null) AND (hsdtts.trangthai_phongGD_HSDTTS = 0 OR hsdtts.trangthai_phongGD_HSDTTS is null) AND (htaths.trangthai_phongGD_HSDTTS = 0 OR htaths.trangthai_phongGD_HSDTTS is null) AND (hbhsdtnt.trangthai_phongGD_HSDTTS = 0 OR hbhsdtnt.trangthai_phongGD_HSDTTS is null) then 1 else 0 END) as phongGD_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_phongGD_MGHP = 1 OR trangthai_phongGD_MGHP is null) AND (trangthai_phongGD_CPHT = 1 OR trangthai_phongGD_CPHT is null) AND (trangthai_phongGD_HTAT = 1 OR trangthai_phongGD_HTAT is null) AND (trangthai_phongGD_HTBT = 1 OR trangthai_phongGD_HTBT is null) AND (trangthai_phongGD_HSKT = 1 OR trangthai_phongGD_HSKT is null) AND (hsdtts.trangthai_phongGD_HSDTTS = 1 OR hsdtts.trangthai_phongGD_HSDTTS is null) AND (htaths.trangthai_phongGD_HSDTTS = 1 OR htaths.trangthai_phongGD_HSDTTS is null) AND (hbhsdtnt.trangthai_phongGD_HSDTTS = 1 OR hbhsdtnt.trangthai_phongGD_HSDTTS is null) then 1 else 0 END) as phongGD_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_phongGD_MGHP = 2 OR trangthai_phongGD_MGHP is null) AND (trangthai_phongGD_CPHT = 2 OR trangthai_phongGD_CPHT is null) AND (trangthai_phongGD_HTAT = 2 OR trangthai_phongGD_HTAT is null) AND (trangthai_phongGD_HTBT = 2 OR trangthai_phongGD_HTBT is null) AND (trangthai_phongGD_HSKT = 2 OR trangthai_phongGD_HSKT is null) AND (hsdtts.trangthai_phongGD_HSDTTS = 2 OR hsdtts.trangthai_phongGD_HSDTTS is null) AND (htaths.trangthai_phongGD_HSDTTS = 2 OR htaths.trangthai_phongGD_HSDTTS is null) AND (hbhsdtnt.trangthai_phongGD_HSDTTS = 2 OR hbhsdtnt.trangthai_phongGD_HSDTTS is null) then 1 else 0 END) as phongGD_tralai'), 


                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 0 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 0 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 0 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 0 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 0 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 0 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 0 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 0 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 1 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 1 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 1 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 1 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 1 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 1 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 1 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 1 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 2 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 2 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 2 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 2 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 2 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 2 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 2 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 2 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_tralai'), 


                    DB::raw('(CASE when (trangthai_So_MGHP = 0 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 0 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 0 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 0 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 0 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 0 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 0 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 0 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_So_MGHP = 1 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 1 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 1 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 1 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 1 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 1 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 1 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 1 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_So_MGHP = 2 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 2 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 2 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 2 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 2 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 2 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 2 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 2 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_tralai'))
                ->get();

            if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                $user = Auth::user()->id;
                $levelUser = 0;
                $userName = '';

                $getLevelUser = DB::table('users')->where('id', $user)->select('level', 'first_name', 'last_name')->get();
                if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                    $levelUser = $getLevelUser[0]->level;
                    if (!is_null($getLevelUser[0]->first_name) && !empty($getLevelUser[0]->first_name)) {
                        $userName =  $getLevelUser[0]->first_name.' '. $getLevelUser[0]->last_name;
                    }
                    else {
                        $userName =  $getLevelUser[0]->last_name;
                    }
                }

                $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                    if ($levelUser == 1 && ($getProfile[0]->truong_chopheduyet == 1 || $getProfile[0]->truong_dapheduyet == 1) && ($getProfile[0]->phongGD_chopheduyet == 1) && ($getProfile[0]->phongTC_chopheduyet == 1) && ($getProfile[0]->So_chopheduyet == 1)) {
                        foreach ($getType as $valueType) {
                            if ($valueType->report == "MGHP") {
                                $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_MGHP' => 2, 
                                        'truong_user_MGHP' => $userName, 
                                        'truong_update_date_MGHP' => $currentdate]);
                            }
                            if ($valueType->report == "CPHT") {
                                $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_CPHT' => 2, 
                                        'truong_user_CPHT' => $userName, 
                                        'truong_update_date_CPHT' => $currentdate]);
                            }
                            if ($valueType->report == "HTAT") {
                                $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HTAT' => 2, 
                                        'truong_user_HTAT' => $userName, 
                                        'truong_update_date_HTAT' => $currentdate]);
                            }
                            if ($valueType->report == "HTBT") {
                                $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HTBT' => 2, 
                                        'truong_user_HTBT' => $userName, 
                                        'truong_update_date_HTBT' => $currentdate]);
                            }
                            if ($valueType->report == "HSKT") {
                                $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HSKT' => 2, 
                                        'truong_user_HSKT' => $userName, 
                                        'truong_update_date_HSKT' => $currentdate]);
                            }
                            if ($valueType->report == "HSDTTS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HSDTTS' => 2, 
                                        'truong_user_HSDTTS' => $userName, 
                                        'truong_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HTATHS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HSDTTS' => 2, 
                                        'truong_user_HSDTTS' => $userName, 
                                        'truong_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HBHSDTNT") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_pheduyet_HSDTTS' => 2, 
                                        'truong_user_HSDTTS' => $userName, 
                                        'truong_update_date_HSDTTS' => $currentdate]);
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $reverted = 0;

                            $waiting_phongGD = 0;
                            if ($status == 0) {
                                foreach ($getReport as $value) {
                                    $waiting = $value->report_waiting - 1;
                                    $reverted = $value->report_reverted + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_waiting' => $waiting,
                                        'report_reverted' => $reverted
                                        ]);
                            }
                            else {
                                foreach ($getReport as $value) {
                                    $approved = $value->report_approved - 1;
                                    $reverted = $value->report_reverted + 1;
                                    $waiting_phongGD = $value->report_waiting_phongGD - 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reverted' => $reverted,
                                        'report_approved' => $approved, 
                                        'report_waiting_phongGD' => $waiting_phongGD
                                        ]);
                            }
                        }

                        $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                        if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                            DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                'his_trangthai_tralai' => 1]);
                        }
                        else {
                            DB::table('qlhs_report_history')->insert([
                                'his_profile_id' => $profile_id,
                                'his_trangthai_duyet' => 0,
                                'his_trangthai_tralai' => 1,
                                'his_trangthai_thuhoi_phongGD' => 0,
                                'his_trangthai_thuhoi_phongTC' => 0,
                                'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                        }

                        $result['success'] = "Trả lại học sinh thành công";
                    }
                    else if ($levelUser == 2 && ($getProfile[0]->phongGD_chopheduyet == 1 || $getProfile[0]->phongGD_dapheduyet == 1) && ($getProfile[0]->phongTC_chopheduyet == 1) && ($getProfile[0]->So_chopheduyet == 1)) {
                        foreach ($getType as $valueType) {
                            if ($valueType->report == "MGHP") {
                                $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_MGHP' => 2, 
                                        'phongGD_user_MGHP' => $userName, 
                                        'phongGD_update_date_MGHP' => $currentdate]);
                            }
                            if ($valueType->report == "CPHT") {
                                $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_CPHT' => 2, 
                                        'phongGD_user_CPHT' => $userName, 
                                        'phongGD_update_date_CPHT' => $currentdate]);
                            }
                            if ($valueType->report == "HTAT") {
                                $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HTAT' => 2, 
                                        'phongGD_user_HTAT' => $userName, 
                                        'phongGD_update_date_HTAT' => $currentdate]);
                            }
                            if ($valueType->report == "HTBT") {
                                $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HTBT' => 2, 
                                        'phongGD_user_HTBT' => $userName, 
                                        'phongGD_update_date_HTBT' => $currentdate]);
                            }
                            if ($valueType->report == "HSKT") {
                                $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HSKT' => 2, 
                                        'phongGD_user_HSKT' => $userName, 
                                        'phongGD_update_date_HSKT' => $currentdate]);
                            }
                            if ($valueType->report == "HSDTTS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HSDTTS' => 2, 
                                        'phongGD_user_HSDTTS' => $userName, 
                                        'phongGD_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HTATHS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HSDTTS' => 2, 
                                        'phongGD_user_HSDTTS' => $userName, 
                                        'phongGD_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HBHSDTNT") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongGD_HSDTTS' => 2, 
                                        'phongGD_user_HSDTTS' => $userName, 
                                        'phongGD_update_date_HSDTTS' => $currentdate]);
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $reverted = 0;

                            $waiting_phongTC = 0;
                            if ($status == 2) {
                                foreach ($getReport as $value) {
                                    $waiting = $value->report_waiting_phongGD - 1;
                                    $reverted = $value->report_reverted_phongGD + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_waiting_phongGD' => $waiting,
                                        'report_reverted_phongGD' => $reverted
                                        ]);
                            }
                            else if ($status == 3) {
                                foreach ($getReport as $value) {
                                    $approved = $value->report_approved_phongGD - 1;
                                    $reverted = $value->report_reverted_phongGD + 1;
                                    $waiting_phongTC = $value->report_waiting_phongTC - 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reverted_phongGD' => $reverted,
                                        'report_approved_phongGD' => $approved,
                                        'report_waiting_phongTC' => $waiting_phongTC
                                        ]);
                            }
                        }

                        $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                        if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                            DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                'his_trangthai_tralai' => 1,
                                'his_note_tralai_phongGD' => $note,
                                'his_note_duyet_phongGD' => '']);
                        }
                        else {
                            DB::table('qlhs_report_history')->insert([
                                'his_profile_id' => $profile_id,
                                'his_trangthai_duyet' => 0,
                                'his_trangthai_tralai' => 1,
                                'his_trangthai_thuhoi_phongGD' => 0,
                                'his_trangthai_thuhoi_phongTC' => 0,
                                'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                        }

                        $result['success'] = "Trả lại học sinh thành công";
                    }
                    else if ($levelUser == 3 && ($getProfile[0]->phongTC_chopheduyet == 1 || $getProfile[0]->phongTC_dapheduyet == 1) && ($getProfile[0]->So_chopheduyet == 1)) {
                        foreach ($getType as $valueType) {
                            if ($valueType->report == "MGHP") {
                                $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_MGHP' => 2, 
                                        'phongTC_user_MGHP' => $userName, 
                                        'phongTC_update_date_MGHP' => $currentdate]);
                            }
                            if ($valueType->report == "CPHT") {
                                $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_CPHT' => 2, 
                                        'phongTC_user_CPHT' => $userName, 
                                        'phongTC_update_date_CPHT' => $currentdate]);
                            }
                            if ($valueType->report == "HTAT") {
                                $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HTAT' => 2, 
                                        'phongTC_user_HTAT' => $userName, 
                                        'phongTC_update_date_HTAT' => $currentdate]);
                            }
                            if ($valueType->report == "HTBT") {
                                $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HTBT' => 2, 
                                        'phongTC_user_HTBT' => $userName, 
                                        'phongTC_update_date_HTBT' => $currentdate]);
                            }
                            if ($valueType->report == "HSKT") {
                                $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HSKT' => 2, 
                                        'phongTC_user_HSKT' => $userName, 
                                        'phongTC_update_date_HSKT' => $currentdate]);
                            }
                            if ($valueType->report == "HSDTTS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HSDTTS' => 2, 
                                        'phongTC_user_HSDTTS' => $userName, 
                                        'phongTC_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HTATHS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HSDTTS' => 2, 
                                        'phongTC_user_HSDTTS' => $userName, 
                                        'phongTC_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HBHSDTNT") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_phongTC_HSDTTS' => 2, 
                                        'phongTC_user_HSDTTS' => $userName, 
                                        'phongTC_update_date_HSDTTS' => $currentdate]);
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $reverted = 0;

                            $waiting_So = 0;
                            if ($status == 5) {
                                foreach ($getReport as $value) {
                                    $waiting = $value->report_waiting_phongTC - 1;
                                    $reverted = $value->report_reverted_phongTC + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_waiting_phongTC' => $waiting,
                                        'report_reverted_phongTC' => $reverted
                                        ]);
                            }
                            else if ($status == 6) {
                                foreach ($getReport as $value) {
                                    $approved = $value->report_approved_phongTC - 1;
                                    $reverted = $value->report_reverted_phongTC + 1;
                                    $waiting_So = $value->report_waiting_So - 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reverted_phongTC' => $reverted,
                                        'report_approved_phongTC' => $approved,
                                        'report_waiting_So' => $waiting_So
                                        ]);
                            }
                        }

                        $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                        if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                            DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                'his_trangthai_tralai' => 1,
                                'his_note_tralai_phongTC' => $note,
                                'his_note_duyet_phongTC' => '']);
                        }
                        else {
                            DB::table('qlhs_report_history')->insert([
                                'his_profile_id' => $profile_id,
                                'his_trangthai_duyet' => 0,
                                'his_trangthai_tralai' => 1,
                                'his_trangthai_thuhoi_phongGD' => 0,
                                'his_trangthai_thuhoi_phongTC' => 0,
                                'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                        }

                        $result['success'] = "Trả lại học sinh thành công";
                    }
                    else if ($levelUser == 4 && ($getProfile[0]->So_chopheduyet == 1 || $getProfile[0]->So_dapheduyet == 1)) {
                        foreach ($getType as $valueType) {
                            if ($valueType->report == "MGHP") {
                                $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_MGHP' => 2, 
                                        'so_user_MGHP' => $userName, 
                                        'so_update_date_MGHP' => $currentdate]);
                            }
                            if ($valueType->report == "CPHT") {
                                $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_CPHT' => 2, 
                                        'so_user_CPHT' => $userName, 
                                        'so_update_date_CPHT' => $currentdate]);
                            }
                            if ($valueType->report == "HTAT") {
                                $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HTAT' => 2, 
                                        'so_user_HTAT' => $userName, 
                                        'so_update_date_HTAT' => $currentdate]);
                            }
                            if ($valueType->report == "HTBT") {
                                $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HTBT' => 2, 
                                        'so_user_HTBT' => $userName, 
                                        'so_update_date_HTBT' => $currentdate]);
                            }
                            if ($valueType->report == "HSKT") {
                                $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HSKT' => 2, 
                                        'so_user_HSKT' => $userName, 
                                        'so_update_date_HSKT' => $currentdate]);
                            }
                            if ($valueType->report == "HSDTTS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HSDTTS' => 2, 
                                        'so_user_HSDTTS' => $userName, 
                                        'so_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HTATHS") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HSDTTS' => 2, 
                                        'so_user_HSDTTS' => $userName, 
                                        'so_update_date_HSDTTS' => $currentdate]);
                            }
                            if ($valueType->report == "HBHSDTNT") {
                                $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                        'trangthai_So_HSDTTS' => 2, 
                                        'so_user_HSDTTS' => $userName, 
                                        'so_update_date_HSDTTS' => $currentdate]);
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $reverted = 0;
                            if ($status == 8) {
                                foreach ($getReport as $value) {
                                    $waiting = $value->report_waiting_So - 1;
                                    $reverted = $value->report_reverted_So + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_waiting_So' => $waiting,
                                        'report_reverted_So' => $reverted
                                        ]);
                            }
                            else if ($status == 9) {
                                foreach ($getReport as $value) {
                                    $approved = $value->report_approved_So - 1;
                                    $reverted = $value->report_reverted_So + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reverted_So' => $reverted,
                                        'report_approved_So' => $approved
                                        ]);
                            }
                        }

                        $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                        if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                            DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                'his_trangthai_tralai' => 1,
                                'his_note_tralai_So' => $note,
                                'his_note_duyet_So' => '']);
                        }
                        else {
                            DB::table('qlhs_report_history')->insert([
                                'his_profile_id' => $profile_id,
                                'his_trangthai_duyet' => 0,
                                'his_trangthai_tralai' => 1,
                                'his_trangthai_thuhoi_phongGD' => 0,
                                'his_trangthai_thuhoi_phongTC' => 0,
                                'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                        }

                        $result['success'] = "Trả lại học sinh thành công";
                    }
                    else {
                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $reload = 0;
                            
                            if ($levelUser == 2) {
                                foreach ($getReport as $value) {
                                    $reload = $value->report_reload_phongGD + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reload_phongGD' => $reload
                                        ]);
                            }
                            else if ($levelUser == 3) {
                                foreach ($getReport as $value) {
                                    $reload = $value->report_reload_phongTC + 1;
                                }

                                DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                    ->update([
                                        'report_reload_phongTC' => $reload
                                        ]);
                            }
                        }

                        $phongGD_thuhoi = 0;
                        $phongTC_thuhoi = 0;

                        if ($levelUser == 2) {
                            $phongGD_thuhoi = 1;
                            $phongTC_thuhoi = 0;
                        }

                        if ($levelUser == 3) {
                            $phongGD_thuhoi = 0;
                            $phongTC_thuhoi = 1;
                        }

                        $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                        if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                            DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                'his_trangthai_duyet' => 0,
                                'his_trangthai_tralai' => 0,
                                'his_trangthai_thuhoi_phongGD' => $phongGD_thuhoi,
                                'his_trangthai_thuhoi_phongTC' => $phongTC_thuhoi,
                                'his_note_thuhoi' => $note,
                                'his_note_tralai_So' => '',
                                'his_note_duyet_So' => '',
                                'his_user_id' => $user,
                                'his_date' => $currentdate,
                                'his_capthuhoi' => $levelUser]);
                        }
                        else {
                            DB::table('qlhs_report_history')->insert([
                                'his_profile_id' => $profile_id,
                                'his_trangthai_duyet' => 0,
                                'his_trangthai_tralai' => 0,
                                'his_trangthai_thuhoi_phongGD' => $phongGD_thuhoi,
                                'his_trangthai_thuhoi_phongTC' => $phongTC_thuhoi,
                                'his_note_thuhoi' => $note,
                                'his_capthuhoi' => $levelUser,
                                'his_user_id' => $user,
                                'his_date' => $currentdate,
                                'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                        }

                        $result['success'] = "Học sinh đã được cấp trên phê duyệt, chờ cấp trên đồng ý thu hồi";
                    }
                }
                else {
                    $result['error'] = "Báo cáo không tồn tại";
                }
            }
            else {
                $result['error'] = "Không có học sinh nào";
            }

            return $result;
        } catch (Exception $e) {
            return $result['error'] = $e;
        }
    }

    public function approvedAllPheDuyet(Request $request){
        try {
            $result = [];
            $currentdate = Carbon::now('Asia/Ho_Chi_Minh');
            $schools_id = $request->input('SCHOOLID');
            $socongvan = $request->input('SOCONGVAN');

            $user = Auth::user()->id;
            $levelUser = 0;
            $userName = '';

            $getLevelUser = DB::table('users')->where('id', $user)->select('level', 'first_name', 'last_name')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
                if (!is_null($getLevelUser[0]->first_name) && !empty($getLevelUser[0]->first_name)) {
                    $userName =  $getLevelUser[0]->first_name.' '. $getLevelUser[0]->last_name;
                }
                else {
                    $userName =  $getLevelUser[0]->last_name;
                }
            }

            $update = 0;

            if ($levelUser == 1) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 0) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 0) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 0) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 0) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 0) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 0) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 0) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 0) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_MGHP' => 1, 
                                            'truong_user_MGHP' => $userName, 
                                            'truong_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_CPHT' => 1, 
                                            'truong_user_CPHT' => $userName, 
                                            'truong_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HTAT' => 1, 
                                            'truong_user_HTAT' => $userName, 
                                            'truong_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HTBT' => 1, 
                                            'truong_user_HTBT' => $userName, 
                                            'truong_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSKT' => 1, 
                                            'truong_user_HSKT' => $userName, 
                                            'truong_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 1, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 1, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 1, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_duyet' => 1]);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 1,
                                        'his_trangthai_tralai' => 0,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $waiting_phongGD = 0;

                            foreach ($getReport as $value) {
                                $waiting = $value->report_waiting - count($getProfile);
                                $approved = $value->report_approved + count($getProfile);
                                $waiting_phongGD = $value->report_waiting_phongGD + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_waiting' => $waiting,
                                    'report_approved' => $approved,
                                    'report_waiting_phongGD' => $waiting_phongGD
                                    ]);

                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Phê duyệt toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để phê duyệt";
                }
            }
            else if ($levelUser == 2) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 0) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 0) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 0) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 0) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 0) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 0) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 0) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 0) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get();

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_MGHP' => 1, 
                                            'phongGD_user_MGHP' => $userName, 
                                            'phongGD_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_CPHT' => 1, 
                                            'phongGD_user_CPHT' => $userName, 
                                            'phongGD_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HTAT' => 1, 
                                            'phongGD_user_HTAT' => $userName, 
                                            'phongGD_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HTBT' => 1, 
                                            'phongGD_user_HTBT' => $userName, 
                                            'phongGD_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSKT' => 1, 
                                            'phongGD_user_HSKT' => $userName, 
                                            'phongGD_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 1, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 1, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 1, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_duyet' => 1,
                                        'his_note_duyet_phongGD' => '',
                                        'his_note_tralai_phongGD' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 1,
                                        'his_trangthai_tralai' => 0,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();
                        // return count($getProfile);
                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $waiting_phongTC = 0;

                            foreach ($getReport as $value) {
                                $waiting = $value->report_waiting_phongGD - count($getProfile);
                                $approved = $value->report_approved_phongGD + count($getProfile);
                                $waiting_phongTC = $value->report_waiting_phongTC + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_waiting_phongGD' => $waiting,
                                    'report_approved_phongGD' => $approved,
                                    'report_waiting_phongTC' => $waiting_phongTC
                                    ]);

                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Phê duyệt toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để phê duyệt";
                }
            }
            else if ($levelUser == 3) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 0) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 0) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 0) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 0) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 0) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 0) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 0) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 0) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_MGHP' => 1, 
                                            'phongTC_user_MGHP' => $userName, 
                                            'phongTC_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_CPHT' => 1, 
                                            'phongTC_user_CPHT' => $userName, 
                                            'phongTC_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HTAT' => 1, 
                                            'phongTC_user_HTAT' => $userName, 
                                            'phongTC_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HTBT' => 1, 
                                            'phongTC_user_HTBT' => $userName, 
                                            'phongTC_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSKT' => 1, 
                                            'phongTC_user_HSKT' => $userName, 
                                            'phongTC_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 1, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 1, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 1, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_duyet' => 1,
                                        'his_note_duyet_phongTC' => '',
                                        'his_note_tralai_phongTC' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 1,
                                        'his_trangthai_tralai' => 0,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;
                            $waiting_So = 0;

                            foreach ($getReport as $value) {
                                $waiting = $value->report_waiting_phongTC - count($getProfile);
                                $approved = $value->report_approved_phongTC + count($getProfile);
                                $waiting_So = $value->report_waiting_So + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_waiting_phongTC' => $waiting,
                                    'report_approved_phongTC' => $approved,
                                    'report_waiting_So' => $waiting_So
                                    ]);

                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Phê duyệt toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để phê duyệt";
                }
            }
            else if ($levelUser == 4) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 1 AND trangthai_So_MGHP = 0) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 1 AND trangthai_So_CPHT = 0) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 1 AND trangthai_So_HTAT = 0) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 1 AND trangthai_So_HTBT = 0) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 1 AND trangthai_So_HSKT = 0) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 1 AND hsdtts.trangthai_So_HSDTTS = 0) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 1 AND htaths.trangthai_So_HSDTTS = 0) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1 AND hbhsdtnt.trangthai_So_HSDTTS = 0) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_MGHP' => 1, 
                                            'so_user_MGHP' => $userName, 
                                            'so_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_CPHT' => 1, 
                                            'so_user_CPHT' => $userName, 
                                            'so_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HTAT' => 1, 
                                            'so_user_HTAT' => $userName, 
                                            'so_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HTBT' => 1, 
                                            'so_user_HTBT' => $userName, 
                                            'so_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSKT' => 1, 
                                            'so_user_HSKT' => $userName, 
                                            'so_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 1, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 1, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 1, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_duyet' => 1,
                                        'his_note_duyet_So' => '',
                                        'his_note_tralai_So' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 1,
                                        'his_trangthai_tralai' => 0,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $approved = 0;

                            foreach ($getReport as $value) {
                                $waiting = $value->report_waiting_So - count($getProfile);
                                $approved = $value->report_approved_So + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_waiting_So' => $waiting,
                                    'report_approved_So' => $approved
                                        ]);
                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Phê duyệt toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để phê duyệt";
                }
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    //----------------------23/12/2017---------------------------------------------
    public function approvedAllDaPheDuyet(Request $request){
        try {
            $result = [];
            $currentdate = Carbon::now('Asia/Ho_Chi_Minh');
            $schools_id = $request->input('SCHOOLID');
            $socongvan = $request->input('SOCONGVAN');

            $user = Auth::user()->id;
            $levelUser = 0;
            $userName = '';

            $getLevelUser = DB::table('users')->where('id', $user)->select('level', 'first_name', 'last_name')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
                if (!is_null($getLevelUser[0]->first_name) && !empty($getLevelUser[0]->first_name)) {
                    $userName =  $getLevelUser[0]->first_name.' '. $getLevelUser[0]->last_name;
                }
                else {
                    $userName =  $getLevelUser[0]->last_name;
                }
            }

            $update = 0;

            if ($levelUser == 1) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 2) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 2) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 2) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 2) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 2) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 2) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 2) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 2) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_MGHP' => 1, 
                                            'truong_user_MGHP' => $userName, 
                                            'truong_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_CPHT' => 1, 
                                            'truong_user_CPHT' => $userName, 
                                            'truong_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HTAT' => 1, 
                                            'truong_user_HTAT' => $userName, 
                                            'truong_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HTBT' => 1, 
                                            'truong_user_HTBT' => $userName, 
                                            'truong_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSKT' => 1, 
                                            'truong_user_HSKT' => $userName, 
                                            'truong_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 1, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 1, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 1, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_duyet' => 1,
                                        'his_note_duyet_phongGD' => '',
                                        'his_note_tralai_phongGD' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 1,
                                        'his_trangthai_tralai' => 0,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $reverted = 0;
                            $approved = 0;
                            $waiting_phongGD = 0;

                            foreach ($getReport as $value) {
                                $reverted = $value->report_reverted - count($getProfile);
                                $approved = $value->report_approved + count($getProfile);
                                $waiting_phongGD = $value->report_waiting_phongGD + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_reverted' => $reverted,
                                    'report_approved' => $approved,
                                    'report_waiting_phongGD' => $waiting_phongGD
                                    ]);

                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Phê duyệt toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để phê duyệt";
                }
            }
            else if ($levelUser == 2) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 2) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 2) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 2) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 2) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 2) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 2) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 2) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 2) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_MGHP' => 1, 
                                            'phongGD_user_MGHP' => $userName, 
                                            'phongGD_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_CPHT' => 1, 
                                            'phongGD_user_CPHT' => $userName, 
                                            'phongGD_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HTAT' => 1, 
                                            'phongGD_user_HTAT' => $userName, 
                                            'phongGD_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HTBT' => 1, 
                                            'phongGD_user_HTBT' => $userName, 
                                            'phongGD_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSKT' => 1, 
                                            'phongGD_user_HSKT' => $userName, 
                                            'phongGD_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 1, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 1, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 1, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_duyet' => 1,
                                        'his_note_duyet_phongGD' => '',
                                        'his_note_tralai_phongGD' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 1,
                                        'his_trangthai_tralai' => 0,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $reverted = 0;
                            $approved = 0;
                            $waiting_phongTC = 0;

                            foreach ($getReport as $value) {
                                $reverted = $value->report_reverted_phongGD - count($getProfile);
                                $approved = $value->report_approved_phongGD + count($getProfile);
                                $waiting_phongTC = $value->report_waiting_phongTC + count($getProfile) - $value->report_approved_phongTC;
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_reverted_phongGD' => $reverted,
                                    'report_approved_phongGD' => $approved,
                                    'report_waiting_phongTC' => $waiting_phongTC
                                    ]);

                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Phê duyệt toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để phê duyệt";
                }
            }
            else if ($levelUser == 3) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 2) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 2) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 2) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 2) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 2) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 2) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 2) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 2) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_MGHP' => 1, 
                                            'phongTC_user_MGHP' => $userName, 
                                            'phongTC_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_CPHT' => 1, 
                                            'phongTC_user_CPHT' => $userName, 
                                            'phongTC_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HTAT' => 1, 
                                            'phongTC_user_HTAT' => $userName, 
                                            'phongTC_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HTBT' => 1, 
                                            'phongTC_user_HTBT' => $userName, 
                                            'phongTC_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSKT' => 1, 
                                            'phongTC_user_HSKT' => $userName, 
                                            'phongTC_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 1, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 1, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 1, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_duyet' => 1,
                                        'his_note_duyet_phongTC' => '',
                                        'his_note_tralai_phongTC' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 1,
                                        'his_trangthai_tralai' => 0,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $reverted = 0;
                            $approved = 0;
                            $waiting_So = 0;

                            foreach ($getReport as $value) {
                                $reverted = $value->report_reverted_phongTC - count($getProfile);
                                $approved = $value->report_approved_phongTC + count($getProfile);
                                $waiting_So = $value->report_waiting_So + count($getProfile) - $value->report_approved_So;
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_reverted_phongTC' => $reverted,
                                    'report_approved_phongTC' => $approved,
                                    'report_waiting_So' => $waiting_So
                                    ]);

                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Phê duyệt toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để phê duyệt";
                }
            }
            else if ($levelUser == 4) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 1 AND trangthai_So_MGHP = 2) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 1 AND trangthai_So_CPHT = 2) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 1 AND trangthai_So_HTAT = 2) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 1 AND trangthai_So_HTBT = 2) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 1 AND trangthai_So_HSKT = 2) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 1 AND hsdtts.trangthai_So_HSDTTS = 2) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 1 AND htaths.trangthai_So_HSDTTS = 2) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1 AND hbhsdtnt.trangthai_So_HSDTTS = 2) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_MGHP' => 1, 
                                            'so_user_MGHP' => $userName, 
                                            'so_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_CPHT' => 1, 
                                            'so_user_CPHT' => $userName, 
                                            'so_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HTAT' => 1, 
                                            'so_user_HTAT' => $userName, 
                                            'so_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HTBT' => 1, 
                                            'so_user_HTBT' => $userName, 
                                            'so_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSKT' => 1, 
                                            'so_user_HSKT' => $userName, 
                                            'so_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 1, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 1, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 1, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_duyet' => 1,
                                        'his_note_duyet_So' => '',
                                        'his_note_tralai_So' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 1,
                                        'his_trangthai_tralai' => 0,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $reverted = 0;
                            $approved = 0;

                            foreach ($getReport as $value) {
                                $reverted = $value->report_reverted_So - count($getProfile);
                                $approved = $value->report_approved_So + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_reverted_So' => $reverted,
                                    'report_approved_So' => $approved
                                        ]);
                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Phê duyệt toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để phê duyệt";
                }
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function revertsAllPheDuyet(Request $request){
        try {
            $result = [];
            $currentdate = Carbon::now('Asia/Ho_Chi_Minh');
            $schools_id = $request->input('SCHOOLID');
            $socongvan = $request->input('SOCONGVAN');

            $user = Auth::user()->id;
            $levelUser = 0;
            $userName = '';

            $getLevelUser = DB::table('users')->where('id', $user)->select('level', 'first_name', 'last_name')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
                if (!is_null($getLevelUser[0]->first_name) && !empty($getLevelUser[0]->first_name)) {
                    $userName =  $getLevelUser[0]->first_name.' '. $getLevelUser[0]->last_name;
                }
                else {
                    $userName =  $getLevelUser[0]->last_name;
                }
            }

            $update = 0;

            if ($levelUser == 1) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 0) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 0) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 0) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 0) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 0) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 0) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 0) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 0) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_MGHP' => 2, 
                                            'truong_user_MGHP' => $userName, 
                                            'truong_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_CPHT' => 2, 
                                            'truong_user_CPHT' => $userName, 
                                            'truong_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HTAT' => 2, 
                                            'truong_user_HTAT' => $userName, 
                                            'truong_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HTBT' => 2, 
                                            'truong_user_HTBT' => $userName, 
                                            'truong_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSKT' => 2, 
                                            'truong_user_HSKT' => $userName, 
                                            'truong_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 2, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 2, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 2, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_tralai' => 1]);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 0,
                                        'his_trangthai_tralai' => 1,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $reverted = 0;

                            foreach ($getReport as $value) {
                                $waiting = $value->report_waiting - count($getProfile);
                                $reverted = $value->report_reverted + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_waiting' => $waiting,
                                    'report_reverted' => $reverted
                                        ]);
                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Trả lại toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để trả lại";
                }
            }
            else if ($levelUser == 2) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 0) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 0) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 0) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 0) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 0) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 0) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 0) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 0) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_MGHP' => 2, 
                                            'phongGD_user_MGHP' => $userName, 
                                            'phongGD_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_CPHT' => 2, 
                                            'phongGD_user_CPHT' => $userName, 
                                            'phongGD_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HTAT' => 2, 
                                            'phongGD_user_HTAT' => $userName, 
                                            'phongGD_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HTBT' => 2, 
                                            'phongGD_user_HTBT' => $userName, 
                                            'phongGD_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSKT' => 2, 
                                            'phongGD_user_HSKT' => $userName, 
                                            'phongGD_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 2, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 2, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 2, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_tralai' => 1,
                                        'his_note_duyet_phongGD' => '',
                                        'his_note_tralai_phongGD' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 0,
                                        'his_trangthai_tralai' => 1,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $reverted = 0;

                            foreach ($getReport as $value) {
                                $waiting = $value->report_waiting_phongGD - count($getProfile);
                                $reverted = $value->report_reverted_phongGD + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_waiting_phongGD' => $waiting,
                                    'report_reverted_phongGD' => $reverted
                                        ]);
                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Trả lại toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để trả lại";
                }
            }
            else if ($levelUser == 3) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 0) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 0) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 0) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 0) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 0) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 0) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 0) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 0) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_MGHP' => 2, 
                                            'phongTC_user_MGHP' => $userName, 
                                            'phongTC_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_CPHT' => 2, 
                                            'phongTC_user_CPHT' => $userName, 
                                            'phongTC_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HTAT' => 2, 
                                            'phongTC_user_HTAT' => $userName, 
                                            'phongTC_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HTBT' => 2, 
                                            'phongTC_user_HTBT' => $userName, 
                                            'phongTC_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSKT' => 2, 
                                            'phongTC_user_HSKT' => $userName, 
                                            'phongTC_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 2, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 2, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 2, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_tralai' => 1,
                                        'his_note_duyet_phongTC' => '',
                                        'his_note_tralai_phongTC' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 0,
                                        'his_trangthai_tralai' => 1,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $reverted = 0;

                            foreach ($getReport as $value) {
                                $waiting = $value->report_waiting_phongTC - count($getProfile);
                                $reverted = $value->report_reverted_phongTC + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_waiting_phongTC' => $waiting,
                                    'report_reverted_phongTC' => $reverted
                                        ]);
                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Trả lại toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để trả lại";
                }
            }
            else if ($levelUser == 4) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 1 AND trangthai_So_MGHP = 0) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 1 AND trangthai_So_CPHT = 0) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 1 AND trangthai_So_HTAT = 0) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 1 AND trangthai_So_HTBT = 0) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 1 AND trangthai_So_HSKT = 0) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 1 AND hsdtts.trangthai_So_HSDTTS = 0) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 1 AND htaths.trangthai_So_HSDTTS = 0) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1 AND hbhsdtnt.trangthai_So_HSDTTS = 0) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_MGHP' => 2, 
                                            'so_user_MGHP' => $userName, 
                                            'so_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_CPHT' => 2, 
                                            'so_user_CPHT' => $userName, 
                                            'so_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HTAT' => 2, 
                                            'so_user_HTAT' => $userName, 
                                            'so_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HTBT' => 2, 
                                            'so_user_HTBT' => $userName, 
                                            'so_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSKT' => 2, 
                                            'so_user_HSKT' => $userName, 
                                            'so_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 2, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 2, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 2, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_tralai' => 1,
                                        'his_note_duyet_So' => '',
                                        'his_note_tralai_So' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 0,
                                        'his_trangthai_tralai' => 1,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $waiting = 0;
                            $reverted = 0;

                            foreach ($getReport as $value) {
                                $waiting = $value->report_waiting_So - count($getProfile);
                                $reverted = $value->report_reverted_So + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_waiting_So' => $waiting,
                                    'report_reverted_So' => $reverted
                                        ]);
                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Trả lại toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để trả lại";
                }
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    //----------------------23/12/2017---------------------------------------------
    public function revertAllDaPheDuyet(Request $request){
        try {
            $result = [];
            $currentdate = Carbon::now('Asia/Ho_Chi_Minh');
            $schools_id = $request->input('SCHOOLID');
            $socongvan = $request->input('SOCONGVAN');

            $user = Auth::user()->id;
            $levelUser = 0;
            $userName = '';

            $getLevelUser = DB::table('users')->where('id', $user)->select('level', 'first_name', 'last_name')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
                if (!is_null($getLevelUser[0]->first_name) && !empty($getLevelUser[0]->first_name)) {
                    $userName =  $getLevelUser[0]->first_name.' '. $getLevelUser[0]->last_name;
                }
                else {
                    $userName =  $getLevelUser[0]->last_name;
                }
            }

            $update = 0;

            if ($levelUser == 1) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_MGHP' => 2, 
                                            'truong_user_MGHP' => $userName, 
                                            'truong_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_CPHT' => 2, 
                                            'truong_user_CPHT' => $userName, 
                                            'truong_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HTAT' => 2, 
                                            'truong_user_HTAT' => $userName, 
                                            'truong_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HTBT' => 2, 
                                            'truong_user_HTBT' => $userName, 
                                            'truong_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSKT' => 2, 
                                            'truong_user_HSKT' => $userName, 
                                            'truong_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 2, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 2, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_pheduyet_HSDTTS' => 2, 
                                            'truong_user_HSDTTS' => $userName, 
                                            'truong_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_tralai' => 1]);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 0,
                                        'his_trangthai_tralai' => 1,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $approved = 0;
                            $reverted = 0;
                            $waiting_phongGD = 0;

                            foreach ($getReport as $value) {
                                $approved = $value->report_approved - count($getProfile);
                                $reverted = $value->report_reverted + count($getProfile);
                                $waiting_phongGD = $value->report_waiting_phongGD - count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_approved' => $approved,
                                    'report_reverted' => $reverted,
                                    'report_waiting_phongGD' => $waiting_phongGD
                                    ]);

                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Trả lại toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để trả lại";
                }
            }
            else if ($levelUser == 2) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_MGHP' => 2, 
                                            'phongGD_user_MGHP' => $userName, 
                                            'phongGD_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_CPHT' => 2, 
                                            'phongGD_user_CPHT' => $userName, 
                                            'phongGD_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HTAT' => 2, 
                                            'phongGD_user_HTAT' => $userName, 
                                            'phongGD_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HTBT' => 2, 
                                            'phongGD_user_HTBT' => $userName, 
                                            'phongGD_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSKT' => 2, 
                                            'phongGD_user_HSKT' => $userName, 
                                            'phongGD_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 2, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 2, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongGD_HSDTTS' => 2, 
                                            'phongGD_user_HSDTTS' => $userName, 
                                            'phongGD_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_tralai' => 1,
                                        'his_note_duyet_phongGD' => '',
                                        'his_note_tralai_phongGD' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 0,
                                        'his_trangthai_tralai' => 1,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $approved = 0;
                            $reverted = 0;
                            $waiting_phongTC = 0;

                            foreach ($getReport as $value) {
                                $approved = $value->report_approved_phongGD - count($getProfile);
                                $reverted = $value->report_reverted_phongGD + count($getProfile);
                                $waiting_phongTC = $value->report_waiting_phongTC - count($getProfile) + $value->report_approved_phongTC;
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_approved_phongGD' => $approved,
                                    'report_reverted_phongGD' => $reverted,
                                    'report_waiting_phongTC' => $waiting_phongTC
                                    ]);

                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Trả lại toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để trả lại";
                }
            }
            else if ($levelUser == 3) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 1) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 1) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 1) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 1) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 1) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 1) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 1) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_MGHP' => 2, 
                                            'phongTC_user_MGHP' => $userName, 
                                            'phongTC_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_CPHT' => 2, 
                                            'phongTC_user_CPHT' => $userName, 
                                            'phongTC_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HTAT' => 2, 
                                            'phongTC_user_HTAT' => $userName, 
                                            'phongTC_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HTBT' => 2, 
                                            'phongTC_user_HTBT' => $userName, 
                                            'phongTC_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSKT' => 2, 
                                            'phongTC_user_HSKT' => $userName, 
                                            'phongTC_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 2, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 2, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_phongTC_HSDTTS' => 2, 
                                            'phongTC_user_HSDTTS' => $userName, 
                                            'phongTC_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_tralai' => 1,
                                        'his_note_duyet_phongTC' => '',
                                        'his_note_tralai_phongTC' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 0,
                                        'his_trangthai_tralai' => 1,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $approved = 0;
                            $reverted = 0;
                            $waiting_So = 0;

                            foreach ($getReport as $value) {
                                $approved = $value->report_approved_phongTC - count($getProfile);
                                $reverted = $value->report_reverted_phongTC + count($getProfile);
                                $waiting_So = $value->report_waiting_So - count($getProfile) + $value->report_approved_So;
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_approved_phongTC' => $approved,
                                    'report_reverted_phongTC' => $reverted,
                                    'report_waiting_So' => $waiting_So
                                    ]);

                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Trả lại toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để trả lại";
                }
            }
            else if ($levelUser == 4) {
                $getProfile = DB::table('qlhs_profile')
                    ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                    ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_MGHP = 1 AND trangthai_phongGD_MGHP = 1 AND trangthai_phongTC_MGHP = 1 AND trangthai_So_MGHP = 1) AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_CPHT = 1 AND trangthai_phongGD_CPHT = 1 AND trangthai_phongTC_CPHT = 1 AND trangthai_So_CPHT = 1) AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTAT = 1 AND trangthai_phongGD_HTAT = 1 AND trangthai_phongTC_HTAT = 1 AND trangthai_So_HTAT = 1) AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HTBT = 1 AND trangthai_phongGD_HTBT = 1 AND trangthai_phongTC_HTBT = 1 AND trangthai_So_HTBT = 1) AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (trangthai_pheduyet_HSKT = 1 AND trangthai_phongGD_HSKT = 1 AND trangthai_phongTC_HSKT = 1 AND trangthai_So_HSKT = 1) AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hsdtts.trangthai_pheduyet_HSDTTS = 1 AND hsdtts.trangthai_phongGD_HSDTTS = 1 AND hsdtts.trangthai_phongTC_HSDTTS = 1 AND hsdtts.trangthai_So_HSDTTS = 1) AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (htaths.trangthai_pheduyet_HSDTTS = 1 AND htaths.trangthai_phongGD_HSDTTS = 1 AND htaths.trangthai_phongTC_HSDTTS = 1 AND htaths.trangthai_So_HSDTTS = 1) AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 AND hbhsdtnt.trangthai_phongGD_HSDTTS = 1 AND hbhsdtnt.trangthai_phongTC_HSDTTS = 1 AND hbhsdtnt.trangthai_So_HSDTTS = 1) AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                    ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                    ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id');

                if($schools_id == 0 || $schools_id == null){
                   $getProfile = $getProfile->where(DB::raw(' (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }else{
                    $getProfile = $getProfile->where('profile_school_id', '=', DB::raw($schools_id.' 
                    AND (qlhs_miengiamhocphi.nhu_cau > 0 OR qlhs_miengiamhocphi.du_toan > 0 
                    OR qlhs_chiphihoctap.nhu_cau > 0 OR qlhs_chiphihoctap.du_toan > 0
                    OR qlhs_hotrotienan.nhu_cau > 0 OR qlhs_hotrotienan.du_toan > 0
                    OR qlhs_hotrohocsinhbantru.tong_nhucau > 0 OR qlhs_hotrohocsinhbantru.tong_dutoan > 0
                    OR qlhs_hotrohocsinhkhuyettat.tong_nhucau > 0 OR qlhs_hotrohocsinhkhuyettat.tong_dutoan > 0
                    OR hsdtts.nhucau > 0 OR hsdtts.dutoan > 0
                    OR htaths.nhucau > 0 OR htaths.dutoan > 0
                    OR hbhsdtnt.nhucau > 0 OR hbhsdtnt.dutoan > 0)'));
                }

                $getProfile = $getProfile->select('qlhs_profile.profile_id as profile_id')->get(); 

                if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {

                    $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                    if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                        foreach ($getType as $valueType) {
                            foreach ($getProfile as $profile) {
                                if ($valueType->report == "MGHP") {
                                    $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_MGHP' => 2, 
                                            'so_user_MGHP' => $userName, 
                                            'so_update_date_MGHP' => $currentdate]);
                                }
                                if ($valueType->report == "CPHT") {
                                    $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_CPHT' => 2, 
                                            'so_user_CPHT' => $userName, 
                                            'so_update_date_CPHT' => $currentdate]);
                                }
                                if ($valueType->report == "HTAT") {
                                    $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HTAT' => 2, 
                                            'so_user_HTAT' => $userName, 
                                            'so_update_date_HTAT' => $currentdate]);
                                }
                                if ($valueType->report == "HTBT") {
                                    $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HTBT' => 2, 
                                            'so_user_HTBT' => $userName, 
                                            'so_update_date_HTBT' => $currentdate]);
                                }
                                if ($valueType->report == "HSKT") {
                                    $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSKT' => 2, 
                                            'so_user_HSKT' => $userName, 
                                            'so_update_date_HSKT' => $currentdate]);
                                }
                                if ($valueType->report == "HSDTTS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 2, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HTATHS") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 2, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }
                                if ($valueType->report == "HBHSDTNT") {
                                    $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile->profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                            'trangthai_So_HSDTTS' => 2, 
                                            'so_user_HSDTTS' => $userName, 
                                            'so_update_date_HSDTTS' => $currentdate]);
                                }

                                $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->get();

                                if (!is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                                    DB::table('qlhs_report_history')->where('his_profile_id', '=', $profile->profile_id)->where('his_socongvan', '=', $socongvan)->where('his_school_id', '=', $schools_id)->update([
                                        'his_trangthai_tralai' => 1,
                                        'his_note_duyet_So' => '',
                                        'his_note_tralai_So' => '']);
                                }
                                else {
                                    DB::table('qlhs_report_history')->insert([
                                        'his_profile_id' => $profile->profile_id,
                                        'his_trangthai_duyet' => 0,
                                        'his_trangthai_tralai' => 1,
                                        'his_trangthai_thuhoi_phongGD' => 0,
                                        'his_trangthai_thuhoi_phongTC' => 0,
                                        'his_socongvan' => $socongvan, 'his_school_id' => $schools_id]);
                                }
                            }
                        }

                        $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                        if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                            $approved = 0;
                            $reverted = 0;

                            foreach ($getReport as $value) {
                                $approved = $value->report_approved_So - count($getProfile);
                                $reverted = $value->report_reverted_So + count($getProfile);
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_approved_So' => $approved,
                                    'report_reverted_So' => $reverted
                                        ]);
                            $mess = qlhs_message::where('type',0)->where('report_name',$socongvan)->where('school_id',$schools_id)->update(['status' => 1,'updated_at' => new datetime]);
                        }

                        $result['success'] = "Trả lại toàn bộ học sinh thành công";
                    }
                }
                else {
                    $result['error'] = "Không có học sinh nào để trả lại";
                }
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadthuhoiHocSinh(Request $request){
        try {
            $results = [];

            $profile_id = $request->input('PROFILEID');
            $socongvan = $request->input('SOCONGVAN');
            $schools_id = $request->input('SCHOOLID');

            $getProfile = DB::table('qlhs_profile')
                ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id')
                ->where('qlhs_profile.profile_id', '=', $profile_id)
                ->select(
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 0 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 0 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 0 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 0 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 0 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 0 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 0 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 0 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 1 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 1 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 1 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 1 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 1 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 1 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 1 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 1 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 2 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 2 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 2 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 2 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 2 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 2 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 2 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 2 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_tralai'), 


                    DB::raw('(CASE when (trangthai_So_MGHP = 0 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 0 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 0 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 0 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 0 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 0 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 0 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 0 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_So_MGHP = 1 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 1 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 1 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 1 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 1 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 1 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 1 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 1 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_So_MGHP = 2 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 2 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 2 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 2 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 2 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 2 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 2 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 2 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_tralai'))
                ->get();

            $results['TCAPPROVED'] = 0;
            $results['SOAPPROVED'] = 0;

            if (!is_null($getProfile) && !empty($getProfile) && count($getProfile) > 0) {
                foreach ($getProfile as $value) {
                    $results['TCAPPROVED'] = $value->phongTC_dapheduyet;
                    $results['SOAPPROVED'] = $value->So_dapheduyet;
                }
            }

            $user = Auth::user()->id;
            $levelUser = 0;

            $getLevelUser = DB::table('users')->where('id', $user)->select('level', 'first_name', 'last_name')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
            }

            $results['LEVELUSER'] = $levelUser;

            $results['PROFILE'] = DB::table('qlhs_report_history')
                ->join('users', 'id', '=', 'his_user_id')
                ->join('qlhs_profile', 'his_profile_id', '=', 'profile_id')
                ->where('his_socongvan', '=', $socongvan)
                ->where('his_school_id', '=', $schools_id)
                ->where('his_profile_id', '=', $profile_id)
                ->select('profile_name', 'profile_birthday', 'last_name', 'first_name', 'his_date', 'his_note_thuhoi', 'his_capthuhoi')
                ->get();

            return $results;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function thuhoiHocSinh(Request $request){
        try {
            $results = [];

            $profile_id = $request->input('PROFILEID');
            $socongvan = $request->input('SOCONGVAN');
            $schools_id = $request->input('SCHOOLID');

            $getProfile = DB::table('qlhs_profile')
                ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))

                ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id')
                ->where('qlhs_profile.profile_id', '=', $profile_id)
                ->select(
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 0 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 0 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 0 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 0 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 0 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 0 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 0 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 0 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 1 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 1 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 1 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 1 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 1 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 1 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 1 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 1 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_phongTC_MGHP = 2 OR trangthai_phongTC_MGHP is null) AND (trangthai_phongTC_CPHT = 2 OR trangthai_phongTC_CPHT is null) AND (trangthai_phongTC_HTAT = 2 OR trangthai_phongTC_HTAT is null) AND (trangthai_phongTC_HTBT = 2 OR trangthai_phongTC_HTBT is null) AND (trangthai_phongTC_HSKT = 2 OR trangthai_phongTC_HSKT is null) AND (hsdtts.trangthai_phongTC_HSDTTS = 2 OR hsdtts.trangthai_phongTC_HSDTTS is null) AND (htaths.trangthai_phongTC_HSDTTS = 2 OR htaths.trangthai_phongTC_HSDTTS is null) AND (hbhsdtnt.trangthai_phongTC_HSDTTS = 2 OR hbhsdtnt.trangthai_phongTC_HSDTTS is null) then 1 else 0 END) as phongTC_tralai'), 


                    DB::raw('(CASE when (trangthai_So_MGHP = 0 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 0 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 0 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 0 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 0 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 0 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 0 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 0 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_chopheduyet'), 
                    DB::raw('(CASE when (trangthai_So_MGHP = 1 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 1 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 1 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 1 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 1 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 1 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 1 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 1 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_dapheduyet'), 
                    DB::raw('(CASE when (trangthai_So_MGHP = 2 OR trangthai_So_MGHP is null) AND (trangthai_So_CPHT = 2 OR trangthai_So_CPHT is null) AND (trangthai_So_HTAT = 2 OR trangthai_So_HTAT is null) AND (trangthai_So_HTBT = 2 OR trangthai_So_HTBT is null) AND (trangthai_So_HSKT = 2 OR trangthai_So_HSKT is null) AND (hsdtts.trangthai_So_HSDTTS = 2 OR hsdtts.trangthai_So_HSDTTS is null) AND (htaths.trangthai_So_HSDTTS = 2 OR htaths.trangthai_So_HSDTTS is null) AND (hbhsdtnt.trangthai_So_HSDTTS = 2 OR hbhsdtnt.trangthai_So_HSDTTS is null) then 1 else 0 END) as So_tralai'))
                ->get();

            $getHisReport = DB::table('qlhs_report_history')->where('his_profile_id', $profile_id)->where('his_socongvan', $socongvan)->where('his_school_id', $schools_id)->select('his_capthuhoi')->get();

            $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

            // $getHisReport = DB::table('qlhs_report_history')->where('his_socongvan', $socongvan)->where('his_school_id', $schools_id)->select('his_profile_id')->get();

            if (!is_null($getType) && !empty($getType) && count($getType) > 0 
                && !is_null($getHisReport) && !empty($getHisReport) && count($getHisReport) > 0) {
                if ($getHisReport[0]->his_capthuhoi == 2) {
                    foreach ($getType as $valueType) {
                        if ($valueType->report == "MGHP") {
                            $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongGD_MGHP' => 2, 
                                    'trangthai_phongTC_MGHP' => 0, 
                                    'trangthai_So_MGHP' => 0]);
                        }
                        if ($valueType->report == "CPHT") {
                            $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongGD_CPHT' => 2, 
                                    'trangthai_phongTC_CPHT' => 0, 
                                    'trangthai_So_CPHT' => 0]);
                        }
                        if ($valueType->report == "HTAT") {
                            $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongGD_HTAT' => 2, 
                                    'trangthai_phongTC_HTAT' => 0, 
                                    'trangthai_So_HTAT' => 0]);
                        }
                        if ($valueType->report == "HTBT") {
                            $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongGD_HTBT' => 2, 
                                    'trangthai_phongTC_HTBT' => 0, 
                                    'trangthai_So_HTBT' => 0]);
                        }
                        if ($valueType->report == "HSKT") {
                            $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongGD_HSKT' => 2, 
                                    'trangthai_phongTC_HSKT' => 0, 
                                    'trangthai_So_HSKT' => 0]);
                        }
                        if ($valueType->report == "HSDTTS") {
                            $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongGD_HSDTTS' => 2, 
                                    'trangthai_phongTC_HSDTTS' => 0, 
                                    'trangthai_So_HSDTTS' => 0]);
                        }
                        if ($valueType->report == "HTATHS") {
                            $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongGD_HSDTTS' => 2, 
                                    'trangthai_phongTC_HSDTTS' => 0, 
                                    'trangthai_So_HSDTTS' => 0]);
                        }
                        if ($valueType->report == "HBHSDTNT") {
                            $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongGD_HSDTTS' => 2, 
                                    'trangthai_phongTC_HSDTTS' => 0, 
                                    'trangthai_So_HSDTTS' => 0]);
                        }
                    }

                    $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                    if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                        $approved_phongGD = 0;
                        $reverted_phongGD = 0;
                        $approved_phongTC = 0;

                        $waiting_So = 0;
                        $approved_So = 0;

                        $reload_phongGD = 0;
                        $reload_phongTC = 0;

                        if ($getProfile[0]->So_dapheduyet == 1) {
                            foreach ($getReport as $value) {
                                $approved_phongGD = $value->report_approved_phongGD - 1;
                                $reverted_phongGD = $value->report_reverted_phongGD + 1;
                                $approved_phongTC = $value->report_approved_phongTC - 1;
                                $approved_So = $value->report_approved_So - 1;

                                $reload_phongGD = $value->report_reload_phongGD - 1;
                                $reload_phongTC = $value->report_reload_phongTC + 1;
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_approved_phongGD' => $approved_phongGD,
                                    'report_reverted_phongGD' => $reverted_phongGD,
                                    'report_approved_phongTC' => $approved_phongTC,
                                    'report_approved_So' => $approved_So,
                                    'report_reload_phongGD' => $reload_phongGD
                                    ]);
                        }
                        else {
                            foreach ($getReport as $value) {
                                $approved_phongGD = $value->report_approved_phongGD - 1;
                                $reverted_phongGD = $value->report_reverted_phongGD + 1;
                                $approved_phongTC = $value->report_approved_phongTC - 1;

                                $waiting_So = $value->report_waiting_So - 1;

                                $reload_phongGD = $value->report_reload_phongGD - 1;
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_approved_phongGD' => $approved_phongGD,
                                    'report_reverted_phongGD' => $reverted_phongGD,
                                    'report_approved_phongTC' => $approved_phongTC,
                                    'report_reload_phongGD' => $reload_phongGD,
                                    'report_waiting_So' => $waiting_So
                                    ]);
                        }
                    }
                }
                else if ($getHisReport[0]->his_capthuhoi == 3) {
                    foreach ($getType as $valueType) {
                        if ($valueType->report == "MGHP") {
                            $update = DB::table('qlhs_miengiamhocphi')->where('id_profile', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongTC_MGHP' => 2, 
                                    'trangthai_So_MGHP' => 0]);
                        }
                        if ($valueType->report == "CPHT") {
                            $update = DB::table('qlhs_chiphihoctap')->where('cpht_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([ 
                                    'trangthai_phongTC_CPHT' => 2, 
                                    'trangthai_So_CPHT' => 0]);
                        }
                        if ($valueType->report == "HTAT") {
                            $update = DB::table('qlhs_hotrotienan')->where('htta_profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongTC_HTAT' => 2, 
                                    'trangthai_So_HTAT' => 0]);
                        }
                        if ($valueType->report == "HTBT") {
                            $update = DB::table('qlhs_hotrohocsinhbantru')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongTC_HTBT' => 2, 
                                    'trangthai_So_HTBT' => 0]);
                        }
                        if ($valueType->report == "HSKT") {
                            $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongTC_HSKT' => 2, 
                                    'trangthai_So_HSKT' => 0]);
                        }
                        if ($valueType->report == "HSDTTS") {
                            $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongTC_HSDTTS' => 2, 
                                    'trangthai_So_HSDTTS' => 0]);
                        }
                        if ($valueType->report == "HTATHS") {
                            $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongTC_HSDTTS' => 2, 
                                    'trangthai_So_HSDTTS' => 0]);
                        }
                        if ($valueType->report == "HBHSDTNT") {
                            $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('profile_id', '=', $profile_id)->where('type_code', '=', $valueType->report_type)->update([
                                    'trangthai_phongTC_HSDTTS' => 2, 
                                    'trangthai_So_HSDTTS' => 0]);
                        }
                    }

                    $getReport = DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)->get();

                    if (!is_null($getReport) && !empty($getReport) && count($getReport) > 0) {
                        $approved_phongTC = 0;
                        $reverted_phongTC = 0;
                        $approved_So = 0;

                        $reload_phongTC = 0;

                        if ($getProfile[0]->So_dapheduyet == 1) {
                            foreach ($getReport as $value) {
                                $approved_phongTC = $value->report_approved_phongTC - 1;
                                $approved_phongTC = $value->report_reverted_phongTC + 1;
                                $approved_So = $value->report_approved_So - 1;

                                $reload_phongTC = $value->report_reload_phongTC - 1;
                            }

                            DB::table('qlhs_report')->where('name', '=', $socongvan)->where('report_school_id', '=', $schools_id)
                                ->update([
                                    'report_approved_phongTC' => $approved_phongTC,
                                    'report_reverted_phongTC' => $reverted_phongTC,
                                    'report_approved_So' => $approved_So,
                                    'report_reload_phongTC' => $reload_phongTC
                                    ]);
                        }
                    }
                }

                $results['success'] = "Thu hồi học sinh thành công";
            }
            else {
                $results['error'] = "Có lỗi xảy ra trong quá trình xử lý";
            }

            return $results;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function getLevelUser(Request $request){
        try {
            $user = Auth::user()->id;
            $levelUser = 0;

            $getLevelUser = DB::table('users')->where('id', $user)->select('level', 'first_name', 'last_name')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
            }

            return $levelUser;
        } catch (Exception $e) {
            return $e;
        }
    }

//----------------------------------------------------Danh sách học sinh đã được lập cấp Phòng - Sở---------------------------------------------------
    public function getViewApprovedPheDuyetTheoCV($congvan){
        $cv = DB::table('qlhs_hosobaocao')
        ->where('report_name',$congvan)
        ->select(
            DB::raw('GROUP_CONCAT(report_id_truong) as report_id_truong'),
            DB::raw('MAX(report_cap_status) as report_cap_status'),
            DB::raw('GROUP_CONCAT(report_name_text) as report_name_text'),
            DB::raw('MAX(report_status) as report_status'),
            DB::raw('MAX(report_type) as report_type')
            )->first();

        return view('admin.hoso.duyetdanhsach.listingnew',['id_truong' => $cv->report_id_truong,'status' => $cv->report_cap_status, 'congvan' => $congvan,'report_name_text' => $cv->report_name_text,'report_status' => $cv->report_status,'report_type' => $cv->report_type]);
    }
    public function getViewApprovedPheDuyet(){
        return view('admin.hoso.duyetdanhsach.listingnew',['id_truong' => '','status' => '-1', 'congvan' => '','report_name_text' => '','report_status' => '-1']);
    }

    public function loadDanhSachByPhongSo(Request $request)
    {
        try {
            $json = [];
            $start = $request->start;
            $limit = $request->limit;

            $schools_id = $request->SCHOOLID;
            $loaicongvan = $request->LOAICONGVAN;
            $socongvan = $request->SOCONGVAN;
            $keySearch = $request->KEY;
            $year = $request->YEAR;

            $user = Auth::user()->id;
            $levelUser = Auth::user()->level;
            $dataSchool = explode('-', Auth::user()->truong_id);
            $getData = DB::table('qlhs_hosobaocao as t1')
               ->leftJoin('qlhs_hosobaocao as t2',function($q){
                    $q->on('t1.report_name','t2.report_name_new')
                    ->on('t1.report_id_truong','t2.report_id_truong')
                    ->on('t1.report','t2.report')
                    ->where('t2.report_cap_gui',2);
               })
               ->leftJoin('qlhs_hosobaocao as t3',function($q){
                    $q->where(function($p){
                        $p->on('t2.report_name','t3.report_name_new')
                        ->orOn('t1.report_name','t3.report_name_new');
                    })
                    ->on('t1.report_id_truong','t3.report_id_truong')
                    ->on('t1.report','t3.report')
                    ->where('t3.report_cap_gui',3);
               })
               ->leftJoin('qlhs_hosobaocao as t4',function($q){
                    $q->on('t3.report_name','t4.report_name_new')
                    ->on('t1.report_id_truong','t4.report_id_truong')
                    ->on('t1.report','t4.report')
                    ->where('t4.report_cap_gui',4);
               })
               ->leftJoin('qlhs_schools as s','t1.report_id_truong','s.schools_id');
              // ->where('t1.report_type','NOT LIKE','NGNA%')
             //  ->where('t2.report_type','NOT LIKE','NGNA%')
             //  ->where('t3.report_type','NOT LIKE','NGNA%')
               //->where('t1.report_type','NOT LIKE','NGNA%');
            if (!is_null($schools_id) && !empty($schools_id) && $schools_id > 0) {
                $getData = $getData->where('t1.report_name_new',$schools_id.'-'.$year);    
            }else{
                $getData = $getData->whereIn('t1.report_id_truong',$dataSchool)
                ->where('t1.report_cap_gui',1);
            }
            if($loaicongvan == 1){
                $getData = $getData->where(function($q){
                    $q->where('t1.report_cap_status','<>',2)
                    ->where('t1.report_cap_status','<>',3)
                    ->orWhere('t1.report_cap_status',null);
                })->where(function($q){
                    $q->where('t2.report_cap_status','<>',2)
                    ->where('t2.report_cap_status','<>',3)
                    ->orWhere('t2.report_cap_status',null);
                })->where(function($q){
                    $q->where('t3.report_cap_status','<>',2)
                    ->where('t3.report_cap_status','<>',3)
                    ->orWhere('t3.report_cap_status',null);
                })->where(function($q){
                    $q->where('t4.report_cap_status','<>',2)
                    ->where('t4.report_cap_status','<>',3)
                    ->orWhere('t4.report_cap_status',null);
                });
            }else if($loaicongvan == 2){
                $getData = $getData->where('t1.report_cap_status','<>',2)
                ->where(function($q){
                    $q->orWhere('t2.report_cap_status',2)
                    ->orWhere('t3.report_cap_status',2)
                    ->orWhere('t4.report_cap_status',2);
                });
            }else if($loaicongvan == 3){
                $getData = $getData
                ->where(function($q){
                    $q->orWhere('t1.report_cap_status',3)
                    ->orWhere('t2.report_cap_status',3)
                    ->orWhere('t3.report_cap_status',3)
                    ->orWhere('t4.report_cap_status',3);
                });
            }else if($loaicongvan == 5){
                $getData = $getData
                ->where('t1.report_name',$socongvan);
            }else if($loaicongvan == 6){
                $getData = $getData
                ->where('t2.report_name',$socongvan);
            }else if($loaicongvan == 7){
                $getData = $getData
                ->where('t3.report_name',$socongvan);
            }else if($loaicongvan == 8){
                $getData = $getData
                ->where('t4.report_name',$socongvan);
            }
            $getData = $getData->select('t1.report_type','t1.report_name as truong','t2.report_name as pgd','t3.report_name as ptc','t4.report_name as stc','schools_name','schools_id','t1.report_name_text as date_1','t2.report_name_text as date_2','t3.report_name_text as date_3','t4.report_date as date_4','t1.report_cap_status as report_cap_status_1','t2.report_cap_status as report_cap_status_2','t3.report_cap_status as report_cap_status_3','t4.report_cap_status as report_cap_status_4','t1.report_total as c1','t2.report_total as c2','t3.report_total as c3','t4.report_total as c4','t1.report_status as s1','t2.report_status as s2','t3.report_status as s3','t4.report_status as s4','t1.report_cap_nhan as nhan_1','t2.report_cap_nhan as nhan_2','t3.report_cap_nhan as nhan_3','t4.report_cap_nhan as nhan_4');
            if($keySearch != null && $keySearch != ""){
                $getData->where(function($q) use($keySearch){
                    $q->orWhere('t1.report_name','LIKE','%'.$keySearch.'%')
                    ->orWhere('t2.report_name','LIKE','%'.$keySearch.'%')
                    ->orWhere('t3.report_name','LIKE','%'.$keySearch.'%')
                    ->orWhere('t4.report_name','LIKE','%'.$keySearch.'%');
                });
            }
                $json['totalRows'] = $getData->count();
                if($loaicongvan != 5 && $loaicongvan != 6 && $loaicongvan != 7){
                    if($levelUser == 1){
                        $getData = $getData
                        ->orderBy('t1.report_date','desc')
                        ->orderBy('t2.report_date','desc');
                    }else if($levelUser == 2){
                        $getData = $getData
                        ->orderBy('t2.report_date','desc')
                        ->orderBy('t1.report_date','desc');
                    }else if($levelUser == 3){
                        $getData = $getData
                        ->orderBy('t3.report_date','desc')
                        ->orderBy('t2.report_date','desc')
                        ->orderBy('t1.report_date','desc');
                    }else if($levelUser == 4){
                        $getData = $getData
                        ->orderBy('t4.report_date','desc')
                        ->orderBy('t3.report_date','desc');
                    }
                }else if($loaicongvan == 5){
                    $getData = $getData
                    ->orderBy('t2.report_date','desc');
                }else if($loaicongvan == 6){
                    $getData = $getData
                    ->orderBy('t3.report_date','desc');
                }else if($loaicongvan == 7){
                    $getData = $getData
                    ->orderBy('t4.report_date','desc');
                }else if($loaicongvan == 8){
                    $getData = $getData
                    ->orderBy('t3.report_date','desc');
                }
                
                $json['startRecord'] = ($start);
                $json['numRows'] = $limit;
                $json['level'] =$levelUser;
                $json['data'] = $getData->skip($start*$limit)->take($limit)->get();

            return $json;
        } catch (Exception $e) {
            return $e;
        }
    }
    public function activeNGNA(Request $request){
        $json = [];
        if(Auth::user()->level == 3){
            $datas = qlhs_hosobaocao_ngna_PTC::where('hsbc_id',$request->id)->where('report_name', $request->socongvan)->first();
            if($datas){
                $datas->hsbc_active = $request->value;
                $datas->save();
                $json['success'] = "Thao tác thành công.";
                HoSoBaoCao::where('report_name',$request->socongvan)->where('report_cap_status',0)->update(['report_cap_status' => 1]);
            }else{
                $json['error'] = "Thao tác lỗi. Không tồn tại công văn này.";
            }
        }else if(Auth::user()->level == 2){
            $datas = qlhs_hosobaocao_ngna_PGD::where('hsbc_id',$request->id)->where('report_name', $request->socongvan)->first();
        
            if($datas){
                $datas->hsbc_active = $request->value;
                $datas->save();
                $json['success'] = "Thao tác thành công.";
                HoSoBaoCao::where('report_name',$request->socongvan)->where('report_cap_status',0)->update(['report_cap_status'=> 1]);
            }else{
                $json['error'] = "Thao tác lỗi. Không tồn tại công văn này.";
            }
        }else if(Auth::user()->level == 4){
            $datas = qlhs_hosobaocao_ngna_STC::where('hsbc_id',$request->id)->where('report_name', $request->socongvan)->first();
            if($datas){
                $datas->hsbc_active = $request->value;
                $datas->save();
                $json['success'] = "Thao tác thành công.";
                HoSoBaoCao::where('report_name',$request->socongvan)->where('report_cap_status',0)->update(['report_cap_status' => 1]);
            }else{
                $json['error'] = "Thao tác lỗi. Không tồn tại công văn này.";
            }
        }else{
            $json['error'] = "Thao tác lỗi. Bạn không có quyền trong thao tác này.";
        }
        
        return $json;
    }
// danh sach trong con gvan - use
    public function loadDanhSachHSDaLap(Request $request)
    {
        $json = [];
        $start = $request->start;
        $limit = $request->limit;

        $schools_id = $request->SCHOOLID;
        $loaicongvan = $request->LOAICONGVAN;
        $socongvan = $request->SOCONGVAN;
        $keySearch = $request->KEY;
        $type = $request->TYPE;
        $order = $request->ORDER;

        $user = Auth::user()->id;
        $check = false;

        $levelUser = Auth::user()->level;
        // $capnhan = DB::table('qlhs_hosobaocao')
        // ->where('report_name',$socongvan)
        // ->select('report_cap_nhan','report_cap_gui','report_status')->first();
        //return $capnhan;
        $capnhan = DB::table('qlhs_hosobaocao')
        ->where('report_name',$socongvan)
        ->select(
            DB::raw('MAX(report_cap_nhan) as report_cap_nhan'),
            DB::raw('MAX(report_cap_gui) as report_cap_gui'),
            DB::raw('MAX(report_type) as report_type'),
            DB::raw('MAX(report_status) as report_status')
            )->first();

        $levelUser = $capnhan != null ? $capnhan->report_cap_nhan : Auth::user()->level;
        $report_type = $capnhan != null ? $capnhan->report_type : null;
        $datas = null;

        if($capnhan->report_cap_gui == $levelUser){
            if ($levelUser == 4) {
                $check = false;
                $datas = DB::table('qlhs_hosobaocao_tien_duyet')
                    ->join('qlhs_profile', 'rpp_profile_id', 'profile_id')

                    ->join('qlhs_hosobaocao_trangthai_duyet', 'rppss_profile_id', 'rpp_profile_id')
                    ->join('qlhs_nationals', 'qlhs_nationals.nationals_id', 'profile_nationals_id')
                    ->join('qlhs_schools', 'schools_id', 'profile_school_id')
                    ->join('qlhs_class', 'class_id',  'profile_class_id')
                    ->where('rpp_report_name', $socongvan)
                    ->where('rppss_report_name', $socongvan)
                    ->select('rppss_status as rp_status','rpp_status_MGHP', 'rpp_status_CPHT', 'rpp_status_HTAT', 'rpp_status_HTBT', 'rpp_status_HSKT', 'rpp_status_HSDTTS', 'rpp_status_HTATHS', 'rpp_status_HBHSDTNT', 'qlhs_profile.profile_id', 'profile_name', 'nationals_name', 'profile_birthday', 'schools_name', 'class_name', 'rppss_Status_MGHP as STATUS_MGHP', 'rppss_Status_CPHT as STATUS_CPHT', 'rppss_Status_HTAT as STATUS_HTAT', 'rppss_Status_HTBT_TA as STATUS_HTBT_TA', 'rppss_Status_HTBT_TO as STATUS_HTBT_TO', 'rppss_Status_HTBT_VHTT as STATUS_HTBT_VHTT', 'rppss_Status_HSKT_HB as STATUS_HSKT_HB', 'rppss_Status_HSKT_DDHT as STATUS_HSKT_DDHT', 'rppss_Status_HSDTTS as STATUS_HSDTTS', 'rppss_Status_HTATHS as STATUS_HTATHS', 'rppss_Status_HBHSDTNT as STATUS_HBHSDTNT', 
                        DB::raw('CASE when rpp_MGHP_NhuCau is not null then (rpp_MGHP_NhuCau ) else 0 end MGHP'),
                        DB::raw('CASE when rpp_CPHT_NhuCau is not null then (rpp_CPHT_NhuCau ) else 0 end CPHT'),
                        DB::raw('CASE when rpp_HTAT_NhuCau is not null then (rpp_HTAT_NhuCau ) else 0 end HTAT'),
                        DB::raw('CASE when rpp_HTBT_NhuCau_TA is not null then (rpp_HTBT_NhuCau_TA ) else 0 end HTBT_TA'),
                        DB::raw('CASE when rpp_HTBT_NhuCau_TO is not null then (rpp_HTBT_NhuCau_TO ) else 0 end HTBT_TO'),
                        DB::raw('CASE when rpp_HTBT_NhuCau_VHTT is not null then (rpp_HTBT_NhuCau_VHTT) else 0 end HTBT_VHTT'),
                        DB::raw('CASE when rpp_HSKT_NhuCau_HB is not null then (rpp_HSKT_NhuCau_HB) else 0 end HSKT_HB'),
                        DB::raw('CASE when rpp_HSKT_NhuCau_DDHT is not null then (rpp_HSKT_NhuCau_DDHT) else 0 end HSKT_DDHT'),
                        DB::raw('CASE when rpp_HSDTTS_NhuCau is not null then (rpp_HSDTTS_NhuCau) else 0 end HSDTTS'),
                        DB::raw('CASE when rpp_HTATHS_NhuCau is not null then (rpp_HTATHS_NhuCau ) else 0 end HTATHS'),
                        DB::raw('CASE when rpp_HBHSDTNT_NhuCau is not null  then (rpp_HBHSDTNT_NhuCau) else 0 end HBHSDTNT'),
                    DB::raw('(rpp_MGHP_NhuCau+rpp_CPHT_NhuCau+rpp_HTAT_NhuCau+rpp_HTBT_NhuCau_TA+rpp_HTBT_NhuCau_TO+rpp_HTBT_NhuCau_VHTT+rpp_HTATHS_NhuCau+rpp_HSKT_NhuCau_HB+rpp_HSKT_NhuCau_DDHT+rpp_HBHSDTNT_NhuCau+rpp_HSDTTS_NhuCau) as TONG'));
            }
        }else{
            $check = true;
            if ($loaicongvan == 1 || $loaicongvan == 3) {

                if ($levelUser == 2) {
                    if($report_type && $report_type == 'NGNA'){
                        $datas = DB::table('qlhs_hosobaocao_ngna_PGD');
                    }else{
                        $datas = DB::table('qlhs_baocaokinhphi_PGD');    
                    }
                    
                }else if ($levelUser == 3) {
                    if($report_type && $report_type == 'NGNA'){
                        $datas = DB::table('qlhs_hosobaocao_ngna_PTC');
                    }else{
                        $datas = DB::table('qlhs_baocaokinhphi_PTC');   
                    }
                    
                }else if ($levelUser == 4) {
                    if($report_type && $report_type == 'NGNA'){
                        $datas = DB::table('qlhs_hosobaocao_ngna_STC');
                    }else{
                        $datas = DB::table('qlhs_baocaokinhphi_SGD');  
                    }
                    
                }
                if($report_type && $report_type == 'NGNA'){
                    $datas = $datas->where('report_name', $socongvan)
                                   ->where('hsbc_school_id', $schools_id);
                    $json['LEVELVIEW'] = $levelUser;
                    $json['LEVELUSER'] = Auth::user()->level;
                    $json['LEVELSEND'] = $check;
                    $json['TYPE'] = $capnhan != null ? $capnhan->report_status : 0;
                    $json['totalRows'] = $datas->get()->count();
                    $json['startRecord'] = ($start);
                    $json['numRows'] = $limit;
                    $json['NGNA'] = 1;
                    $json['data'] = $datas->skip($start*$limit)->take($limit)->get();
                    return $json;
                }else{
                    $datas = $datas->join('qlhs_profile', 'bckp_profile_id', 'profile_id')
                    ->leftJoin('qlhs_profile_history',function($q){
                        $q->on('bckp_profile_id', 'history_profile_id')
                        ->where(DB::raw('SUBSTRING(history_year,1, 4)'),DB::raw('SUBSTRING(bckp_namhoc,1, 4)'));                        
                    })
                    ->join('qlhs_nationals', 'qlhs_nationals.nationals_id', 'profile_nationals_id')
                    ->join('qlhs_schools', 'schools_id','profile_school_id')
                    ->join('qlhs_class', 'class_id',  'history_class_id')
                    ->where('bckp_name', $socongvan)
                    
                    ->where(function($q) {
                        $q->orWhere('bckp_nhucau_mghp','>',0)
                        ->orWhere('bckp_nhucau_cpht','>',0)
                        ->orWhere('bckp_nhucau_htat','>',0)
                        ->orWhere('bckp_nhucau_htbt_ta','>',0)
                        ->orWhere('bckp_nhucau_htbt_to','>',0)
                        ->orWhere('bckp_nhucau_htbt_vhtt','>',0)
                        ->orWhere('bckp_nhucau_htkt_hb','>',0)
                        ->orWhere('bckp_nhucau_htkt_ddht','>',0)
                        ->orWhere('bckp_nhucau_hsdtts','>',0)
                        ->orWhere('bckp_nhucau_htaths','>',0)
                        ->orWhere('bckp_nhucau_hbhsdtnt','>',0);
                    })
                    ->select(
                        'bckp_trangthai as rp_status',
                        'bckp_trangthai_mghp as rpp_status_MGHP', 
                        'bckp_trangthai_cpht as rpp_status_CPHT', 
                        'bckp_trangthai_htat as rpp_status_HTAT', 
                        'bckp_trangthai_htbt as rpp_status_HTBT', 
                        'bckp_trangthai_htkt as rpp_status_HSKT', 
                        'bckp_trangthai_hsdtts as rpp_status_HSDTTS', 
                        'bckp_trangthai_htaths as rpp_status_HTATHS', 
                        'bckp_trangthai_hbhsdtnt as rpp_status_HBHSDTNT', 
                        'qlhs_profile.profile_id', 
                        'profile_name', 
                        'nationals_name', 
                        'profile_birthday', 
                        'schools_name', 
                        'class_name', 
                        'bckp_trangthai_mghp as STATUS_MGHP', 
                        'bckp_trangthai_cpht as STATUS_CPHT', 
                        'bckp_trangthai_htat as STATUS_HTAT', 
                        'bckp_trangthai_htbt as STATUS_HTBT_TA', 
                        'bckp_trangthai_htbt as STATUS_HTBT_TO', 
                        'bckp_trangthai_htbt as STATUS_HTBT_VHTT',
                        'bckp_trangthai_htkt as STATUS_HSKT_HB', 
                        'bckp_trangthai_htkt as STATUS_HSKT_DDHT', 
                        'bckp_trangthai_hsdtts as STATUS_HSDTTS', 
                        'bckp_trangthai_htaths as STATUS_HTATHS', 
                        'bckp_trangthai_hbhsdtnt as STATUS_HBHSDTNT', 

                        'bckp_active_mghp as ACTIVE_MGHP',
                        'bckp_active_cpht as ACTIVE_CPHT',
                        'bckp_active_htat as ACTIVE_HTAT',
                        'bckp_active_htbt_to as ACTIVE_HTBT_TO',
                        'bckp_active_htbt_ta as ACTIVE_HTBT_TA',
                        'bckp_active_htbt_vhtt as ACTIVE_HTBT_VHTT',
                        'bckp_active_htkt_hb as ACTIVE_HTKT_HB',
                        'bckp_active_htkt_ddht as ACTIVE_HTKT_DDHT',
                        'bckp_active_hsdtts as ACTIVE_HSDTTS',
                        'bckp_active_htaths as ACTIVE_HTATHS',
                        'bckp_active_hbhsdtnt as ACTIVE_HBHSDTNT',

                        'bckp_trangthai_mghp as STATUS_MGHP_2', 
                        'bckp_trangthai_cpht as STATUS_CPHT_2', 
                        'bckp_trangthai_htat as STATUS_HTAT_2', 
                        'bckp_trangthai_htbt as STATUS_HTBT_TA_2', 
                        'bckp_trangthai_htbt as STATUS_HTBT_TO_2', 
                        'bckp_trangthai_htbt as STATUS_HTBT_VHTT_2',
                        'bckp_trangthai_htkt as STATUS_HSKT_HB_2', 
                        'bckp_trangthai_htkt as STATUS_HSKT_DDHT_2', 
                        'bckp_trangthai_hsdtts as STATUS_HSDTTS_2', 
                        'bckp_trangthai_htaths as STATUS_HTATHS_2', 
                        'bckp_trangthai_hbhsdtnt as STATUS_HBHSDTNT_2',
                        'bckp_nhucau_mghp as MGHP',
                        'bckp_nhucau_cpht as CPHT',
                        'bckp_nhucau_htat as HTAT',
                        'bckp_nhucau_htbt_to as HTBT_TO',
                        'bckp_nhucau_htbt_ta as HTBT_TA',
                        'bckp_nhucau_htbt_vhtt as HTBT_VHTT',
                        'bckp_nhucau_htkt_hb as HSKT_HB',
                        'bckp_nhucau_htkt_ddht as HSKT_DDHT',
                        'bckp_nhucau_hsdtts as HSDTTS',
                        'bckp_nhucau_htaths as HTATHS',
                        'bckp_nhucau_hbhsdtnt as HBHSDTNT',
                        'bckp_nhucau_tong as TONG');
                }
                
            }else if($loaicongvan == 2){
                if ($levelUser == 1 && $capnhan->report_cap_gui == 2) {
                    $datas = DB::table('qlhs_tralaikinhphi_PGD');
                }else if($levelUser == 2){
                    $datas = DB::table('qlhs_tralaikinhphi_PTC');
                }else if($levelUser == 3){
                    $datas = DB::table('qlhs_tralaikinhphi_SGD');
                }else if($levelUser == 1 && $capnhan->report_cap_gui == 3){
                    $datas = DB::table('qlhs_tralaikinhphi_PTC');
                }   
                $datas = $datas->join('qlhs_profile', 'bckp_profile_id', 'profile_id')
                    ->leftJoin('qlhs_profile_history',function($q){
                        $q->on('bckp_profile_id', 'history_profile_id')
                        ->where(DB::raw('SUBSTRING(history_year,1, 4)'),DB::raw('SUBSTRING(bckp_namhoc,1, 4)'));                        
                    })
                    ->join('qlhs_nationals', 'qlhs_nationals.nationals_id', 'profile_nationals_id')
                    ->join('qlhs_schools', 'schools_id','profile_school_id')
                    ->join('qlhs_class', 'class_id',  'history_class_id')
                    ->where('bckp_name', $socongvan)
                    ->where(function($q) {
                        $q->orWhere('bckp_nhucau_mghp','>',0)
                        ->orWhere('bckp_nhucau_cpht','>',0)
                        ->orWhere('bckp_nhucau_htat','>',0)
                        ->orWhere('bckp_nhucau_htbt_ta','>',0)
                        ->orWhere('bckp_nhucau_htbt_to','>',0)
                        ->orWhere('bckp_nhucau_htbt_vhtt','>',0)
                        ->orWhere('bckp_nhucau_htkt_hb','>',0)
                        ->orWhere('bckp_nhucau_htkt_ddht','>',0)
                        ->orWhere('bckp_nhucau_hsdtts','>',0)
                        ->orWhere('bckp_nhucau_htaths','>',0)
                        ->orWhere('bckp_nhucau_hbhsdtnt','>',0);
                    })
                    ->select(
                        'bckp_trangthai as rp_status',
                        'bckp_trangthai_mghp as rpp_status_MGHP', 
                        'bckp_trangthai_cpht as rpp_status_CPHT', 
                        'bckp_trangthai_htat as rpp_status_HTAT', 
                        'bckp_trangthai_htbt as rpp_status_HTBT', 
                        'bckp_trangthai_htkt as rpp_status_HSKT', 
                        'bckp_trangthai_hsdtts as rpp_status_HSDTTS', 
                        'bckp_trangthai_htaths as rpp_status_HTATHS', 
                        'bckp_trangthai_hbhsdtnt as rpp_status_HBHSDTNT', 
                        'qlhs_profile.profile_id', 
                        'profile_name', 
                        'nationals_name', 
                        'profile_birthday', 
                        'schools_name', 
                        'class_name', 
                        'bckp_trangthai_mghp as STATUS_MGHP', 
                        'bckp_trangthai_cpht as STATUS_CPHT', 
                        'bckp_trangthai_htat as STATUS_HTAT', 
                        'bckp_trangthai_htbt as STATUS_HTBT_TA', 
                        'bckp_trangthai_htbt as STATUS_HTBT_TO', 
                        'bckp_trangthai_htbt as STATUS_HTBT_VHTT',
                        'bckp_trangthai_htkt as STATUS_HSKT_HB', 
                        'bckp_trangthai_htkt as STATUS_HSKT_DDHT', 
                        'bckp_trangthai_hsdtts as STATUS_HSDTTS', 
                        'bckp_trangthai_htaths as STATUS_HTATHS', 
                        'bckp_trangthai_hbhsdtnt as STATUS_HBHSDTNT', 


                        'bckp_trangthai_mghp as STATUS_MGHP_2', 
                        'bckp_trangthai_cpht as STATUS_CPHT_2', 
                        'bckp_trangthai_htat as STATUS_HTAT_2', 
                        'bckp_trangthai_htbt as STATUS_HTBT_TA_2', 
                        'bckp_trangthai_htbt as STATUS_HTBT_TO_2', 
                        'bckp_trangthai_htbt as STATUS_HTBT_VHTT_2',
                        'bckp_trangthai_htkt as STATUS_HSKT_HB_2', 
                        'bckp_trangthai_htkt as STATUS_HSKT_DDHT_2', 
                        'bckp_trangthai_hsdtts as STATUS_HSDTTS_2', 
                        'bckp_trangthai_htaths as STATUS_HTATHS_2', 
                        'bckp_trangthai_hbhsdtnt as STATUS_HBHSDTNT_2',
                        'bckp_nhucau_mghp as MGHP',
                        'bckp_nhucau_cpht as CPHT',
                        'bckp_nhucau_htat as HTAT',
                        'bckp_nhucau_htbt_to as HTBT_TO',
                        'bckp_nhucau_htbt_ta as HTBT_TA',
                        'bckp_nhucau_htbt_vhtt as HTBT_VHTT',
                        'bckp_nhucau_htkt_hb as HSKT_HB',
                        'bckp_nhucau_htkt_ddht as HSKT_DDHT',
                        'bckp_nhucau_hsdtts as HSDTTS',
                        'bckp_nhucau_htaths as HTATHS',
                        'bckp_nhucau_hbhsdtnt as HBHSDTNT',
                        'bckp_nhucau_tong as TONG');             
            }
            
        }
        if($schools_id != null && $schools_id != ""){
             $datas = $datas->where('profile_school_id',$schools_id);
        }else{
            if(Auth::user()->truong_id !=null && Auth::user()->truong_id != 0 && Auth::user()->truong_id != '0'){
                $datas = $datas->whereIn('profile_school_id',explode('-',Auth::user()->truong_id));
            }
        }
        //return explode('-',Auth::user()->truong_id);///$datas->toSql();

        if (!is_null($datas) && !empty($datas)) {            
            if (!is_null($keySearch) && !empty($keySearch)) {
                $kw = bussinessClass::to_slug($keySearch);
                $datas->where(function($q) use($keySearch,$kw){
                    $q->orWhere('profile_name', 'LIKE', '%'.$keySearch.'%')
                    ->orWhere('profile_rewrite', 'LIKE', '%'.$kw.'%')
                    ->orWhere('class_name', 'LIKE', '%'.$keySearch.'%');
                });
            }
            $json['LEVELVIEW'] = $levelUser;
            $json['LEVELUSER'] = Auth::user()->level;
            $json['LEVELSEND'] = $check;
            $json['TYPE'] = $capnhan != null ? $capnhan->report_status : 0;
            $json['totalRows'] = $datas->get()->count();
            $json['startRecord'] = ($start);
            $json['numRows'] = $limit;
            $json['NGNA'] = 0;
            $or = 'asc';
            if($order == 1){
                $or = 'desc';
            }
            if($type == 1){
                $datas = $datas->orderBy('bckp_nhucau_mghp',$or);
            }else if($type == 2){
                $datas = $datas->orderBy('bckp_nhucau_cpht',$or);
            }else if($type == 3){
                $datas = $datas->orderBy('bckp_nhucau_htat',$or);
            }else if($type == 4){
                $datas = $datas->orderBy('bckp_nhucau_htbt_ta',$or);
            }else if($type == 5){
                $datas = $datas->orderBy('bckp_nhucau_htbt_to',$or);
            }else if($type == 6){
                $datas = $datas->orderBy('bckp_nhucau_htbt_vhtt',$or);
            }else if($type == 7){
                $datas = $datas->orderBy('bckp_nhucau_htaths',$or);
            }else if($type == 8){
                $datas = $datas->orderBy('bckp_nhucau_htkt_hb',$or);
            }else if($type == 9){
                $datas = $datas->orderBy('bckp_nhucau_htkt_ddht',$or);
            }else if($type == 10){
                $datas = $datas->orderBy('bckp_nhucau_hbhsdtnt',$or);
            }else if($type == 11){
                $datas = $datas->orderBy('bckp_nhucau_hsdtts',$or);
            }else if($type == 12){
                $datas = $datas->orderBy(DB::raw('bckp_nhucau_mghp+bckp_nhucau_cpht+bckp_nhucau_htat+bckp_nhucau_htbt_ta+bckp_nhucau_htbt_to+bckp_nhucau_htbt_vhtt+bckp_nhucau_htaths+bckp_nhucau_htkt_hb+bckp_nhucau_htkt_ddht+bckp_nhucau_hbhsdtnt+bckp_nhucau_hsdtts'),$or);
            }else if($type == 13){
                $datas = $datas->orderBy('class_name',$or);
            }else if($type == 14){
                $datas = $datas->orderBy('profile_name',$or);
            }
            $json['data'] = $datas->orderBy('qlhs_profile.profile_name')->skip($start*$limit)->take($limit)->get();
            
        }

        return $json;
    }

    public function approvedchedoTD($objJson){
        $result = [];
        try {

            $obj = json_decode($objJson);
            $profile_id = $obj->{'PROFILEID'};
            $schools_id = $obj->{'SCHOOLID'};
            $socongvan = $obj->{'SOCONGVAN'};
            $arrSubId = $obj->{'ARRSUBJECTID'};

            $note = $obj->{'NOTE'};

            $arrSubjectId = [];
            $arrSubjectId = explode('-', $arrSubId);

            $update = 0;

            $statusMGHP = 0;
            $statusCPHT = 0;
            $statusHTAT = 0;
            $statusHTBT = 0;
            $statusHTBT_TA = 0;
            $statusHTBT_TO = 0;
            $statusHTBT_VHTT = 0;
            $statusHSKT = 0;
            $statusHSKT_HB = 0;
            $statusHSKT_DDHT = 0;
            $statusHSDTTS = 0;
            $statusHTATHS = 0;
            $statusHBHSDTNT = 0;

            $trangthai_PD = 0;

            if ($profile_id > 0 && !empty($socongvan)) {
                
                foreach ($arrSubjectId as $value) {
                    // return $value;
                    //MGHP
                    if ($value == 89 || $value == 90 || $value == 91) {

                        $statusMGHP = 1;
                    }

                    //CPHT
                    if ($value == 92) {

                        $statusCPHT = 1;
                    }

                    //HTAT
                    if ($value == 93) {

                        $statusHTAT = 1;
                    }

                    //HTBT
                    if ($value == 94) {
                        $statusHTBT = 1;
                        $statusHTBT_TA = 1;
                    }

                    if ($value == 98) {
                        $statusHTBT = 1;
                        $statusHTBT_TO = 1;
                    }

                    if ($value == 115) {
                        $statusHTBT = 1;
                        $statusHTBT_VHTT = 1;
                    }

                    //HSKT
                    if ($value == 95) {
                        $statusHSKT = 1;
                        $statusHSKT_HB = 1;
                    }

                    if ($value == 100) {
                        $statusHSKT = 1;
                        $statusHSKT_DDHT = 1;
                    }

                    //HSDTTS
                    if ($value == 99) {

                        $statusHSDTTS = 1;
                    }

                    //HTATHS
                    if ($value == 118) {

                        $statusHTATHS = 1;
                    }

                    //HBHSDTNT
                    if ($value == 119) {

                        $statusHBHSDTNT = 1;
                    }
                }

                if ($statusMGHP == 0 && $statusCPHT == 0 && $statusHTAT == 0 && $statusHTBT_TA == 0 &&  $statusHTBT_TO == 0 &&  $statusHTBT_VHTT == 0 && $statusHSKT_HB == 0 && $statusHSKT_DDHT == 0 && $statusHSDTTS == 0 && $statusHTATHS == 0 && $statusHBHSDTNT == 0) {
                    
                    $result['success'] = 'Hủy thẩm định thành công';
                }
                else {
                    $trangthai_PD = 1;
                    
                    $result['success'] = 'Thẩm định thành công';
                }

                $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

                $getRevert = DB::table('qlhs_danhsachphongtralai')->where('Profile_id', '=', $profile_id)->where('Report_name', '=', $socongvan)->where('School_id', '=', $schools_id)->where('Status', '=', 3)->get();

                if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                    foreach ($getType as $valueType) {
                        if ($valueType->report == "MGHP") {
                            $update = DB::table('qlhs_miengiamhocphi')->where('type_code', '=', $valueType->report_type)->where('id_profile', '=', $profile_id)->update(['trangthai_thamdinh_MGHP' => $statusMGHP]);
                        }
                        if ($valueType->report == "CPHT") {
                            $update = DB::table('qlhs_chiphihoctap')->where('type_code', '=', $valueType->report_type)->where('cpht_profile_id', '=', $profile_id)->update(['trangthai_thamdinh_CPHT' => $statusCPHT]);
                        }
                        if ($valueType->report == "HTAT") {
                            $update = DB::table('qlhs_hotrotienan')->where('type_code', '=', $valueType->report_type)->where('htta_profile_id', '=', $profile_id)->update(['trangthai_thamdinh_HTAT' => $statusHTAT]);
                        }
                        if ($valueType->report == "HTBT") {
                            $update = DB::table('qlhs_hotrohocsinhbantru')->where('type_code', '=', $valueType->report_type)->where('profile_id', '=', $profile_id)->update(['trangthai_thamdinh_HTBT' => $statusHTBT]);
                        }
                        if ($valueType->report == "HSKT") {
                            $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('type_code', '=', $valueType->report_type)->where('profile_id', '=', $profile_id)->update(['trangthai_thamdinh_HSKT' => $statusHSKT]);
                        }
                        if ($valueType->report == "HSDTTS") {
                            $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', '=', $valueType->report_type)->where('profile_id', '=', $profile_id)->update(['trangthai_thamdinh_HSDTTS' => $statusHSDTTS]);
                        }
                        if ($valueType->report == "HTATHS") {
                            $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', '=', $valueType->report_type)->where('profile_id', '=', $profile_id)->update(['trangthai_thamdinh_HSDTTS' => $statusHTATHS]);
                        }
                        if ($valueType->report == "HBHSDTNT") {
                            $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', '=', $valueType->report_type)->where('profile_id', '=', $profile_id)->update(['trangthai_thamdinh_HSDTTS' => $statusHBHSDTNT]);
                        }
                    }
                }


                if ((is_null($getRevert) || empty($getRevert) || count($getRevert) <= 0) && (is_null($arrSubId) || empty($arrSubId))) {
                    $insert = DB::table('qlhs_danhsachphongtralai')->insert([
                        'Profile_id' => $profile_id,
                        'Status' => 3,
                        'Note' => $note,
                        'Report_name' => $socongvan,
                        'School_id' => $schools_id
                        ]);
                }
                else if ((!is_null($getRevert) || !empty($getRevert) || count($getRevert) > 0) && (is_null($arrSubId) || empty($arrSubId))) {
                    $update = DB::table('qlhs_danhsachphongtralai')
                    ->where('Profile_id', '=', $profile_id)->where('Report_name', '=', $socongvan)->where('School_id', '=', $schools_id)->where('Status', '=', 3)
                    ->update([
                        'Status' => 3,
                        'Note' => $note
                        ]);
                }

                if (!is_null($arrSubId) && !empty($arrSubId)) {
                    $delete = DB::table('qlhs_danhsachphongtralai')
                    ->where('Profile_id', '=', $profile_id)->where('Report_name', '=', $socongvan)->where('School_id', '=', $schools_id)->where('Status', '=', 3)
                    ->delete();
                }
            }

            return $result;
        } catch (Exception $e) {
            return $result['error'] = $e;
        }
    }

    
    public function loadListUnApprovedThamDinh(Request $request)
    {
        try {
            $json = [];
            $start = $request->input('start');
            $limit = $request->input('limit');

            $schools_id = $request->input('SCHOOLID');
           // $year = $request->input('YEAR');
            $socongvan = $request->input('SOCONGVAN');
            $keySearch = $request->input('KEY');

            // $arrYear = [];
            // $arrYear = explode("-", $year);
            // $schoolId = 37;//$request->input('SCHOOLID');
         //    $year = 2016;//$request->input('YEAR');
         //    $profileId = 834;

            // $user = Auth::user()->id;

            $datas = DB::table('qlhs_profile')
                ->join('qlhs_danhsachphongtralai', 'qlhs_danhsachphongtralai.Profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_danhsachphongtralai.Status = 3 AND qlhs_danhsachphongtralai.Report_name = "'.$socongvan.'" AND qlhs_danhsachphongtralai.School_id = '.$schools_id))
                ->join('qlhs_nationals', 'nationals_id', '=', 'profile_nationals_id')
                ->leftJoin('qlhs_miengiamhocphi', 'id_profile', '=', DB::raw('qlhs_profile.profile_id AND qlhs_miengiamhocphi.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "MGHP" and report_name = "'.$socongvan.'")'))
                ->leftJoin('qlhs_chiphihoctap', 'cpht_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_chiphihoctap.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "CPHT" and report_name = "'.$socongvan.'")'))
                ->leftJoin('qlhs_hotrotienan', 'htta_profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrotienan.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTAT" and report_name = "'.$socongvan.'")'))
                ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhbantru.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTBT" and report_name = "'.$socongvan.'")'))
                ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.profile_id', '=', DB::raw('qlhs_profile.profile_id AND qlhs_hotrohocsinhkhuyettat.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSKT" and report_name = "'.$socongvan.'")'))
                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hsdtts', 'hsdtts.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hsdtts.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HSDTTS" and report_name = "'.$socongvan.'")'))
                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS htaths', 'htaths.profile_id', '=', DB::raw('qlhs_profile.profile_id AND htaths.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HTATHS" and report_name = "'.$socongvan.'")'))
                ->leftJoin('qlhs_hotrohocsinhdantocthieuso AS hbhsdtnt', 'hbhsdtnt.profile_id', '=', DB::raw('qlhs_profile.profile_id AND hbhsdtnt.type_code = (SELECT report_type FROM qlhs_hosobaocao WHERE report = "HBHSDTNT" and report_name = "'.$socongvan.'")'))
                ->leftJoin('qlhs_schools', 'schools_id', '=', 'profile_school_id')
                ->leftJoin('qlhs_class', 'class_id', '=', 'profile_class_id')
                ->where('profile_school_id', '=', DB::raw($schools_id.' AND (hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 OR htaths.trangthai_pheduyet_HSDTTS = 1 OR hsdtts.trangthai_pheduyet_HSDTTS = 1 OR trangthai_pheduyet_HSKT = 1 OR trangthai_pheduyet_HTBT = 1 OR trangthai_pheduyet_HTAT = 1 OR trangthai_pheduyet_CPHT = 1 OR trangthai_pheduyet_MGHP = 1)'))
                ->select('qlhs_profile.profile_id', 'profile_birthday', 'schools_name', 'profile_name', 'class_name', 'qlhs_danhsachphongtralai.Note', 
                    DB::raw('CASE 
                        when qlhs_miengiamhocphi.nhu_cau is not null or qlhs_miengiamhocphi.du_toan is not null 
                        then (qlhs_miengiamhocphi.nhu_cau + qlhs_miengiamhocphi.du_toan) else 0 end MGHP'),
                    DB::raw('CASE 
                        when qlhs_chiphihoctap.nhu_cau is not null or qlhs_chiphihoctap.du_toan is not null 
                        then (qlhs_chiphihoctap.nhu_cau + qlhs_chiphihoctap.du_toan) else 0 end CPHT'),
                    DB::raw('CASE 
                        when qlhs_hotrotienan.nhu_cau is not null or qlhs_hotrotienan.du_toan is not null 
                        then (qlhs_hotrotienan.nhu_cau + qlhs_hotrotienan.du_toan) else 0 end HTAT'),
                    DB::raw('CASE 
                        when qlhs_hotrohocsinhbantru.nhucau_hotrotienan is not null or qlhs_hotrohocsinhbantru.dutoan_hotrotienan is not null 
                        then (qlhs_hotrohocsinhbantru.nhucau_hotrotienan + qlhs_hotrohocsinhbantru.dutoan_hotrotienan) else 0 end HTBT_TA'),
                    DB::raw('CASE 
                        when qlhs_hotrohocsinhbantru.nhucau_hotrotieno is not null or qlhs_hotrohocsinhbantru.dutoan_hotrotieno is not null 
                        then (qlhs_hotrohocsinhbantru.nhucau_hotrotieno + qlhs_hotrohocsinhbantru.dutoan_hotrotieno) else 0 end HTBT_TO'),
                    DB::raw('CASE 
                        when qlhs_hotrohocsinhbantru.nhucau_VHTT is not null or qlhs_hotrohocsinhbantru.dutoan_VHTT is not null 
                        then (qlhs_hotrohocsinhbantru.nhucau_VHTT + qlhs_hotrohocsinhbantru.dutoan_VHTT) else 0 end HTBT_VHTT'),
                    DB::raw('CASE 
                        when qlhs_hotrohocsinhkhuyettat.nhucau_hocbong is not null or qlhs_hotrohocsinhkhuyettat.dutoan_hocbong is not null 
                        then (qlhs_hotrohocsinhkhuyettat.nhucau_hocbong + qlhs_hotrohocsinhkhuyettat.dutoan_hocbong) else 0 end HSKT_HB'),
                    DB::raw('CASE 
                        when qlhs_hotrohocsinhkhuyettat.nhucau_muadodung is not null or qlhs_hotrohocsinhkhuyettat.dutoan_muadodung is not null 
                        then (qlhs_hotrohocsinhkhuyettat.nhucau_muadodung + qlhs_hotrohocsinhkhuyettat.dutoan_muadodung) else 0 end HSKT_DDHT'),
                    DB::raw('CASE 
                        when hsdtts.nhucau is not null or hsdtts.dutoan is not null 
                        then (hsdtts.nhucau + hsdtts.dutoan) else 0 end HSDTTS'),
                    DB::raw('CASE 
                        when htaths.nhucau is not null or htaths.dutoan is not null 
                        then (htaths.nhucau + htaths.dutoan) else 0 end HTATHS'),
                    DB::raw('CASE 
                        when hbhsdtnt.nhucau is not null or hbhsdtnt.dutoan is not null 
                        then (hbhsdtnt.nhucau + hbhsdtnt.dutoan) else 0 end HBHSDTNT'),
                    // DB::raw('(qlhs_miengiamhocphi.nhu_cau + qlhs_miengiamhocphi.du_toan + qlhs_chiphihoctap.nhu_cau + qlhs_chiphihoctap.du_toan + qlhs_hotrotienan.nhu_cau + qlhs_hotrotienan.du_toan + qlhs_hotrohocsinhbantru.tong_nhucau + qlhs_hotrohocsinhbantru.tong_dutoan + qlhs_hotrohocsinhkhuyettat.tong_nhucau + qlhs_hotrohocsinhkhuyettat.tong_dutoan + hsdtts.nhucau + hsdtts.dutoan + htaths.nhucau + htaths.dutoan + hbhsdtnt.nhucau + hbhsdtnt.dutoan) as TONGTIEN'),
                    DB::raw('(CASE when trangthai_pheduyet_MGHP = 1 or trangthai_pheduyet_CPHT = 1 or trangthai_pheduyet_HTAT = 1 or trangthai_pheduyet_HTBT = 1 or trangthai_pheduyet_HSKT = 1 or hsdtts.trangthai_pheduyet_HSDTTS = 1 or htaths.trangthai_pheduyet_HSDTTS = 1 or hbhsdtnt.trangthai_pheduyet_HSDTTS = 1 then 1 else 0 END) as TRANGTHAIPHEDUYET'),
                    DB::raw('(CASE when trangthai_thamdinh_MGHP = 1 or trangthai_thamdinh_CPHT = 1 or trangthai_thamdinh_HTAT = 1 or trangthai_thamdinh_HTBT = 1 or trangthai_thamdinh_HSKT = 1 or hsdtts.trangthai_thamdinh_HSDTTS = 1 or htaths.trangthai_thamdinh_HSDTTS = 1 or hbhsdtnt.trangthai_thamdinh_HSDTTS = 1 then 1 else 0 END) as TRANGTHAITHAMDINH'));

            
            if (!is_null($keySearch) && !empty($keySearch)) {
                $datas->where('profile_name', 'LIKE', '%'.$keySearch.'%')
                        ->orWhere('class_name', 'LIKE', '%'.$keySearch.'%');
            }

            $json['totalRows'] = $datas->get()->count();
            
            $json['startRecord'] = ($start);
            $json['numRows'] = $limit;
                
            $json['data'] = $datas->orderBy('qlhs_profile.updated_at','desc')->skip($start*$limit)->take($limit)->get();

            return $json;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function approvedAllThamDinh(Request $request){
        try {
            $result = [];

            $schools_id = $request->input('SCHOOLID');
            $socongvan = $request->input('SOCONGVAN');

            $update = 0;

            $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

            if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                foreach ($getType as $valueType) {
                    if ($valueType->report == "MGHP") {
                        $update = DB::table('qlhs_miengiamhocphi')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_MGHP' => 1]);
                    }
                    if ($valueType->report == "CPHT") {
                        $update = DB::table('qlhs_chiphihoctap')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_CPHT' => 1]);
                    }
                    if ($valueType->report == "HTAT") {
                        $update = DB::table('qlhs_hotrotienan')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HTAT' => 1]);
                    }
                    if ($valueType->report == "HTBT") {
                        $update = DB::table('qlhs_hotrohocsinhbantru')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HTBT' => 1]);
                    }
                    if ($valueType->report == "HSKT") {
                        $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HSKT' => 1]);
                    }
                    if ($valueType->report == "HSDTTS") {
                        $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HSDTTS' => 1]);
                    }
                    if ($valueType->report == "HTATHS") {
                        $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HSDTTS' => 1]);
                    }
                    if ($valueType->report == "HBHSDTNT") {
                        $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HSDTTS' => 1]);
                    }
                }
            }

            if ($update == 0) {
                $result['error'] = "Toàn bộ học sinh đã được thẩm định";
            }
            else {
                $result['success'] = "Thẩm định toàn bộ học sinh thành công";
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function unApprovedAllThamDinh(Request $request){
        try {
            $result = [];

            $schools_id = $request->input('SCHOOLID');
            $socongvan = $request->input('SOCONGVAN');

            $update = 0;

            $getType = DB::table('qlhs_hosobaocao')->where('report_name', '=', $socongvan)->where('report_id_truong', '=', $schools_id)->select('report_name', 'report_type', 'report')->get();

            if (!is_null($getType) && !empty($getType) && count($getType) > 0) {
                foreach ($getType as $valueType) {
                    if ($valueType->report == "MGHP") {
                        $update = DB::table('qlhs_miengiamhocphi')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_MGHP' => 0]);
                    }
                    if ($valueType->report == "CPHT") {
                        $update = DB::table('qlhs_chiphihoctap')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_CPHT' => 0]);
                    }
                    if ($valueType->report == "HTAT") {
                        $update = DB::table('qlhs_hotrotienan')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HTAT' => 0]);
                    }
                    if ($valueType->report == "HTBT") {
                        $update = DB::table('qlhs_hotrohocsinhbantru')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HTBT' => 0]);
                    }
                    if ($valueType->report == "HSKT") {
                        $update = DB::table('qlhs_hotrohocsinhkhuyettat')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HSKT' => 0]);
                    }
                    if ($valueType->report == "HSDTTS") {
                        $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HSDTTS' => 0]);
                    }
                    if ($valueType->report == "HTATHS") {
                        $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HSDTTS' => 0]);
                    }
                    if ($valueType->report == "HBHSDTNT") {
                        $update = DB::table('qlhs_hotrohocsinhdantocthieuso')->where('type_code', '=', $valueType->report_type)->update(['trangthai_thamdinh_HSDTTS' => 0]);
                    }
                }
            }

            if ($update == 0) {
                $result['error'] = "Toàn bộ học sinh đã được hủy thẩm định";
            }
            else {
                $result['success'] = "Hủy thẩm định toàn bộ học sinh thành công";
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function downloadfile_ExportHTATHS($id){
        $data = DB::table('qlhs_hosobaocao')->where('report','=','HTATHS')->where('report_id','=',$id)->select('report_type')->first(); 
        $dir = storage_path().'/exceldownload/HTATHS/'.$data->report_type.'.xlsx';
        return response()->download($dir, $data->report_type.'.xlsx');
    }

    public function downloadfile_ExportHBHSDTNT($id){
        $data = DB::table('qlhs_hosobaocao')->where('report','=','HBHSDTNT')->where('report_id','=',$id)->select('report_type')->first(); 
        $dir = storage_path().'/exceldownload/HBHSDTNT/'.$data->report_type.'.xlsx';
        return response()->download($dir, $data->report_type.'.xlsx');
    }

//---------------------------------------------------------Danh sách đề nghị đã lập-------------------------------------------------------------------
    public function loadDataReport(){
        try {
            $result = [];

            $currentuser_id = Auth::user()->id;
            $currentdate = Carbon::now();

            $arrID = [];
            $arrID = explode('-', Auth::user()->truong_id);

            if ($arrID[0] == 0 && count($arrID) > 0) {
                $result['SCHOOL'] = DB::table('qlhs_schools')
                     ->select('schools_id', 'schools_name')->get();

                $result['REPORT'] = DB::table('qlhs_hosobaocao')
                ->where('report_cap_gui', 1)
                ->select('report_name as report_name', 'report_id_truong')
                ->orderBy('report_date', 'desc')
                ->groupBy('report_name', 'report_id_truong')->get();
            }
            else {
                $result['SCHOOL'] = DB::table('qlhs_schools')
                ->whereIn('schools_id', $arrID)
                ->select('schools_id', 'schools_name')->get();

                $result['REPORT'] = DB::table('qlhs_hosobaocao')
                ->where('report_cap_gui', 1)
                ->whereIn('report_id_truong', $arrID)
                ->select('report_name as report_name', 'report_id_truong')
                ->orderBy('report_date', 'desc')
                ->groupBy('report_name', 'report_id_truong')->get();
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadDataReportBySchool($id){
        try {

            $user = Auth::user()->id;
            // $levelUser = 0;

            // $getLevelUser = DB::table('users')->where('id', $user)->select('level')->get();
            // if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
            //     $levelUser = $getLevelUser[0]->level;
            // }

            $getData = DB::table('qlhs_report')
                ->where('report_school_id', '=', $id)
                ->where('report_status', '=', 0)
                ->select('name as report_name')
                ->orderBy('report_startdate', 'desc')->get();

            // if ($levelUser == 1) {
            //     $getData = $getData->where('report_waiting', '>', 0)->orWhere('report_approved', '>', 0)->orWhere('report_reverted', '>', 0)->select('name as report_name', 'report_waiting', 'report_approved', 'report_reverted')->orderBy('report_startdate', 'desc')->get();
            // }
            // else if ($levelUser == 2) {
            //     $getData = $getData->where('report_waiting_phongGD', '>', 0)->orWhere('report_approved_phongGD', '>', 0)->orWhere('report_reverted_phongGD', '>', 0)->select('name as report_name', 'report_waiting_phongGD as report_waiting', 'report_approved_phongGD as report_approved', 'report_reverted_phongGD as report_reverted')->orderBy('report_startdate', 'desc')->get();
            // }
            // else if ($levelUser == 3) {
            //     $getData = $getData->where('report_waiting_phongTC', '>', 0)->orWhere('report_approved_phongTC', '>', 0)->orWhere('report_reverted_phongTC', '>', 0)->select('name as report_name', 'report_waiting_phongTC as report_waiting', 'report_approved_phongTC as report_approved', 'report_reverted_phongTC as report_reverted')->orderBy('report_startdate', 'desc')->get();
            // }
            // else if ($levelUser == 4) {
            //     $getData = $getData->where('report_waiting_So', '>', 0)->orWhere('report_approved_So', '>', 0)->orWhere('report_reverted_So', '>', 0)->select('name as report_name', 'report_waiting_So as report_waiting', 'report_approved_So as report_approved', 'report_reverted_So as report_reverted')->orderBy('report_startdate', 'desc')->get();
            // }

            return $getData;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadComboReportBySchoolStatus(Request $request){
        try {
            $schools_id = $request->input('SCHOOLID');
            $status = $request->input('STATUS');

            $user = Auth::user()->id;
            $levelUser = 0;

            $getLevelUser = DB::table('users')->where('id', $user)->select('level')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
            }

            $getData = DB::table('qlhs_hosobaocao')
                ->where('report_id_truong', $schools_id)
                ->where('report_cap_status', $status);

            // if ($levelUser == 1) {
            //     $getData = $getData->where('report_waiting', '>', 0)->orWhere('report_approved', '>', 0)->orWhere('report_reverted', '>', 0)->select('name as report_name', 'report_waiting', 'report_approved', 'report_reverted')->orderBy('report_startdate', 'desc')->get();
            // }
            // else 
            if ($levelUser == 2) {
                if ($status == 0 || $status == 3) {
                    $getData = $getData->where('report_cap_nhan', 2)
                        ->select('report_name_new as report_name', 'report_name_new as report_value')
                        ->orderBy('report_date', 'desc')->get();
                }
                else {
                    $getData = $getData->where('report_cap_gui', 2)
                        ->select('report_name_new as report_name', 'report_name_new as report_value')
                        ->orderBy('report_date', 'desc')->get();
                }
            }
            else if ($levelUser == 3) {
                if ($status == 0 || $status == 3) {
                    $getData = $getData->where('report_cap_nhan', 3)
                        ->select('report_name_new as report_name', 'report_name_new as report_value')
                        ->orderBy('report_date', 'desc')->get();
                }
                else {
                    $getData = $getData->where('report_cap_gui', 3)
                        ->select('report_name_new as report_name', 'report_name_new as report_value')
                        ->orderBy('report_date', 'desc')->get();
                }
            }
            else if ($levelUser == 4) {
                if ($status == 0 || $status == 3) {
                    $getData = $getData->where('report_cap_nhan', 4)
                        ->select('report_name_new as report_name', 'report_name_new as report_value')
                        ->orderBy('report_date', 'desc')->get();
                }
                else {
                    $getData = $getData->where('report_cap_gui', 4)
                        ->select('report_name_new as report_name', 'report_name_new as report_value')
                        ->orderBy('report_date', 'desc')->get();
                }
            }

            return $getData;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadDataUnReportBySchool($id){
        try {

            $getData = DB::table('qlhs_danhsachphongtralai')->where('School_id', '=', $id)->select('Report_name as report_name')->orderBy('updated_at', 'asc')->groupBy('Report_name','School_id')->get();

            return $getData;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadDataReportType($objData){
        try {

            $getData = DB::table('qlhs_hosobaocao')
            ->where('report_name',$objData)
            ->select('report')
            ->orderBy('report')
            ->get();

            return $getData;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadDatabyGroupA(Request $request){
        try {
            $result = [];

            $reportName = $request->input('REPORTNAME');
            $reportType = $request->input('REPORTTYPE');

            $start = $request->input('start');
            $limit = $request->input('limit');
            $keySearch = $request->input('KEY');
            $groupHS = $request->input('GROUP');

            $getReport = DB::table('qlhs_hosobaocao')
                ->where('report_name', '=', $reportName)
                ->where('report', '=', $reportType)
                ->select('report_type', 'report_year')->first();

            if (!is_null($getReport) && !empty($getReport) && $getReport->report_year > 0) {
                
                if ($reportType == "MGHP") {
                    $getData = DB::table('qlhs_miengiamhocphi')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_miengiamhocphi.id_profile')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "MGHP"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_miengiamhocphi.id_profile and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_miengiamhocphi.id_profile and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_site as thon', 'thon.site_id', '=', 'qlhs_profile.profile_household')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_miengiamhocphi.type_code', '=', $getReport->report_type);

                    if (!is_null($groupHS) && !empty($groupHS)) {
                        if ($groupHS == "GROUPA") {
                            $getData->where('qlhs_miengiamhocphi.type', '=', 1);
                        }
                        if ($groupHS == "GROUPB") {
                            $getData->where('qlhs_miengiamhocphi.type', '=', 2);
                        }
                        if ($groupHS == "GROUPC") {
                            $getData->where('qlhs_miengiamhocphi.type', '=', 3);
                        }
                    }

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("thon.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'thon.site_name as profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_miengiamhocphi.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "CPHT") {
                    $getData = DB::table('qlhs_chiphihoctap')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_chiphihoctap.cpht_profile_id')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "CPHT"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_chiphihoctap.cpht_profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_chiphihoctap.cpht_profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_site as thon', 'thon.site_id', '=', 'qlhs_profile.profile_household')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_chiphihoctap.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("thon.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }
                    
                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'thon.site_name as profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_chiphihoctap.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HTAT") {
                    $getData = DB::table('qlhs_hotrotienan')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrotienan.htta_profile_id')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HTAT"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_hotrotienan.htta_profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_hotrotienan.htta_profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_site as thon', 'thon.site_id', '=', 'qlhs_profile.profile_household')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrotienan.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("thon.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'thon.site_name as profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrotienan.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HTBT") {
                    $getData = DB::table('qlhs_hotrohocsinhbantru')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhbantru.profile_id')
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhbantru.profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhbantru.profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_site as thon', 'thon.site_id', '=', 'qlhs_profile.profile_household')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrohocsinhbantru.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("thon.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'thon.site_name as profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_km', 'qlhs_profile.profile_giaothong', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrohocsinhbantru.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HSKT") {
                    $getData = DB::table('qlhs_hotrohocsinhkhuyettat')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhkhuyettat.profile_id')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HSKT"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhkhuyettat.profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhkhuyettat.profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_site as thon', 'thon.site_id', '=', 'qlhs_profile.profile_household')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrohocsinhkhuyettat.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("thon.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'thon.site_name as profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrohocsinhkhuyettat.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HTATHS" || $reportType == "HSDTTS" || $reportType == "HBHSDTNT") {
                    
                    $getData = DB::table('qlhs_hotrohocsinhdantocthieuso')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_site as thon', 'thon.site_id', '=', 'qlhs_profile.profile_household')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("thon.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'thon.site_name as profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrohocsinhdantocthieuso.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "NGNA") {
                    
                    $getData = DB::table('qlhs_hotronguoinauan')
                        ->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hotronguoinauan.school_id')
                        ->where('qlhs_hotronguoinauan.type_code', '=', $getReport->report_type);

                    $result['year'] = $getReport->report_year;
                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('qlhs_schools.schools_name', 'qlhs_hotronguoinauan.*')->skip($start*$limit)->take($limit)->get();
                }
            }

            // if (is_null($getReport) && empty($getReport)) {
            //     $getData = DB::table('qlhs_hosobaocao')
            //         ->leftJoin('qlhs_miengiamhocphi', 'qlhs_miengiamhocphi.type_code', '=', 'qlhs_hosobaocao.report_type')
            //         ->leftJoin('qlhs_chiphihoctap', 'qlhs_chiphihoctap.type_code', '=', 'qlhs_hosobaocao.report_type')
            //         ->leftJoin('qlhs_hotrotienan', 'qlhs_hotrotienan.type_code', '=', 'qlhs_hosobaocao.report_type')
            //         ->leftJoin('qlhs_hotrohocsinhbantru', 'qlhs_hotrohocsinhbantru.type_code', '=', 'qlhs_hosobaocao.report_type')
            //         ->leftJoin('qlhs_hotrohocsinhkhuyettat', 'qlhs_hotrohocsinhkhuyettat.type_code', '=', 'qlhs_hosobaocao.report_type')
            //         ->leftJoin('qlhs_hotrohocsinhdantocthieuso as hsdtts', 'hsdtts.type_code', '=', 'qlhs_hosobaocao.report_type')
            //         ->leftJoin('qlhs_hotrohocsinhdantocthieuso as htaths', 'htaths.type_code', '=', 'qlhs_hosobaocao.report_type')
            //         ->leftJoin('qlhs_hotrohocsinhdantocthieuso as hbhsdtnt', 'hbhsdtnt.type_code', '=', 'qlhs_hosobaocao.report_type')
            //         ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_miengiamhocphi.id_profile')
            //         ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
            //         ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and oldHis.history_year = "qlhs_hosobaocao.report_year-(qlhs_hosobaocao.report_year + 1)"'))
            //         ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_profile.profile_id and newHis.history_year = "(qlhs_hosobaocao.report_year + 1)-(qlhs_hosobaocao.report_year + 2)"'))
            //         ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
            //         ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
            //         ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id');

            //     if (!is_null($groupHS) && !empty($groupHS)) {
            //         if ($groupHS == "GROUPA") {
            //             $getData->where('qlhs_miengiamhocphi.type', '=', 1);
            //         }
            //         if ($groupHS == "GROUPB") {
            //             $getData->where('qlhs_miengiamhocphi.type', '=', 2);
            //         }
            //         if ($groupHS == "GROUPC") {
            //             $getData->where('qlhs_miengiamhocphi.type', '=', 3);
            //         }
            //     }

            //     if (!is_null($keySearch) && !empty($keySearch)) {
            //         $getData->where(function($query) use ($keySearch){
            //             $query->where("profile_name", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("profile_household", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
            //                 ->orWhere("profile_year", "=", "%".$keySearch."%");
            //         });
            //     }

            //     $result['startRecord'] = ($start);
            //     $result['numRows'] = $limit;
            //     $result['totalRows'] = $getData->count();
            //     $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_miengiamhocphi.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->toSql();
            // }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadDatabyGroupB(Request $request){
        try {
            $result = [];

            $reportName = $request->input('REPORTNAME');
            $reportType = $request->input('REPORTTYPE');

            $start = $request->input('start');
            $limit = $request->input('limit');
            $keySearch = $request->input('KEY');
            $groupHS = $request->input('GROUP');

            $getReport = DB::table('qlhs_hosobaocao')
                ->where('report_name', '=', $reportName)
                ->where('report', '=', $reportType)
                ->select('report_type', 'report_year')->first();

            if (!is_null($getReport) && !empty($getReport) && $getReport->report_year > 0) {
                
                if ($reportType == "MGHP") {
                    $getData = DB::table('qlhs_miengiamhocphi')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_miengiamhocphi.id_profile')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "MGHP"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_miengiamhocphi.id_profile and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_miengiamhocphi.id_profile and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_miengiamhocphi.type_code', '=', $getReport->report_type);

                    if (!is_null($groupHS) && !empty($groupHS)) {
                        if ($groupHS == "GROUPA") {
                            $getData->where('qlhs_miengiamhocphi.type', '=', 1);
                        }
                        if ($groupHS == "GROUPB") {
                            $getData->where('qlhs_miengiamhocphi.type', '=', 2);
                        }
                        if ($groupHS == "GROUPC") {
                            $getData->where('qlhs_miengiamhocphi.type', '=', 3);
                        }
                    }

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_household", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_miengiamhocphi.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "CPHT") {
                    $getData = DB::table('qlhs_chiphihoctap')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_chiphihoctap.cpht_profile_id')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "CPHT"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_chiphihoctap.cpht_profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_chiphihoctap.cpht_profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_chiphihoctap.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_household", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }
                    
                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_chiphihoctap.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HTAT") {
                    $getData = DB::table('qlhs_hotrotienan')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrotienan.htta_profile_id')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HTAT"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_hotrotienan.htta_profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_hotrotienan.htta_profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrotienan.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_household", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrotienan.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HTBT") {
                    $getData = DB::table('qlhs_hotrohocsinhbantru')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhbantru.profile_id')
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhbantru.profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhbantru.profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrohocsinhbantru.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_household", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_km', 'qlhs_profile.profile_giaothong', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrohocsinhbantru.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HSKT") {
                    $getData = DB::table('qlhs_hotrohocsinhkhuyettat')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhkhuyettat.profile_id')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HSKT"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhkhuyettat.profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhkhuyettat.profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrohocsinhkhuyettat.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_household", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrohocsinhkhuyettat.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HTATHS" || $reportType == "HSDTTS" || $reportType == "HBHSDTNT") {
                    
                    $getData = DB::table('qlhs_hotrohocsinhdantocthieuso')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history as oldHis', 'oldHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and oldHis.history_year = "'.$getReport->report_year.'-'.($getReport->report_year + 1).'"'))
                        ->leftJoin('qlhs_profile_history as newHis', 'newHis.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and newHis.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getReport->report_type);

                    if (!is_null($keySearch) && !empty($keySearch)) {
                        $getData->where(function($query) use ($keySearch){
                           $query->where("profile_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_birthday", "LIKE", "%".$keySearch."%")
                           ->orWhere("nationals_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_parentname", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_household", "LIKE", "%".$keySearch."%")
                           ->orWhere("xa.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("huyen.site_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("schools_name", "LIKE", "%".$keySearch."%")
                           ->orWhere("oldHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("newHis.level_cur", "LIKE", "%".$keySearch."%")
                           ->orWhere("profile_year", "=", "%".$keySearch."%");
                        });
                    }

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('oldHis.history_year as old_history_year', 'oldHis.level_old as old_level_old', 'oldHis.level_cur as old_level_cur', 'oldHis.level_new as old_level_new','newHis.history_year as new_history_year', 'newHis.level_old as new_level_old', 'newHis.level_cur as new_level_cur', 'newHis.level_new as new_level_new', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrohocsinhdantocthieuso.*')->orderBy('type', 'asc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "NGNA") {
                    
                    $getData = DB::table('qlhs_hotronguoinauan')
                        ->join('qlhs_schools', 'qlhs_schools.schools_id', '=', 'qlhs_hotronguoinauan.school_id')
                        ->where('qlhs_hotronguoinauan.type_code', '=', $getReport->report_type);

                    $result['year'] = $getReport->report_year;
                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('qlhs_schools.schools_name', 'qlhs_hotronguoinauan.*')->skip($start*$limit)->take($limit)->get();
                }
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadDatabyGroupC(Request $request){
        try {
            $result = [];

            $reportName = $request->input('REPORTNAME');
            $reportType = $request->input('REPORTTYPE');

            $start = $request->input('start');
            $limit = $request->input('limit');
            $keySearch = $request->input('KEY');

            $getReport = DB::table('qlhs_hosobaocao')
                ->where('report_name', '=', $reportName)
                ->where('report', '=', $reportType)
                ->select('report_type', 'report_year')->first();

            if (!is_null($getReport) && !empty($getReport) && $getReport->report_year > 0) {
                if ($reportType == "MGHP") {
                    $getData = DB::table('qlhs_miengiamhocphi')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_miengiamhocphi.id_profile')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "MGHP"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->leftJoin('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_miengiamhocphi.id_profile and qlhs_profile_history.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_miengiamhocphi.type_code', '=', $getReport->report_type) 
                        ->where('qlhs_miengiamhocphi.type', '=', 3);

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('qlhs_profile_history.history_year', 'qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_miengiamhocphi.*')->orderBy('qlhs_profile.updated_at', 'desc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "CPHT") {
                    $getData = DB::table('qlhs_chiphihoctap')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_chiphihoctap.cpht_profile_id')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "CPHT"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_chiphihoctap.cpht_profile_id and qlhs_profile_history.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_chiphihoctap.type_code', '=', $getReport->report_type)
                        ->where('qlhs_chiphihoctap.type', '=', 3);

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_chiphihoctap.*')->orderBy('qlhs_profile.updated_at', 'desc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HTAT") {
                    $getData = DB::table('qlhs_hotrotienan')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrotienan.htta_profile_id')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HTAT"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrotienan.htta_profile_id and qlhs_profile_history.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrotienan.type_code', '=', $getReport->report_type)
                        ->where('qlhs_hotrotienan.type', '=', 3);

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrotienan.*')->orderBy('qlhs_profile.updated_at', 'desc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HTBT") {
                    $getData = DB::table('qlhs_hotrohocsinhbantru')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhbantru.profile_id')
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhbantru.profile_id and qlhs_profile_history.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrohocsinhbantru.type_code', '=', $getReport->report_type)
                        ->where('qlhs_hotrohocsinhbantru.type', '=', 3);

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_km', 'qlhs_profile.profile_giaothong', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrohocsinhbantru.*')->orderBy('qlhs_profile.updated_at', 'desc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HSKT") {
                    $getData = DB::table('qlhs_hotrohocsinhkhuyettat')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhkhuyettat.profile_id')
                        ->leftJoin(DB::raw('(select decided_profile_id, max(decided_id) decided_id, max(decided_confirmation) decided_confirmation, max(decided_confirmdate) decided_confirmdate, max(decided_number) decided_number, max(decided_type) decided_type from qlhs_decided GROUP BY decided_profile_id) as qlhs_decided'), 'qlhs_decided.decided_profile_id', '=', DB::raw('qlhs_profile.profile_id and qlhs_decided.decided_type = "HSKT"'))
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhkhuyettat.profile_id and qlhs_profile_history.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrohocsinhkhuyettat.type_code', '=', $getReport->report_type)
                        ->where('qlhs_hotrohocsinhkhuyettat.type', '=', 3);

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_decided.decided_id', 'qlhs_decided.decided_confirmation', 'qlhs_decided.decided_number', 'qlhs_decided.decided_confirmdate', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrohocsinhkhuyettat.*')->orderBy('qlhs_profile.updated_at', 'desc')->skip($start*$limit)->take($limit)->get();
                }
                if ($reportType == "HTATHS" || $reportType == "HSDTTS" || $reportType == "HBHSDTNT") {
                    
                    $getData = DB::table('qlhs_hotrohocsinhdantocthieuso')
                        ->join('qlhs_profile', 'qlhs_profile.profile_id', '=', 'qlhs_hotrohocsinhdantocthieuso.profile_id')
                        ->join('qlhs_nationals', 'nationals_id', '=', 'qlhs_profile.profile_nationals_id')
                        ->join('qlhs_profile_history', 'qlhs_profile_history.history_profile_id', '=', DB::raw('qlhs_hotrohocsinhdantocthieuso.profile_id and qlhs_profile_history.history_year = "'.($getReport->report_year + 1).'-'.($getReport->report_year + 2).'"'))
                        ->join('qlhs_site as huyen', 'huyen.site_id', '=', 'qlhs_profile.profile_site_id2')
                        ->leftJoin('qlhs_site as xa', 'xa.site_id', '=', 'qlhs_profile.profile_site_id3')
                        ->leftJoin('qlhs_schools', 'schools_id', '=', 'qlhs_profile.profile_school_id')
                        ->where('qlhs_hotrohocsinhdantocthieuso.type_code', '=', $getReport->report_type)
                        ->where('qlhs_hotrohocsinhdantocthieuso.type', '=', 3);

                    $result['startRecord'] = ($start);
                    $result['numRows'] = $limit;
                    $result['totalRows'] = $getData->count();
                    $result['data'] = $getData->select('qlhs_profile_history.level_old', 'qlhs_profile_history.level_cur', 'qlhs_profile_history.level_new', 'qlhs_profile_history.history_year', 'qlhs_profile.profile_id', 'qlhs_profile.profile_name', 'qlhs_profile.profile_birthday', 'qlhs_nationals.nationals_name', 'qlhs_profile.profile_household', 'qlhs_profile.profile_site_id3', 'huyen.site_name as tenhuyen', 'xa.site_name as tenxa', 'qlhs_profile.profile_parentname', 'qlhs_profile.profile_year', 'schools_name', 'qlhs_hotrohocsinhdantocthieuso.*')->orderBy('qlhs_profile.updated_at', 'desc')->skip($start*$limit)->take($limit)->get();
                }
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function loadCongVanThuHoi($socongvan){
        try {

            $check = DB::table('qlhs_hosobaocao')
                ->where('report_name', $socongvan)
                ->whereIn('report_cap_gui', [2, 3, 4])->get();

            $getData = null;

            if (is_null($check) || empty($check) || count($check) <= 0) {
                $getData = DB::table('qlhs_hosobaocao')
                    ->where('report_name', $socongvan)
                    ->where('report_cap_gui', 1)->select('report_name', 'report_id')->get();
            }

            return $getData;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function thuhoiCongVan(Request $request){
        try {
            $result = [];
            $report_id = $request->input('REPORTID');
            $current_date = Carbon::now('Asia/Ho_Chi_Minh');

            $updateTrangthai = DB::table('qlhs_hosobaocao')->where('report_id', '=', $report_id)
                ->update([
                    'report_cap_status' => 3,
                    'updated_at' => $current_date
                    ]);

            if ($updateTrangthai > 0) {
                $result['success'] = "Công văn đã được thu hồi thành công!";
            }
            else {
                $result['error'] = "Có lỗi xảy ra trong quá trình thu hồi!";
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }


//---------------------------------------------------------Lập danh sách mới--------------------------------------------------------------------------
    public function lapdanhsach_Truong(Request $request){
        try {

            $namhoc = explode('-',$request->YEAR);
            $school_id = $request->SCHOOLID;
            $year = $namhoc[1];
            $hocky = $namhoc[0];
            $name = $request->NAME;
            $soCongVan = $request->NUMBERCV;
            $note = $request->NOTE;
            $status = 0;
            $chedo = explode(',', $request->ARRCHEDO);
            $khoi = $request->UNITNAME;
            $capnhan = $request->CAPNHAN;
            $loaicongvan = $request->LOAICONGVAN;

            $message = [];
            $chedoMGHP = 0;
            $chedoCPHT = 0;
            $chedoHTAT = 0;
            $chedoHTBT = 0;
            $chedoHSKT = 0;
            $chedoHSDTTS = 0;
            $chedoHTATHS = 0;
            $chedoHBHSDTNT = 0;
            
            $value_type = "";
            $checkSCV = HoSoBaoCao::where('report_name',$soCongVan)->count();
            if($checkSCV > 0){
                $message['error'] = "Công văn đã tồn tại.";
                return $message;
            }
            $report_name = $soCongVan != null ? $soCongVan : bussinessClass::autoCode(1,$school_id);
            if($chedo[0] == 9){
                $ngna = qlhs_nguoinauan::where('NGNA_id',$loaicongvan)->first();
                $load_data = qlhs_nguoinauan::leftJoin('qlhs_schools_history as sh','sh.type_his_school_id','NGNA_school_id')
                    ->leftJoin('years_months_kp as kp',function($q){
                        $q->on('sh.type_his_type_id','kp.id_schooltype')
                        ->where('NGNA_years',\DB::raw(" YEAR(kp.date_con) AND CASE WHEN SUBSTR(NGNA_HK,1,3) = 'HK1' THEN kp.months IN (9,10,11,12) ELSE kp.months IN (1,2,3,4,5) END"))
                        ->where('kp.id_doituong',102);
                    })
                    ->where('NGNA_id',$loaicongvan)
                    ->select(\DB::raw("ROUND(SUM(CASE WHEN NGNA_Total < 5 THEN ((NGNA_TW - NGNA_68) * 1.35 * value_m)
                   ELSE (5 * 1.35 * value_m) END)) as 'TW',
                   ROUND(SUM(CASE WHEN NGNA_Total > 5 THEN ((NGNA_DP - NGNA_68) * 2.25 * value_m)
                   ELSE 0 END)) as 'DP',NGNA_HK,NGNA_years,NGNA_TW,NGNA_DP,NGNA_68,NGNA_amount,NGNA_id"))
                    ->groupBy('value_m','years','ngna_hk','NGNA_HK','NGNA_years','NGNA_TW','NGNA_DP','NGNA_68','NGNA_amount','NGNA_id')->first(); 
                if($ngna && $load_data){
                    $insert_HSBC = new HoSoBaoCao();
                    $insert_HSBC->report_name = $report_name;
                    $insert_HSBC->report_value = bussinessClass::autoCodeFirst(1,$school_id);
                    $insert_HSBC->report_type = 'NGNA';
                    $insert_HSBC->report_name_text = $name;
                    $insert_HSBC->report_date = Carbon::now();
                    $insert_HSBC->create_userid = Auth::user()->id;
                    $insert_HSBC->report_year = $year;
                    $insert_HSBC->report_id_truong = $school_id;
                    $insert_HSBC->report_note = $note;
                    $insert_HSBC->report_cap_gui = 1;
                    $insert_HSBC->report_cap_status = 0;
                    $insert_HSBC->report_status = 0;
                    
                    $insert_HSBC->report_cap_nhan = $capnhan;
                    $insert_HSBC->report_total = null;
                    $insert_HSBC->report_name_new = $school_id.'-'.$year;
                    $insert_HSBC->number = bussinessClass::autoCodeNumber(1,$school_id);
                    if($khoi == null || $khoi == '' || $khoi == 'undefined'){
                        $khoi = 0;
                    }
                    $insert_HSBC->report = $khoi;//Khối lớp
                    $insert_HSBC->save();

                    $ngna->NGNA_Status = $ngna->NGNA_Status + 1;
                    $ngna->save();
                    if($capnhan == 2){
                        $nauan = new qlhs_hosobaocao_ngna_PGD();
                    }else if($capnhan == 3){
                        $nauan = new qlhs_hosobaocao_ngna_PTC();
                    }
                    
                    $nauan->hsbc_school_id = $ngna->NGNA_school_id;
                    $nauan->hsbc_amount = $ngna->NGNA_amount;
                    $nauan->hsbc_HSTW = $ngna->NGNA_HSTW;
                    $nauan->hsbc_HSDP = $ngna->NGNA_HSDP;
                    $nauan->hsbc_Total = $ngna->NGNA_Total;
                    $nauan->hsbc_unit_id = $ngna->NGNA_unit_id;
                    $nauan->hsbc_years = $ngna->NGNA_years;
                    $nauan->hsbc_HK = $ngna->NGNA_HK;
                    $nauan->hsbc_TW = $ngna->NGNA_TW;
                    $nauan->hsbc_DP = $ngna->NGNA_DP;
                    $nauan->hsbc_68 = $ngna->NGNA_68;
                    $nauan->hsbc_amount_TW = $load_data->TW;
                    $nauan->hsbc_amount_DP = $load_data->DP;
                    $nauan->report_name = $report_name;
                    $nauan->save();
                    $message['success'] = "Công văn đã được lập và gửi lên cấp trên.";
                }else{
                    $message['error'] = "Không tồn tại danh sách này!";
                }
                return $message;
            }
            //Kiếm tra loại trường
            $getSchoolType = DB::table('qlhs_schools_history')
                ->where('type_his_school_id',$school_id)
                ->where('type_his_startdate','<=',$year.'-09-05')
                ->where(function($q) use($year){
                    $q->orWhere('type_his_enddate','>=',$year.'-09-05')
                    ->orWhere('type_his_enddate',null);
                })
                ->select('type_his_type_id')->first();

            $getProfileBySchool = LichSuHSHocSinh::leftJoin('qlhs_tonghopchedo_truong',function($q) use($year) {
                    $q->on('history_profile_id','thcd_nhucau_profile_id')
                    ->on('history_school_id','thcd_nhucau_school_id')
                    ->where('thcd_nhucau_nam',$year)
                    ->where('history_class_id','<>',null);
                })
                ->leftJoin('qlhs_class','class_id','history_class_id')
                ->where('history_year',$year.'-'.((int)$year+1))
                ->where('history_school_id',Auth::user()->truong_id);
                if($khoi != null && $khoi != '' && $khoi != 'undefined'){
                    $getProfileBySchool = $getProfileBySchool
                    ->where('class_unit_id',$khoi);
                }
                

            if($loaicongvan == 2){// Công văn điều chỉnh
                $getProfileBySchool = $getProfileBySchool
                ->where('trangthai_'.$hocky,'>',0);
            }else{//Công văn duyệt
                $getProfileBySchool = $getProfileBySchool
                ->where('trangthai_'.$hocky,1);
            }

            $getProfile = null;
            if($hocky != "CA"){
                $hk = 0;
                if($hocky == "HK1"){
                    $hk = 1;
                }else{
                    $hk = 2;
                }
                
                // Tổng hợp chế độ cần lập
                foreach ($chedo as $value) {
                    if ($value == 1){
                        $chedoMGHP = 1;
                        $value_type .= "MGHP-";
                    }
                    if ($value == 2){
                        $chedoCPHT = 1;
                        $value_type .= "CPHT-";
                    }
                    if ($value == 3){
                        $chedoHTAT = 1;
                        $value_type .= "HTAT-";
                    }
                    if ($value == 4){
                        $chedoHTBT = 1;
                         $value_type .= "HTBT-";
                    }
                    if ($value == 5){
                        $chedoHSKT = 1;
                        $value_type .= "HSKT-";
                    }
                    if ($value == 6){
                        $chedoHTATHS = 1;
                        $value_type .= "HTATHS-";
                    }
                    if ($value == 7){
                        $chedoHSDTTS = 1;
                        $value_type .= "HSDTTS-";
                    }
                    if ($value == 8){
                        $chedoHBHSDTNT = 1;
                        $value_type .= "HBHSDTNT-";
                    }
                }
                $value_type = substr($value_type,0,strlen($value_type) - 1); 

                $getProfile = $getProfileBySchool
                ->where(function($qq) use($hocky,$chedoMGHP,$chedoCPHT,$chedoHTAT,$chedoHTBT,$chedoHSKT,$chedoHSDTTS,$chedoHTATHS,$chedoHBHSDTNT){
                    $qq->orWhere(function($qa) use($hocky,$chedoMGHP){
                        $qa->where(DB::raw($chedoMGHP),1)
                        ->where('thcd_nhucau_MGHP_'.$hocky,'>',0)
                        ->where('thcd_nhucau_trangthai_MGHP_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qb) use($hocky,$chedoCPHT){
                        $qb->where(DB::raw($chedoCPHT),1)
                        ->where('thcd_nhucau_CPHT_'.$hocky,'>',0)
                        ->where('thcd_nhucau_trangthai_CPHT_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qc) use($hocky,$chedoHTAT){
                        $qc->where(DB::raw($chedoHTAT),1)
                        ->where('thcd_nhucau_HTAT_'.$hocky,'>',0)
                        ->where('thcd_nhucau_trangthai_HTAT_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qd) use($hocky,$chedoHTBT){
                        $qd->where(DB::raw($chedoHTBT),1)
                        ->where('thcd_nhucau_HTBT_TA_'.$hocky,'>',0)
                        ->where('thcd_nhucau_trangthai_HTBT_TA_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qe) use($hocky,$chedoHTBT){
                        $qe->where(DB::raw($chedoHTBT),1)
                        ->where('thcd_nhucau_trangthai_HTBT_TO_'.$hocky,'>',0)
                        ->where('thcd_nhucau_HTBT_TO_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qf) use($hocky,$chedoHTBT){
                        $qf->where(DB::raw($chedoHTBT),1)
                        ->where('thcd_nhucau_trangthai_HTBT_VHTT_'.$hocky,'>',0)
                        ->where('thcd_nhucau_HTBT_VHTT_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qg) use($hocky,$chedoHSKT){
                        $qg->where(DB::raw($chedoHSKT),1)
                        ->where('thcd_nhucau_trangthai_HSKT_HB_'.$hocky,'>',0)
                        ->where('thcd_nhucau_HSKT_HB_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qh) use($hocky,$chedoHSKT){
                        $qh->where(DB::raw($chedoHSKT),1)
                        ->where('thcd_nhucau_HTBT_VHTT_'.$hocky,'>',0)
                        ->where('thcd_nhucau_trangthai_HTBT_VHTT_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qi) use($hocky,$chedoHSDTTS){
                        $qi->where(DB::raw($chedoHSDTTS),1)
                        ->where('thcd_nhucau_trangthai_HSDTTS_'.$hocky,'>',0)
                        ->where('thcd_nhucau_HSDTTS_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qj) use($hocky,$chedoHTATHS){
                        $qj->where(DB::raw($chedoHTATHS),1)
                        ->where('thcd_nhucau_trangthai_HTATHS_'.$hocky,'>',0)
                        ->where('thcd_nhucau_HTATHS_'.$hocky,'>',0);
                    })
                    ->orWhere(function($qk) use($hocky,$chedoHBHSDTNT){
                        $qk->where(DB::raw($chedoHBHSDTNT),1)
                        ->where('thcd_nhucau_trangthai_HBHSDTNT_'.$hocky,'>',0)
                        ->where('thcd_nhucau_HBHSDTNT_'.$hocky,'>',0);
                    });
                })
                ->select(
                    DB::raw('CASE WHEN '.$chedoMGHP.' = 1 AND thcd_nhucau_trangthai_MGHP_'.$hocky.' > 0 THEN thcd_nhucau_MGHP_'.$hocky.' ELSE 0 END MGHP'),
                    DB::raw('CASE WHEN '.$chedoCPHT.' = 1 AND thcd_nhucau_trangthai_CPHT_'.$hocky.' > 0 THEN thcd_nhucau_CPHT_'.$hocky.' ELSE 0 END CPHT'),
                    DB::raw('CASE WHEN '.$chedoHTAT.' = 1 AND thcd_nhucau_trangthai_HTAT_'.$hocky.' > 0 THEN thcd_nhucau_HTAT_'.$hocky.' ELSE 0 END HTAT'),
                    DB::raw('CASE WHEN '.$chedoHTBT.' = 1 AND thcd_nhucau_trangthai_HTBT_TA_'.$hocky.' > 0 THEN thcd_nhucau_HTBT_TA_'.$hocky.' ELSE 0 END HTBT_TA'),
                    DB::raw('CASE WHEN '.$chedoHTBT.' = 1 AND thcd_nhucau_trangthai_HTBT_TO_'.$hocky.' > 0 THEN thcd_nhucau_HTBT_TO_'.$hocky.' ELSE 0 END HTBT_TO'),
                    DB::raw('CASE WHEN '.$chedoHTBT.' = 1 AND thcd_nhucau_trangthai_HTBT_VHTT_'.$hocky.' > 0 THEN thcd_nhucau_HTBT_VHTT_'.$hocky.' ELSE 0 END HTBT_VHTT'),
                    DB::raw('CASE WHEN '.$chedoHSKT.' = 1 AND thcd_nhucau_trangthai_HSKT_HB_'.$hocky.' > 0 THEN thcd_nhucau_HSKT_HB_'.$hocky.' ELSE 0 END HSKT_HB'),
                    DB::raw('CASE WHEN '.$chedoHSKT.' = 1 AND thcd_nhucau_trangthai_HSKT_DDHT_'.$hocky.' > 0 THEN thcd_nhucau_HSKT_DDHT_'.$hocky.' ELSE 0 END HSKT_DDHT'),
                    DB::raw('CASE WHEN '.$chedoHSDTTS.' = 1 AND thcd_nhucau_trangthai_HSDTTS_'.$hocky.' > 0 THEN thcd_nhucau_HSDTTS_'.$hocky.' ELSE 0 END HSDTTS'),
                    DB::raw('CASE WHEN '.$chedoHTATHS.' = 1 AND thcd_nhucau_trangthai_HTATHS_'.$hocky.' > 0 THEN thcd_nhucau_HTATHS_'.$hocky.' ELSE 0 END HTATHS'),
                    DB::raw('CASE WHEN '.$chedoHBHSDTNT.' = 1 AND thcd_nhucau_trangthai_HBHSDTNT_'.$hocky.' > 0 THEN thcd_nhucau_HBHSDTNT_'.$hocky.' ELSE 0 END HBHSDTNT'),
                    'history_profile_id as rpp_profile_id','class_unit_id',
                    DB::raw('("'.$report_name.'") as rpp_report_name'),
                    DB::raw('("'.$year.'") as rpp_year_cur'),
                    DB::raw('("'.$hk.'") as rpp_type')
                );            
                
                $getProfile = DB::table(DB::raw("(".$getProfile->toSql().") as m"))
                ->mergeBindings($getProfile->getQuery())
                ->where(DB::raw("(m.MGHP + m.CPHT + m.HTAT + m.HTBT_TA + m.HTBT_TO + m.HTBT_VHTT + m.HSKT_HB + m.HSKT_DDHT + m.HSDTTS + m.HTATHS + m.HBHSDTNT)"),'>',0)
                ->select(
                    'm.MGHP as rpp_MGHP_NhuCau',
                    'm.CPHT as rpp_CPHT_NhuCau',
                    'm.HTAT as rpp_HTAT_NhuCau',
                    'm.HTBT_TA as rpp_HTBT_NhuCau_TA',
                    'm.HTBT_TO as rpp_HTBT_NhuCau_TO',
                    'm.HTBT_VHTT as rpp_HTBT_NhuCau_VHTT',
                    DB::raw('(m.HTBT_TA + m.HTBT_TO + m.HTBT_VHTT) as rpp_HTBT_Tong_NhuCau'),
                    'm.HSKT_HB as rpp_HSKT_NhuCau_HB',
                    'm.HSKT_DDHT as rpp_HSKT_NhuCau_DDHT',
                    DB::raw('(m.HSKT_HB + m.HSKT_DDHT) as rpp_HSKT_Tong_NhuCau'),
                    'm.HSDTTS as rpp_HSDTTS_NhuCau',
                    'm.HTATHS as rpp_HTATHS_NhuCau',
                    'm.HBHSDTNT as rpp_HBHSDTNT_NhuCau',
                    'm.rpp_profile_id','m.class_unit_id',
                    'm.rpp_report_name','m.rpp_year_cur','m.rpp_type',
                    DB::raw('(m.MGHP + m.CPHT + m.HTAT + m.HTBT_TA + m.HTBT_TO + m.HTBT_VHTT + m.HSKT_HB + m.HSKT_DDHT + m.HSDTTS + m.HTATHS + m.HBHSDTNT) as rpp_Tong_Nhu_Cau')
                )->get();

            }
            
            if(count($getProfile) > 0){
                $khoi = $getProfile[0] != null ? $getProfile[0]->class_unit_id : 0;
               // return $getProfile;
                dispatch((new sendDocumentary_Truong($school_id,$getSchoolType->type_his_type_id,$year,$loaicongvan,$name,$note,$chedo,$getProfile,$khoi,$capnhan,Auth::user()->id,$report_name,$value_type,$hk))->onQueue('school'));
               $message['success'] = "Công văn đã được lập và gửi lên cấp trên.".count($getProfile);
            }else{
                $message['error'] = "Danh sách không có học sinh được duyệt";
            }                
            return $message;
        } catch (Exception $e) {
            return $e;
        }
    }
// Lập danh sách từ phòng tài chính hoặc phòng giáo dục lên cấp trên
    public function lapdanhsach_PhongSo(Request $request){
        try {
            $result = [];
            // 
            $report_name = $request->SOCONGVAN;// cv cũ
            $r_name = $request->CONGVAN;// so cv mới
            $report_status = $request->REPORTSTATUS;// 1- CV duyệt 2-CV trả lại
            $chedo = $request->ARRCHEDO;
            $name = $request->TENCONGVAN;
            $note = $request->GHICHUCV;
            
            $time = time();
            $current_date = Carbon::now();
            $user = Auth::user()->id;
            $levelUser = Auth::user()->level;

            $chedoMGHP = 0;
            $chedoCPHT = 0;
            $chedoHTAT = 0;
            $chedoHTBT = 0;
            $chedoHSKT = 0;
            $chedoHSDTTS = 0;
            $chedoHTATHS = 0;
            $chedoHBHSDTNT = 0;
            $chedoNGNA = 0;
            $autoCode  ="";
            $value_type = "";

            foreach ($chedo as $value) {
                if ($value == 1){
                    $chedoMGHP = $report_status;
                    $value_type .= "MGHP-";
                }
                if ($value == 2){
                    $chedoCPHT = $report_status;
                    $value_type .= "CPHT-";
                }
                if ($value == 3){
                    $chedoHTAT = $report_status;
                    $value_type .= "HTAT-";
                }
                if ($value == 4){
                    $chedoHTBT = $report_status;
                    $value_type .= "HTBT-";
                }
                if ($value == 5){
                    $chedoHSKT = $report_status;
                    $value_type .= "HSKT-";
                }
                if ($value == 6){
                    $chedoHTATHS = $report_status;
                    $value_type .= "HTATHS-";
                }
                if ($value == 7){
                    $chedoHSDTTS = $report_status;
                    $value_type .= "HSDTTS-";
                }
                if ($value == 8){
                    $chedoHBHSDTNT = $report_status;
                    $value_type .= "HBHSDTNT-";
                }
                if ($value == 9){
                    $chedoNGNA = $report_status;
                    $value_type = "NGNA-";
                }
            }
            $value_type = substr($value_type,0,strlen($value_type) - 1);

            $checkSCV = HoSoBaoCao::where('report_name',$r_name)
            ->where('report_cap_gui','<','report_cap_nhan')
            ->count();
            if($checkSCV > 0){
                $checkTypeCV = HoSoBaoCao::where('report_name',$r_name)
                ->where('report_type',$value_type)
                ->where('report_cap_gui',Auth::user()->level)
                ->where('report_cap_nhan',(Auth::user()->level + 1))
                ->first();
                if($checkSCV){
                    $result['error'] = "Công văn không cùng chế độ hoặc cấp nhận";
                    return $result;
                }
            }

            $getDataHS = [];
            $dataHS = [];     
            $check_next = null;   
            $autoCode = $r_name != null ? $r_name : bussinessClass::autoCode($levelUser,Auth::user()->id);
            if($report_status == 1){
                if($value_type == 'NGNA'){
                    if($levelUser == 2){
                       $check_next = qlhs_hosobaocao_ngna_PGD::where('hsbc_active',1)->where('report_name',$report_name)->first();
                        if($check_next){
                            $school_id = $check_next->hsbc_school_id;
                            $insert_HSBC = new HoSoBaoCao();
                            $insert_HSBC->report_name = $autoCode;
                            $insert_HSBC->report_value = bussinessClass::autoCodeFirst(2,$user);
                            $insert_HSBC->report_type = 'NGNA';
                            $insert_HSBC->report_name_text = $name;
                            $insert_HSBC->report_date = Carbon::now();
                            $insert_HSBC->create_userid = Auth::user()->id;
                            $insert_HSBC->report_year = $check_next->hsbc_years;
                            $insert_HSBC->report_id_truong = $school_id;
                            $insert_HSBC->report_note = $note;
                            $insert_HSBC->report_cap_gui = 2;
                            $insert_HSBC->report_cap_status = 0;
                            $insert_HSBC->report_status = 0;
                            
                            $insert_HSBC->report_cap_nhan = 3;
                            $insert_HSBC->report_total = null;
                            $insert_HSBC->report_name_new = $report_name;
                            $insert_HSBC->number = bussinessClass::autoCodeNumber(2,$user);
                            $insert_HSBC->save();

                            $nauan = new qlhs_hosobaocao_ngna_PTC();
                            $nauan->hsbc_school_id = $check_next->hsbc_school_id;
                            $nauan->hsbc_amount = $check_next->hsbc_amount;
                            $nauan->hsbc_HSTW = $check_next->hsbc_HSTW;
                            $nauan->hsbc_HSDP = $check_next->hsbc_HSDP;
                            $nauan->hsbc_Total = $check_next->hsbc_Total;
                            $nauan->hsbc_unit_id = $check_next->hsbc_unit_id;
                            $nauan->hsbc_years = $check_next->hsbc_years;
                            $nauan->hsbc_HK = $check_next->hsbc_HK;
                            $nauan->hsbc_TW = $check_next->hsbc_TW;
                            $nauan->hsbc_DP = $check_next->hsbc_DP;
                            $nauan->hsbc_68 = $check_next->hsbc_68;
                            $nauan->hsbc_amount_TW = $check_next->hsbc_amount_TW;
                            $nauan->hsbc_amount_DP = $check_next->hsbc_amount_DP;
                            $nauan->report_name = $insert_HSBC->report_name;
                            $nauan->save();
                            $check_next->hsbc_status = 1;
                            $check_next->save();
                        }
                    }else if($levelUser == 3){
                        $check_next = qlhs_hosobaocao_ngna_PTC::where('hsbc_active',1)->where('report_name',$report_name)->first();
                        if($check_next){
                            $school_id = $check_next->hsbc_school_id;
                            $insert_HSBC = new HoSoBaoCao();
                            $insert_HSBC->report_name = $autoCode;
                            $insert_HSBC->report_value = bussinessClass::autoCodeFirst(3,$user);
                            $insert_HSBC->report_type = 'NGNA';
                            $insert_HSBC->report_name_text = $name;
                            $insert_HSBC->report_date = Carbon::now();
                            $insert_HSBC->create_userid = Auth::user()->id;
                            $insert_HSBC->report_year = $check_next->hsbc_years;
                            $insert_HSBC->report_id_truong = $school_id;
                            $insert_HSBC->report_note = $note;
                            $insert_HSBC->report_cap_gui = 3;
                            $insert_HSBC->report_cap_status = 0;
                            $insert_HSBC->report_status = 0;
                            
                            $insert_HSBC->report_cap_nhan = 4;
                            $insert_HSBC->report_total = null;
                            $insert_HSBC->report_name_new = $report_name;
                            $insert_HSBC->number = bussinessClass::autoCodeNumber(3,$user);
                            $insert_HSBC->save();

                            $nauan = new qlhs_hosobaocao_ngna_STC();
                            $nauan->hsbc_school_id = $check_next->hsbc_school_id;
                            $nauan->hsbc_amount = $check_next->hsbc_amount;
                            $nauan->hsbc_HSTW = $check_next->hsbc_HSTW;
                            $nauan->hsbc_HSDP = $check_next->hsbc_HSDP;
                            $nauan->hsbc_Total = $check_next->hsbc_Total;
                            $nauan->hsbc_unit_id = $check_next->hsbc_unit_id;
                            $nauan->hsbc_years = $check_next->hsbc_years;
                            $nauan->hsbc_HK = $check_next->hsbc_HK;
                            $nauan->hsbc_TW = $check_next->hsbc_TW;
                            $nauan->hsbc_DP = $check_next->hsbc_DP;
                            $nauan->hsbc_68 = $check_next->hsbc_68;
                            $nauan->hsbc_amount_TW = $check_next->hsbc_amount_TW;
                            $nauan->hsbc_amount_DP = $check_next->hsbc_amount_DP;
                            $nauan->report_name = $insert_HSBC->report_name;
                            $nauan->save();
                            $check_next->hsbc_status = 1;
                            $check_next->save();
                        }
                    }else if($levelUser == 4){
                        $check_next = qlhs_hosobaocao_ngna_STC::where('hsbc_active',1)->where('report_name',$report_name)->first();
                        if($check_next){
                            $school_id = $check_next->hsbc_school_id;
                            $insert_HSBC = new HoSoBaoCao();
                            $insert_HSBC->report_name = $autoCode;
                            $insert_HSBC->report_value = bussinessClass::autoCodeFirst(4,$user);
                            $insert_HSBC->report_type = 'NGNA';
                            $insert_HSBC->report_name_text = $name;
                            $insert_HSBC->report_date = Carbon::now();
                            $insert_HSBC->create_userid = Auth::user()->id;
                            $insert_HSBC->report_year = $check_next->hsbc_years;
                            $insert_HSBC->report_id_truong = $school_id;
                            $insert_HSBC->report_note = $note;
                            $insert_HSBC->report_cap_gui = 4;
                            $insert_HSBC->report_cap_status = 1;
                            $insert_HSBC->report_status = 0;
                            
                            $insert_HSBC->report_cap_nhan = 4;
                            $insert_HSBC->report_total = null;
                            $insert_HSBC->report_name_new = $report_name;
                            $insert_HSBC->number = bussinessClass::autoCodeNumber(4,$user);
                            $insert_HSBC->save();

                            $nauan = new qlhs_hosobaocao_ngna_duyet();
                            $nauan->hsbc_school_id = $check_next->hsbc_school_id;
                            $nauan->hsbc_amount = $check_next->hsbc_amount;
                            $nauan->hsbc_HSTW = $check_next->hsbc_HSTW;
                            $nauan->hsbc_HSDP = $check_next->hsbc_HSDP;
                            $nauan->hsbc_Total = $check_next->hsbc_Total;
                            $nauan->hsbc_unit_id = $check_next->hsbc_unit_id;
                            $nauan->hsbc_years = $check_next->hsbc_years;
                            $nauan->hsbc_HK = $check_next->hsbc_HK;
                            $nauan->hsbc_TW = $check_next->hsbc_TW;
                            $nauan->hsbc_DP = $check_next->hsbc_DP;
                            $nauan->hsbc_68 = $check_next->hsbc_68;
                            $nauan->hsbc_amount_TW = $check_next->hsbc_amount_TW;
                            $nauan->hsbc_amount_DP = $check_next->hsbc_amount_DP;
                            $nauan->report_name = $insert_HSBC->report_name;
                            $nauan->save();
                            $check_next->hsbc_status = 1;
                            $check_next->save();
                        }
                    }
                    $result['success'] = "Công văn đã được lập và gửi lên cấp trên.";
                    return $result;
                }
                
                if($levelUser == 2){
                   $check_next = DB::table('qlhs_baocaokinhphi_PGD');
                }else if($levelUser == 3){
                    $check_next = DB::table('qlhs_baocaokinhphi_PTC');
                }else if($levelUser == 4){
                    $check_next = DB::table('qlhs_baocaokinhphi_SGD');
                }
                if($chedoMGHP > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_mghp',1)
                            ->where(function($q){
                                $q->orWhere('bckp_trangthai_mghp',1)
                                  ->orWhere('bckp_trangthai_mghp',4);
                            });
                    });
                    
                }
                if($chedoCPHT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_cpht',1)
                          ->where(function($q){
                             $q->orWhere('bckp_trangthai_cpht',1)
                               ->orWhere('bckp_trangthai_cpht',4);
                        });
                    });
                }
                if($chedoHTBT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_htbt_to',1)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htbt_to',1)
                                ->orWhere('bckp_trangthai_htbt_to',4);
                        });
                    })
                    ->orWhere(function($p){
                        $p->where('bckp_active_htbt_ta',1)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htbt_ta',1)
                                ->orWhere('bckp_trangthai_htbt_ta',4);
                        });
                    })
                    ->orWhere(function($p){
                        $p->where('bckp_active_htbt_vhtt',1)
                          ->where(function($q){
                            $q->orWhere('bckp_trangthai_htbt_vhtt',1)
                                ->orWhere('bckp_trangthai_htbt_vhtt',4);
                        });
                    });
                }
                if($chedoHTAT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_htat',1)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htat',1)
                            ->orWhere('bckp_trangthai_htat',4);
                        });
                    });
                }
                if($chedoHSKT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_htkt_hb',1)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htkt_hb',1)
                              ->orWhere('bckp_trangthai_htkt_hb',4);
                        });
                    })
                    ->orWhere(function($p){
                        $p->where('bckp_active_htkt_ddht',1)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htkt_ddht',1)
                              ->orWhere('bckp_trangthai_htkt_ddht',4);
                        }); 
                    });                       
                }
                if($chedoHTATHS > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_htaths',1)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htaths',1)
                            ->orWhere('bckp_trangthai_htaths',4);
                        });
                    });
                }
                if($chedoHSDTTS > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_hsdtts',1)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_hsdtts',1)
                            ->orWhere('bckp_trangthai_hsdtts',4);
                        });
                    });
                }
                if($chedoHBHSDTNT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_hbhsdtnt',1)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_hbhsdtnt',1)
                              ->orWhere('bckp_trangthai_hbhsdtnt',4);
                        });
                    });
                }  
                    
                $check_next = DB::table(DB::raw("({$check_next->toSql()}) as check_next"))
                    ->mergeBindings($check_next)->where('bckp_name',$report_name);

            }else if($report_status == 2){
               // $autoCode = $r_name != null ? $r_name : bussinessClass::autoCodeCallback($levelUser,Auth::user()->id);

                if($levelUser == 2){
                    $check_next = DB::table('qlhs_baocaokinhphi_PGD');
                }else if($levelUser == 3){
                    $check_next = DB::table('qlhs_baocaokinhphi_PTC');
                }else if($levelUser == 4){
                    $check_next = DB::table('qlhs_baocaokinhphi_SGD');
                }
                if($chedoMGHP > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_mghp',2)
                            ->where(function($q){
                                $q->orWhere('bckp_trangthai_mghp',2)
                                  ->orWhere('bckp_trangthai_mghp',3);
                            });
                    });
                    
                }
                if($chedoCPHT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_cpht',2)
                          ->where(function($q){
                             $q->orWhere('bckp_trangthai_cpht',2)
                               ->orWhere('bckp_trangthai_cpht',3);
                        });
                    });
                }
                if($chedoHTBT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_htbt_to',2)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htbt_to',2)
                                ->orWhere('bckp_trangthai_htbt_to',3);
                        });
                    })
                    ->orWhere(function($p){
                        $p->where('bckp_active_htbt_ta',2)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htbt_ta',2)
                                ->orWhere('bckp_trangthai_htbt_ta',3);
                        });
                    })
                    ->orWhere(function($p){
                        $p->where('bckp_active_htbt_vhtt',2)
                          ->where(function($q){
                            $q->orWhere('bckp_trangthai_htbt_vhtt',3)
                                ->orWhere('bckp_trangthai_htbt_vhtt',2);
                        });
                    });
                }
                if($chedoHTAT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_htat',2)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htat',2)
                            ->orWhere('bckp_trangthai_htat',3);
                        });
                    });
                }
                if($chedoHSKT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_htkt_hb',2)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htkt_hb',2)
                              ->orWhere('bckp_trangthai_htkt_hb',3);
                        });
                    })
                    ->orWhere(function($p){
                        $p->where('bckp_active_htkt_ddht',2)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htkt_ddht',2)
                              ->orWhere('bckp_trangthai_htkt_ddht',3);
                        }); 
                    });                       
                }
                if($chedoHTATHS > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_htaths',2)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_htaths',2)
                            ->orWhere('bckp_trangthai_htaths',3);
                        });
                    });
                }
                if($chedoHSDTTS > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_hsdtts',2)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_hsdtts',2)
                            ->orWhere('bckp_trangthai_hsdtts',3);
                        });
                    });
                }
                if($chedoHBHSDTNT > 0){
                    $check_next = $check_next
                    ->orWhere(function($p){
                        $p->where('bckp_active_hbhsdtnt',2)
                        ->where(function($q){
                            $q->orWhere('bckp_trangthai_hbhsdtnt',2)
                              ->orWhere('bckp_trangthai_hbhsdtnt',3);
                        });
                    });
                }  
                    
                $check_next = DB::table(DB::raw("({$check_next->toSql()}) as check_next"))
                    ->mergeBindings($check_next)->where('bckp_name',$report_name);
                
            }
            if($check_next->count() <= 0){
                $result['error'] = "Danh sách học sinh trống";
                return $result;
            } 
            dispatch((new sendDocumentary_PhongSo(0,$report_name,$report_status,$chedo,$name,$note,$time,$user,$levelUser,$autoCode))->onQueue('school_'.$levelUser));
                
            $result['success'] = "Công văn đã được lập và gửi lên cấp trên.";
            
        } catch (Exception $e) {
            $result['error'] = "Lập danh sách thất bại" .$e;
        }

        return $result;
    }

    

    public function approvedAllPhongSo(Request $request) {
        try {
            $result = [];

            $socongvan = $request->SOCONGVAN;
            $loai = $request->loai;

           // $user = Auth::user()->id;
            $levelUser = Auth::user()->level;
            DB::statement("call approvedPhongSoAll(".$levelUser.",'".$socongvan."',".$loai.")");
            DB::table('qlhs_hosobaocao')
                ->where('report_name',$socongvan)
                ->update(['report_cap_status' => 1]);
            if($loai == 1){
                $result['success'] = "Chọn duyệt toàn bộ học sinh thành công";
            }else{
                $result['success'] = "Hủy duyệt toàn bộ học sinh thành công";
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function revertedAllPhongSo(Request $request) {
        try {
            $result = [];
            $socongvan = $request->SOCONGVAN;
            $loai = $request->loai;

            //$user = Auth::user()->id;
            $levelUser = Auth::user()->level;
            DB::statement("call approvedPhongSoAll(".$levelUser.",'".$socongvan."',".$loai.")");
            DB::table('qlhs_hosobaocao')
                ->where('report_name',$socongvan)
                ->update(['report_cap_status' => 1]);
            if($loai == 2){
                $result['success'] = "Chọn trả lại toàn bộ học sinh thành công";
            }else{
                $result['success'] = "Hủy trả lại toàn bộ học sinh thành công";
            }



            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function reloadAllPhongSo(Request $request) {
        try {
            $result = [];
            $socongvan = $request->input('SOCONGVAN');

            $user = Auth::user()->id;
            $levelUser = 0;

            $getLevelUser = DB::table('users')->where('id', $user)->select('level')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
            }

            $MGHP = 0;
            $CPHT = 0;
            $HTAT = 0;
            $HTBT_TA = 0;
            $HTBT_TO = 0;
            $HTBT_VHTT = 0;
            $HSKT_HB = 0;
            $HSKT_DDHT = 0;
            $HSDTTS = 0;
            $HTATHS = 0;
            $HBHSDTNT = 0;

            $getData = DB::table('qlhs_subject_danhsach')->where('subject_ds_socongvan', $socongvan)->get();
            if (!is_null($getData) && !empty($getData) && count($getData) > 0) {
                foreach ($getData as $values) {
                    $arrValue = [];
                    $arrValue = explode(',', $values->subject_ds_group_sub_name);
                    foreach ($arrValue as $item) {
                        $arrItem = [];
                        $arrItem = explode('-', $item);
                        $value = $arrItem[0];
                        if ($value == 89 || $value == 90 || $value == 91) {
                            $MGHP = 3;
                        }
                        if ($value == 92) {
                            $CPHT = 3;
                        }
                        if ($value == 93) {
                            $HTAT = 3;
                        }
                        if ($value == 94) {
                            $HTBT_TA = 3;
                        }
                        if ($value == 98) {
                            $HTBT_TO = 3;
                        }
                        if ($value == 115) {
                            $HTBT_VHTT = 3;
                        }
                        if ($value == 95) {
                            $HSKT_HB = 3;
                        }
                        if ($value == 100) {
                            $HSKT_DDHT = 3;
                        }
                        if ($value == 99) {
                            $HSDTTS = 3;
                        }
                        if ($value == 118) {
                            $HTATHS = 3;
                        }
                        if ($value == 119) {
                            $HBHSDTNT = 3;
                        }
                    }
                    if ($levelUser == 2) {
                        DB::table('qlhs_hosobaocao_trangthai_PGD')->where('rppspgd_report_name', $socongvan)->where('rppspgd_profile_id', $values->subject_ds_profile_id)
                            ->update([
                                'rppspgd_Status_MGHP' => $MGHP,
                                'rppspgd_Status_CPHT' => $CPHT,
                                'rppspgd_Status_HTAT' => $HTAT,
                                'rppspgd_Status_HTBT_TA' => $HTBT_TA,
                                'rppspgd_Status_HTBT_TO' => $HTBT_TO,
                                'rppspgd_Status_HTBT_VHTT' => $HTBT_VHTT,
                                'rppspgd_Status_HSKT_HB' => $HSKT_HB,
                                'rppspgd_Status_HSKT_DDHT' => $HSKT_DDHT,
                                'rppspgd_Status_HSDTTS' => $HSDTTS,
                                'rppspgd_Status_HTATHS' => $HTATHS,
                                'rppspgd_Status_HBHSDTNT' => $HBHSDTNT
                                ]);
                    }
                    if ($levelUser == 3) {
                        DB::table('qlhs_hosobaocao_trangthai_PTC')->where('rppsptc_report_name', $socongvan)->where('rppsptc_profile_id', $values->subject_ds_profile_id)
                            ->update([
                                'rppsptc_Status_MGHP' => $MGHP,
                                'rppsptc_Status_CPHT' => $CPHT,
                                'rppsptc_Status_HTAT' => $HTAT,
                                'rppsptc_Status_HTBT_TA' => $HTBT_TA,
                                'rppsptc_Status_HTBT_TO' => $HTBT_TO,
                                'rppsptc_Status_HTBT_VHTT' => $HTBT_VHTT,
                                'rppsptc_Status_HSKT_HB' => $HSKT_HB,
                                'rppsptc_Status_HSKT_DDHT' => $HSKT_DDHT,
                                'rppsptc_Status_HSDTTS' => $HSDTTS,
                                'rppsptc_Status_HTATHS' => $HTATHS,
                                'rppsptc_Status_HBHSDTNT' => $HBHSDTNT
                                ]);
                    }
                    if ($levelUser == 4) {
                        DB::table('qlhs_hosobaocao_trangthai_So')->where('rppss_report_name', $socongvan)->where('rppss_profile_id', $values->subject_ds_profile_id)
                            ->update([
                                'rppss_Status_MGHP' => $MGHP,
                                'rppss_Status_CPHT' => $CPHT,
                                'rppss_Status_HTAT' => $HTAT,
                                'rppss_Status_HTBT_TA' => $HTBT_TA,
                                'rppss_Status_HTBT_TO' => $HTBT_TO,
                                'rppss_Status_HTBT_VHTT' => $HTBT_VHTT,
                                'rppss_Status_HSKT_HB' => $HSKT_HB,
                                'rppss_Status_HSKT_DDHT' => $HSKT_DDHT,
                                'rppss_Status_HSDTTS' => $HSDTTS,
                                'rppss_Status_HTATHS' => $HTATHS,
                                'rppss_Status_HBHSDTNT' => $HBHSDTNT
                                ]);
                    }
                }
                

                $result['success'] = "Chọn thu hồi toàn bộ học sinh thành công";
            }
            else { $result['error'] = "Xảy ra lỗi"; }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function approvedPhongSo(Request $request) {
        try {
            $result = [];
            $arrSubjectId = $request->ARRSUBJECTID;
            $socongvan = $request->SOCONGVAN;
            $profile_id = $request->PROFILEID;
            $note = $request->NOTE;

            $user = Auth::user()->id;
            $levelUser = Auth::user()->level;

            $arrSubId = [];
            $arrSubId = explode('-', $arrSubjectId);

            $MGHP = 0;
            $CPHT = 0;
            $HTAT = 0;
            $HTBT_TA = 0;
            $HTBT_TO = 0;
            $HTBT_VHTT = 0;
            $HSKT_HB = 0;
            $HSKT_DDHT = 0;
            $HSDTTS = 0;
            $HTATHS = 0;
            $HBHSDTNT = 0;

            foreach ($arrSubId as $value) {
                if ($value == 89 || $value == 90 || $value == 91) {
                    $MGHP = 1;
                }
                if ($value == 92) {
                    $CPHT = 1;
                }
                if ($value == 93) {
                    $HTAT = 1;
                }
                if ($value == 94) {
                    $HTBT_TA = 1;
                }
                if ($value == 98) {
                    $HTBT_TO = 1;
                }
                if ($value == 115) {
                    $HTBT_VHTT = 1;
                }
                if ($value == 95) {
                    $HSKT_HB = 1;
                }
                if ($value == 100) {
                    $HSKT_DDHT = 1;
                }
                if ($value == 99) {
                    $HSDTTS = 1;
                }
                if ($value == 118) {
                    $HTATHS = 1;
                }
                if ($value == 119) {
                    $HBHSDTNT = 1;
                }
            }

            DB::statement("call approvedPhongSo(".$levelUser.",".$MGHP.",".$CPHT.",".$HTAT.",".$HTBT_TA.",".$HTBT_TO.",".$HTBT_VHTT.",".$HSKT_HB.",".$HSKT_DDHT.",".$HSDTTS.",".$HTATHS.",".$HBHSDTNT.",'".$note."','".$socongvan."',".$profile_id.",1)");
//START
            // if ($levelUser == 2) {
            //     DB::table('qlhs_hosobaocao_trangthai_PGD')
            //         ->where('rppspgd_report_name', $socongvan)
            //         ->where('rppspgd_profile_id', $profile_id)
            //         ->update([
            //             'rppspgd_Status_MGHP' => $MGHP,
            //             'rppspgd_Status_CPHT' => $CPHT,
            //             'rppspgd_Status_HTAT' => $HTAT,
            //             'rppspgd_Status_HTBT_TA' => $HTBT_TA,
            //             'rppspgd_Status_HTBT_TO' => $HTBT_TO,
            //             'rppspgd_Status_HTBT_VHTT' => $HTBT_VHTT,
            //             'rppspgd_Status_HSKT_HB' => $HSKT_HB,
            //             'rppspgd_Status_HSKT_DDHT' => $HSKT_DDHT,
            //             'rppspgd_Status_HSDTTS' => $HSDTTS,
            //             'rppspgd_Status_HTATHS' => $HTATHS,
            //             'rppspgd_Status_HBHSDTNT' => $HBHSDTNT,
            //             're_ghi_chu' => $note
            //         ]);
            // }
            // else if ($levelUser == 3) {
            //     DB::table('qlhs_hosobaocao_trangthai_PTC')
            //     ->where('rppsptc_report_name', $socongvan)
            //     ->where('rppsptc_profile_id', $profile_id)
            //         ->update([
            //             'rppsptc_Status_MGHP' => $MGHP,
            //             'rppsptc_Status_CPHT' => $CPHT,
            //             'rppsptc_Status_HTAT' => $HTAT,
            //             'rppsptc_Status_HTBT_TA' => $HTBT_TA,
            //             'rppsptc_Status_HTBT_TO' => $HTBT_TO,
            //             'rppsptc_Status_HTBT_VHTT' => $HTBT_VHTT,
            //             'rppsptc_Status_HSKT_HB' => $HSKT_HB,
            //             'rppsptc_Status_HSKT_DDHT' => $HSKT_DDHT,
            //             'rppsptc_Status_HSDTTS' => $HSDTTS,
            //             'rppsptc_Status_HTATHS' => $HTATHS,
            //             'rppsptc_Status_HBHSDTNT' => $HBHSDTNT,
            //             're_ghi_chu' => $note
            //             ]);
            // }
            // else if ($levelUser == 4) {
            //     DB::table('qlhs_hosobaocao_trangthai_So')
            //     ->where('rppss_report_name', $socongvan)
            //     ->where('rppss_profile_id', $profile_id)
            //         ->update([
            //             'rppss_Status_MGHP' => $MGHP,
            //             'rppss_Status_CPHT' => $CPHT,
            //             'rppss_Status_HTAT' => $HTAT,
            //             'rppss_Status_HTBT_TA' => $HTBT_TA,
            //             'rppss_Status_HTBT_TO' => $HTBT_TO,
            //             'rppss_Status_HTBT_VHTT' => $HTBT_VHTT,
            //             'rppss_Status_HSKT_HB' => $HSKT_HB,
            //             'rppss_Status_HSKT_DDHT' => $HSKT_DDHT,
            //             'rppss_Status_HSDTTS' => $HSDTTS,
            //             'rppss_Status_HTATHS' => $HTATHS,
            //             'rppss_Status_HBHSDTNT' => $HBHSDTNT,
            //             're_ghi_chu' => $note
            //             ]);
            // }
//END
            DB::table('qlhs_hosobaocao')
            ->where('report_name',$socongvan)
            ->update(['report_cap_status' => 1]);
            if ($MGHP == 0 && $CPHT == 0 && $HTAT == 0 && $HTBT_TA == 0 && $HTBT_TO == 0 && $HTBT_VHTT == 0 && $HSKT_HB == 0 && $HSKT_DDHT == 0 && $HSDTTS == 0 && $HTATHS == 0 && $HBHSDTNT == 0) {
                $result['success'] = "Bỏ chọn duyệt toàn bộ chế độ";
            }
            else {
                $result['success'] = "Thao tác thành công";
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }
//use
    public function revertedPhongSo(Request $request) {
        try {
            $result = [];
            $arrSubjectId = $request->ARRSUBJECTID;
            $socongvan = $request->SOCONGVAN;
            $profile_id = $request->PROFILEID;
            $note = $request->NOTE;

            $user = Auth::user()->id;
            $levelUser = Auth::user()->level;

            $arrSubId = [];
            $arrSubId = explode('-', $arrSubjectId);

            $MGHP = 0;
            $CPHT = 0;
            $HTAT = 0;
            $HTBT_TA = 0;
            $HTBT_TO = 0;
            $HTBT_VHTT = 0;
            $HSKT_HB = 0;
            $HSKT_DDHT = 0;
            $HSDTTS = 0;
            $HTATHS = 0;
            $HBHSDTNT = 0;
            foreach ($arrSubId as $value) {
                if ($value == 89 || $value == 90 || $value == 91) {
                    $MGHP = 2;
                }
                if ($value == 92) {
                    $CPHT = 2;
                }
                if ($value == 93) {
                    $HTAT = 2;
                }
                if ($value == 94) {
                    $HTBT_TA = 2;
                }
                if ($value == 98) {
                    $HTBT_TO = 2;
                }
                if ($value == 115) {
                    $HTBT_VHTT = 2;
                }
                if ($value == 95) {
                    $HSKT_HB = 2;
                }
                if ($value == 100) {
                    $HSKT_DDHT = 2;
                }
                if ($value == 99) {
                    $HSDTTS = 2;
                }
                if ($value == 118) {
                    $HTATHS = 2;
                }
                if ($value == 119) {
                    $HBHSDTNT = 2;
                }
            }

            DB::statement("call approvedPhongSo(".$levelUser.",".$MGHP.",".$CPHT.",".$HTAT.",".$HTBT_TA.",".$HTBT_TO.",".$HTBT_VHTT.",".$HSKT_HB.",".$HSKT_DDHT.",".$HSDTTS.",".$HTATHS.",".$HBHSDTNT.",'".$note."','".$socongvan."',".$profile_id.",2)");
            
            DB::table('qlhs_hosobaocao')
            ->where('report_name',$socongvan)
            ->update(['report_cap_status' => 1]);

            if ($MGHP == 0 && $CPHT == 0 && $HTAT == 0 && $HTBT_TA == 0 && $HTBT_TO == 0 && $HTBT_VHTT == 0 && $HSKT_HB == 0 && $HSKT_DDHT == 0 && $HSDTTS == 0 && $HTATHS == 0 && $HBHSDTNT == 0) {
                $result['error'] = "Bỏ chọn trả lại toàn bộ chế độ";
            }
            else {
                $result['success'] = "Chọn trả lại chế độ thành công";
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function reloadPhongSo(Request $request) {
        try {
            $result = [];
            $arrSubjectId = $request->input('ARRSUBJECTID');
            $socongvan = $request->input('SOCONGVAN');
            $profile_id = $request->input('PROFILEID');

            $user = Auth::user()->id;
            $levelUser = 0;

            $getLevelUser = DB::table('users')->where('id', $user)->select('level')->get();
            if (!is_null($getLevelUser) && !empty($getLevelUser) && count($getLevelUser) > 0) {
                $levelUser = $getLevelUser[0]->level;
            }

            $arrSubId = [];
            $arrSubId = explode('-', $arrSubjectId);

            $MGHP = 0;
            $CPHT = 0;
            $HTAT = 0;
            $HTBT_TA = 0;
            $HTBT_TO = 0;
            $HTBT_VHTT = 0;
            $HSKT_HB = 0;
            $HSKT_DDHT = 0;
            $HSDTTS = 0;
            $HTATHS = 0;
            $HBHSDTNT = 0;

            if ($levelUser == 2) {
                $getData = DB::table('qlhs_hosobaocao_trangthai_PGD')->where('rppspgd_report_name', $socongvan)->where('rppspgd_profile_id', $profile_id)
                    ->get();

                if (!is_null($getData) && !empty($getData) && count($getData) > 0) {
                    foreach ($getData as $value) {
                        if ($value->rppspgd_Status_MGHP != 3) {
                            $MGHP = $value->rppspgd_Status_MGHP;
                        }
                        if ($value->rppspgd_Status_CPHT != 3) {
                            $CPHT = $value->rppspgd_Status_CPHT;
                        }
                        if ($value->rppspgd_Status_HTAT != 3) {
                            $HTAT = $value->rppspgd_Status_HTAT;
                        }
                        if ($value->rppspgd_Status_HTBT_TA != 3) {
                            $HTBT_TA = $value->rppspgd_Status_HTBT_TA;
                        }
                        if ($value->rppspgd_Status_HTBT_TO != 3) {
                            $HTBT_TO = $value->rppspgd_Status_HTBT_TO;
                        }
                        if ($value->rppspgd_Status_HTBT_VHTT != 3) {
                            $HTBT_VHTT = $value->rppspgd_Status_HTBT_VHTT;
                        }
                        if ($value->rppspgd_Status_HSKT_HB != 3) {
                            $HSKT_HB = $value->rppspgd_Status_HSKT_HB;
                        }
                        if ($value->rppspgd_Status_HSKT_DDHT != 3) {
                            $HSKT_DDHT = $value->rppspgd_Status_HSKT_DDHT;
                        }
                        if ($value->rppspgd_Status_HSDTTS != 3) {
                            $HSDTTS = $value->rppspgd_Status_HSDTTS;
                        }
                        if ($value->rppspgd_Status_HTATHS != 3) {
                            $HTATHS = $value->rppspgd_Status_HTATHS;
                        }
                        if ($value->rppspgd_Status_HBHSDTNT != 3) {
                            $HBHSDTNT = $value->rppspgd_Status_HBHSDTNT;
                        }
                    }
                }
            }
            if ($levelUser == 3) {
                $getData = DB::table('qlhs_hosobaocao_trangthai_PTC')->where('rppsptc_report_name', $socongvan)->where('rppsptc_profile_id', $profile_id)
                    ->get();

                if (!is_null($getData) && !empty($getData) && count($getData) > 0) {
                    foreach ($getData as $value) {
                        if ($value->rppsptc_Status_MGHP != 3) {
                            $MGHP = $value->rppsptc_Status_MGHP;
                        }
                        if ($value->rppsptc_Status_CPHT != 3) {
                            $CPHT = $value->rppsptc_Status_CPHT;
                        }
                        if ($value->rppsptc_Status_HTAT != 3) {
                            $HTAT = $value->rppsptc_Status_HTAT;
                        }
                        if ($value->rppsptc_Status_HTBT_TA != 3) {
                            $HTBT_TA = $value->rppsptc_Status_HTBT_TA;
                        }
                        if ($value->rppsptc_Status_HTBT_TO != 3) {
                            $HTBT_TO = $value->rppsptc_Status_HTBT_TO;
                        }
                        if ($value->rppsptc_Status_HTBT_VHTT != 3) {
                            $HTBT_VHTT = $value->rppsptc_Status_HTBT_VHTT;
                        }
                        if ($value->rppsptc_Status_HSKT_HB != 3) {
                            $HSKT_HB = $value->rppsptc_Status_HSKT_HB;
                        }
                        if ($value->rppsptc_Status_HSKT_DDHT != 3) {
                            $HSKT_DDHT = $value->rppsptc_Status_HSKT_DDHT;
                        }
                        if ($value->rppsptc_Status_HSDTTS != 3) {
                            $HSDTTS = $value->rppsptc_Status_HSDTTS;
                        }
                        if ($value->rppsptc_Status_HTATHS != 3) {
                            $HTATHS = $value->rppsptc_Status_HTATHS;
                        }
                        if ($value->rppsptc_Status_HBHSDTNT != 3) {
                            $HBHSDTNT = $value->rppsptc_Status_HBHSDTNT;
                        }
                    }
                }
            }
            if ($levelUser == 4) {
                $getData = DB::table('qlhs_hosobaocao_trangthai_So')->where('rppss_report_name', $socongvan)->where('rppss_profile_id', $profile_id)
                    ->get();

                if (!is_null($getData) && !empty($getData) && count($getData) > 0) {
                    foreach ($getData as $value) {
                        if ($value->rppss_Status_MGHP != 3) {
                            $MGHP = $value->rppss_Status_MGHP;
                        }
                        if ($value->rppss_Status_CPHT != 3) {
                            $CPHT = $value->rppss_Status_CPHT;
                        }
                        if ($value->rppss_Status_HTAT != 3) {
                            $HTAT = $value->rppss_Status_HTAT;
                        }
                        if ($value->rppss_Status_HTBT_TA != 3) {
                            $HTBT_TA = $value->rppss_Status_HTBT_TA;
                        }
                        if ($value->rppss_Status_HTBT_TO != 3) {
                            $HTBT_TO = $value->rppss_Status_HTBT_TO;
                        }
                        if ($value->rppss_Status_HTBT_VHTT != 3) {
                            $HTBT_VHTT = $value->rppss_Status_HTBT_VHTT;
                        }
                        if ($value->rppss_Status_HSKT_HB != 3) {
                            $HSKT_HB = $value->rppss_Status_HSKT_HB;
                        }
                        if ($value->rppss_Status_HSKT_DDHT != 3) {
                            $HSKT_DDHT = $value->rppss_Status_HSKT_DDHT;
                        }
                        if ($value->rppss_Status_HSDTTS != 3) {
                            $HSDTTS = $value->rppss_Status_HSDTTS;
                        }
                        if ($value->rppss_Status_HTATHS != 3) {
                            $HTATHS = $value->rppss_Status_HTATHS;
                        }
                        if ($value->rppss_Status_HBHSDTNT != 3) {
                            $HBHSDTNT = $value->rppss_Status_HBHSDTNT;
                        }
                    }
                }
            }

            foreach ($arrSubId as $value) {
                if ($value == 89 || $value == 90 || $value == 91) {
                    $MGHP = 3;
                }
                if ($value == 92) {
                    $CPHT = 3;
                }
                if ($value == 93) {
                    $HTAT = 3;
                }
                if ($value == 94) {
                    $HTBT_TA = 3;
                }
                if ($value == 98) {
                    $HTBT_TO = 3;
                }
                if ($value == 115) {
                    $HTBT_VHTT = 3;
                }
                if ($value == 95) {
                    $HSKT_HB = 3;
                }
                if ($value == 100) {
                    $HSKT_DDHT = 3;
                }
                if ($value == 99) {
                    $HSDTTS = 3;
                }
                if ($value == 118) {
                    $HTATHS = 3;
                }
                if ($value == 119) {
                    $HBHSDTNT = 3;
                }
            }

            if ($levelUser == 2) {
                DB::table('qlhs_hosobaocao_trangthai_PGD')->where('rppspgd_report_name', $socongvan)->where('rppspgd_profile_id', $profile_id)
                    ->update([
                        'rppspgd_Status_MGHP' => $MGHP,
                        'rppspgd_Status_CPHT' => $CPHT,
                        'rppspgd_Status_HTAT' => $HTAT,
                        'rppspgd_Status_HTBT_TA' => $HTBT_TA,
                        'rppspgd_Status_HTBT_TO' => $HTBT_TO,
                        'rppspgd_Status_HTBT_VHTT' => $HTBT_VHTT,
                        'rppspgd_Status_HSKT_HB' => $HSKT_HB,
                        'rppspgd_Status_HSKT_DDHT' => $HSKT_DDHT,
                        'rppspgd_Status_HSDTTS' => $HSDTTS,
                        'rppspgd_Status_HTATHS' => $HTATHS,
                        'rppspgd_Status_HBHSDTNT' => $HBHSDTNT
                        ]);
            }
            if ($levelUser == 3) {
                DB::table('qlhs_hosobaocao_trangthai_PTC')->where('rppsptc_report_name', $socongvan)->where('rppsptc_profile_id', $profile_id)
                    ->update([
                        'rppsptc_Status_MGHP' => $MGHP,
                        'rppsptc_Status_CPHT' => $CPHT,
                        'rppsptc_Status_HTAT' => $HTAT,
                        'rppsptc_Status_HTBT_TA' => $HTBT_TA,
                        'rppsptc_Status_HTBT_TO' => $HTBT_TO,
                        'rppsptc_Status_HTBT_VHTT' => $HTBT_VHTT,
                        'rppsptc_Status_HSKT_HB' => $HSKT_HB,
                        'rppsptc_Status_HSKT_DDHT' => $HSKT_DDHT,
                        'rppsptc_Status_HSDTTS' => $HSDTTS,
                        'rppsptc_Status_HTATHS' => $HTATHS,
                        'rppsptc_Status_HBHSDTNT' => $HBHSDTNT
                        ]);
            }
            if ($levelUser == 4) {
                DB::table('qlhs_hosobaocao_trangthai_So')->where('rppss_report_name', $socongvan)->where('rppss_profile_id', $profile_id)
                    ->update([
                        'rppss_Status_MGHP' => $MGHP,
                        'rppss_Status_CPHT' => $CPHT,
                        'rppss_Status_HTAT' => $HTAT,
                        'rppss_Status_HTBT_TA' => $HTBT_TA,
                        'rppss_Status_HTBT_TO' => $HTBT_TO,
                        'rppss_Status_HTBT_VHTT' => $HTBT_VHTT,
                        'rppss_Status_HSKT_HB' => $HSKT_HB,
                        'rppss_Status_HSKT_DDHT' => $HSKT_DDHT,
                        'rppss_Status_HSDTTS' => $HSDTTS,
                        'rppss_Status_HTATHS' => $HTATHS,
                        'rppss_Status_HBHSDTNT' => $HBHSDTNT
                        ]);
            }

            if ($MGHP == 0 && $CPHT == 0 && $HTAT == 0 && $HTBT_TA == 0 && $HTBT_TO == 0 && $HTBT_VHTT == 0 && $HSKT_HB == 0 && $HSKT_DDHT == 0 && $HSDTTS == 0 && $HTATHS == 0 && $HBHSDTNT == 0) {
                $result['error'] = "Bỏ chọn thu hồi toàn bộ chế độ";
            }
            else {
                $result['success'] = "Chọn thu hồi chế độ thành công";
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }

    public function thuhoicongvanlap(Request $request)
    {
        try {
            $result = [];
            $socongvan = $request->input('SOCONGVAN');



            $getValue = DB::table('qlhs_hosobaocao')->where('report_name_new', $socongvan)->select('report_name')->first();

            $getListName = DB::table('qlhs_hosobaocao')->where('report_name', $getValue->report_name)->select('report_cap_nhan', 'report_name_new')->get();

            $getListProfile = DB::table('qlhs_hosobaocao_tien')->where('rpp_report_name', $socongvan)->select('rpp_profile_id')->get();


            if (!is_null($getListName) && !empty($getListName) && count($getListName) > 0 && !is_null($getListProfile) && !empty($getListProfile) && count($getListProfile) > 0) {
                foreach ($getListName as $value) {
                    foreach ($getListProfile as $valueProfile) {
                        DB::table('qlhs_hosobaocao_tien')->where('rpp_report_name', $value->report_name_new)->where('rpp_profile_id', $valueProfile->rpp_profile_id)->update(['rpp_status' => 1]);
                    }
                }

                $result['success'] = 'Đồng ý thu hồi học sinh thành công';
            }
            else {
                $result['error'] = 'Thu hồi học sinh thất bại';
            }

            return $result;
        } catch (Exception $e) {
            return $e;
        }
    }
    public function huycongvan_tralai($congvan){
        $result = [];
        try{
//            DB::table('qlhs_message')->where('report_name',$congvan)->delete();
            $get_data_hsbc = DB::table('qlhs_hosobaocao')
            ->where('report_name', $congvan)
            ->where('report_cap_status',2)->get();
            if(count($get_data_hsbc) > 0){
                $capgui = $get_data_hsbc[0]->report_cap_gui;
                $report_name = $get_data_hsbc[0]->report_name_new;
                $get_type = explode('-', $get_data_hsbc[0]->report_type);
                $chedoMGHP = 0;
                $chedoCPHT = 0;
                $chedoHTAT = 0;
                $chedoHSKT = 0;
                $chedoHTATHS = 0;
                $chedoHSDTTS = 0;
                $chedoHBHSDTNT = 0;
                $chedoHTBT = 0;
                $report_status = 1;
                $levelUser = Auth::user()->level;
                foreach ($get_type as $key => $value) {
                    if ($value == 'MGHP'){
                        $chedoMGHP = $report_status;
                    }else if ($value == 'CPHT'){
                        $chedoCPHT = $report_status;
                    }else if($value == 'HTAT'){
                        $chedoHTAT = $report_status;
                    }else if ($value == 'HTBT'){
                        $chedoHTBT = $report_status;
                    }else if ($value == 'HSKT'){
                        $chedoHSKT = $report_status;
                    }else if ($value == 'HTATHS'){
                        $chedoHTATHS = $report_status;
                    }else if ($value == 'HSDTTS'){
                        $chedoHSDTTS = $report_status;
                    }else if ($value == 'HBHSDTNT'){
                        $chedoHBHSDTNT = $report_status;
                    }
                }
                $report_name  = $get_data_hsbc[0]->report_name_new;
               // return $capgui.",'".$report_name."','".$congvan. "',2,".$chedoMGHP.",".$chedoCPHT.",".$chedoHTAT.",".$chedoHTBT.",".$chedoHSKT.",".$chedoHSDTTS.",".$chedoHTATHS.",".$chedoHBHSDTNT;
                DB::statement("call update_congvan_old(".$capgui.",'".$report_name."','".$congvan. "',2,".$chedoMGHP.",".$chedoCPHT.",".$chedoHTAT.",".$chedoHTBT.",".$chedoHSKT.",".$chedoHSDTTS.",".$chedoHTATHS.",".$chedoHBHSDTNT.")");
                $result['success'] = 'Hủy thông báo công văn thành công';
            }else{
                $result['success'] = 'Công văn không tồn tại hoặc đã được xóa.Xin mời tải lại';
            }
        }catch (Exception $e) {
            $result['error'] = 'Hủy thông báo công văn có lỗi.Xin mời thử lại sau ít phút';
        }
        return $result;
    }
    public function thuhoi_congvan($congvan){
        $result = [];
        $get_data_hsbc = DB::table('qlhs_hosobaocao')
            ->where('report_name', $congvan)
            ->where('report_cap_status',0)->get();
        $check_congvan = count($get_data_hsbc);
        if($check_congvan > 0){

            $update_thuhoi = DB::table('qlhs_hosobaocao')
                        ->where('report_name', $congvan)
                        ->where('report_cap_status',0)
                        ->update(['report_cap_status' => 3]);
            if($update_thuhoi >= 0){
                $get_type = explode('-', $get_data_hsbc[0]->report_type);
                $chedoMGHP = 0;
                $chedoCPHT = 0;
                $chedoHTAT = 0;
                $chedoHSKT = 0;
                $chedoHTATHS = 0;
                $chedoHSDTTS = 0;
                $chedoHBHSDTNT = 0;
                $chedoHTBT = 0;
                $report_status = 1;
                $levelUser = Auth::user()->level;
                foreach ($get_type as $key => $value) {
                    if ($value == 'MGHP'){
                        $chedoMGHP = $report_status;
                    }else if ($value == 'CPHT'){
                        $chedoCPHT = $report_status;
                    }else if($value == 'HTAT'){
                        $chedoHTAT = $report_status;
                    }else if ($value == 'HTBT'){
                        $chedoHTBT = $report_status;
                    }else if ($value == 'HSKT'){
                        $chedoHSKT = $report_status;
                    }else if ($value == 'HTATHS'){
                        $chedoHTATHS = $report_status;
                    }else if ($value == 'HSDTTS'){
                        $chedoHSDTTS = $report_status;
                    }else if ($value == 'HBHSDTNT'){
                        $chedoHBHSDTNT = $report_status;
                    }
                }
                $report_name  = $get_data_hsbc[0]->report_name_new;
                DB::statement("call update_congvan_old(".$levelUser.",'".$report_name."','".$congvan. "',3,".$chedoMGHP.",".$chedoCPHT.",".$chedoHTAT.",".$chedoHTBT.",".$chedoHSKT.",".$chedoHSDTTS.",".$chedoHTATHS.",".$chedoHBHSDTNT.")");
                $result['success'] = 'Thu hồi công văn thành công';
            }else{
                $result['error'] = 'Thu hồi công văn có lỗi. Xin mời thử lại!';
            }
        }else{
             $check_data_hsbc = DB::table('qlhs_hosobaocao')
            ->where('report_name_new', $congvan)
            ->count();
            if($check_data_hsbc > 0){
                $result['error'] = 'Công văn đã được xử lý và gửi cấp trên.Yêu cầu xin thu hồi công văn từ cấp trên!';
            }else{

                $update_thuhoi = DB::table('qlhs_hosobaocao')
                 ->where('report_name', $congvan);
                 if(Auth::user()->level == 4){
                    $update_thuhoi = $update_thuhoi->where('report_cap_gui', 4)
                    ->where('report_cap_nhan', 4)
                    ->update(['report_cap_status' => 3]);
                    $result['error'] = 'Đã thu hồi công văn duyệt';
                 }else{
                    $update_thuhoi->update(['report_cap_status' => 4]);
                    $result['error'] = 'Công văn đã xử lý. Chờ cấp trên cho phép thu hồi!';
                 }
                 
                
            }
        }
        return $result;
    }
    public function khoa_congvan($congvan){
        $result = [];
        $update_khoa = DB::table('qlhs_hosobaocao')
                ->where('report_name', $congvan)
                ->where('report_cap_gui', 4)
                ->where('report_cap_nhan', 4)
                ->update(['report_cap_status' => 5]);//Khoá dữ liệu
        if($update_khoa > 0){
            $result['success'] = 'Khóa dữ liệu công văn thành công';
        }else{
            $result['error'] = 'Khóa dữ liệu công văn có lỗi. Xin mời thử lại!';
        }
        return $result;
    }
    public function dongythuhoi_congvan($congvan){
        $result = [];
        $check_data_hsbc = DB::table('qlhs_hosobaocao')
            ->where('report_name_new', $congvan)
            ->count();
        if($check_data_hsbc > 0){
            DB::table('qlhs_hosobaocao')
            ->where('report_name', $congvan)
            ->update(['report_cap_status' => 1]);
            $result['error'] = 'Công văn đã được xử lý và gửi cấp trên.Yêu cầu xin thu hồi công văn từ cấp trên!';
        }else{
            $get_data_hsbc = DB::table('qlhs_hosobaocao')
            ->where('report_name', $congvan)
            ->where('report_cap_status',4);
            $check_congvan = $get_data_hsbc->count();

            if($check_congvan > 0){
                $update_thuhoi = $get_data_hsbc->update(['report_cap_status' => 3]);
                if($update_thuhoi > 0){
                    $result['success'] = 'Cho phép thu hồi công văn thành công';
                }else{
                    $result['error'] = 'Cho phép thu hồi công văn có lỗi. Xin mời thử lại!';
                }
            }
        }
        
        return $result;
    }
    public function huythuhoi_congvan($congvan){
        $result = [];
        $get_data_hsbc = DB::table('qlhs_hosobaocao')
            ->where('report_name', $congvan)
            ->where('report_cap_status',4);
        $check_congvan = $get_data_hsbc->count();
        if($check_congvan > 0){
            $update_thuhoi = $get_data_hsbc->update(['report_cap_status' => 1]);
            if($update_thuhoi > 0){
                $result['success'] = 'Không cho phép thu hồi';
            }else{
                $result['error'] = 'Không cho phép thu hồi. Xin mời thử lại!';
            }
        }
        return $result;
    }

    public function locCongVanTheoTruong($type,$congvan){

        $cv = DB::table('qlhs_hosobaocao')
        ->where('report_name',$congvan)
        ->select('report_id_truong','report_cap_status')
        ->first();
        return view('admin.hoso.duyetdanhsach.listingfilter',['id_truong' => $cv->report_id_truong,
            'status' => $cv->report_cap_status, 'congvan' => $congvan,'type' => $type]);
    }
}

?>